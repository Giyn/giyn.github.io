<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Pyppeteer 的基本使用方法</title>
      <link href="/posts/e24b51bb/"/>
      <url>/posts/e24b51bb/</url>
      
        <content type="html"><![CDATA[<h1 id="什么是-Puppeteer？"><a href="#什么是-Puppeteer？" class="headerlink" title="什么是 Puppeteer？"></a>什么是 Puppeteer？</h1><p>要想知道什么是 Pyppeteer，首先应该先了解一下 Puppeteer：</p><p>Puppeteer 是 Google 基于 Node.js 开发的一个工具，拥有 Puppeteer 即可通过 JavaScript 来控制 Chrome 浏览器的一些操作，也可以用于网络爬虫上，其 API 极其完善，功能非常强大。</p><h1 id="什么是-Pyppeteer？"><a href="#什么是-Pyppeteer？" class="headerlink" title="什么是 Pyppeteer？"></a>什么是 Pyppeteer？</h1><p>Pyppeteer 是 Puppeteer 的 Python 实现，Pyppetter 基于 Chromium 浏览器通过执行一些动作来进行网页渲染，Pyppeteer 基于 Python 的新特性 async 实现，因此它也支持异步操作，效率相对于 Selenium 也有一定的提高。</p><h1 id="使用-Pyppeteer-进行页面渲染"><a href="#使用-Pyppeteer-进行页面渲染" class="headerlink" title="使用 Pyppeteer 进行页面渲染"></a>使用 Pyppeteer 进行页面渲染</h1><p><img src="https://img-blog.csdnimg.cn/20210128144413258.png?1x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTk2MTc3NA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" loading="lazy"></p><p><a href="https://movie.douban.com/explore#!type=movie&tag=%E7%83%AD%E9%97%A8&sort=recommend&page_limit=20&page_start=0">豆瓣电影筛选页面</a>页面是 JavaScript 渲染生成的，此处使用 Pyppeteer，模拟浏览器的操作，直接用浏览器把页面渲染出来，然后再直接获取渲染后的结果。</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> asyncio<span class="token keyword">from</span> lxml <span class="token keyword">import</span> etree<span class="token keyword">from</span> faker <span class="token keyword">import</span> Faker<span class="token keyword">from</span> pyppeteer <span class="token keyword">import</span> launchfake <span class="token operator">=</span> Faker<span class="token punctuation">(</span><span class="token punctuation">)</span>URL <span class="token operator">=</span> <span class="token string">'https://movie.douban.com/explore#!type=movie&amp;tag=%E7%83%AD%E9%97%A8&amp;sort=recommend&amp;page_limit=20&amp;page_start=0'</span><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    browser <span class="token operator">=</span> <span class="token keyword">await</span> launch<span class="token punctuation">(</span><span class="token punctuation">)</span>    page <span class="token operator">=</span> <span class="token keyword">await</span> browser<span class="token punctuation">.</span>newPage<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> page<span class="token punctuation">.</span>setUserAgent<span class="token punctuation">(</span>fake<span class="token punctuation">.</span>user_agent<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> page<span class="token punctuation">.</span>goto<span class="token punctuation">(</span>URL<span class="token punctuation">,</span> options<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'timeout'</span><span class="token punctuation">:</span> <span class="token number">10000</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    doc <span class="token operator">=</span> etree<span class="token punctuation">.</span>HTML<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">await</span> page<span class="token punctuation">.</span>content<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    titles_xpath <span class="token operator">=</span> <span class="token string">"//div[@class='list']/a[@class='item']/div/img/@alt"</span>    titles <span class="token operator">=</span> doc<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span>titles_xpath<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>titles<span class="token punctuation">)</span>    <span class="token keyword">await</span> browser<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><p>运行结果：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token punctuation">[</span><span class="token string">'心灵奇旅'</span><span class="token punctuation">,</span> <span class="token string">'无依之地'</span><span class="token punctuation">,</span> <span class="token string">'迈阿密的一夜'</span><span class="token punctuation">,</span> <span class="token string">'捕鲸男孩'</span><span class="token punctuation">,</span> <span class="token string">'绿洲'</span><span class="token punctuation">,</span> <span class="token string">'我是大哥大 电影版'</span><span class="token punctuation">,</span> <span class="token string">'除暴'</span><span class="token punctuation">,</span> <span class="token string">'女人的碎片'</span><span class="token punctuation">,</span> <span class="token string">'波斯语课'</span><span class="token punctuation">,</span> <span class="token string">'穷途鼠的奶酪梦'</span><span class="token punctuation">,</span> <span class="token string">'一秒钟'</span><span class="token punctuation">,</span> <span class="token string">'刻在你心底的名字'</span><span class="token punctuation">,</span> <span class="token string">'神奇女侠1984'</span><span class="token punctuation">,</span> <span class="token string">'白虎'</span><span class="token punctuation">,</span> <span class="token string">'玫瑰岛的不可思议的历史'</span><span class="token punctuation">,</span> <span class="token string">'2020去死'</span><span class="token punctuation">,</span> <span class="token string">'沐浴之王'</span><span class="token punctuation">,</span> <span class="token string">'我和我的家乡'</span><span class="token punctuation">,</span> <span class="token string">'夺冠'</span><span class="token punctuation">,</span> <span class="token string">'信条'</span><span class="token punctuation">]</span></code></pre><p>具体分析如下：</p><p>使用 launch 方法新建一个 Browser 对象，相当于启动浏览器；接着 browser 调用 newPage  方法新建了一个 Page 对象，相当于浏览器新建一个选项卡，随后调用 setUserAgent 方法设置 User-Agent，然后 Page 对象调用了 goto 方法访问目标页面，相当于在浏览器中输入目标 URL，浏览器跳转到了对应页面进行加载；页面加载完成后再调用 content 方法获取当前浏览器页面的源代码，即 JavaScript 渲染后的结果；最后使用 lxml 进行解析并提取电影名称。</p><p>可以看到 Pyppeteer 的代码比 Selenium 更简洁易读，且环境配置更方便，还实现了异步爬取。</p><p>除此以外，我们还可以尝试 Pyppeteer 的其他功能：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> asyncio<span class="token keyword">from</span> faker <span class="token keyword">import</span> Faker<span class="token keyword">from</span> pyppeteer <span class="token keyword">import</span> launchfake <span class="token operator">=</span> Faker<span class="token punctuation">(</span><span class="token punctuation">)</span>URL <span class="token operator">=</span> <span class="token string">'https://movie.douban.com/explore#!type=movie&amp;tag=%E7%83%AD%E9%97%A8&amp;sort=recommend&amp;page_limit=20&amp;page_start=0'</span><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    browser <span class="token operator">=</span> <span class="token keyword">await</span> launch<span class="token punctuation">(</span><span class="token punctuation">)</span>    page <span class="token operator">=</span> <span class="token keyword">await</span> browser<span class="token punctuation">.</span>newPage<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> page<span class="token punctuation">.</span>setViewport<span class="token punctuation">(</span>viewport<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'width'</span><span class="token punctuation">:</span> <span class="token number">1280</span><span class="token punctuation">,</span> <span class="token string">'height'</span><span class="token punctuation">:</span> <span class="token number">800</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> page<span class="token punctuation">.</span>setUserAgent<span class="token punctuation">(</span>fake<span class="token punctuation">.</span>user_agent<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> page<span class="token punctuation">.</span>goto<span class="token punctuation">(</span>URL<span class="token punctuation">,</span> options<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'timeout'</span><span class="token punctuation">:</span> <span class="token number">10000</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">4.12</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> page<span class="token punctuation">.</span>screenshot<span class="token punctuation">(</span>path<span class="token operator">=</span><span class="token string">'screenshot.png'</span><span class="token punctuation">)</span>    dimensions <span class="token operator">=</span> <span class="token keyword">await</span> page<span class="token punctuation">.</span>evaluate<span class="token punctuation">(</span><span class="token triple-quoted-string string">'''() => &#123;        return &#123;            width: document.documentElement.clientWidth,            height: document.documentElement.clientHeight,            deviceScaleFactor: window.devicePixelRatio,        &#125;    &#125;'''</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>dimensions<span class="token punctuation">)</span>    <span class="token keyword">await</span> browser<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><p>运行结果：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token punctuation">&#123;</span><span class="token string">'width'</span><span class="token punctuation">:</span> <span class="token number">1263</span><span class="token punctuation">,</span> <span class="token string">'height'</span><span class="token punctuation">:</span> <span class="token number">800</span><span class="token punctuation">,</span> <span class="token string">'deviceScaleFactor'</span><span class="token punctuation">:</span> <span class="token number">1.0000000149011612</span><span class="token punctuation">&#125;</span></code></pre><p>此处使用 setViewport 方法设定了浏览器窗口大小并模拟了网页截图，此外还执行了自定义的 JavaScript 以获得特定的内容。</p><p>截图如下：</p><p><img src="https://img-blog.csdnimg.cn/2021012815292040.png?1x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTk2MTc3NA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" loading="lazy"><br>最后调用 evaluate 方法执行 JavaScript 代码，其传入一个函数，返回网页的宽高、像素大小比率，最后得到一个 JSON 格式的对象。</p><h1 id="Pyppeteer-常用方法"><a href="#Pyppeteer-常用方法" class="headerlink" title="Pyppeteer 常用方法"></a>Pyppeteer 常用方法</h1><h2 id="launch"><a href="#launch" class="headerlink" title="launch"></a>launch</h2><p>使用 Pyppeteer 的第一步是调用 launch 方法来启动浏览器，首先通过<a href="https://miyakogi.github.io/pyppeteer/reference.html#pyppeteer.launcher.launch">官方文档</a>查看 launch 方法的定义：</p><pre class="language-python" data-language="python"><code class="language-python">pyppeteer<span class="token punctuation">.</span>launcher<span class="token punctuation">.</span>launch<span class="token punctuation">(</span>options<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span> → pyppeteer<span class="token punctuation">.</span>browser<span class="token punctuation">.</span>Browser</code></pre><p>launch 方法处于 launcher 模块中，参数没有在声明中特别指定，返回类型是 browser 模块中的 Browser 对象，launch 方法是 async 修饰的方法，因此调用时需要使用 await。</p><p>launch 方法的参数如下：</p><table><thead><tr><th>参数</th><th>描述</th></tr></thead><tbody><tr><td>ignoreHTTPSErrors (bool)</td><td>是否要忽略 HTTPS 的错误，默认是 False。</td></tr><tr><td>headless (bool)</td><td>是否启用 Headless 模式，即无界面模式，如果 devtools 这个参数是 True 的话，那么该参数就会被设置为 False，否则为 True，即默认是开启无界面模式的。</td></tr><tr><td>executablePath (str)</td><td>可执行文件的路径，如果指定之后就不需要使用默认的 Chromium 了，可以指定为已有的 Chrome 或 Chromium。</td></tr><tr><td>slowMo (int or float)</td><td>通过传入指定的时间，可以减缓 Pyppeteer 的一些模拟操作。</td></tr><tr><td>args (List[str])</td><td>在执行过程中可以传入的额外参数。</td></tr><tr><td>ignoreDefaultArgs (bool)</td><td>不使用 Pyppeteer 的默认参数，如果使用了这个参数，那么最好通过 args 参数来设定一些参数，否则可能会出现一些意想不到的问题。这个参数相对比较危险，慎用。</td></tr><tr><td>handleSIGINT (bool)</td><td>是否响应 SIGINT 信号，也就是可以使用 Ctrl + C 来终止浏览器程序，默认是 True。</td></tr><tr><td>handleSIGTERM (bool)</td><td>是否响应 SIGTERM 信号，一般是 kill 命令，默认是 True。</td></tr><tr><td>handleSIGHUP (bool)</td><td>是否响应 SIGHUP 信号，即挂起信号，比如终端退出操作，默认是 True。</td></tr><tr><td>dumpio (bool)</td><td>是否将 Pyppeteer 的输出内容传给 process.stdout 和 process.stderr 对象，默认是 False。</td></tr><tr><td>userDataDir (str)</td><td>即用户数据文件夹，即可以保留一些个性化配置和操作记录。</td></tr><tr><td>env (dict)</td><td>环境变量，可以通过字典形式传入。</td></tr><tr><td>devtools (bool)</td><td>是否为每一个页面自动开启调试工具，默认是 False。如果这个参数设置为 True，那么 headless 参数就会无效，会被强制设置为 False。</td></tr><tr><td>logLevel  (int or str)</td><td>日志级别，默认和 root logger 对象的级别相同。</td></tr><tr><td>autoClose (bool)</td><td>当一些命令执行完之后，是否自动关闭浏览器，默认是 True。</td></tr><tr><td>loop (asyncio.AbstractEventLoop)</td><td>事件循环对象。</td></tr></tbody></table><h3 id="有头模式和调试模式"><a href="#有头模式和调试模式" class="headerlink" title="有头模式和调试模式"></a>有头模式和调试模式</h3><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> asyncio<span class="token keyword">from</span> faker <span class="token keyword">import</span> Faker<span class="token keyword">from</span> pyppeteer <span class="token keyword">import</span> launchfake <span class="token operator">=</span> Faker<span class="token punctuation">(</span><span class="token punctuation">)</span>URL <span class="token operator">=</span> <span class="token string">'https://movie.douban.com/explore#!type=movie&amp;tag=%E7%83%AD%E9%97%A8&amp;sort=recommend&amp;page_limit=20&amp;page_start=0'</span><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    browser <span class="token operator">=</span> <span class="token keyword">await</span> launch<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">'headless'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span>                            <span class="token string">'devtools'</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>                            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    page <span class="token operator">=</span> <span class="token keyword">await</span> browser<span class="token punctuation">.</span>newPage<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> page<span class="token punctuation">.</span>setUserAgent<span class="token punctuation">(</span>fake<span class="token punctuation">.</span>user_agent<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> page<span class="token punctuation">.</span>goto<span class="token punctuation">(</span>URL<span class="token punctuation">,</span> options<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'timeout'</span><span class="token punctuation">:</span> <span class="token number">10000</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">412</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> browser<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><p>运行结果：</p><p>使用调试模式后，每开启一个界面就会弹出一个调试窗口。</p><p><img src="https://img-blog.csdnimg.cn/20210128160045685.png?1x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTk2MTc3NA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" loading="lazy"></p><p><img src="https://img-blog.csdnimg.cn/20210128160049282.png?1x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTk2MTc3NA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" loading="lazy"></p><h3 id="禁用页面顶端提示条"><a href="#禁用页面顶端提示条" class="headerlink" title="禁用页面顶端提示条"></a>禁用页面顶端提示条</h3><p>有头模式时可以看到页面顶端提示条：”Chrome 正受到自动测试软件的控制”，可以使用 args 参数来关闭：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> asyncio<span class="token keyword">from</span> faker <span class="token keyword">import</span> Faker<span class="token keyword">from</span> pyppeteer <span class="token keyword">import</span> launchfake <span class="token operator">=</span> Faker<span class="token punctuation">(</span><span class="token punctuation">)</span>URL <span class="token operator">=</span> <span class="token string">'https://movie.douban.com/explore#!type=movie&amp;tag=%E7%83%AD%E9%97%A8&amp;sort=recommend&amp;page_limit=20&amp;page_start=0'</span><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    browser <span class="token operator">=</span> <span class="token keyword">await</span> launch<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">'headless'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span>                            <span class="token string">'args'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'--disable-infobars'</span><span class="token punctuation">]</span>                            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    page <span class="token operator">=</span> <span class="token keyword">await</span> browser<span class="token punctuation">.</span>newPage<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> page<span class="token punctuation">.</span>setUserAgent<span class="token punctuation">(</span>fake<span class="token punctuation">.</span>user_agent<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> page<span class="token punctuation">.</span>goto<span class="token punctuation">(</span>URL<span class="token punctuation">,</span> options<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'timeout'</span><span class="token punctuation">:</span> <span class="token number">10000</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">412</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> browser<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><p><img src="https://img-blog.csdnimg.cn/20210128161342687.png?1x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTk2MTc3NA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" loading="lazy"></p><h3 id="防止-WebDriver-检测"><a href="#防止-WebDriver-检测" class="headerlink" title="防止 WebDriver 检测"></a>防止 WebDriver 检测</h3><p>我们试着访问<a href="https://gz.meituan.com/meishi/">美团美食网</a>：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> asyncio<span class="token keyword">from</span> faker <span class="token keyword">import</span> Faker<span class="token keyword">from</span> pyppeteer <span class="token keyword">import</span> launchfake <span class="token operator">=</span> Faker<span class="token punctuation">(</span><span class="token punctuation">)</span>URL <span class="token operator">=</span> <span class="token string">'https://gz.meituan.com/meishi/'</span><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    browser <span class="token operator">=</span> <span class="token keyword">await</span> launch<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">'headless'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span>                            <span class="token string">'args'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'--disable-infobars'</span><span class="token punctuation">]</span>                            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    page <span class="token operator">=</span> <span class="token keyword">await</span> browser<span class="token punctuation">.</span>newPage<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> page<span class="token punctuation">.</span>setUserAgent<span class="token punctuation">(</span>fake<span class="token punctuation">.</span>user_agent<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> page<span class="token punctuation">.</span>goto<span class="token punctuation">(</span>URL<span class="token punctuation">,</span> options<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'timeout'</span><span class="token punctuation">:</span> <span class="token number">10000</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">412</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> browser<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><p>可以看到 HTTP 状态码 为 403（403 Forbidden），即使我们设置了 User-Agent，美团依然能够检测到 WebDriver。<br><img src="https://img-blog.csdnimg.cn/20210128174301204.png?1x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTk2MTc3NA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" loading="lazy"><br>Pyppeteer 的 Page 对象有一个 evaluateOnNewDocument 方法，可以在每次加载网页的时候执行某个语句，此处执行将 WebDriver 隐藏的命令 <code>&#39;Object.defineProperty(navigator, &quot;webdriver&quot;, &#123;get: () =&gt; undefined&#125;)&#39;</code>：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> asyncio<span class="token keyword">from</span> faker <span class="token keyword">import</span> Faker<span class="token keyword">from</span> pyppeteer <span class="token keyword">import</span> launchfake <span class="token operator">=</span> Faker<span class="token punctuation">(</span><span class="token punctuation">)</span>URL <span class="token operator">=</span> <span class="token string">'https://gz.meituan.com/meishi/'</span><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    browser <span class="token operator">=</span> <span class="token keyword">await</span> launch<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">'headless'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span>                            <span class="token string">'args'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'--disable-infobars'</span><span class="token punctuation">]</span>                            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    page <span class="token operator">=</span> <span class="token keyword">await</span> browser<span class="token punctuation">.</span>newPage<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> page<span class="token punctuation">.</span>setUserAgent<span class="token punctuation">(</span>fake<span class="token punctuation">.</span>user_agent<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> page<span class="token punctuation">.</span>evaluateOnNewDocument<span class="token punctuation">(</span><span class="token string">'function()&#123;Object.defineProperty(navigator, "webdriver", &#123;get: () => undefined&#125;)&#125;'</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> page<span class="token punctuation">.</span>goto<span class="token punctuation">(</span>URL<span class="token punctuation">,</span> options<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'timeout'</span><span class="token punctuation">:</span> <span class="token number">10000</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">412</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> browser<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><p>如下图可以看到绕过了 WebDriver 的检测，成功访问页面并加载出美团美食内容：<br><img src="https://img-blog.csdnimg.cn/20210128180122856.png?1x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTk2MTc3NA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" loading="lazy"></p><h3 id="页面大小调整"><a href="#页面大小调整" class="headerlink" title="页面大小调整"></a>页面大小调整</h3><p>上图中可发现页面大小与浏览器大小不统一，可以使用 setViewport 方法进行调整：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> asyncio<span class="token keyword">from</span> faker <span class="token keyword">import</span> Faker<span class="token keyword">from</span> pyppeteer <span class="token keyword">import</span> launchfake <span class="token operator">=</span> Faker<span class="token punctuation">(</span><span class="token punctuation">)</span>URL <span class="token operator">=</span> <span class="token string">'https://gz.meituan.com/meishi/'</span><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    browser <span class="token operator">=</span> <span class="token keyword">await</span> launch<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">'headless'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span>                            <span class="token string">'args'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'--disable-infobars'</span><span class="token punctuation">]</span>                            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    page <span class="token operator">=</span> <span class="token keyword">await</span> browser<span class="token punctuation">.</span>newPage<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">await</span> page<span class="token punctuation">.</span>setViewport<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">'width'</span><span class="token punctuation">:</span> <span class="token number">1530</span><span class="token punctuation">,</span> <span class="token string">'height'</span><span class="token punctuation">:</span> <span class="token number">800</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> page<span class="token punctuation">.</span>setUserAgent<span class="token punctuation">(</span>fake<span class="token punctuation">.</span>user_agent<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> page<span class="token punctuation">.</span>evaluateOnNewDocument<span class="token punctuation">(</span><span class="token string">'function()&#123;Object.defineProperty(navigator, "webdriver", &#123;get: () => undefined&#125;)&#125;'</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> page<span class="token punctuation">.</span>goto<span class="token punctuation">(</span>URL<span class="token punctuation">,</span> options<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'timeout'</span><span class="token punctuation">:</span> <span class="token number">10000</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">412</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> browser<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><p>可以看到页面大小调整为正常状态：</p><p><img src="https://img-blog.csdnimg.cn/20210128181012680.png?1x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTk2MTc3NA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" loading="lazy"></p><h3 id="用户数据持久化"><a href="#用户数据持久化" class="headerlink" title="用户数据持久化"></a>用户数据持久化</h3><p>平时访问网站时关键 Cookies 已经保存到本地浏览器，因此下次登录时可以直接读取并保持登录状态，这些信息保存在用户目录下，其不仅包含浏览器的基本配置信息，还有一些 Cache、Cookies 等信息，若能在浏览器启动时读取这些信息，则可以恢复一些历史记录以及登录状态信息。</p><p>Pyppeteer 提供了实现手段，即在启动的时候设置 userDataDir：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> asyncio<span class="token keyword">from</span> faker <span class="token keyword">import</span> Faker<span class="token keyword">from</span> pyppeteer <span class="token keyword">import</span> launchfake <span class="token operator">=</span> Faker<span class="token punctuation">(</span><span class="token punctuation">)</span>URL <span class="token operator">=</span> <span class="token string">'https://www.zhihu.com/'</span><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    browser <span class="token operator">=</span> <span class="token keyword">await</span> launch<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">'headless'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span>                            <span class="token string">'args'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'--disable-infobars'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                            <span class="token string">'userDataDir'</span><span class="token punctuation">:</span> <span class="token string">'./userdata'</span>                            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    page <span class="token operator">=</span> <span class="token keyword">await</span> browser<span class="token punctuation">.</span>newPage<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> page<span class="token punctuation">.</span>setViewport<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">'width'</span><span class="token punctuation">:</span> <span class="token number">1530</span><span class="token punctuation">,</span> <span class="token string">'height'</span><span class="token punctuation">:</span> <span class="token number">800</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> page<span class="token punctuation">.</span>setUserAgent<span class="token punctuation">(</span>fake<span class="token punctuation">.</span>user_agent<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> page<span class="token punctuation">.</span>evaluateOnNewDocument<span class="token punctuation">(</span><span class="token string">'function()&#123;Object.defineProperty(navigator, "webdriver", &#123;get: () => undefined&#125;)&#125;'</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> page<span class="token punctuation">.</span>goto<span class="token punctuation">(</span>URL<span class="token punctuation">,</span> options<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'timeout'</span><span class="token punctuation">:</span> <span class="token number">10000</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">412</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> browser<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><p>第一次启动时先手动登录：</p><p><img src="https://img-blog.csdnimg.cn/20210128184314288.png?1x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTk2MTc3NA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" loading="lazy"></p><p>登录后相关信息会保存在用户目录下，下次登录时即可直接读取：</p><p><img src="https://img-blog.csdnimg.cn/20210128184420725.png?1x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTk2MTc3NA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" loading="lazy"></p><p>此后再启动，无需重新登录（除非 Cookies 过期）。</p><p><img src="https://img-blog.csdnimg.cn/2021012818422064.png?1x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTk2MTc3NA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" loading="lazy"></p><h2 id="Browser"><a href="#Browser" class="headerlink" title="Browser"></a>Browser</h2><p>launch 方法返回的是 Browser 对象（浏览器对象），即 Browser 类的一个实例，其拥有许多用于操作浏览器的方法。</p><h3 id="无痕模式"><a href="#无痕模式" class="headerlink" title="无痕模式"></a>无痕模式</h3><p>无痕模式的好处就是环境干净，不与其他的浏览器示例共享 Cache、Cookies 等内容，其开启方式可以通过 createIncognitoBrowserContext 方法，其返回一个 context 对象，用其创建新选项卡：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> asyncio<span class="token keyword">from</span> faker <span class="token keyword">import</span> Faker<span class="token keyword">from</span> pyppeteer <span class="token keyword">import</span> launchfake <span class="token operator">=</span> Faker<span class="token punctuation">(</span><span class="token punctuation">)</span>URL <span class="token operator">=</span> <span class="token string">'https://gz.meituan.com/meishi/'</span><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    browser <span class="token operator">=</span> <span class="token keyword">await</span> launch<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">'headless'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span>                            <span class="token string">'args'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'--disable-infobars'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                            <span class="token string">'userDataDir'</span><span class="token punctuation">:</span> <span class="token string">'./userdata'</span>                            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    context <span class="token operator">=</span> <span class="token keyword">await</span> browser<span class="token punctuation">.</span>createIncognitoBrowserContext<span class="token punctuation">(</span><span class="token punctuation">)</span>    page <span class="token operator">=</span> <span class="token keyword">await</span> context<span class="token punctuation">.</span>newPage<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> page<span class="token punctuation">.</span>setViewport<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">'width'</span><span class="token punctuation">:</span> <span class="token number">1530</span><span class="token punctuation">,</span> <span class="token string">'height'</span><span class="token punctuation">:</span> <span class="token number">800</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> page<span class="token punctuation">.</span>setUserAgent<span class="token punctuation">(</span>fake<span class="token punctuation">.</span>user_agent<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> page<span class="token punctuation">.</span>evaluateOnNewDocument<span class="token punctuation">(</span><span class="token string">'function()&#123;Object.defineProperty(navigator, "webdriver", &#123;get: () => undefined&#125;)&#125;'</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> page<span class="token punctuation">.</span>goto<span class="token punctuation">(</span>URL<span class="token punctuation">,</span> options<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'timeout'</span><span class="token punctuation">:</span> <span class="token number">10000</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">412</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> browser<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><p>访问美团后先登录：</p><p><img src="https://img-blog.csdnimg.cn/20210128230741529.png?1x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTk2MTc3NA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" loading="lazy"></p><p>第二次使用无痕模式访问的时候，仍然需要登录：</p><p><img src="https://img-blog.csdnimg.cn/20210128230852752.png?1x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTk2MTc3NA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" loading="lazy"></p><h2 id="Page"><a href="#Page" class="headerlink" title="Page"></a>Page</h2><p>Page 对象即一个选项卡，对应一个页面。</p><h3 id="提取网页资源"><a href="#提取网页资源" class="headerlink" title="提取网页资源"></a>提取网页资源</h3><p>成功访问网页后，可以通过 Page 对象的 xpath 方法提取资源，并使用 getProperty 方法和 .jsonValue() 获取资源：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> asyncio<span class="token keyword">from</span> faker <span class="token keyword">import</span> Faker<span class="token keyword">from</span> pyppeteer <span class="token keyword">import</span> launchfake <span class="token operator">=</span> Faker<span class="token punctuation">(</span><span class="token punctuation">)</span>URL <span class="token operator">=</span> <span class="token string">'https://www.zhihu.com/'</span><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    browser <span class="token operator">=</span> <span class="token keyword">await</span> launch<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">'headless'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span>                            <span class="token string">'args'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'--disable-infobars'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                            <span class="token string">'userDataDir'</span><span class="token punctuation">:</span> <span class="token string">'./userdata'</span>                            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    page <span class="token operator">=</span> <span class="token keyword">await</span> browser<span class="token punctuation">.</span>newPage<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> page<span class="token punctuation">.</span>setViewport<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">'width'</span><span class="token punctuation">:</span> <span class="token number">1530</span><span class="token punctuation">,</span> <span class="token string">'height'</span><span class="token punctuation">:</span> <span class="token number">800</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> page<span class="token punctuation">.</span>setUserAgent<span class="token punctuation">(</span>fake<span class="token punctuation">.</span>user_agent<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> page<span class="token punctuation">.</span>evaluateOnNewDocument<span class="token punctuation">(</span><span class="token string">'function()&#123;Object.defineProperty(navigator, "webdriver", &#123;get: () => undefined&#125;)&#125;'</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> page<span class="token punctuation">.</span>goto<span class="token punctuation">(</span>URL<span class="token punctuation">,</span> options<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'timeout'</span><span class="token punctuation">:</span> <span class="token number">10000</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    title_elements <span class="token operator">=</span> <span class="token keyword">await</span> page<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">"//div[@class='Card TopstoryItem TopstoryItem--old TopstoryItem-isRecommend']//a[@target='_blank']"</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> element <span class="token keyword">in</span> title_elements<span class="token punctuation">:</span>        title <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token keyword">await</span> element<span class="token punctuation">.</span>getProperty<span class="token punctuation">(</span><span class="token string">'textContent'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>jsonValue<span class="token punctuation">(</span><span class="token punctuation">)</span>        url <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token keyword">await</span> element<span class="token punctuation">.</span>getProperty<span class="token punctuation">(</span><span class="token string">'href'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>jsonValue<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>title<span class="token punctuation">)</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">412</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> browser<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><p><img src="https://img-blog.csdnimg.cn/20210129011018946.png?1x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTk2MTc3NA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" loading="lazy"><br><img src="https://img-blog.csdnimg.cn/2021012901102753.png?1x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTk2MTc3NA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" loading="lazy"></p><h3 id="获取和切换选项卡"><a href="#获取和切换选项卡" class="headerlink" title="获取和切换选项卡"></a>获取和切换选项卡</h3><p>新建选项卡使用的是 newPage 方法，下面是获取和切换操作：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> asyncio<span class="token keyword">from</span> pyppeteer <span class="token keyword">import</span> launch<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    browser <span class="token operator">=</span> <span class="token keyword">await</span> launch<span class="token punctuation">(</span>headless<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>    page <span class="token operator">=</span> <span class="token keyword">await</span> browser<span class="token punctuation">.</span>newPage<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> page<span class="token punctuation">.</span>goto<span class="token punctuation">(</span><span class="token string">'https://www.baidu.com'</span><span class="token punctuation">)</span>    page <span class="token operator">=</span> <span class="token keyword">await</span> browser<span class="token punctuation">.</span>newPage<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> page<span class="token punctuation">.</span>goto<span class="token punctuation">(</span><span class="token string">'https://www.bilibili.com/'</span><span class="token punctuation">)</span>    pages <span class="token operator">=</span> <span class="token keyword">await</span> browser<span class="token punctuation">.</span>pages<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 获取所有页面</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Pages:'</span><span class="token punctuation">,</span> pages<span class="token punctuation">)</span>    page1 <span class="token operator">=</span> pages<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>        <span class="token comment"># 等候2秒后切换选项卡</span>    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> page1<span class="token punctuation">.</span>bringToFront<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> browser<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><p>此处调用了 newPage 方法新建了两个选项卡并访问了两个网站。若要切换选项卡，只需调用 pages 方法获取所有页面，然后选一个页面调用其 bringToFront 方法即可切换到该页面对应的选项卡。</p><h3 id="页面的前进、后退、刷新、截图、关闭功能"><a href="#页面的前进、后退、刷新、截图、关闭功能" class="headerlink" title="页面的前进、后退、刷新、截图、关闭功能"></a>页面的前进、后退、刷新、截图、关闭功能</h3><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> asyncio<span class="token keyword">from</span> faker <span class="token keyword">import</span> Faker<span class="token keyword">from</span> pyppeteer <span class="token keyword">import</span> launchfake <span class="token operator">=</span> Faker<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    browser <span class="token operator">=</span> <span class="token keyword">await</span> launch<span class="token punctuation">(</span>headless<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'--disable-infobars'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    page <span class="token operator">=</span> <span class="token keyword">await</span> browser<span class="token punctuation">.</span>newPage<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">await</span> page<span class="token punctuation">.</span>setUserAgent<span class="token punctuation">(</span>fake<span class="token punctuation">.</span>user_agent<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> page<span class="token punctuation">.</span>setExtraHTTPHeaders<span class="token punctuation">(</span>headers<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> page<span class="token punctuation">.</span>evaluateOnNewDocument<span class="token punctuation">(</span>        <span class="token string">'function()&#123;Object.defineProperty(navigator, "webdriver", &#123;get: () => undefined&#125;)&#125;'</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> page<span class="token punctuation">.</span>goto<span class="token punctuation">(</span><span class="token string">'https://www.bilibili.com/'</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> page<span class="token punctuation">.</span>goto<span class="token punctuation">(</span><span class="token string">'https://www.toutiao.com/'</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> page<span class="token punctuation">.</span>goBack<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> page<span class="token punctuation">.</span>goForward<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token builtin">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> page<span class="token punctuation">.</span>screenshot<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> page<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> browser<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><h3 id="输入文本、点击操作"><a href="#输入文本、点击操作" class="headerlink" title="输入文本、点击操作"></a>输入文本、点击操作</h3><p>输入文本使用 Page 对象的 type 方法：</p><ul><li><p>第一个参数为选择器；</p></li><li><p>第二个参数为所输入的内容。</p></li></ul><p>点击操作使用 Page 对象的 click 方法：</p><ul><li>第一个参数为选择器；</li><li>button：left、middle、right；</li><li>clickCount：点击次数；</li><li>delay：延迟点击（ms）。</li></ul><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> asyncio<span class="token keyword">from</span> faker <span class="token keyword">import</span> Faker<span class="token keyword">from</span> pyppeteer <span class="token keyword">import</span> launch<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    browser <span class="token operator">=</span> <span class="token keyword">await</span> launch<span class="token punctuation">(</span>headless<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>    page <span class="token operator">=</span> <span class="token keyword">await</span> browser<span class="token punctuation">.</span>newPage<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> page<span class="token punctuation">.</span>goto<span class="token punctuation">(</span><span class="token string">'https://www.baidu.com/'</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">(</span><span class="token string">'#kw'</span><span class="token punctuation">,</span> <span class="token string">'Python'</span><span class="token punctuation">)</span>  <span class="token comment"># 输入文本</span>    <span class="token keyword">await</span> page<span class="token punctuation">.</span>click<span class="token punctuation">(</span><span class="token string">'#su'</span><span class="token punctuation">,</span> options<span class="token operator">=</span><span class="token punctuation">&#123;</span>        <span class="token string">'button'</span><span class="token punctuation">:</span> <span class="token string">'left'</span><span class="token punctuation">,</span>        <span class="token string">'clickCount'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>        <span class="token string">'delay'</span><span class="token punctuation">:</span> <span class="token number">3000</span><span class="token punctuation">,</span>  <span class="token comment"># 延迟点击(ms)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">412</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> browser<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><p>运行结果：</p><p><img src="https://img-blog.csdnimg.cn/20210129142426509.png?1x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTk2MTc3NA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" loading="lazy"></p><h3 id="获取源代码和-Cookies"><a href="#获取源代码和-Cookies" class="headerlink" title="获取源代码和 Cookies"></a>获取源代码和 Cookies</h3><p>Page 对象获取源代码使用 content 方法，获取 Cookies 使用 cookies 方法。</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> asyncio<span class="token keyword">from</span> faker <span class="token keyword">import</span> Faker<span class="token keyword">from</span> pyppeteer <span class="token keyword">import</span> launch<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    browser <span class="token operator">=</span> <span class="token keyword">await</span> launch<span class="token punctuation">(</span>headless<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>    page <span class="token operator">=</span> <span class="token keyword">await</span> browser<span class="token punctuation">.</span>newPage<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> page<span class="token punctuation">.</span>goto<span class="token punctuation">(</span><span class="token string">'https://www.baidu.com/'</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token keyword">await</span> page<span class="token punctuation">.</span>content<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token keyword">await</span> page<span class="token punctuation">.</span>cookies<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">412</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> browser<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><p>运行结果：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">&lt;</span>!DOCTYPE html<span class="token operator">></span><span class="token operator">&lt;</span>html<span class="token operator">></span><span class="token operator">&lt;</span>head<span class="token operator">></span><span class="token operator">&lt;</span>script <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">"text/javascript"</span> charset<span class="token operator">=</span><span class="token string">"utf-8"</span> src<span class="token operator">=</span><span class="token string">"https://dss0.bdstatic.com/5aV1bjqh_Q23odCf/static/superman/js/components/guide-8759cd328f.js"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span><span class="token operator">&lt;</span>script <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">"text/javascript"</span> charset<span class="token operator">=</span><span class="token string">"utf-8"</span> src<span class="token operator">=</span><span class="token string">"https://dss0.bdstatic.com/5aV1bjqh_Q23odCf/static/superman/js/components/qrcode-da919182da.js"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span><span class="token operator">&lt;</span>script <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">"text/javascript"</span> charset<span class="token operator">=</span><span class="token string">"utf-8"</span> src<span class="token operator">=</span><span class="token string">"https://dss0.bdstatic.com/5aV1bjqh_Q23odCf/static/superman/js/super_load-a97cbd2188.js"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span><span class="token operator">&lt;</span>script <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">"text/javascript"</span> charset<span class="token operator">=</span><span class="token string">"utf-8"</span> src<span class="token operator">=</span><span class="token string">"https://dss0.bdstatic.com/5aV1bjqh_Q23odCf/static/superman/js/components/tips-e2ceadd14d.js"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span><span class="token operator">&lt;</span>meta http<span class="token operator">-</span>equiv<span class="token operator">=</span><span class="token string">"Content-Type"</span> content<span class="token operator">=</span><span class="token string">"text/html;charset=utf-8"</span><span class="token operator">></span><span class="token operator">&lt;</span>meta http<span class="token operator">-</span>equiv<span class="token operator">=</span><span class="token string">"X-UA-Compatible"</span> content<span class="token operator">=</span><span class="token string">"IE=edge,chrome=1"</span><span class="token operator">></span><span class="token operator">&lt;</span>meta content<span class="token operator">=</span><span class="token string">"always"</span> name<span class="token operator">=</span><span class="token string">"referrer"</span><span class="token operator">></span><span class="token operator">&lt;</span>meta name<span class="token operator">=</span><span class="token string">"theme-color"</span> content<span class="token operator">=</span><span class="token string">"#2932e1"</span><span class="token operator">></span><span class="token operator">&lt;</span>meta name<span class="token operator">=</span><span class="token string">"description"</span> content<span class="token operator">=</span><span class="token string">"全球最大的中文搜索引擎、致力于让网民更便捷地获取信息，找到所求。百度超过千亿的中文网页数据库，可以瞬间找到相关的搜索结果。"</span><span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">&#123;</span><span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token string">'PSTM'</span><span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">:</span> <span class="token string">'1611901664'</span><span class="token punctuation">,</span> <span class="token string">'domain'</span><span class="token punctuation">:</span> <span class="token string">'.baidu.com'</span><span class="token punctuation">,</span> <span class="token string">'path'</span><span class="token punctuation">:</span> <span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token string">'expires'</span><span class="token punctuation">:</span> <span class="token number">3759385311.821295</span><span class="token punctuation">,</span> <span class="token string">'size'</span><span class="token punctuation">:</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token string">'httpOnly'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">'secure'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">'session'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token string">'BIDUPSID'</span><span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">:</span> <span class="token string">'6361BE73058980E68337B0E3AAA39F48'</span><span class="token punctuation">,</span> <span class="token string">'domain'</span><span class="token punctuation">:</span> <span class="token string">'.baidu.com'</span><span class="token punctuation">,</span> <span class="token string">'path'</span><span class="token punctuation">:</span> <span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token string">'expires'</span><span class="token punctuation">:</span> <span class="token number">3759385311.821179</span><span class="token punctuation">,</span> <span class="token string">'size'</span><span class="token punctuation">:</span> <span class="token number">40</span><span class="token punctuation">,</span> <span class="token string">'httpOnly'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">'secure'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">'session'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token string">'H_PS_PSSID'</span><span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">:</span> <span class="token string">'33425_33516_33440_33259_33344_33585_26350_33544'</span><span class="token punctuation">,</span> <span class="token string">'domain'</span><span class="token punctuation">:</span> <span class="token string">'.baidu.com'</span><span class="token punctuation">,</span> <span class="token string">'path'</span><span class="token punctuation">:</span> <span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token string">'expires'</span><span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'size'</span><span class="token punctuation">:</span> <span class="token number">57</span><span class="token punctuation">,</span> <span class="token string">'httpOnly'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">'secure'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">'session'</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token string">'BAIDUID'</span><span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">:</span> <span class="token string">'6361BE73058980E68E74F842C5A4CEBB:FG=1'</span><span class="token punctuation">,</span> <span class="token string">'domain'</span><span class="token punctuation">:</span> <span class="token string">'.baidu.com'</span><span class="token punctuation">,</span> <span class="token string">'path'</span><span class="token punctuation">:</span> <span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token string">'expires'</span><span class="token punctuation">:</span> <span class="token number">1643437664.821377</span><span class="token punctuation">,</span> <span class="token string">'size'</span><span class="token punctuation">:</span> <span class="token number">44</span><span class="token punctuation">,</span> <span class="token string">'httpOnly'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">'secure'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">'session'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token string">'BD_HOME'</span><span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">:</span> <span class="token string">'1'</span><span class="token punctuation">,</span> <span class="token string">'domain'</span><span class="token punctuation">:</span> <span class="token string">'www.baidu.com'</span><span class="token punctuation">,</span> <span class="token string">'path'</span><span class="token punctuation">:</span> <span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token string">'expires'</span><span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'size'</span><span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'httpOnly'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">'secure'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">'session'</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token string">'BD_UPN'</span><span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">:</span> <span class="token string">'12314753'</span><span class="token punctuation">,</span> <span class="token string">'domain'</span><span class="token punctuation">:</span> <span class="token string">'www.baidu.com'</span><span class="token punctuation">,</span> <span class="token string">'path'</span><span class="token punctuation">:</span> <span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token string">'expires'</span><span class="token punctuation">:</span> <span class="token number">1612765665</span><span class="token punctuation">,</span> <span class="token string">'size'</span><span class="token punctuation">:</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token string">'httpOnly'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">'secure'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">'session'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token string">'BA_HECTOR'</span><span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">:</span> <span class="token string">'8pak0l852g812l0guh1g17an10r'</span><span class="token punctuation">,</span> <span class="token string">'domain'</span><span class="token punctuation">:</span> <span class="token string">'.baidu.com'</span><span class="token punctuation">,</span> <span class="token string">'path'</span><span class="token punctuation">:</span> <span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token string">'expires'</span><span class="token punctuation">:</span> <span class="token number">1611905265</span><span class="token punctuation">,</span> <span class="token string">'size'</span><span class="token punctuation">:</span> <span class="token number">36</span><span class="token punctuation">,</span> <span class="token string">'httpOnly'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">'secure'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">'session'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span></code></pre><h3 id="执行-JavaScript-代码"><a href="#执行-JavaScript-代码" class="headerlink" title="执行 JavaScript 代码"></a>执行 JavaScript 代码</h3><p>使用 Page 对象的 evaluate 方法即可执行 JavaScript 代码：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> asyncio<span class="token keyword">from</span> faker <span class="token keyword">import</span> Faker<span class="token keyword">from</span> pyppeteer <span class="token keyword">import</span> launchfake <span class="token operator">=</span> Faker<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    browser <span class="token operator">=</span> <span class="token keyword">await</span> launch<span class="token punctuation">(</span>headless<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>    page <span class="token operator">=</span> <span class="token keyword">await</span> browser<span class="token punctuation">.</span>newPage<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> page<span class="token punctuation">.</span>setViewport<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">'width'</span><span class="token punctuation">:</span> <span class="token number">1530</span><span class="token punctuation">,</span> <span class="token string">'height'</span><span class="token punctuation">:</span> <span class="token number">800</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> page<span class="token punctuation">.</span>goto<span class="token punctuation">(</span><span class="token string">'https://www.bilibili.com/'</span><span class="token punctuation">)</span>    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>    dimensions <span class="token operator">=</span> <span class="token keyword">await</span> page<span class="token punctuation">.</span>evaluate<span class="token punctuation">(</span><span class="token triple-quoted-string string">'''() => &#123;        return &#123;            width: document.documentElement.clientWidth,            height: document.documentElement.clientHeight,            deviceScaleFactor: window.devicePixelRatio,        &#125;    &#125;'''</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>dimensions<span class="token punctuation">)</span>    <span class="token keyword">await</span> browser<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><p>运行结果：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token punctuation">&#123;</span><span class="token string">'width'</span><span class="token punctuation">:</span> <span class="token number">465</span><span class="token punctuation">,</span> <span class="token string">'height'</span><span class="token punctuation">:</span> <span class="token number">658</span><span class="token punctuation">,</span> <span class="token string">'deviceScaleFactor'</span><span class="token punctuation">:</span> <span class="token number">1.25</span><span class="token punctuation">&#125;</span></code></pre><p>除了 evaluate 方法，还有 exposeFunction、evaluateOnNewDocument、evaluateHandle 方法也可以执行 JavaScript 代码。</p><h3 id="延时等待"><a href="#延时等待" class="headerlink" title="延时等待"></a>延时等待</h3><table><thead><tr><th>方法</th><th>描述</th></tr></thead><tbody><tr><td>waitForFunction</td><td>等待某个 JavaScript 方法执行完毕或返回结果</td></tr><tr><td>waitForNavigation</td><td>等待页面跳转，如果没加载出来就会报错</td></tr><tr><td>waitForRequest</td><td>等待某个特定的请求被发出</td></tr><tr><td>waitForResponse</td><td>等待某个特定的请求收到了回应</td></tr><tr><td>waitFor</td><td>通用的等待方法</td></tr><tr><td>waitForSelector</td><td>等待符合选择器的节点加载出来</td></tr><tr><td>waitForXPath</td><td>等待符合 XPath 的节点加载出来</td></tr></tbody></table><hr><p>Reference：<a href="https://kaiwu.lagou.com/course/courseInfo.htm?courseId=46#/detail/pc?id=1679">https://kaiwu.lagou.com/course/courseInfo.htm?courseId=46#/detail/pc?id=1679</a></p>]]></content>
      
      
      <categories>
          
          <category> WebScraper </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> Pyppeteer </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用 Pyppeteer 的 evaluateOnNewDocument 方法时出现 Object.defineProperty(...) is not a function 的解决方案</title>
      <link href="/posts/9b4f9c18/"/>
      <url>/posts/9b4f9c18/</url>
      
        <content type="html"><![CDATA[<h2 id="所遇问题"><a href="#所遇问题" class="headerlink" title="所遇问题"></a>所遇问题</h2><p>最近使用 Pyppeteer 过程中调用 evaluateOnNewDocument 方法在浏览器中执行 JavaScript 代码时出现了一个错误，关键代码如下：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">await</span> page<span class="token punctuation">.</span>evaluateOnNewDocument<span class="token punctuation">(</span><span class="token string">'Object.defineProperty(navigator, "webdriver", &#123;get: () => undefined&#125;)'</span><span class="token punctuation">)</span></code></pre><p>其中 JavaScript 代码如下：</p><pre class="language-javascript" data-language="javascript"><code class="language-javascript">Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>navigator<span class="token punctuation">,</span> <span class="token string">"webdriver"</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">undefined</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></code></pre><p>单从代码来看是没问题的，但是在 Chrome 控制台上会报如下错误：</p><p><img src="https://i.loli.net/2021/01/29/u4TchBJdALDW8I5.png" alt="d4ecde51248cc8e46ffb0589cce6241.png" loading="lazy"></p><p><code>Uncaught TypeError: Object.defineProperty(...) is not a function</code></p><p>但输入 <code>Object.defineProperty</code> 或 <code>navigator.webdriver</code> 却能正确显示：</p><p><img src="https://i.loli.net/2021/01/29/oFqnDrfmHJdy97P.png" alt="ca8c58557ed0f2e3e01ff5a08e41866.png" loading="lazy"></p><p>显示的是正确执行的结果：</p><p><img src="https://i.loli.net/2021/01/29/e5uvDmFLrajKG12.png" alt="481ba07d324fe9114fc9cf8b3f32e77.png" loading="lazy"></p><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>最终在调试器的 Sources 面板发现了一个关键的错误：</p><p><img src="https://i.loli.net/2021/01/29/8eJEc3Ggn6lRY1P.png" alt="bb0aa487f194dce7e70286a7b184364.png" loading="lazy"></p><p><img src="https://i.loli.net/2021/01/29/1F7KvDHMQlPdiR5.png" alt="564ef5adf1dba17ae4fc8486cf31ef6.png" loading="lazy"></p><p>可以发现 <code>Object.defineProperty(navigator, &quot;webdriver&quot;, &#123;get: () =&gt; undefined&#125;)</code> 本身就已经执行了函数，但通过查阅 evaluateOnNewDocument 方法的源代码发现其功能是重新添加一个函数而不是直接执行该代码，而我们的使用是把函数结果作为函数来执行，由于返回结果不是一个函数，因此会报 <code>Uncaught TypeError: Object.defineProperty(...) is not a function</code>。</p><p><img src="https://i.loli.net/2021/01/29/Lt2JUsxhIVSaRAG.png" alt="f69d43cbfa1f033e7898c7002b6c4e6.png" loading="lazy"></p><p>解决方案是将 evaluateOnNewDocument 方法的参数换为：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">await</span> page<span class="token punctuation">.</span>evaluateOnNewDocument<span class="token punctuation">(</span><span class="token string">'function()&#123;Object.defineProperty(navigator, "webdriver", &#123;get: () => undefined&#125;)&#125;'</span><span class="token punctuation">)</span></code></pre><p>即 JavaScript 代码换为：</p><pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>navigator<span class="token punctuation">,</span> <span class="token string">"webdriver"</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">undefined</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></code></pre><p>再次运行程序，成功解决问题：</p><p><img src="https://i.loli.net/2021/01/29/kwYOq56bAUErame.png" alt="d77bb1ba27aa74b65dba76172735c0d.png" loading="lazy"></p>]]></content>
      
      
      <categories>
          
          <category> WebScraper </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> Pyppeteer </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Python 内存分配与垃圾回收</title>
      <link href="/posts/a13f9ad3/"/>
      <url>/posts/a13f9ad3/</url>
      
        <content type="html"><![CDATA[<h2 id="计算机存储器的分类"><a href="#计算机存储器的分类" class="headerlink" title="计算机存储器的分类"></a>计算机存储器的分类</h2><p>根据计算机存储器的作用，存储器可以分为主存储器、辅助存储器和缓冲存储器。</p><h2 id="内存的定义"><a href="#内存的定义" class="headerlink" title="内存的定义"></a>内存的定义</h2><p>主存储器也称主存、内存或可执行存储器，是与 CPU 直接进行信息交换的存储器，其读写速度相对较快，容量相对较小，通常用来保存进程运行时的程序和相应数据以供 CPU 使用；而辅助存储器不能与 CPU 直接进行信息交换，其读写速度相对较慢，容量相对较大。缓冲存储器常用于两个速度不同的部件之间，比如 CPU 和主存之间设置的高速缓冲存储 Cache。</p><p><img src="https://i.loli.net/2021/01/26/su5O2dUHwqPrMeT.png" alt="5d2c7de9b0c548a5bc9e1ec8dc16a17.png" loading="lazy"></p><h2 id="内存管理"><a href="#内存管理" class="headerlink" title="内存管理"></a>内存管理</h2><h3 id="操作系统的内存管理"><a href="#操作系统的内存管理" class="headerlink" title="操作系统的内存管理"></a>操作系统的内存管理</h3><p>由于内存的容量有限，很难承载系统以及用户进程所需的全部信息，所以操作系统需要对内存空间进行存储管理。在操作系统层面上内存管理的实现相当复杂，其大致功能包括内存空间的划分与动态分配、回收、扩充以及存储保护、地址转换等。</p><h3 id="进程内的内存管理"><a href="#进程内的内存管理" class="headerlink" title="进程内的内存管理"></a>进程内的内存管理</h3><p>操作系统对各个进程的内存进行管理，同时我们也需要管理我们编写的程序所对应进程内的内存，从可用内存中申请内存并且具有足够内存来进行相关操作，以及在适当的时间释放内存，这些都是程序和系统能够正常运行的前提。</p><p>在 C / C++ 中需要手动的进行内存管理，如 C 语言中通过 <code>malloc</code> 和 <code>free</code> 函数来申请给定字节数的内存以及释放对应的内存。但在 Python 中无须手动进行内存的申请和释放，Python 在内部已经完成了大量涉及到内存管理的操作，包括内存分配及垃圾回收。</p><p><img src="https://i.loli.net/2021/01/26/aJGrZ7TNMqjbYHR.png" alt="b4e0af7ddafedfddfc15deb917f2642.png" loading="lazy"></p><h2 id="内存分配"><a href="#内存分配" class="headerlink" title="内存分配"></a>内存分配</h2><h4 id="内存池机制"><a href="#内存池机制" class="headerlink" title="内存池机制"></a>内存池机制</h4><p>在 Python 中，有列表、字典等常用的数据结构。如在列表中不仅可以保存其他不同类型的对象，而且可以非常方便的使用 <code>append</code>、<code>extend</code> 等方法进行动态扩充。但常用数据结构的一系列操作会造成内存的频繁分配和释放，而且像 <code>int</code>、<code>list</code> 等 Python 对象的内存分配和释放涉及到的数据量通常相对较小，因此 Python 引入了内存池机制，实现了小块内存的管理器（PyMalloc ）用于提高处理小块内存的效率，由此来避免底层中频繁的 <code>malloc</code> 和 <code>free</code> 操作对效率带来的影响。</p><h4 id="分配策略"><a href="#分配策略" class="headerlink" title="分配策略"></a>分配策略</h4><p>在内存分配中，Python 以 512 bytes 为界限对大内存和小内存进行划分，不超过 512 bytes 的内存申请，会通过 PyMalloc 管理器进行处理，超过 512 bytes 的内存申请，则会通过 C 中的 <code>malloc</code> 来进行处理。在管理器的内部，主要包括 <code>block</code>、<code>pool</code>、<code>arena</code> 层级， 其中 <code>block</code>是 Python 内存管理中的最小单元，一个 <code>pool</code> 中包含多个 <code>block</code>，多个 <code>pool</code> 构成一个 <code>arena</code>。 同时，由于内存池机制，Python 并不会将释放的内存立即归还操作系统。</p><h4 id="缓冲池机制"><a href="#缓冲池机制" class="headerlink" title="缓冲池机制"></a>缓冲池机制</h4><p>在内存池机制的基础上，Python 为了提高常用对象的创建和释放效率，又进一步对整数、字符串等对象建立了对象缓冲池。如对于 [-5, 256] 内的小整数，Python 已经在内部创建好了对应的小整数对象的缓冲池。</p><h2 id="垃圾回收"><a href="#垃圾回收" class="headerlink" title="垃圾回收"></a>垃圾回收</h2><p>垃圾回收是一种自动回收内存的技术，会将不再被使用的内存空间进行释放。在 CPython 中，垃圾回收主要是通过<strong>引用计数、标记清除及分代回收</strong>来完成的。使用引用计数来检测并清除不可访问的对象，并结合标记清除及分代回收来收集、定期检测及清除具有引用循环的对象。</p><p>在 CPython 之外的一些其他实现中，它们的垃圾回收机制和 CPython 通常会有所不同，比如 PyPy 或 Jython。一些依赖 CPython 中引用计数的代码在这些实现下可能会出现问题，比如在 CPython 中使用 <code>open()</code> 打开相关文件后，可以不用显式的关闭它：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">for</span> line <span class="token keyword">in</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">)</span><span class="token punctuation">:</span>do_something_with_line<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>但在其他实现中如果不显式地关闭打开的文件，则有可能会出现文件描述符耗尽的情况。此处可以使用 <code>with</code> 语句声明一个上下文管理器的方法，这样代码就不依赖于任何实现，在可移植性和通用性上更佳。</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>    <span class="token keyword">for</span> line <span class="token keyword">in</span> f<span class="token punctuation">:</span>    do_something_with_line<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>虽然垃圾回收机制隐藏在 Python 内部，但它非常重要，相比于 C 程序员手动进行内存的申请和释放（可能会造成内存泄露等相关问题），Python 的垃圾回收机制在背后完成了大量工作：</p><h3 id="Python-中的引用关系：名字、对象、引用"><a href="#Python-中的引用关系：名字、对象、引用" class="headerlink" title="Python 中的引用关系：名字、对象、引用"></a>Python 中的引用关系：名字、对象、引用</h3><p>此处先理解 Python 中名字和对象之间的引用关系：</p><p>先看看在 C 语言中有关变量声明和赋值的一段代码：</p><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span></code></pre><p>第一行表示声明及初始化变量，即为变量创建和标记存储空间，并指定了初始值；第二行表示为变量重新赋值。整个过程可以使用下图来表明，可以看到的是，在给变量重新赋值后，相同地址上的值被修改为 2。变量名 <code>a</code> 可称为标识符，此处可以把变量理解为一块内存，把变量名理解为<strong>内存别名</strong>，声明过程把标识符和内存中某个特定的位置关联了起来，同时也确定了该位置存储的数据类型。</p><p><img src="https://i.loli.net/2021/01/26/m9TsbrWug3DQx2p.png" alt="224294513e01a00dd9052febd8aabd4.png" loading="lazy"></p><p>在 Python 中有如下代码：</p><pre class="language-python" data-language="python"><code class="language-python">a <span class="token operator">=</span> <span class="token number">1</span>a <span class="token operator">=</span> <span class="token number">2</span></code></pre><p>在 Python 中，此过程和 C 语言中有很大区别。在 Python 中，可以把变量名称为名字（name），把对象理解为分配的一块内存，名字和对象之间的关联关系称为引用（此种引用关系和 C 语言中的指针类似）。因此重新赋值修改的是引用关系，名字 <code>a</code> 重新关联到另外一个对象 <code>2</code> 上，而不是修改原来的对象 <code>1</code>。</p><p><img src="https://i.loli.net/2021/01/26/NPrtUsiZv7o8Mkm.png" alt="76e92c96af3bd3ef14e9f986b4e75a1.png" loading="lazy"></p><p>Python 中的名字和 C 语言中的标识符都可以理解为变量名，但在两种语言中对变量名的处理方式是不同的。C 语言中的标识符相当于内存的别称，<strong>在执行过程中会被替代</strong>；而在 Python 中，名字会参与到运行过程中，并且<strong>名字和对象的映射关系会存放在命名空间中</strong>。</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">globals</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 以字典形式返回全局命名空间</span><span class="token punctuation">&#123;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">&#125;</span></code></pre><h3 id="引用计数（Reference-Counting）"><a href="#引用计数（Reference-Counting）" class="headerlink" title="引用计数（Reference Counting）"></a>引用计数（Reference Counting）</h3><p>引用计数是一种内存管理技术，通过对对象的引用计数进行跟踪从而实现自动的内存管理，Python 的垃圾回收便是以引用计数为主的。对象的引用计数随着程序的运行进行变动，当对象的引用计数变为零时，对应的内存便会被释放。可以通过 <code>sys.getrefcount</code> 来查看某个对象的引用计数。</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> sys<span class="token operator">>></span><span class="token operator">></span> a <span class="token operator">=</span> <span class="token string">"hello world"</span><span class="token operator">>></span><span class="token operator">></span> sys<span class="token punctuation">.</span>getrefcount<span class="token punctuation">(</span>a<span class="token punctuation">)</span>  <span class="token comment"># 输出结果会比我们预期多1，因为a在sys.getrefcount()中作为参数也被引用了一次</span><span class="token number">2</span></code></pre><h4 id="引用计数的实现"><a href="#引用计数的实现" class="headerlink" title="引用计数的实现"></a>引用计数的实现</h4><p>在 Python 对象的实现中，每个对象中都持有一个统计引用次数的计数器，当该计数器变为 0 时，对应对象的内存空间就会被回收。源码 <a href="https://github.com/python/cpython/blob/master/Include/object.h"><code>object.h</code></a> 中的 <code>PyObject</code> 是 Python 对象系统中最基础的部分，它的一个成员便是引用计数变量 <code>ob_refcnt</code>。</p><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_object</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/* 省略部分代码 */</span>    Py_ssize_t ob_refcnt<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">_typeobject</span> <span class="token operator">*</span>ob_type<span class="token punctuation">;</span><span class="token punctuation">&#125;</span> PyObject<span class="token punctuation">;</span></code></pre><h4 id="引用计数的问题"><a href="#引用计数的问题" class="headerlink" title="引用计数的问题"></a>引用计数的问题</h4><p>引用计数在原理和实现上相对简单，并且延迟低、实时性强，对于内存的回收分布在程序的运行时，不会造成瞬时的卡顿。但引用计数占用了较多的空间（每个对象都持有一个引用计数变量 <code>ob_refcnt</code>），频繁地引用计数增减。</p><p>此外，引用计数还存在两个问题：</p><ul><li>引用计数无法处理循环引用；</li><li>引用计数是非线程安全的。</li></ul><h4 id="循环引用"><a href="#循环引用" class="headerlink" title="循环引用"></a>循环引用</h4><p>循环引用的例子：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">class</span> <span class="token class-name">Container</span><span class="token punctuation">:</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">def</span> <span class="token function">point</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         self<span class="token punctuation">.</span>point <span class="token operator">=</span> value<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token operator">>></span><span class="token operator">></span> container_one <span class="token operator">=</span> Container<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">>></span><span class="token operator">></span> container_two <span class="token operator">=</span> Container<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">>></span><span class="token operator">></span> container_one<span class="token punctuation">.</span>point<span class="token punctuation">(</span>container_two<span class="token punctuation">)</span><span class="token operator">>></span><span class="token operator">></span> container_two<span class="token punctuation">.</span>point<span class="token punctuation">(</span>container_one<span class="token punctuation">)</span></code></pre><p>此处使用 <code>objgraph</code> 来可视化上述创建的对象（<code>objgraph</code> 是一个用于定位内存泄露的工具）：</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 在终端中进入虚拟环境</span>workon python-core-tech<span class="token comment"># 安装第三方库</span>pip <span class="token function">install</span> objgraph<span class="token comment"># objgraph库会生成可视化图片</span><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> graphvi<span class="token operator">>></span><span class="token operator">></span> <span class="token function">import</span> objgraph<span class="token operator">>></span><span class="token operator">></span> objgraph.show_backrefs<span class="token punctuation">(</span>container_one, <span class="token assign-left variable">max_depth</span><span class="token operator">=</span><span class="token number">4</span>, <span class="token assign-left variable">filename</span><span class="token operator">=</span><span class="token string">"container.png"</span><span class="token punctuation">)</span>Graph written to /tmp/objgraph-o748tdfx.dot <span class="token punctuation">(</span><span class="token number">31</span> nodes<span class="token punctuation">)</span>Image generated as container.png</code></pre><p>此处截取生成图片的一部分，定位到代码中的关键字，如 <code>container_one</code>、<code>container_two</code>、<code>point</code>。</p><p><img src="https://i.loli.net/2021/01/26/HLXQJWMFpOy5rDq.png" alt="856c4af00a78648a4a85005594f63e8.png" loading="lazy"></p><p>把上图的关系简化一下得到下图，指向对象的箭头数量可以理解为对象的引用计数， <code>container_one</code>、<code>container_two</code> 的引用计数都为 2。如下图所示，<code>container_one</code>、<code>container_two</code> 之间便构成了循环引用。循环引用是一个对象直接或者间接引用自身，从而在引用关系上构成环状结构。另外，在 Python 中将能够持有其他对象引用的对象称为容器（ container ），只有容器对象才能造成循环引用。</p><p><img src="https://i.loli.net/2021/01/26/VEsnhOj2TqoNFxD.png" alt="cd25b2c7c2d44048dac687e42fbd027.png" loading="lazy"></p><p>清除掉命名空间内<code>container_one</code>、<code>container_two</code>的引用：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">del</span> container_one<span class="token keyword">del</span> container_two</code></pre><p>如下图，在上面的引用被解除后，预期中这两个对象的内存应该被回收，但这两个对象由于循环引用其引用计数仍然为 1，根据引用计数并不能对其内存进行释放。当这种循环引用的对象达到一定数量后，会造成比较严重的<strong>内存泄露</strong>问题。</p><p><img src="https://i.loli.net/2021/01/26/Iufm4gnbtBTC1EK.png" alt="8675dfe84c125b77ddc45c988dfbdd8.png" loading="lazy"></p><p>另一种常见的循环引用是一个序列对象包含自身的引用，如下例，Python 会自动将循环引用部分打印为 <code>[...]</code>，从而避免严重的无限循环。</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> lis <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">>></span><span class="token operator">></span> lis<span class="token punctuation">.</span>append<span class="token punctuation">(</span>l<span class="token punctuation">)</span><span class="token operator">>></span><span class="token operator">></span> lis<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">]</span></code></pre><h3 id="标记清除（Mark-and-Sweep）和分代回收（Generational）"><a href="#标记清除（Mark-and-Sweep）和分代回收（Generational）" class="headerlink" title="标记清除（Mark and Sweep）和分代回收（Generational）"></a>标记清除（Mark and Sweep）和分代回收（Generational）</h3><p>为了<strong>解决引用计数在垃圾回收中无法处理循环引用</strong>的问题，Python 引入了标记清除和分代回收来<strong>检测和打破循环引用</strong> 。标记清除是追踪回收中的一种基础算法，其涉及到两个主要过程，即标记过程和清除过程，在标记过程中将所有可达对象进行标记，在清除过程中将所有未标记的对象进行清除。分代回收则是基于标记清除基础上的一种空间换时间的实现策略。</p><h4 id="分代回收"><a href="#分代回收" class="headerlink" title="分代回收"></a>分代回收</h4><p>分代回收将 Python 对象划分成 3 代，包括 0、1、2 代。对于新创建的对象，会被放入 0 代。若一个对象在经过一次垃圾回收后没有被清除，则它会被放入下一代中。对于每一代对象来说，都具有触发垃圾回收的相关阈值（收集频率）。关于这个过程的细节，官方文档中给出了比较明确的描述：</p><blockquote><p>垃圾回收器把所有对象分类为 3 代，取决于对象幸存于多少次垃圾回收。新创建的对象会被放第 <code>0</code> 代。如果一个对象幸存于一次垃圾回收，则该对象会被放入下一代。第 <code>2</code> 代是最老的一代，因此这一代的对象幸存于垃圾回收后，仍会留在第 <code>2</code> 代。</p><p>为了判定何时需要进行垃圾回收，垃圾回收器会跟踪上一次回收后，分配和释放的对象的数目。当分配对象的数量减去释放对象的数量大于阈值 <em>threshold0</em> 时，回收器开始进行垃圾回收。起初只有第 <code>0</code> 代会被检查。当上一次第 <code>1</code> 代被检查后，第 <code>0</code> 代被检查的次数多于阈值 <em>threshold1</em> 时，第 <code>1</code> 代也会被检查。相似的， <em>threshold2</em> 设置了触发第 <code>2</code> 代被垃圾回收的第 <code>1</code> 代被垃圾回收的次数。</p></blockquote><p>分代回收的主要目的是降低回收中需要处理的对象数量，提高垃圾回收效率。可以使用 <a href="https://docs.python.org/zh-cn/3/library/gc.html#module-gc"><code>gc</code></a> 模块来执行或优化垃圾回收的相关过程，并获取更多的调试信息，比如通过 <code>gc.get_threshold()</code> 来获取当前的回收阈值；通过 <code>gc.disable()</code> 关闭垃圾回收，这通常在程序中确定不存在循环引用时使用。</p><p>CPython 在退出时不一定会释放所有内存，当 Python 解释器退出时，会进行内存清理，试图释放每个对象的内存，但不一定会释放所有内存，如全局命名空间中引用的某些对象、循环引用下 C 扩展库中分配的某些内存都有可能不被释放。</p><hr><p>Reference：<a href="http://www.imooc.com/read/79/article/2140">Python 在垃圾回收中如何解决循环引用问题？</a></p>]]></content>
      
      
      <categories>
          
          <category> Python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> Computer </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SMOTE 算法</title>
      <link href="/posts/21c8089f/"/>
      <url>/posts/21c8089f/</url>
      
        <content type="html"><![CDATA[<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>在数据采样时，我们经常会遇到正负样本不均衡的问题，其容易导致模型过拟合问题，而大多数机器学习模型对正负样本比是敏感的（例如 LogisticRegression），对于该情况，常用解决方法有随机采样、分层采样、采集更多数据、oversampling、修改损失函数权重等方法。</p><h2 id="什么是-SMOTE-算法"><a href="#什么是-SMOTE-算法" class="headerlink" title="什么是 SMOTE 算法"></a>什么是 SMOTE 算法</h2><p>在人工智能研究杂志（Journal of Artificial Intelligence Research）的文章《SMOTE: Synthetic Minority Over-sampling Technique》提出了一种过采样算法 SMOTE（Synthetic Minority Oversampling Technique），即合成少数类过采样技术。</p><h2 id="SMOTE-算法的基本思想"><a href="#SMOTE-算法的基本思想" class="headerlink" title="SMOTE 算法的基本思想"></a>SMOTE 算法的基本思想</h2><p>SMOTE 算法的基本思想为：对那些占比小的类别的样本进行分析和模拟，并将人工模拟生成的新样本添加到原始数据集中，进而改善原始数据中的类别不平衡问题，SMOTE 算法的模拟过程采用了 KNN 算法的思想。</p><p>大致步骤如下：</p><ol><li><p>对于占比小的类别中每一个样本 $x$，以欧氏距离为标准计算 $x$ 到少数类样本集 $S_{min}$ 中所有样本的距离，得到其 $k$ 近邻。</p><p><img src="https://i.loli.net/2020/10/07/tpJw9uW2hYa3Il5.png" alt="059c22c781625f554a117d9878e8fb8.png" loading="lazy"></p></li><li><p>根据样本不平衡比例设置一个采样比例以确定采样倍率 $N$，对于每一个少数类样本 $x$，从其 $k$ 近邻中随机选择若干个样本。</p></li><li><p>假设选择的近邻为 $x_n$，对于每一个随机选出的近邻 $x_n$，分别与原样本按照如下的公式构建新的样本：</p><div>    $$ x_{new} = x+rand(0,1)×|x-x_n| $$</div><p><img src="https://i.loli.net/2020/10/07/XRvQGuqNEUrkjcZ.png" alt="3265c32ef3c314607902614520f5df6.png" loading="lazy"></p></li></ol><h2 id="使用-Python-实现-SMOTE-算法："><a href="#使用-Python-实现-SMOTE-算法：" class="headerlink" title="使用 Python 实现 SMOTE 算法："></a>使用 Python 实现 SMOTE 算法：</h2><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> random<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>neighbors <span class="token keyword">import</span> NearestNeighbors<span class="token keyword">class</span> <span class="token class-name">Smote</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> samples<span class="token punctuation">,</span> N<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> k<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>n_samples<span class="token punctuation">,</span> self<span class="token punctuation">.</span>n_attrs <span class="token operator">=</span> samples<span class="token punctuation">.</span>shape        self<span class="token punctuation">.</span>N <span class="token operator">=</span> N        self<span class="token punctuation">.</span>k <span class="token operator">=</span> k        self<span class="token punctuation">.</span>samples <span class="token operator">=</span> samples        self<span class="token punctuation">.</span>new_index <span class="token operator">=</span> <span class="token number">0</span>    <span class="token keyword">def</span> <span class="token function">over_sampling</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        N_ <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>N <span class="token operator">/</span> <span class="token number">100</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>synthetic <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>n_samples <span class="token operator">*</span> N_<span class="token punctuation">,</span> self<span class="token punctuation">.</span>n_attrs<span class="token punctuation">)</span><span class="token punctuation">)</span>        neighbors <span class="token operator">=</span> NearestNeighbors<span class="token punctuation">(</span>n_neighbors<span class="token operator">=</span>self<span class="token punctuation">.</span>k<span class="token punctuation">)</span><span class="token punctuation">.</span>fit<span class="token punctuation">(</span>self<span class="token punctuation">.</span>samples<span class="token punctuation">)</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'neighbors'</span><span class="token punctuation">,</span> neighbors<span class="token punctuation">)</span>        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>samples<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'samples'</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>samples<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>            <span class="token comment"># Finds the K-neighbors of a point.</span>            nnarray <span class="token operator">=</span> neighbors<span class="token punctuation">.</span>kneighbors<span class="token punctuation">(</span>self<span class="token punctuation">.</span>samples<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                           return_distance<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'nna'</span><span class="token punctuation">,</span> nnarray<span class="token punctuation">)</span>            self<span class="token punctuation">.</span>_populate<span class="token punctuation">(</span>N_<span class="token punctuation">,</span> i<span class="token punctuation">,</span> nnarray<span class="token punctuation">)</span>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>synthetic    <span class="token comment"># for each minority class sample i ,choose N of the k nearest neighbors and generate N synthetic samples.</span>    <span class="token keyword">def</span> <span class="token function">_populate</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> N<span class="token punctuation">,</span> i<span class="token punctuation">,</span> nnarray<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>N<span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'j'</span><span class="token punctuation">,</span> j<span class="token punctuation">)</span>            nn <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>k <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># 包括end</span>            dif <span class="token operator">=</span> self<span class="token punctuation">.</span>samples<span class="token punctuation">[</span>nnarray<span class="token punctuation">[</span>nn<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">-</span> self<span class="token punctuation">.</span>samples<span class="token punctuation">[</span>i<span class="token punctuation">]</span>            gap <span class="token operator">=</span> random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span>            self<span class="token punctuation">.</span>synthetic<span class="token punctuation">[</span>self<span class="token punctuation">.</span>new_index<span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>samples<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> gap <span class="token operator">*</span> dif            self<span class="token punctuation">.</span>new_index <span class="token operator">+=</span> <span class="token number">1</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>new_index<span class="token punctuation">)</span>data <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>smote <span class="token operator">=</span> Smote<span class="token punctuation">(</span>data<span class="token punctuation">,</span> N<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">)</span>smote<span class="token punctuation">.</span>over_sampling<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>References：</p><ul><li><p>Journal of Artificial Intelligence Research 16 (2002) 321–357《SMOTE: Synthetic Minority Over-sampling Technique》</p></li><li><p><a href="https://blog.csdn.net/jiede1/article/details/70215477">https://blog.csdn.net/jiede1/article/details/70215477</a></p></li></ul>]]></content>
      
      
      <categories>
          
          <category> MachineLearning </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MachineLearning </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Python 中使用协程实现异步操作</title>
      <link href="/posts/f4de23f8/"/>
      <url>/posts/f4de23f8/</url>
      
        <content type="html"><![CDATA[<h2 id="阻塞与非阻塞"><a href="#阻塞与非阻塞" class="headerlink" title="阻塞与非阻塞"></a>阻塞与非阻塞</h2><h3 id="阻塞"><a href="#阻塞" class="headerlink" title="阻塞"></a>阻塞</h3><p>阻塞状态指程序未得到所需计算资源时被挂起的状态。程序在等待某个操作完成期间，自身无法继续处理其他事情，则称该程序在该操作上是阻塞的。</p><blockquote><p>常见的阻塞形式有：网络 I/O 阻塞、磁盘 I/O 阻塞、用户输入阻塞等。</p></blockquote><h3 id="非阻塞"><a href="#非阻塞" class="headerlink" title="非阻塞"></a>非阻塞</h3><p>程序在等待某个操作的过程中，自身不被阻塞，可以继续处理其他事情，则称该程序在该操作上是非阻塞的。</p><blockquote><p>非阻塞并不是在任何程序级别、任何情况下都可以存在的。仅当程序封装的级别可以囊括独立的子程序单元时，它才可能存在非阻塞状态。</p></blockquote><h2 id="同步与异步"><a href="#同步与异步" class="headerlink" title="同步与异步"></a>同步与异步</h2><h3 id="同步"><a href="#同步" class="headerlink" title="同步"></a>同步</h3><p>不同程序单元为了完成某个任务，在执行过程中需靠某种通信方式以协调一致，则称这些程序单元是同步执行的。</p><blockquote><p>如数据库中的数据更新，需要用“行锁”作为通信信号，让不同的更新请求强制排队顺序执行，则更新的操作是同步的，同步意味着有序。</p></blockquote><h3 id="异步"><a href="#异步" class="headerlink" title="异步"></a>异步</h3><p>为完成某个任务，过程中不同程序单元之间无需通信协调也能完成任务的方式，则称这些程序单元是异步执行的。</p><blockquote><p>如网络爬虫下载网页，调度程序在调用完下载程序后，即可调度其他任务，而无需与该下载程序保持通信以协调行为，不同网页的下载、保存等操作都是无关的，也无需相互通知协调，这些异步操作的完成时刻是不确定的，异步意味着无序。</p></blockquote><h2 id="协程"><a href="#协程" class="headerlink" title="协程"></a>协程</h2><p>协程，英文叫作 Coroutine，又称微线程、纤程，协程是一种用户态的轻量级线程。</p><p>协程拥有自己的寄存器上下文和栈。协程调度切换时，将寄存器上下文和栈保存到其他地方，在切回来的时候，恢复先前保存的寄存器上下文和栈。因此协程能保留上一次调用时的状态，即所有局部状态的一个特定组合，每次过程重入时，就相当于进入上一次调用的状态。</p><blockquote><p>协程本质上是个单进程，协程相对于多进程来说，无需线程上下文切换的开销，无需原子操作锁定及同步的开销，编程模型也非常简单。</p></blockquote><h3 id="协程用法"><a href="#协程用法" class="headerlink" title="协程用法"></a>协程用法</h3><p>我们可以使用协程来实现异步操作，比如在网络爬虫的场景下，发出一个请求之后，需要等待一定的时间才能得到响应，但其实在该等待过程中，程序可以实现其他的事情，等到响应返回之后再切换回来继续处理，这样可以充分利用 CPU 和其他资源，这就是协程的优势。</p><p>Python 中使用协程最常用的库为 <code>asyncio</code>。</p><p><strong>首先了解以下概念：</strong></p><ul><li><strong>event_loop：</strong>事件循环，相当于一个无限循环，可以把一些函数注册到该事件循环上，当满足条件发生的时候，就会调用对应的处理方法。</li><li><strong>coroutine：</strong>协程，在 Python 中常指代为协程对象类型，可以将协程对象注册到事件循环中，它会被事件循环调用。我们可以使用 async 关键字定义一个方法，此方法在调用时不会立即被执行，而是返回一个协程对象。</li><li><strong>task：</strong>任务，它是对协程对象的进一步封装，包含了任务的各个状态。</li><li><strong>future：</strong>代表将来执行或没有执行的任务的结果，实际上和 task 没有本质区别。</li></ul><p>另外还需了解 <code>async/await</code> 关键字，其专门用于定义协程。其中 <code>async</code> 定义一个协程，<code>await</code> 用来挂起阻塞方法的执行。</p><h4 id="定义协程"><a href="#定义协程" class="headerlink" title="定义协程"></a>定义协程</h4><p>首先定义一个协程，认识它和普通进程在实现上的不同之处：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> asyncio<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">execute</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>   <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Number:'</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>coroutine <span class="token operator">=</span> execute<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Coroutine:'</span><span class="token punctuation">,</span> coroutine<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'After calling execute'</span><span class="token punctuation">)</span>loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>coroutine<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'After calling loop'</span><span class="token punctuation">)</span></code></pre><p><strong>运行结果：</strong></p><pre class="language-none"><code class="language-none">Coroutine: &lt;coroutine object execute at 0x0000022B804A6C48&gt;After calling executeNumber: 1After calling loop</code></pre><p>首先引入 asyncio 库，这样才能使用 async 和 await，接着使用 async 定义一个 execute 方法，方法接收一个数字参数，执行方法之后会打印该数字，随后调用 execute 方法，然而该方法并没有执行，而是返回一个 coroutine 协程对象，接着使用 get_event_loop 方法创建一个事件循环 loop，并调用 loop 对象的 run_until_complete 方法将协程注册到事件循环 loop 中，然后启动，最后才看到 execute 方法打印输出结果。可见，async 定义的方法会变成一个无法直接执行的 coroutine 对象，必须将其注册到事件循环中才可以执行。</p><p>task 是对 coroutine 对象的进一步封装，其相比 coroutine 对象多了运行状态，比如 running、finished 等，我们可以用这些状态来获取协程对象的执行情况。</p><p>在上述例子中，当把 coroutine 对象传递给 run_until_complete 方法时，实际上将 coroutine 封装成了 task 对象，我们也可以显式地进行声明：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> asyncio<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">execute</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Number:'</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>    <span class="token keyword">return</span> xcoroutine <span class="token operator">=</span> execute<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Coroutine:'</span><span class="token punctuation">,</span> coroutine<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'After calling execute'</span><span class="token punctuation">)</span>loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>task <span class="token operator">=</span> loop<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>coroutine<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Task:'</span><span class="token punctuation">,</span> task<span class="token punctuation">)</span>loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Task:'</span><span class="token punctuation">,</span> task<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'After calling loop'</span><span class="token punctuation">)</span></code></pre><p><strong>运行结果：</strong></p><pre class="language-none"><code class="language-none">Coroutine: &lt;coroutine object execute at 0x000001F413606CC8&gt;After calling executeTask: &lt;Task pending coro&#x3D;&lt;execute() running at coroutine_learning.py:28&gt;&gt;Number: 1Task: &lt;Task finished coro&#x3D;&lt;execute() done, defined at coroutine_learning.py:28&gt; result&#x3D;1&gt;After calling loop</code></pre><p>此处定义了 loop 对象之后，接着调用其 create_task 方法将 coroutine 对象转化为 task 对象，随后打印输出，发现它是 pending 状态。然后将 task 对象添加到事件循环中执行，随后打印输出，发现它是 finished 状态，同时还可以看到输出 Number: 1，也就是 execute 方法的返回结果。</p><p>定义 task 对象还可以直接通过 asyncio 的 ensure_future 方法，返回结果也是 task 对象，这样就不必借助 loop 来定义，即使还没声明 loop 也可以提前定义 task 对象：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> asyncio<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">execute</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Number:'</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>    <span class="token keyword">return</span> xcoroutine <span class="token operator">=</span> execute<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Coroutine:'</span><span class="token punctuation">,</span> coroutine<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'After calling execute'</span><span class="token punctuation">)</span>task <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>ensure_future<span class="token punctuation">(</span>coroutine<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Task:'</span><span class="token punctuation">,</span> task<span class="token punctuation">)</span>loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Task:'</span><span class="token punctuation">,</span> task<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'After calling loop'</span><span class="token punctuation">)</span></code></pre><p><strong>运行结果：</strong></p><pre class="language-none"><code class="language-none">Coroutine: &lt;coroutine object execute at 0x0000023F48EE6CC8&gt;After calling executeTask: &lt;Task pending coro&#x3D;&lt;execute() running at coroutine_learning.py:47&gt;&gt;Number: 1Task: &lt;Task finished coro&#x3D;&lt;execute() done, defined at coroutine_learning.py:47&gt; result&#x3D;1&gt;After calling loop</code></pre><p>两者运行结果是一样的。</p><h4 id="绑定回调"><a href="#绑定回调" class="headerlink" title="绑定回调"></a>绑定回调</h4><p>另外也可以为某个 task 绑定一个回调方法：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> asyncio<span class="token keyword">import</span> requests<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    url <span class="token operator">=</span> <span class="token string">'https://www.baidu.com'</span>    status <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span>    <span class="token keyword">return</span> status<span class="token keyword">def</span> <span class="token function">callback</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Status:'</span><span class="token punctuation">,</span> task<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>coroutine <span class="token operator">=</span> request<span class="token punctuation">(</span><span class="token punctuation">)</span>task <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>ensure_future<span class="token punctuation">(</span>coroutine<span class="token punctuation">)</span>task<span class="token punctuation">.</span>add_done_callback<span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Task:'</span><span class="token punctuation">,</span> task<span class="token punctuation">)</span>loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Task:'</span><span class="token punctuation">,</span> task<span class="token punctuation">)</span></code></pre><p>此处定义了 request 方法，向百度发送请求，获取请求状态码，但此方法里没有任何 print 语句。随后定义一个 callback 方法，此方法接收一个参数，它是 task 对象，然后调用 print 方法打印 task 对象的结果，这样即定义了一个 coroutine 对象和一个回调方法，接着调用 add_done_callback 方法将 callback 方法传递给封装好的 task 对象，则当 task 执行完毕后就可以调用 callback 方法了，同时 task 对象作为参数传递给 callback 方法，再调用 task 对象的 result 方法即可获取返回结果。</p><p><strong>运行结果：</strong></p><pre class="language-none"><code class="language-none">Task: &lt;Task pending coro&#x3D;&lt;request() running at coroutine_learning.py:79&gt; cb&#x3D;[callback() at coroutine_learning.py:84]&gt;Status: &lt;Response [200]&gt;Task: &lt;Task finished coro&#x3D;&lt;request() done, defined at coroutine_learning.py:79&gt; result&#x3D;&lt;Response [200]&gt;&gt;</code></pre><p>不用回调方法，直接在 task 运行完毕之后也可以直接调用 result 方法获取结果：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> asyncio<span class="token keyword">import</span> requests<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    url <span class="token operator">=</span> <span class="token string">'https://www.baidu.com'</span>    status <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span>    <span class="token keyword">return</span> statuscoroutine <span class="token operator">=</span> request<span class="token punctuation">(</span><span class="token punctuation">)</span>task <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>ensure_future<span class="token punctuation">(</span>coroutine<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Task:'</span><span class="token punctuation">,</span> task<span class="token punctuation">)</span>loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Task:'</span><span class="token punctuation">,</span> task<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Task Result:'</span><span class="token punctuation">,</span> task<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><p><strong>运行结果：</strong></p><pre class="language-python" data-language="python"><code class="language-python">Task<span class="token punctuation">:</span> <span class="token operator">&lt;</span>Task pending coro<span class="token operator">=</span><span class="token operator">&lt;</span>request<span class="token punctuation">(</span><span class="token punctuation">)</span> running at coroutine_learning<span class="token punctuation">.</span>py<span class="token punctuation">:</span><span class="token number">103</span><span class="token operator">>></span>Task<span class="token punctuation">:</span> <span class="token operator">&lt;</span>Task finished coro<span class="token operator">=</span><span class="token operator">&lt;</span>request<span class="token punctuation">(</span><span class="token punctuation">)</span> done<span class="token punctuation">,</span> defined at coroutine_learning<span class="token punctuation">.</span>py<span class="token punctuation">:</span><span class="token number">103</span><span class="token operator">></span> result<span class="token operator">=</span><span class="token operator">&lt;</span>Response <span class="token punctuation">[</span><span class="token number">200</span><span class="token punctuation">]</span><span class="token operator">>></span>Task Result<span class="token punctuation">:</span> <span class="token operator">&lt;</span>Response <span class="token punctuation">[</span><span class="token number">200</span><span class="token punctuation">]</span><span class="token operator">></span></code></pre><p>两者运行结果是一样的。</p><h4 id="多任务协程"><a href="#多任务协程" class="headerlink" title="多任务协程"></a>多任务协程</h4><p>上述例子只执行了一次请求，如果想执行多次请求可以定义一个 task 列表，然后使用 asyncio 的 wait 方法即可执行：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> asyncio<span class="token keyword">import</span> requests<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>   url <span class="token operator">=</span> <span class="token string">'https://www.baidu.com'</span>   status <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span>   <span class="token keyword">return</span> statustasks <span class="token operator">=</span> <span class="token punctuation">[</span>asyncio<span class="token punctuation">.</span>ensure_future<span class="token punctuation">(</span>request<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Tasks:'</span><span class="token punctuation">,</span> tasks<span class="token punctuation">)</span>loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>asyncio<span class="token punctuation">.</span>wait<span class="token punctuation">(</span>tasks<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">for</span> task <span class="token keyword">in</span> tasks<span class="token punctuation">:</span>   <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Task Result:'</span><span class="token punctuation">,</span> task<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><p>此处使用列表推导式创建 5 个 task，然后把该列表传递给 asyncio 的 wait 方法，接着将其注册到时间循环中，就可以发起 5 个任务了，最后再将任务的运行结果输出：</p><pre class="language-none"><code class="language-none">Tasks: [&lt;Task pending coro&#x3D;&lt;request() running at coroutine_learning.py:124&gt;&gt;, &lt;Task pending coro&#x3D;&lt;request() running at coroutine_learning.py:124&gt;&gt;, &lt;Task pending coro&#x3D;&lt;request() running at coroutine_learning.py:124&gt;&gt;, &lt;Task pending coro&#x3D;&lt;request() running at coroutine_learning.py:124&gt;&gt;, &lt;Task pending coro&#x3D;&lt;request() running at coroutine_learning.py:124&gt;&gt;]Task Result: &lt;Response [200]&gt;Task Result: &lt;Response [200]&gt;Task Result: &lt;Response [200]&gt;Task Result: &lt;Response [200]&gt;Task Result: &lt;Response [200]&gt;</code></pre><p>可以看到 5 个任务被顺次执行了。</p><h3 id="使用协程时的常见错误"><a href="#使用协程时的常见错误" class="headerlink" title="使用协程时的常见错误"></a>使用协程时的常见错误</h3><p>网络请求为耗时等待的操作，因为请求网页之后需要等待页面响应并返回结果，耗时等待的操作一般都是 I/O 操作，如文件读取、网络请求等。协程对于处理耗时等待操作上占有优势，当遇到需要等待的情况时，程序可以暂时挂起，转而去执行其他操作，从而避免一直等待一个程序而耗费过多的时间，达到充分利用资源的目的。</p><p>下面使用<a href="https://static4.scrape.cuiqingcai.com/">示例网站</a>进行演示，该网站响应较慢，因此可以通过爬取时间来体现爬虫速度。</p><h4 id="错误-1：缺少任务的挂起操作"><a href="#错误-1：缺少任务的挂起操作" class="headerlink" title="错误 1：缺少任务的挂起操作"></a>错误 1：缺少任务的挂起操作</h4><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> asyncio<span class="token keyword">import</span> requests<span class="token keyword">import</span> timestart <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>   url <span class="token operator">=</span> <span class="token string">'https://static4.scrape.cuiqingcai.com/'</span>   <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Waiting for'</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span>   response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span>   <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Get response from'</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token string">'response'</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span>tasks <span class="token operator">=</span> <span class="token punctuation">[</span>asyncio<span class="token punctuation">.</span>ensure_future<span class="token punctuation">(</span>request<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">]</span>loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>asyncio<span class="token punctuation">.</span>wait<span class="token punctuation">(</span>tasks<span class="token punctuation">)</span><span class="token punctuation">)</span>end <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Cost time:'</span><span class="token punctuation">,</span> end <span class="token operator">-</span> start<span class="token punctuation">)</span></code></pre><p><strong>运行结果：</strong></p><pre class="language-none"><code class="language-none">Waiting for https:&#x2F;&#x2F;static4.scrape.cuiqingcai.com&#x2F;Get response from https:&#x2F;&#x2F;static4.scrape.cuiqingcai.com&#x2F; response &lt;Response [200]&gt;Waiting for https:&#x2F;&#x2F;static4.scrape.cuiqingcai.com&#x2F;Get response from https:&#x2F;&#x2F;static4.scrape.cuiqingcai.com&#x2F; response &lt;Response [200]&gt;……Waiting for https:&#x2F;&#x2F;static4.scrape.cuiqingcai.com&#x2F;Get response from https:&#x2F;&#x2F;static4.scrape.cuiqingcai.com&#x2F; response &lt;Response [200]&gt;Waiting for https:&#x2F;&#x2F;static4.scrape.cuiqingcai.com&#x2F;Get response from https:&#x2F;&#x2F;static4.scrape.cuiqingcai.com&#x2F; response &lt;Response [200]&gt;Cost time: 101.05766081809998</code></pre><p>实现异步处理得先要有挂起的操作，当一个任务需要等待 I/O 结果时，可以挂起当前任务，转而去执行其他任务，这样才能充分利用资源。</p><h4 id="错误-2：requests-返回的-Response-对象不能和-await-一起使用"><a href="#错误-2：requests-返回的-Response-对象不能和-await-一起使用" class="headerlink" title="错误 2：requests 返回的 Response 对象不能和 await 一起使用"></a>错误 2：requests 返回的 Response 对象不能和 await 一起使用</h4><p>实现异步需要了解 await 的用法，使用 await 可以将耗时等待的操作挂起，让出控制权。当协程执行的时候遇到 await，时间循环就会将本协程挂起，转而去执行别的协程，直到其他的协程挂起或执行完毕，即修改  request 方法如下：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>   url <span class="token operator">=</span> <span class="token string">'https://static4.scrape.cuiqingcai.com/'</span>   <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Waiting for'</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span>   response <span class="token operator">=</span> <span class="token keyword">await</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span>   <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Get response from'</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token string">'response'</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span></code></pre><p><strong>运行结果：</strong></p><pre class="language-python" data-language="python"><code class="language-python">Waiting <span class="token keyword">for</span> https<span class="token punctuation">:</span><span class="token operator">//</span>static4<span class="token punctuation">.</span>scrape<span class="token punctuation">.</span>cuiqingcai<span class="token punctuation">.</span>com<span class="token operator">/</span>Waiting <span class="token keyword">for</span> https<span class="token punctuation">:</span><span class="token operator">//</span>static4<span class="token punctuation">.</span>scrape<span class="token punctuation">.</span>cuiqingcai<span class="token punctuation">.</span>com<span class="token operator">/</span>……Cost time<span class="token punctuation">:</span> <span class="token number">54.90193843841553</span>Task exception was never retrievedfuture<span class="token punctuation">:</span> <span class="token operator">&lt;</span>Task finished coro<span class="token operator">=</span><span class="token operator">&lt;</span>request<span class="token punctuation">(</span><span class="token punctuation">)</span> done<span class="token punctuation">,</span> defined at coroutine_learning<span class="token punctuation">.</span>py<span class="token punctuation">:</span><span class="token number">171</span><span class="token operator">></span> exception<span class="token operator">=</span>TypeError<span class="token punctuation">(</span><span class="token string">"object Response can't be used in 'await' expression"</span><span class="token punctuation">)</span><span class="token operator">></span>Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>  File <span class="token string">"coroutine_learning.py"</span><span class="token punctuation">,</span> line <span class="token number">174</span><span class="token punctuation">,</span> <span class="token keyword">in</span> request    response <span class="token operator">=</span> <span class="token keyword">await</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span>TypeError<span class="token punctuation">:</span> <span class="token builtin">object</span> Response can<span class="token string">'t be used in '</span><span class="token keyword">await</span>' expressionTask exception was never retrievedfuture<span class="token punctuation">:</span> <span class="token operator">&lt;</span>Task finished coro<span class="token operator">=</span><span class="token operator">&lt;</span>request<span class="token punctuation">(</span><span class="token punctuation">)</span> done<span class="token punctuation">,</span> defined at coroutine_learning<span class="token punctuation">.</span>py<span class="token punctuation">:</span><span class="token number">171</span><span class="token operator">></span> exception<span class="token operator">=</span>TypeError<span class="token punctuation">(</span><span class="token string">"object Response can't be used in 'await' expression"</span><span class="token punctuation">)</span><span class="token operator">></span>Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>  File <span class="token string">"coroutine_learning.py"</span><span class="token punctuation">,</span> line <span class="token number">174</span><span class="token punctuation">,</span> <span class="token keyword">in</span> request    response <span class="token operator">=</span> <span class="token keyword">await</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span>TypeError<span class="token punctuation">:</span> <span class="token builtin">object</span> Response can<span class="token string">'t be used in '</span><span class="token keyword">await</span>' expression……</code></pre><p>使用 await 方法后的确挂起并等待了，但是最后却出现错误，其意思是 requests 返回的 Response 对象不能和 await 一起使用。</p><p><strong>根据官方文档说明，await 后面的对象必须是如下格式之一：</strong></p><ul><li>A native coroutine object returned from a native coroutine function，一个原生 coroutine 对象。</li><li>A generator-based coroutine object returned from a function decorated with types.coroutine，一个由 types.coroutine 修饰的生成器，该生成器可以返回 coroutine 对象。</li><li>An object with an <strong>await</strong> method returning an iterator，一个包含 <strong>await</strong> 方法的对象返回的一个迭代器。</li></ul><p>而 requests 返回的 Response 不符合上面任一条件，因此会出现错误。</p><p>那么既然 await 后面可以跟一个 coroutine 对象，那试试看用 async 把请求的方法改成 coroutine 对象：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> asyncio<span class="token keyword">import</span> requests<span class="token keyword">import</span> timestart <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>   <span class="token keyword">return</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>   url <span class="token operator">=</span> <span class="token string">'https://static4.scrape.cuiqingcai.com/'</span>   <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Waiting for'</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span>   response <span class="token operator">=</span> <span class="token keyword">await</span> get<span class="token punctuation">(</span>url<span class="token punctuation">)</span>   <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Get response from'</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token string">'response'</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span>tasks <span class="token operator">=</span> <span class="token punctuation">[</span>asyncio<span class="token punctuation">.</span>ensure_future<span class="token punctuation">(</span>request<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">]</span>loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>asyncio<span class="token punctuation">.</span>wait<span class="token punctuation">(</span>tasks<span class="token punctuation">)</span><span class="token punctuation">)</span>end <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Cost time:'</span><span class="token punctuation">,</span> end <span class="token operator">-</span> start<span class="token punctuation">)</span></code></pre><p>此处将请求页面的方法独立出来，并用 async 修饰即可得到一个 coroutine 对象，运行结果如下：</p><pre class="language-none"><code class="language-none">Waiting for https:&#x2F;&#x2F;static4.scrape.cuiqingcai.com&#x2F;Get response from https:&#x2F;&#x2F;static4.scrape.cuiqingcai.com&#x2F; response &lt;Response [200]&gt;Waiting for https:&#x2F;&#x2F;static4.scrape.cuiqingcai.com&#x2F;Get response from https:&#x2F;&#x2F;static4.scrape.cuiqingcai.com&#x2F; response &lt;Response [200]&gt;……Cost time: 39.119487047195435</code></pre><p>依然不是异步执行，也就是说仅仅将涉及 I/O 操作的代码封装到 async 修饰的方法里面是不可行的，我们必须<strong>使用支持异步操作的请求方式才可以实现真正的异步</strong>。</p><h3 id="使用-aiohttp-实现协程"><a href="#使用-aiohttp-实现协程" class="headerlink" title="使用 aiohttp 实现协程"></a>使用 aiohttp 实现协程</h3><p>aiohttp 是一个支持异步请求的库，利用它和 asyncio 可以非常方便地实现异步请求操作。</p><p>（安装：<code>pip install aiohttp</code>）</p><p>下面尝试使用 aiohttp 实现协程：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> asyncio<span class="token keyword">import</span> aiohttp<span class="token keyword">import</span> timestart <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>   session <span class="token operator">=</span> aiohttp<span class="token punctuation">.</span>ClientSession<span class="token punctuation">(</span><span class="token punctuation">)</span>   response <span class="token operator">=</span> <span class="token keyword">await</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span>   <span class="token keyword">await</span> response<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token keyword">await</span> session<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token keyword">return</span> response<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>   url <span class="token operator">=</span> <span class="token string">'https://static4.scrape.cuiqingcai.com/'</span>   <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Waiting for'</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span>   response <span class="token operator">=</span> <span class="token keyword">await</span> get<span class="token punctuation">(</span>url<span class="token punctuation">)</span>   <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Get response from'</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token string">'response'</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span>tasks <span class="token operator">=</span> <span class="token punctuation">[</span>asyncio<span class="token punctuation">.</span>ensure_future<span class="token punctuation">(</span>request<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">]</span>loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>asyncio<span class="token punctuation">.</span>wait<span class="token punctuation">(</span>tasks<span class="token punctuation">)</span><span class="token punctuation">)</span>end <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Cost time:'</span><span class="token punctuation">,</span> end <span class="token operator">-</span> start<span class="token punctuation">)</span></code></pre><p>此处将<strong>请求库由 requests 改成了 aiohttp，通过 aiohttp 的 ClientSession 类的 get 方法进行请求</strong>，运行结果如下：</p><pre class="language-none"><code class="language-none">Waiting for https:&#x2F;&#x2F;static4.scrape.cuiqingcai.com&#x2F;Waiting for https:&#x2F;&#x2F;static4.scrape.cuiqingcai.com&#x2F;……Get response from https:&#x2F;&#x2F;static4.scrape.cuiqingcai.com&#x2F; response &lt;ClientResponse(https:&#x2F;&#x2F;static4.scrape.cuiqingcai.com&#x2F;) [200 OK]&gt;&lt;CIMultiDictProxy(&#39;Server&#39;: &#39;nginx&#x2F;1.17.8&#39;, &#39;Date&#39;: &#39;Wed, 07 Oct 2020 02:20:39 GMT&#39;, &#39;Content-Type&#39;: &#39;text&#x2F;html; charset&#x3D;utf-8&#39;, &#39;Transfer-Encoding&#39;: &#39;chunked&#39;, &#39;Connection&#39;: &#39;keep-alive&#39;, &#39;Vary&#39;: &#39;Accept-Encoding&#39;, &#39;X-Frame-Options&#39;: &#39;DENY&#39;, &#39;X-Content-Type-Options&#39;: &#39;nosniff&#39;, &#39;Referrer-Policy&#39;: &#39;same-origin&#39;, &#39;Strict-Transport-Security&#39;: &#39;max-age&#x3D;15724800; includeSubDomains&#39;, &#39;Content-Encoding&#39;: &#39;gzip&#39;)&gt;Get response from https:&#x2F;&#x2F;static4.scrape.cuiqingcai.com&#x2F; response &lt;ClientResponse(https:&#x2F;&#x2F;static4.scrape.cuiqingcai.com&#x2F;) [200 OK]&gt;&lt;CIMultiDictProxy(&#39;Server&#39;: &#39;nginx&#x2F;1.17.8&#39;, &#39;Date&#39;: &#39;Wed, 07 Oct 2020 02:20:39 GMT&#39;, &#39;Content-Type&#39;: &#39;text&#x2F;html; charset&#x3D;utf-8&#39;, &#39;Transfer-Encoding&#39;: &#39;chunked&#39;, &#39;Connection&#39;: &#39;keep-alive&#39;, &#39;Vary&#39;: &#39;Accept-Encoding&#39;, &#39;X-Frame-Options&#39;: &#39;DENY&#39;, &#39;X-Content-Type-Options&#39;: &#39;nosniff&#39;, &#39;Referrer-Policy&#39;: &#39;same-origin&#39;, &#39;Strict-Transport-Security&#39;: &#39;max-age&#x3D;15724800; includeSubDomains&#39;, &#39;Content-Encoding&#39;: &#39;gzip&#39;)&gt;……Cost time: 5.771064758300781</code></pre><p>可以看到运行时间大幅度减少了，分析一下，此处使用了 await，后面跟了 get 方法，在执行这 10 个协程的时候，如果遇到了 await，那么就会将当前协程挂起，转而去执行其他的协程，直到其他的协程也挂起或执行完毕，再进行下一个协程的执行。</p><p>运行程序，时间循环会运行第一个 task，当执行到第一个 await 跟着的 get 方法时，该 task 被挂起，但 get 方法第一步的执行是非阻塞的，挂起之后立马被唤醒，创建了 ClientSession 对象，接着遇到了第二个 await，调用了 session.get 请求方法，然后就被挂起了，由于请求需要耗时很久，所以一直没有被唤醒，当第一个 task 被挂起，事件循环会寻找当前未被挂起的协程继续执行，于是转而执行第二个 task，重复上述流程，直到执行完最后一个 task 的 session.get 方法之后，所有 task 都已处于挂起状态，直到所有请求都有了响应，其他 task 也被唤醒并输出请求结果。</p><blockquote><p>异步操作的便捷之处在于当遇到阻塞式操作时，任务被挂起，程序接着去执行其他的任务，这样可以充分利用 CPU 时间，而不必把时间浪费在等待 I/O 上。</p></blockquote><p>下面以百度为例，来测试一下并发数量为 1、3、5、10、…、500 的情况下的耗时情况：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> asyncio<span class="token keyword">import</span> aiohttp<span class="token keyword">import</span> time<span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">:</span>    start <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>        session <span class="token operator">=</span> aiohttp<span class="token punctuation">.</span>ClientSession<span class="token punctuation">(</span><span class="token punctuation">)</span>        response <span class="token operator">=</span> <span class="token keyword">await</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span>        <span class="token keyword">await</span> response<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">await</span> session<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> response    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        url <span class="token operator">=</span> <span class="token string">'https://www.baidu.com/'</span>        <span class="token keyword">await</span> get<span class="token punctuation">(</span>url<span class="token punctuation">)</span>    tasks <span class="token operator">=</span> <span class="token punctuation">[</span>asyncio<span class="token punctuation">.</span>ensure_future<span class="token punctuation">(</span>request<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">]</span>    loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>    loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>asyncio<span class="token punctuation">.</span>wait<span class="token punctuation">(</span>tasks<span class="token punctuation">)</span><span class="token punctuation">)</span>    end <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Number:'</span><span class="token punctuation">,</span> number<span class="token punctuation">,</span> <span class="token string">'Cost time:'</span><span class="token punctuation">,</span> end <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token keyword">for</span> number <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">75</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">]</span><span class="token punctuation">:</span>    test<span class="token punctuation">(</span>number<span class="token punctuation">)</span></code></pre><p><strong>运行结果：</strong></p><pre class="language-none"><code class="language-none">Number: 1 Cost time: 0.11201262474060059Number: 3 Cost time: 0.058622121810913086Number: 5 Cost time: 0.05884289741516113Number: 10 Cost time: 0.06981253623962402Number: 15 Cost time: 0.07978653907775879Number: 30 Cost time: 0.08477306365966797Number: 50 Cost time: 0.1296529769897461Number: 75 Cost time: 0.20744585990905762Number: 100 Cost time: 0.7709352970123291Number: 200 Cost time: 0.5674834251403809Number: 500 Cost time: 1.262622356414795</code></pre><p>在服务器能承受高并发的前提下，即使增加并发数量，其爬取速度几乎不太受影响。</p><p>在使用了异步请求之后，几乎可以在相同的时间内实现多次网络请求，将其运用到网络爬虫中会带来可观的效益。</p><p>Reference：<a href="https://kaiwu.lagou.com/course/courseInfo.htm?courseId=46#/detail/pc?id=1677">https://kaiwu.lagou.com/course/courseInfo.htm?courseId=46#/detail/pc?id=1677</a></p>]]></content>
      
      
      <categories>
          
          <category> Python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> Computer </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用 opencv-python 提取视频每一帧的图片</title>
      <link href="/posts/b123dfba/"/>
      <url>/posts/b123dfba/</url>
      
        <content type="html"><![CDATA[<blockquote><p>计算机视觉是指用摄影机和计算机代替人眼对目标进行识别、跟踪和测量等机器视觉，并进一步做图像处理，用计算机处理成为更适合人眼观察或传送给仪器检测的图像，其任务有图像形成、图像处理、图像提取和图像的三维推理，而目标识别和面部识别也是很重要的研究领域。</p></blockquote><blockquote><p>OpenCV 的全称是 Open Source Computer Vision Library，是一个跨平台的计算机视觉库，其基于C/C++，支持 Linux/Windows/MacOS/Android/iOS，并提供了 Python，Matlab 和 Java 等语言的接口。</p></blockquote><h2 id="如何使用-opencv-python-提取视频每一帧的图片？"><a href="#如何使用-opencv-python-提取视频每一帧的图片？" class="headerlink" title="如何使用 opencv-python 提取视频每一帧的图片？"></a>如何使用 opencv-python 提取视频每一帧的图片？</h2><ul><li><p>编程语言：Python</p></li><li><p>所需库：cv2</p></li></ul><h3 id="获取视频（创建-VideoCapture-对象）"><a href="#获取视频（创建-VideoCapture-对象）" class="headerlink" title="获取视频（创建 VideoCapture 对象）"></a>获取视频（创建 VideoCapture 对象）</h3><p>使用 <code>cv2.VideoCapture</code> 类</p><p>Args：</p><ul><li><p>filename – 文件路径；</p></li><li><p>device – 视频设备id ，若只有一个摄像头可以填 0，表示打开默认摄像头；</p></li></ul><pre class="language-python" data-language="python"><code class="language-python">vc <span class="token operator">=</span> cv2<span class="token punctuation">.</span>VideoCapture<span class="token punctuation">(</span>filename<span class="token punctuation">)</span></code></pre><h4 id="检验-VideoCapture-对象是否创境成功"><a href="#检验-VideoCapture-对象是否创境成功" class="headerlink" title="检验 VideoCapture 对象是否创境成功"></a>检验 VideoCapture 对象是否创境成功</h4><p>使用 <code>VideoCapture</code> 对象的 <code>isOpened</code> 方法 </p><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># determine whether to open normally</span><span class="token keyword">if</span> vc<span class="token punctuation">.</span>isOpened<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    ret<span class="token punctuation">,</span> frame <span class="token operator">=</span> vc<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>    ret <span class="token operator">=</span> <span class="token boolean">False</span></code></pre><p>若成功，返回 True。</p><h3 id="按帧读取视频"><a href="#按帧读取视频" class="headerlink" title="按帧读取视频"></a>按帧读取视频</h3><p>使用 <code>VideoCapture</code> 对象的 <code>read</code> 方法 </p><p>使用 VideoCapture 对象的 read 方法按帧读取视频，ret, frame 是 read 方法的两个返回值 ，其中 ret 是布尔值，如果能正确读取帧，则返回 True；如果文件读取到结尾，它的返回值就为 False。frame 就是每一帧的图像，是一个三维矩阵。</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># loop read video frame</span><span class="token keyword">while</span> ret<span class="token punctuation">:</span>    ret<span class="token punctuation">,</span> frame <span class="token operator">=</span> vc<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><h3 id="保存图片"><a href="#保存图片" class="headerlink" title="保存图片"></a>保存图片</h3><p>使用 <code>cv2.imwrite()</code> 函数</p><p>第一个参数是文件名，第二个参数是图片资源。</p><pre class="language-python" data-language="python"><code class="language-python">cv2<span class="token punctuation">.</span>imwrite<span class="token punctuation">(</span>image_path<span class="token punctuation">,</span> image<span class="token punctuation">)</span></code></pre><h3 id="播放每一帧时适当持续时间"><a href="#播放每一帧时适当持续时间" class="headerlink" title="播放每一帧时适当持续时间"></a>播放每一帧时适当持续时间</h3><p>使用 <code>cv2.waitKey()</code> 函数</p><pre class="language-python" data-language="python"><code class="language-python">cv2<span class="token punctuation">.</span>waitKey<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></code></pre><p>参数 1 表示延时 1ms 切换到下一帧图像，对于视频而言；</p><p>参数 0 表示只显示当前帧图像，相当于视频暂停；</p><p>参数过大会因为延时过久而卡顿感觉到卡顿。</p><h3 id="关闭视频文件"><a href="#关闭视频文件" class="headerlink" title="关闭视频文件"></a>关闭视频文件</h3><p>使用 <code>VideoCapture</code> 对象的 <code>release</code> 方法</p><pre class="language-python" data-language="python"><code class="language-python">vc<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><h3 id="测试代码："><a href="#测试代码：" class="headerlink" title="测试代码："></a>测试代码：</h3><pre class="language-python" data-language="python"><code class="language-python"><span class="token triple-quoted-string string">"""-------------------------------------# -*- coding: utf-8 -*-# @Time    : 2020/10/1 15:44:12# @Author  : Giyn# @Email   : giyn.jy@gmail.com# @File    : video_processing.py# @Software: PyCharm-------------------------------------"""</span><span class="token keyword">import</span> cv2<span class="token keyword">import</span> logging<span class="token comment"># log information settings</span>logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span>level<span class="token operator">=</span>logging<span class="token punctuation">.</span>INFO<span class="token punctuation">,</span>                    <span class="token builtin">format</span><span class="token operator">=</span><span class="token string">'%(asctime)s - %(levelname)s: %(message)s'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">save_image</span><span class="token punctuation">(</span>num<span class="token punctuation">,</span> image<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""Save the images.    Args:        num: serial number        image: image resource    Returns:        None    """</span>    image_path <span class="token operator">=</span> <span class="token string">'../raw_pictures/&#123;&#125;.jpg'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">)</span>    cv2<span class="token punctuation">.</span>imwrite<span class="token punctuation">(</span>image_path<span class="token punctuation">,</span> image<span class="token punctuation">)</span>file_path <span class="token operator">=</span> <span class="token string">'../videos/video_1.mp4'</span>vc <span class="token operator">=</span> cv2<span class="token punctuation">.</span>VideoCapture<span class="token punctuation">(</span>file_path<span class="token punctuation">)</span>  <span class="token comment"># import video files</span><span class="token comment"># determine whether to open normally</span><span class="token keyword">if</span> vc<span class="token punctuation">.</span>isOpened<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    ret<span class="token punctuation">,</span> frame <span class="token operator">=</span> vc<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>    ret <span class="token operator">=</span> <span class="token boolean">False</span>count <span class="token operator">=</span> <span class="token number">0</span>  <span class="token comment"># count the number of pictures</span>frame_interval <span class="token operator">=</span> <span class="token number">30</span>  <span class="token comment"># video frame count interval frequency</span>frame_interval_count <span class="token operator">=</span> <span class="token number">0</span><span class="token comment"># loop read video frame</span><span class="token keyword">while</span> ret<span class="token punctuation">:</span>    ret<span class="token punctuation">,</span> frame <span class="token operator">=</span> vc<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment"># store operation every time f frame</span>    <span class="token keyword">if</span> frame_interval_count <span class="token operator">%</span> frame_interval <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>        save_image<span class="token punctuation">(</span>count<span class="token punctuation">,</span> frame<span class="token punctuation">)</span>        logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"num："</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", frame: "</span> <span class="token operator">+</span>                     <span class="token builtin">str</span><span class="token punctuation">(</span>frame_interval_count<span class="token punctuation">)</span><span class="token punctuation">)</span>        count <span class="token operator">+=</span> <span class="token number">1</span>    frame_interval_count <span class="token operator">+=</span> <span class="token number">1</span>    cv2<span class="token punctuation">.</span>waitKey<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>vc<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><h3 id="运行结果："><a href="#运行结果：" class="headerlink" title="运行结果："></a>运行结果：</h3><p><img src="https://i.loli.net/2020/10/01/tHPDNUyhFcv3roB.png" alt="5b3e88fd8b8933a3936717fa8dde6bb.png" loading="lazy"></p><p><img src="https://i.loli.net/2020/10/01/k4eZicdPstjM7JY.png" alt="2992cfb20d33925600d13ba03fb596a.png" loading="lazy"></p>]]></content>
      
      
      <categories>
          
          <category> opencv </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> opencv </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>requests 库高级用法</title>
      <link href="/posts/423cd474/"/>
      <url>/posts/423cd474/</url>
      
        <content type="html"><![CDATA[<h2 id="requests-库高级用法"><a href="#requests-库高级用法" class="headerlink" title="requests 库高级用法"></a>requests 库高级用法</h2><p>requests 库的基本用法有 GET、POST 请求以及 Response 对象等等，但 requests 库的功能十分强大，它能做到完成 HTTP 的所有操作。</p><h3 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h3><p>requests 库可以模拟提交一些数据，例如有的网站需要上传文件：</p><pre class="language-python" data-language="python"><code class="language-python">files <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">'file'</span><span class="token punctuation">:</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'Helper.ico'</span><span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span>response <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span><span class="token string">'http://httpbin.org/post'</span><span class="token punctuation">,</span> files<span class="token operator">=</span>files<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>text<span class="token punctuation">)</span></code></pre><p><strong>Result：</strong></p><pre class="language-none"><code class="language-none">&#123;  &quot;args&quot;: &#123;&#125;,   &quot;data&quot;: &quot;&quot;,   &quot;files&quot;: &#123;    &quot;file&quot;: &quot;data:application&#x2F;octet-stream;base64,AAABAA……&#125;,   &quot;form&quot;: &#123;&#125;,   &quot;headers&quot;: &#123;    &quot;Accept&quot;: &quot;*&#x2F;*&quot;,     &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;,     &quot;Content-Length&quot;: &quot;67792&quot;,     &quot;Content-Type&quot;: &quot;multipart&#x2F;form-data; boundary&#x3D;d3323082de17a33701180820874930a0&quot;,     &quot;Host&quot;: &quot;httpbin.org&quot;,     &quot;User-Agent&quot;: &quot;python-requests&#x2F;2.22.0&quot;,     &quot;X-Amzn-Trace-Id&quot;: &quot;Root&#x3D;1-5f7478d3-6d46fa5d3ce2b731603098bd&quot;  &#125;,   &quot;json&quot;: null,   &quot;origin&quot;: &quot;23.99.107.243&quot;,   &quot;url&quot;: &quot;http:&#x2F;&#x2F;httpbin.org&#x2F;post&quot;&#125;</code></pre><p><a href="http://httpbin.org/post">http://httpbin.org/post</a> 会返回 HTTP 响应，其中包含 files 字段，而 form 字段是空的，这说明文件上传部分会单独有一个 files 字段来标识。</p><h3 id="Cookies"><a href="#Cookies" class="headerlink" title="Cookies"></a>Cookies</h3><p>使用 requests 获取和设置 Cookies 只需一步。</p><p>获取 Cookies：</p><pre class="language-python" data-language="python"><code class="language-python">response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'http://www.baidu.com'</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>cookies<span class="token punctuation">)</span><span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token keyword">in</span> response<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>key <span class="token operator">+</span> <span class="token string">'='</span> <span class="token operator">+</span> value<span class="token punctuation">)</span></code></pre><p>Result：</p><pre class="language-none"><code class="language-none">&lt;RequestsCookieJar[&lt;Cookie BDORZ&#x3D;27315 for .baidu.com&#x2F;&gt;]&gt;BDORZ&#x3D;27315</code></pre><p>首先调用 cookies 属性即可获取 HTTP 请求的 Cookies 信息，可以发现它是 RequestCookieJar 类型，接着用 items 方法将其转化为元组组成的列表，遍历输出每一个 Cookie 的名称和值，实现 Cookie 的遍历解析。</p><p>此处可以用 Cookie 来维持登录状态，以 GitHub 为测试样例，首先登录 GitHub，接着使用 F12 查看登录的 Headers 信息，并将 Headers 中的 Cookie 内容复制下来：</p><p><img src="https://i.loli.net/2020/10/01/tHM9EuYAxXz267S.png" alt="1c8be6f25a7362075727baa795a7015.png" loading="lazy"></p><pre class="language-python" data-language="python"><code class="language-python">headers <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token string">'Cookie'</span><span class="token punctuation">:</span> <span class="token string">'_octo=GH1.1.1179373472.1580811112; _ga=GA1.2.1111800227.1581126066; _device_id=6eb9156285db6a78b8bb1372cd2ef157; experiment:homepage_signup_flow=eyJ2ZXJzaW9uIjoiMSIsInJvbGxPdXRQbGFjZW1lbnQiOjczLjQxNjA3MzcwNzI2MjA3LCJzdWJncm91cCI6bnVsbCwiY3JlYXRlZEF0IjoiMjAyMC0wNC0xN1QwNToyODowOC40OTJaIiwidXBkYXRlZEF0IjoiMjAyMC0wNC0xN1QwNTozNjoyNi40MzhaIn0=; user_session=aLl4gq2OaWXwA6gA-CBd69fuXfsPpOZRjl9hLzvlspI_cDe9; __Host-user_session_same_site=aLl4gq2OaWXwA6gA-CBd69fuXfsPpOZRjl9hLzvlspI_cDe9; logged_in=yes; dotcom_user=Giyn; tz=Asia%2FShanghai; has_recent_activity=1; _gat=1; _gh_sess=……'</span><span class="token punctuation">,</span>    <span class="token string">'User-Agent'</span><span class="token punctuation">:</span> <span class="token string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.121 Safari/537.36'</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span>r <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'https://github.com/'</span><span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>text<span class="token punctuation">)</span></code></pre><p>返回结果中包含了登录后才能显示的 GitHub 用户名信息：</p><p><img src="https://i.loli.net/2020/10/01/8kd16Urb9NF4eEA.png" alt="5839e0156e75445d78b89942780699e.png" loading="lazy"></p><p>此处也可以通过 cookies 参数设置 Cookies 信息，首先可以构造一个 RequestsCookieJar 对象，接着把刚才复制的 Cookie 处理一下并赋值：</p><pre class="language-python" data-language="python"><code class="language-python">cookies <span class="token operator">=</span> <span class="token string">'_octo=GH1.1.1179373472.1580811112; _ga=GA1.2.1111800227.1581126066; _device_id=6eb9156285db6a78b8bb1372cd2ef157; experiment:homepage_signup_flow=eyJ2ZXJzaW9uIjoiMSIsInJvbGxPdXRQbGFjZW1lbnQiOjczLjQxNjA3MzcwNzI2MjA3LCJzdWJncm91cCI6bnVsbCwiY3JlYXRlZEF0IjoiMjAyMC0wNC0xN1QwNToyODowOC40OTJaIiwidXBkYXRlZEF0IjoiMjAyMC0wNC0xN1QwNTozNjoyNi40MzhaIn0=; user_session=aLl4gq2OaWXwA6gA-CBd69fuXfsPpOZRjl9hLzvlspI_cDe9; __Host-user_session_same_site=aLl4gq2OaWXwA6gA-CBd69fuXfsPpOZRjl9hLzvlspI_cDe9; logged_in=yes; dotcom_user=Giyn; tz=Asia%2FShanghai; has_recent_activity=1; _gat=1; _gh_sess=……'</span>jar <span class="token operator">=</span> requests<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span>RequestsCookieJar<span class="token punctuation">(</span><span class="token punctuation">)</span>headers <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token string">'User-Agent'</span><span class="token punctuation">:</span> <span class="token string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.121 Safari/537.36'</span><span class="token punctuation">&#125;</span><span class="token keyword">for</span> cookie <span class="token keyword">in</span> cookies<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">';'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    key<span class="token punctuation">,</span> value <span class="token operator">=</span> cookie<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'='</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>    jar<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>r <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'https://github.com/'</span><span class="token punctuation">,</span> cookies<span class="token operator">=</span>jar<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>text<span class="token punctuation">)</span></code></pre><p>此处首先新建一个 RequestCookieJar 对象，然后将复制下来的 cookies 利用 split 方法分割，接着利用 set 方法设置好每个 Cookie 的 key 和 value，最后通过调用 requests 的 get 方法并传递给 cookies 参数即可。</p><p>运行代码，返回结果中同样包含了登录后才能显示的 GitHub 用户名信息：</p><p><img src="https://i.loli.net/2020/10/02/HxDkENPaO5WbCqs.png" alt="01c824ee07f20b10e4d3096a21cef45.png" loading="lazy"></p><h3 id="Session-维持"><a href="#Session-维持" class="headerlink" title="Session 维持"></a>Session 维持</h3><p>在 requests 库中，如果直接使用 get 或 post 等方法虽然可以做到模拟 HTTP 请求，但这实际上相当于不同的 Session，即相当于用两个浏览器打开了不同的页面。</p><p>例如，第一个请求利用 post 方法登录了某个网站，第二次想获取成功登录后的个人信息，又用了一次 get 方法去请求个人信息页面，这相当于打开了两个浏览器，是两个完全不相关的 Session，因此是无法获取个人信息的。</p><blockquote><p>不同浏览器之间的 Session 是不能共享的，Session 是与用户相关的，一个人在同一台机上打开两个浏览器，即使地址一样也是两个 Session。</p></blockquote><blockquote><p>在两次请求时设置一样的 Cookies 可以解决问题，但这样很烦琐，下面有更简单的解决方法。</p></blockquote><p>解决上述问题的主要方法就是维持同一个 Session，相当于打开一个新的浏览器选项卡而不是新开一个浏览器页面，实现该需求就要用到 Session 对象。</p><p>利用 Session 对象可以方便地维护一个 Session，而且不用担心 Cookies 的问题，Session 对象会自动处理好：</p><ul><li><strong>无 Session 对象：</strong></li></ul><pre class="language-python" data-language="python"><code class="language-python">requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'http://httpbin.org/cookies/set/number/Giyn'</span><span class="token punctuation">)</span>r <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'http://httpbin.org/cookies'</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>text<span class="token punctuation">)</span></code></pre><p>测试网址为 <a href="http://httpbin.org/cookies/set/name/Giyn">http://httpbin.org/cookies/set/name/Giyn</a>，对该网址发送请求时，可以设置一个 cookie，名称叫作 name，内容是 Giyn，接着又请求了 <a href="http://httpbin.org/cookies">http://httpbin.org/cookies</a>，此网址可以获取当前的 Cookies。</p><p>运行结果：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token punctuation">&#123;</span>  <span class="token string">"cookies"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><p>由于两次请求的 Cookie 不同，因此无法获取所需信息。</p><ul><li><strong>有 Session 对象：</strong></li></ul><pre class="language-python" data-language="python"><code class="language-python">s <span class="token operator">=</span> requests<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span>s<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'http://httpbin.org/cookies/set/name/Giyn'</span><span class="token punctuation">)</span>r <span class="token operator">=</span> s<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'http://httpbin.org/cookies'</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>text<span class="token punctuation">)</span></code></pre><p>运行结果：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token punctuation">&#123;</span>  <span class="token string">"cookies"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>    <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Giyn"</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><p>使用了 Session 对象即可成功获取信息。总的来说，利用 Session 对象可以做到模拟同一个 Session 而不用担心 Cookies 的问题，它通常用于模拟登录成功之后再进行下一步的操作。</p><h3 id="SSL-证书验证"><a href="#SSL-证书验证" class="headerlink" title="SSL 证书验证"></a>SSL 证书验证</h3><p>如今许多网站都要求使用 HTTPS 协议，但是有些网站没有设置好 HTTPS 证书，或者网站的 HTTPS 证书不被 CA 机构认可，此时这些网站可能就会出现 SSL 证书错误的提示。</p><p>如果用 Chrome 浏览器打开这个<a href="https://static2.scrape.cuiqingcai.com/">示例网站</a>，则会提示「您的连接不是私密连接」这样的错误：</p><p><img src="https://i.loli.net/2020/10/02/VPOoMxQfdcyYraW.png" alt="2c65ea9858397f2974ea76f9eca10f5.png" loading="lazy"></p><blockquote><p>可以在浏览器中通过设置来忽略证书的验证。</p></blockquote><p>使用 requests 库对这类网站发出请求：</p><pre class="language-python" data-language="python"><code class="language-python">r <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'https://static2.scrape.cuiqingcai.com/'</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>status_code<span class="token punctuation">)</span></code></pre><p>运行结果：</p><pre class="language-python" data-language="python"><code class="language-python">SSLError<span class="token punctuation">:</span> HTTPSConnectionPool<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'static2.scrape.cuiqingcai.com'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">443</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Max retries exceeded <span class="token keyword">with</span> url<span class="token punctuation">:</span> <span class="token operator">/</span> <span class="token punctuation">(</span>Caused by SSLError<span class="token punctuation">(</span>SSLError<span class="token punctuation">(</span><span class="token string">"bad handshake: Error([('SSL routines', 'tls_process_server_certificate', 'certificate verify failed')])"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><p>可以看到抛出了 SSLError 错误，因为请求的 URL 的证书是无效的，若实在需要爬取这个网站，可以使用 verify 参数控制是否验证证书。如果将 verify 参数设置为 False，在请求时就不会再验证证书是否有效；如果不加 verify 参数，默认值是 True，会自动验证。</p><p><strong>设置 verify 参数不验证 SSL 证书：</strong></p><pre class="language-python" data-language="python"><code class="language-python">r <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'https://static2.scrape.cuiqingcai.com/'</span><span class="token punctuation">,</span> verify<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>status_code<span class="token punctuation">)</span></code></pre><p>运行结果：</p><pre class="language-python" data-language="python"><code class="language-python">\Anaconda\lib\site<span class="token operator">-</span>packages\urllib3\connectionpool<span class="token punctuation">.</span>py<span class="token punctuation">:</span><span class="token number">1004</span><span class="token punctuation">:</span> InsecureRequestWarning<span class="token punctuation">:</span> Unverified HTTPS request <span class="token keyword">is</span> being made to host <span class="token string">'static2.scrape.cuiqingcai.com'</span><span class="token punctuation">.</span> Adding certificate verification <span class="token keyword">is</span> strongly advised<span class="token punctuation">.</span> See<span class="token punctuation">:</span> https<span class="token punctuation">:</span><span class="token operator">//</span>urllib3<span class="token punctuation">.</span>readthedocs<span class="token punctuation">.</span>io<span class="token operator">/</span>en<span class="token operator">/</span>latest<span class="token operator">/</span>advanced<span class="token operator">-</span>usage<span class="token punctuation">.</span>html<span class="token comment">#ssl-warnings</span>  InsecureRequestWarning<span class="token punctuation">,</span><span class="token number">200</span></code></pre><p>程序发出一个 Warning，它建议我们给它指定证书，此处可以通过设置忽略警告的方式来屏蔽该警告：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> requests<span class="token punctuation">.</span>packages <span class="token keyword">import</span> urllib3urllib3<span class="token punctuation">.</span>disable_warnings<span class="token punctuation">(</span><span class="token punctuation">)</span>r <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'https://static2.scrape.cuiqingcai.com/'</span><span class="token punctuation">,</span> verify<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>status_code<span class="token punctuation">)</span></code></pre><p>或者通过捕获警告到日志的方式忽略警告：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> logginglogging<span class="token punctuation">.</span>captureWarnings<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span>r <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'https://static2.scrape.cuiqingcai.com/'</span><span class="token punctuation">,</span> verify<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>status_code<span class="token punctuation">)</span></code></pre><p>此外也可以指定一个本地证书用作客户端证书，其可以是单个文件（包含密钥和证书）或一个包含两个文件路径的元组：</p><pre class="language-python" data-language="python"><code class="language-python">r <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'https://static2.scrape.cuiqingcai.com/'</span><span class="token punctuation">,</span> cert<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">'/path/server.crt'</span><span class="token punctuation">,</span> <span class="token string">'/path/server.key'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>status_code<span class="token punctuation">)</span></code></pre><h3 id="超时设置"><a href="#超时设置" class="headerlink" title="超时设置"></a>超时设置</h3><p>在本机网络状况不好或者服务器网络响应延迟甚至无响应时，我们可能需要等待很久才能收到响应，甚至到最后收不到响应而报错。为了防止服务器不能及时响应，应该设置一个超时时间，即超过了这个时间还没有得到响应就报错。此处需要用到 timeout 参数，其时间的计算是从发出请求到服务器返回响应的时间：</p><pre class="language-python" data-language="python"><code class="language-python">r <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'https://httpbin.org/get'</span><span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>status_code<span class="token punctuation">)</span></code></pre><p>通过 timeout 参数，我们可以将超时时间设置为 1 秒，如果 1 秒内没有响应就抛出异常。</p><p>实际上，请求分为两个阶段，即连接（connect）和读取（read），如上设置的 timeout 参数将用作 connect 和 read 二者的 timeout 总和，如果要分别指定，就可以传入一个元组：</p><pre class="language-python" data-language="python"><code class="language-python">r <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'https://httpbin.org/get'</span><span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><p>如果希望永久等待，可以直接将 timeout 设置为 None，或者直接留空（默认是 None）：</p><pre class="language-python" data-language="python"><code class="language-python">r <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'https://httpbin.org/get'</span><span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token comment"># r = requests.get('https://httpbin.org/get')</span></code></pre><h3 id="身份认证"><a href="#身份认证" class="headerlink" title="身份认证"></a>身份认证</h3><p>在访问某些设置了身份认证的网站时，例如：<a href="https://static3.scrape.cuiqingcai.com/">https://static3.scrape.cuiqingcai.com/</a>，可能会遇到这样的认证窗口：</p><p><img src="https://i.loli.net/2020/10/02/DYNQWw4zsun2glc.png" alt="90eb3bf4f8e066510c16b7ad2a6eaf8.png" loading="lazy"></p><p>如果遇到了这种情况，是因为该网站启用了基本身份认证，英文叫作 HTTP Basic Access Authentication，它是一种<strong>用来允许网页浏览器或其他客户端程序在请求时提供用户名和口令形式的身份凭证</strong>的一种登录验证方式。</p><p>如果遇到了上述情况，可以使用 requests 自带的身份认证功能，通过 auth 参数即可设置：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> requests<span class="token punctuation">.</span>auth <span class="token keyword">import</span> HTTPBasicAuth  r <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'https://static3.scrape.cuiqingcai.com/'</span><span class="token punctuation">,</span> auth<span class="token operator">=</span>HTTPBasicAuth<span class="token punctuation">(</span><span class="token string">'admin'</span><span class="token punctuation">,</span> <span class="token string">'admin'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>status_code<span class="token punctuation">)</span></code></pre><p>运行结果：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token number">200</span></code></pre><p>上述示例网站的用户名和密码都是 admin，此处可以直接设置。如果用户名和密码都正确的话，请求时会自动认证成功，返回 200 状态码；如果认证失败，则返回 401 状态码。</p><p>如果每次发出请求，参数都传一个 HTTPBasicAuth 类，则显得有点烦琐，requests 库提供了直接传一个元组的方法，它会默认使用 HTTPBasicAuth 这个类来认证：</p><pre class="language-python" data-language="python"><code class="language-python">r <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'https://static3.scrape.cuiqingcai.com/'</span><span class="token punctuation">,</span> auth<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">'admin'</span><span class="token punctuation">,</span> <span class="token string">'admin'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>status_code<span class="token punctuation">)</span></code></pre><p>运行结果：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token number">200</span></code></pre><p>此外，requests 库还提供了其他认证方式，如 OAuth 认证（需要安装 oauth 包：<code>pip install requests_oauthlib</code>）：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> requests_oauthlib <span class="token keyword">import</span> OAuth1url <span class="token operator">=</span> <span class="token string">'https://api.twitter.com/1.1/account/verify_credentials.json'</span>auth <span class="token operator">=</span> OAuth1<span class="token punctuation">(</span><span class="token string">'APP_KEY'</span><span class="token punctuation">,</span> <span class="token string">'APP_SECRET'</span><span class="token punctuation">,</span>              <span class="token string">'USER_OAUTH_TOKEN'</span><span class="token punctuation">,</span> <span class="token string">'USER_OAUTH_TOKEN_SECRET'</span><span class="token punctuation">)</span>requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">,</span> auth<span class="token operator">=</span>auth<span class="token punctuation">)</span></code></pre><p><a href="https://requests-oauthlib.readthedocs.org/">requests_oauthlib 官方文档</a></p><h3 id="代理设置"><a href="#代理设置" class="headerlink" title="代理设置"></a>代理设置</h3><p>某些网站在经过频繁的请求之后，可能会弹出验证码，或者跳转到登录认证页面，甚至可能会直接封禁客户端的 IP，导致用户在一定时间段内无法访问。为了防止这种情况发生，需要设置代理来解决这个问题，此处需要用到 proxies 参数：</p><pre class="language-python" data-language="python"><code class="language-python">proxies <span class="token operator">=</span> <span class="token punctuation">&#123;</span>        <span class="token string">'http'</span><span class="token punctuation">:</span> <span class="token string">'http://'</span> <span class="token operator">+</span> <span class="token string">'113.194.28.190:9999'</span><span class="token punctuation">,</span>        <span class="token string">'https'</span><span class="token punctuation">:</span> <span class="token string">'https://'</span> <span class="token operator">+</span> <span class="token string">'113.194.28.190:9999'</span>   <span class="token punctuation">&#125;</span>r <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'http://httpbin.org/get'</span><span class="token punctuation">,</span> proxies<span class="token operator">=</span>proxies<span class="token punctuation">)</span></code></pre><p>如果代理需要使用上述的身份认证，可以使用类似 <code>http://user:password@host:port</code> 这样的语法来设置代理，即在代理的前面加上用户名和密码：</p><pre class="language-python" data-language="python"><code class="language-python">proxy <span class="token operator">=</span> <span class="token string">'username:password@113.194.28.190:9999'</span></code></pre><p>除了基本的 HTTP 代理外，requests 库还支持 SOCKS 协议的代理，（需要安装 socks 库：<code>pip3 install &quot;requests[socks]&quot;</code>）：</p><pre class="language-python" data-language="python"><code class="language-python">proxies <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token string">'http'</span><span class="token punctuation">:</span> <span class="token string">'socks5://user:password@host:port'</span><span class="token punctuation">,</span>    <span class="token string">'https'</span><span class="token punctuation">:</span> <span class="token string">'socks5://user:password@host:port'</span><span class="token punctuation">&#125;</span>requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'https://httpbin.org/get'</span><span class="token punctuation">,</span> proxies<span class="token operator">=</span>proxies<span class="token punctuation">)</span></code></pre><h3 id="Prepared-Request"><a href="#Prepared-Request" class="headerlink" title="Prepared Request"></a>Prepared Request</h3><p>实际上，requests 发送请求时在内部构造了一个 Request 对象，并给这个对象赋予了各种参数，包括 url、headers、data 等，接着直接把这个 Request 对象发送出去，请求成功后返回一个 Response 对象，再对其解析即可。</p><p>Request 对象实际上就是 Prepared Request。</p><p>下面深入一下，试着不用 get 方法，而是直接构造一个 Prepared Request 对象：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> requests <span class="token keyword">import</span> Request<span class="token punctuation">,</span> Sessionurl <span class="token operator">=</span> <span class="token string">'http://httpbin.org/post'</span>data <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token string">'Giyn'</span><span class="token punctuation">&#125;</span>headers <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">'User-Agent'</span><span class="token punctuation">:</span> <span class="token string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.121 Safari/537.36'</span><span class="token punctuation">&#125;</span>s <span class="token operator">=</span> Session<span class="token punctuation">(</span><span class="token punctuation">)</span>req <span class="token operator">=</span> Request<span class="token punctuation">(</span><span class="token string">'POST'</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">)</span>prepped <span class="token operator">=</span> s<span class="token punctuation">.</span>prepare_request<span class="token punctuation">(</span>req<span class="token punctuation">)</span>r <span class="token operator">=</span> s<span class="token punctuation">.</span>send<span class="token punctuation">(</span>prepped<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>text<span class="token punctuation">)</span></code></pre><p>此处引入了 Request 类，然后用 url、data 和 headers 参数构造了一个 Request 对象，此时需要再调用 Session 的 prepare_request 方法将其转换为一个 Prepared Request 对象，接着调用 send 方法发送。</p><p>运行结果：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token punctuation">&#123;</span>  <span class="token string">"args"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>   <span class="token string">"data"</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span>   <span class="token string">"files"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>   <span class="token string">"form"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>    <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Giyn"</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>   <span class="token string">"headers"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>    <span class="token string">"Accept"</span><span class="token punctuation">:</span> <span class="token string">"*/*"</span><span class="token punctuation">,</span>     <span class="token string">"Accept-Encoding"</span><span class="token punctuation">:</span> <span class="token string">"gzip, deflate"</span><span class="token punctuation">,</span>     <span class="token string">"Content-Length"</span><span class="token punctuation">:</span> <span class="token string">"9"</span><span class="token punctuation">,</span>     <span class="token string">"Content-Type"</span><span class="token punctuation">:</span> <span class="token string">"application/x-www-form-urlencoded"</span><span class="token punctuation">,</span>     <span class="token string">"Host"</span><span class="token punctuation">:</span> <span class="token string">"httpbin.org"</span><span class="token punctuation">,</span>     <span class="token string">"User-Agent"</span><span class="token punctuation">:</span> <span class="token string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.121 Safari/537.36"</span><span class="token punctuation">,</span>     <span class="token string">"X-Amzn-Trace-Id"</span><span class="token punctuation">:</span> <span class="token string">"Root=1-5f76d019-4ef039c66f7f2ff26bac88c3"</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>   <span class="token string">"json"</span><span class="token punctuation">:</span> null<span class="token punctuation">,</span>   <span class="token string">"origin"</span><span class="token punctuation">:</span> <span class="token string">"211.97.3.238"</span><span class="token punctuation">,</span>   <span class="token string">"url"</span><span class="token punctuation">:</span> <span class="token string">"http://httpbin.org/post"</span><span class="token punctuation">&#125;</span></code></pre><p>其同样达到了 POST 方法的请求效果。</p><p>使用 Request 对象即可将请求当作独立的对象来看待，在特定的需求中可以直接操作 Request 对象，以便更加灵活地实现请求的调度以及其他操作。</p><p><a href="http://docs.python-requests.org/">requests 库官方文档</a></p>]]></content>
      
      
      <categories>
          
          <category> requests </category>
          
      </categories>
      
      
        <tags>
            
            <tag> requests </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Multiple Dimensional Scaling 降维算法</title>
      <link href="/posts/3a002fbb/"/>
      <url>/posts/3a002fbb/</url>
      
        <content type="html"><![CDATA[<p>在高维情形下出现的数据样本稀疏、距离计算困难等问题，是所有机器学习方法共同面临的严重障碍，被称为“维数灾难” (curse ofdimensionality)。</p><p>缓解维数灾难的一个重要途径是降维 (dimension reduction)，亦称“维数约简”，即通过某种数学变换将原始高维属性空间转变为一个低维“子空间”(subspace)，在这个子空间中样本密度大幅提高，距离计算也变得更为容易。为什么能进行降维？这是因为在很多时候，人们观测或收集到的数据样本虽是高维的，但与学习任务密切相关的也许仅是某个低维分布，即高维空间中的一个低维“ 嵌入” (embedding)。下图给出了一个直观的例子。原始高维空间中的样本点，在这个低维嵌入子空间中更容易进行学习。</p><p><img src="https://img-blog.csdnimg.cn/20200819162849161.png?1x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTk2MTc3NA==,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述" loading="lazy"></p><p>若要求原始空间中样本之间的距离在低维空间中得以保持，如上图所示，即得到“多维缩放” (Multiple Dimensional Scaling，简称 $MDS$ ) 这样一种经典的降维方法。下面做一个简单的介绍。</p><p>假定 $m$ 个样本在原始空间的距离矩阵为 $D∈\mathbb{R}^{m×m}$，其第 $i$ 行 $j$ 列的元素 $dist_{ij}$ 为样本 $x_i$ 到 $x_j$ 的距离。我们的目标是获得样本在 $d’$ 维空间的表示 $Z∈\mathbb{R}^{d’×m},d’≤d$，且任意两个样本在 $d’$ 维空间中的欧氏距离等于原始空间中的距离，即 $||z_i-z_j||=dist_{ij}$。</p><p>令 $B=Z^TZ∈\mathbb{R}^{m×m}$，其中 $B$ 为降维后样本的内积矩阵，$b_{ij}=z_i^Tz_j$，有</p><div>    $$\begin{aligned}\operatorname{dist}_{i j}^{2} &=\left\|z_{i}\right\|^{2}+\left\|z_{j}\right\|^{2}-2 z_{i}^{T} z_{j} \\&=b_{i i}+b_{j j}-2 b_{i j}\end{aligned}$$</div><blockquote><p>$0∈\mathbb{R}^{d’}$ 为全零向量。</p></blockquote><p>为便于讨论，令降维后的样本 $Z$ 被中心化，即 $\sum^m_{i=1}z_i=0$。显然，矩阵 $B$ 的行与列之和均为零，即 $\sum^m_{i=1}b_{ij}=\sum^m_{j=1}b_{ij}0$。易知</p><div>    $$\sum^m_{i=1}dist^2_{ij}=tr(B)+mb_{jj}\,\,,\tag{4}$$    $$\sum^m_{j=1}dist^2_{ij}=tr(B)+mb_{ii}\,\,,\tag{5}$$    $$\sum^m_{i=1}\sum^m_{j=1}dist^2_{ij}=2m\,tr(B)\,\,,\tag{6}$$</div><p>其中 $tr(·)$ 表示矩阵的迹 (trace)，$tr(B)=\sum^m_{i=1}||z_i||^2$。令</p><div>    $$dist_{i.}^2=\frac{1}{m}\sum^m_{j=1}dist_{ij}^2\,\,,\tag{7}$$    $$dist_{.j}^2=\frac{1}{m}\sum^m_{j=1}dist_{ij}^2\,\,,\tag{8}$$    $$dist_{..}^2=\frac{1}{m^2}\sum^m_{i=1}\sum^m_{j=1}dist_{ij}^2\,\,,\tag{9}$$</div><p>由式 (3) 和式 (4)~(9) 可得</p><div>    $$b_{ij}=-\frac{1}{2}(dist_{ij}^2-dist^2_{i.}-dist^2_{.j}+dist^2_{..})\,\,,\tag{10}$$</div><p>由此即可通过降维前后保持不变的距离矩阵 $D$ 求取内积矩阵 $B$。</p><p>对矩阵 $B$ 做特征值分解 (eigenvalue decomposition)，$B=Ⅴ\Lambda Ⅴ^T$，其中 $\Lambda= diag(λ_ 1,λ_ 2,…,\lambda_d)$ 为特征值构成的对角矩阵，$λ_ 1≥\lambda_2≥…≥\lambda_d$，$V$ 为特征向量矩阵。假定其中有 $d^*$ 个非零特征值，它们构成对角矩阵 $\Lambda_ * =diag(\lambda_1,\lambda_2,…,\lambda_{d^*})$。令 $Ⅴ _ *$ 表示相应的特征向量矩阵，则 $Z$ 可表达为</p><div>    $$Z=\Lambda_*^{1/2}Ⅴ^T_*∈\mathbb{R}^{d^*×m}\,\,.\tag{11}$$</div><p>在现实应用中为了有效降维，往往仅需降维后的距离与原始空间中的距离尽可能接近，而不必严格相等。此时可取 $d’\ll d$ 个最大特征值构成对角矩阵 $\tilde{\Lambda}=diag(\lambda_1,\lambda_2,…,\lambda_{d’})$，令 $\tilde{Ⅴ}$ 表示相应的特征向量矩阵，则 $Z$ 可表达为</p><div>    $$Z=\tilde{\Lambda}^{1/2}\tilde{Ⅴ}^T∈\mathbb{R}^{d'×m}\,\,.\tag{12}$$</div><p>下图给出了 $MDS$ 算法的描述：</p><p><img src="https://img-blog.csdnimg.cn/20200819162909635.png?1x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTk2MTc3NA==,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述" loading="lazy"></p><p>一般来说，欲获得低维子空间，最简单的是对原始高维空间进行线性变换。给定 $d$ 维空间中的样本 $X=(x_1,x_2,…,x_m)∈\mathbb{R}^{d×m}$，变换之后得到 $d’≤d$ 维空间中的样本</p><div>    $$Z=W^TX\,\,,\tag{13}$$</div><blockquote><p>通常令 $d’\ll d$。</p></blockquote><p>其中 $W∈\mathbb{R}^{d×d’}$ 变换矩阵，$Z∈R^{d’×m}$ 是样本在新空间中的表达。</p><p>变换矩阵 $W$ 可视为 $d’$ 个 $d$ 维基向量，$z_i=W^Tx_i$ 是第 $i$ 个样本与这 $d’$ 个基向量分别做内积而得到的 $d’$ 维属性向量。换言之，$z_i$ 是原属性向量 $x_i$ 在新坐标系 ${w_1,w_2,…,w_{d’}}$ 中的坐标向量。若 $w_i$ 与 $w_j(i≠j)$ 正交，则新坐标系是一个正交坐标系，此时 $W$ 为正交变换。显然，新空间中的属性是原空间中属性的线性组合。</p><p>基于线性变换来进行降维的方法称为线性降维方法，它们都符合式 (13) 的基本形式，不同之处是对低维子空间的性质有不同的要求，相当于对 $W$ 施加了不同的约束。在下一节我们将会看到，若要求低维子空间对样本具有最大可分性,则将得到一种极为常用的线性降维方法。</p><p>对降维效果的评估，通常是比较降维前后学习器的性能，若性能有所提高则认为降维起到了作用。若将维数降至二维或三维，则可通过可视化技术来直观地判断降维效果。</p><hr><p>Reference：《机器学习》</p>]]></content>
      
      
      <categories>
          
          <category> MachineLearning </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MachineLearning </tag>
            
            <tag> Dimensionality Reduction </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Bagging 和随机森林算法</title>
      <link href="/posts/3f56ccc4/"/>
      <url>/posts/3f56ccc4/</url>
      
        <content type="html"><![CDATA[<h2 id="Bagging-与随机森林"><a href="#Bagging-与随机森林" class="headerlink" title="$Bagging$ 与随机森林"></a>$Bagging$ 与随机森林</h2><p>由个体与集成的知识可知，欲得到泛化性能强的集成，集成中的个体学习器应尽可能相互独立；虽然“独立”在现实任务中无法做到，但可以设法使基学习器尽可能具有较大的差异。给定一个训练数据集，一种可能的做法是对训练样本进行采样，产生出若干个不同的子集，再从每个数据子集中训练出一个基学习器。这样，由于训练数据不同，我们获得的基学习器可望具有比较大的差异。然而，为获得好的集成，我们同时还希望个体学习器不能太差。如果采样出的每个子集都完全不同，则每个基学习器只用到了一小部分训练数据，甚至不足以进行有效学习，这显然无法确保产生出比较好的基学习器。为解决这个问题，我们可考虑使用相互有交叠的采样子集。</p><hr><h3 id="Bagging"><a href="#Bagging" class="headerlink" title="$Bagging$"></a>$Bagging$</h3><blockquote><p>$Bagging$ 这个名字是由 $Bootstrap,AGGregatING$ 缩写而来。</p></blockquote><p>$Bagging$ 是并行式集成学习方法最著名的代表。从名字即可看出，它直接基于自助采样法(bootstrap sampling)。给定包含 $m$ 个样本的数据集，我们先随机取出一个样本放入采样集中，再把该样本放回初始数据集，使得下次采样时该样本仍有可能被选中，这样，经过 $m$ 次随机采样操作，我们得到含 $m$ 个样本的采样集，初始训练集中有的样本在采样集里多次出现，有的则从未出现。它的特点是各个弱学习器之间没有依赖关系，可以并行拟合，而且是随机采样。</p><blockquote><p>随机采样就是从训练集里采集固定个数的样本，但是每采集一个样本后，都将样本放回。</p></blockquote><p>照这样，我们可采样出 $T$ 个含 $m$ 个训练样本的采样集，然后基于每个采样集训练出一个基学习器，再将这些基学习器进行结合。这就是 $Bagging$ 的基本流程。<strong>在对预测输出进行结合时，$Bagging$ 通常对分类任务使用简单投票法，对回归任务使用简单平均法。</strong>若分类预测时出现两个类收到同样票数的情形，则最简单的做法是随机选择一个，也可进一步考察学习器投票的置信度来确定最终胜者。$Bagging$ 的算法描述如下图所示。</p><blockquote><p>即每个基学习器使用相同权重的投票、平均。</p></blockquote><img src="https://img-blog.csdnimg.cn/2020080310055683.png" width="60%" loading="lazy"><blockquote><p>$D_{bs}$ 是自助采样产生的样本分布。</p></blockquote><hr><h4 id="Bagging-的优点："><a href="#Bagging-的优点：" class="headerlink" title="$Bagging$ 的优点："></a>$Bagging$ 的优点：</h4><ul><li><p>训练一个 $Bagging$ 集成与直接使用基学习算法训练一个学习器的复杂度同阶，这说明 $Bagging$ 是一个很高效的集成学习算法。</p><blockquote><p>假定基学习器的计算复杂度为 $O(m)$，则 $Bagging$ 的复杂度大致为 $T(O(m)+O(s))$，考虑到采样与投票/平均过程的复杂度 $O(s)$很小，而 $T$ 通常是一个不太大的常数。</p></blockquote></li><li><p>与标准 $AdaBoost$ 只适用于二分类任务不同，$Bagging$ 能不经修改地用于多分类、回归等任务。</p></li><li><p>自助采样过程还给 $Bagging$ 带来了另一个优点：由于每个基学习器只使用了初始训练集中约 $63.2%$ 的样本，剩下约 $36.8%$ 的样本可用作验证集来对泛化性能进行“包外估计”(out-of-bag estimate)。为此需记录每个基学习器所使用的训练样本。</p></li><li><p>由于 $Bagging$ 算法每次都进行采样来训练模型，因此泛化能力很强，对于降低模型的方差很有作用。当然对于训练集的拟合程度就会差一些。</p></li></ul><p>不妨令 $D_t$ 表示 $h_t$ 实际使用的训练样本集，令 $H^{oob}(x)$ 表示对样本 $x$ 的包外预测，即仅考虑那些未使用 $x$ 训练的基学习器在 $x$ 上的预测，有</p><div>    $$H^{oob}(x)=\arg\limits_{y∈γ}\max\sum^T_{t=1}Ⅱ(h_t(x)=y)\,·\,Ⅱ(x\notin D_t)\,\,,\tag{1}$$</div><p>则 $Bagging$ 泛化误差的包外估计为</p><div>    $$\epsilon^{oob}=\frac{1}{|D|}\sum_{(x,y)\in D}Ⅱ(H^{oob}(x)\neq y)\,\,.\tag{2}$$</div><p>事实上，包外样本还有许多其他用途：</p><ul><li>当基学习器是决策树时，可使用包外样本来辅助剪枝，或用于估计决策树中各结点的后验概率以辅助对零训练样本结点的处理；</li><li>当基学习器是神经网络时，可使用包外样本来辅助早期停止以减小过拟合风险。</li></ul><p>从偏差方差分解的角度看，$Bagging$ 主要关注降低方差，因此它在不剪枝决策树、神经网络等易受样本扰动的学习器上效用更为明显。</p><hr><h3 id="随机森林"><a href="#随机森林" class="headerlink" title="随机森林"></a>随机森林</h3><p>随机森林（Random Forest，简称RF）是 $Bagging$ 的一个扩展变体。$RF$ 在以决策树为基学习器构建 $Bagging$ 集成的基础上，进一步在决策树的训练过程中引入了随机属性选择。具体来说，传统决策树在选择划分属性时是在当前结点的属性集合(假定有 $d$ 个属性)中选择一个最优属性；而在 $RF$ 中，对基决策树的每个结点，先从该结点的属性集合中随机选择一个包含 $k$ 个属性的子集，然后再从这个子集中选择一个最优属性用于划分。</p><blockquote><p>这里的参数 $k$ 控制了随机性的引入程度：若令 $k=d$，则基决策树的构建与传统决策树相同；若令 $k= 1$，则是随机选择一个属性用于划分；一般情况下，推荐值 $k= log_2d$。</p></blockquote><p>随机森林简单、容易实现、计算开销小，令人惊奇的是，它在很多现实任务中展现出强大的性能，被誉为“代表集成学习技术水平的方法”。可以看出，随机森林对 $Bagging$ 只做了小改动，但是与 $Bagging$ 中基学习器的“多样性”仅通过样本扰动（通过对初始训练集采样）而来不同，随机森林中基学习器的多样性不仅来自样本扰动，还来自属性扰动，这就使得最终集成的泛化性能可通过个体学习器之间差异度的增加而进一步提升。</p><p>随机森林的收敛性与 $Bagging$ 相似。如下图所示，随机森林的起始性能往往相对较差，特别是在集成中只包含一个基学习器时。这很容易理解，因为通过引入属性扰动，随机森林中个体学习器的性能往往有所降低。然而，随着个体学习器数目的增加，随机森林通常会收敛到更低的泛化误差。值得一提的是，随机森林的训练效率常优于 $Bagging$，因为在个体决策树的构建过程中，$Bagging$ 使用的是“确定型”决策树，在选择划分属性时要对结点的所有属性进行考察，而随机森林使用的“随机型”决策树则只需考察一个属性子集。</p><img src="https://img-blog.csdnimg.cn/20200803100913113.png" width="70%" loading="lazy"><hr><h4 id="随机森林的主要优点："><a href="#随机森林的主要优点：" class="headerlink" title="随机森林的主要优点："></a>随机森林的主要优点：</h4><ul><li>训练可以高度并行化。</li><li>由于可以随机选择决策树节点划分特征，这样在样本特征维度很高的时候，仍然能高效的训练模型。</li><li>在训练后，可以给出各个特征对于输出的重要性。</li><li>由于采用了随机采样，训练出的模型的方差小，泛化能力强。</li><li>相对于 $Boosting$ 系列的 $Adaboost$ 和 $GBDT$ ，$RF$ 实现比较简单。</li><li>对部分特征缺失不敏感。</li></ul><h4 id="随机森林的主要缺点："><a href="#随机森林的主要缺点：" class="headerlink" title="随机森林的主要缺点："></a>随机森林的主要缺点：</h4><ul><li>在某些噪音比较大的样本集上，随机森林模型容易陷入过拟合。</li><li>取值划分比较多的特征容易对随机森林的决策产生更大的影响，从而影响拟合的模型的效果。</li></ul><blockquote><p>随机森林需要调整的参数有：</p><ul><li>决策树的个数</li><li>特征属性的个数</li><li>递归次数（决策树的深度）</li></ul></blockquote><hr><p>Reference：《机器学习》</p>]]></content>
      
      
      <categories>
          
          <category> MachineLearning </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MachineLearning </tag>
            
            <tag> Bagging </tag>
            
            <tag> RandomForest </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>决策树算法原理</title>
      <link href="/posts/748a96c4/"/>
      <url>/posts/748a96c4/</url>
      
        <content type="html"><![CDATA[<h2 id="什么是决策树？"><a href="#什么是决策树？" class="headerlink" title="什么是决策树？"></a>什么是决策树？</h2><p>决策树是一种逻辑简单的机器学习算法，可用作分类，也可用作回归，属于监督学习（Supervised learning）。</p><p>决策树的模型表达式 f(x) 很难被写出，却很容易被画出</p><h3 id="决策树是一种树形结构："><a href="#决策树是一种树形结构：" class="headerlink" title="决策树是一种树形结构："></a>决策树是一种树形结构：</h3><blockquote><h6 id="树形结构："><a href="#树形结构：" class="headerlink" title="树形结构："></a>树形结构：</h6><p><strong>①结点+有向边</strong><br><strong>②没有回路，根结点为始、叶子结点为终</strong></p></blockquote><img src="https://img-blog.csdnimg.cn/20200424102622422.png" width="30%" loading="lazy"><p><strong>或者这么画：</strong></p><img src="https://img-blog.csdnimg.cn/20200424102640336.png" width="40%" loading="lazy"><pre><code>根节点：包含样本的全集内部节点：对应特征属性测试叶节点：代表决策的结果</code></pre><h3 id="决策树学习的步骤："><a href="#决策树学习的步骤：" class="headerlink" title="决策树学习的步骤："></a>决策树学习的步骤：</h3><ol><li><p><strong>特征选择</strong><br>根据信息增益的准则，筛选出跟分类结果相关性较高的特征，也就是分类能力较强的特征。</p></li><li><p><strong>决策树生成及分裂</strong><br>从根节点开始，对每个节点计算所有特征的信息增益，选择信息增益最大的特征作为节点特征，根据该特征的不同取值建立子节点；然后对每个子节点使用相同的方式生成新的子节点，直到信息增益很小或者没有特征可以选择为止。</p></li><li><p><strong>决策树剪枝</strong><br>主动去掉部分分支，防止过拟合。</p></li></ol><h3 id="决策树的分裂（决策）："><a href="#决策树的分裂（决策）：" class="headerlink" title="决策树的分裂（决策）："></a>决策树的分裂（决策）：</h3><img src="https://img-blog.csdnimg.cn/20200424105433997.png" width="20%" loading="lazy"><p><strong>根据 <code>分裂的特征 x</code> 和 <code>分裂的阈值 a</code> 进行分裂，即进行一次决策。然后由判断结果决定进入哪个分支节点，直至到达叶节点处，得到分类结果。</strong></p><blockquote><p>在构建决策树模型时，我们无法得知参数数量，而是采用启发式算法。</p></blockquote><h3 id="启发式算法："><a href="#启发式算法：" class="headerlink" title="启发式算法："></a>启发式算法：</h3><ol><li><strong>将所有的训练数据都放在根结点中。</strong></li><li><strong>选择一个当前的最优决策，将根结点的数据分割成子集。</strong></li><li><strong>对每个子集，选择一个子集的最优决策，得到子集的子集。</strong></li><li><strong>递归执行，直到各个子集都有较好的分类时结束。</strong></li></ol><h3 id="最优决策："><a href="#最优决策：" class="headerlink" title="最优决策："></a>最优决策：</h3><blockquote><p>分类树决策的优劣用熵来衡量。</p></blockquote><img src="https://img-blog.csdnimg.cn/20200424110907282.png" width="30%" loading="lazy"><img src="https://img-blog.csdnimg.cn/20200424111253350.png" width="30%" loading="lazy"><h4 id="决策树的损失函数就是条件熵"><a href="#决策树的损失函数就是条件熵" class="headerlink" title="决策树的损失函数就是条件熵"></a><code>决策树的损失函数就是条件熵</code></h4><h3 id="决策树算法的分类："><a href="#决策树算法的分类：" class="headerlink" title="决策树算法的分类："></a>决策树算法的分类：</h3><ul><li><strong>ID3</strong></li><li><strong>C4.5</strong></li><li><strong>CART</strong></li></ul><p>ID3 算法的思路：信息增益最大化<br><code>信息增益 = 熵 - 条件熵</code></p><p>C4.5 算法的思路：信息增益率最大化<br><code>信息增益率 = 信息增益 / 熵</code></p><blockquote><p>ID3 算法和 C4.5算法 的区别仅在于信息增益和信息增益率。</p></blockquote><h3 id="决策树算法的优缺点："><a href="#决策树算法的优缺点：" class="headerlink" title="决策树算法的优缺点："></a>决策树算法的优缺点：</h3><ul><li>优点：计算复杂度不高，输出结果易于理解，对中间值的缺失不敏感，可以处理不相关特征数据。</li><li>缺点：可能会产生过度匹配问题。</li><li>适用数据类型：数值型和标称型。</li></ul><h2 id="什么是-ID3-算法？"><a href="#什么是-ID3-算法？" class="headerlink" title="什么是 $ID3$ 算法？"></a>什么是 $ID3$ 算法？</h2><p>$ID3$ 算法是构建决策树模型的一种常用方法，根据信息增益来选择特征。</p><h3 id="信息增益"><a href="#信息增益" class="headerlink" title="信息增益"></a>信息增益</h3><p>“信息熵”是度量样本集合纯度最常用的一种指标，假定当前样本集合 $D$ 中第 $k$ 类样本所占的比例为$P_k (k=1,2,…,|y|)$，则 $D$ 的信息熵定义为：</p><div>    $$Ent(D)=-\sum^{|y|}_{k=1}p_klog_2p_k$$</div><p>$Ent(D)$ 的值越小，则 $D$ 的纯度越高。</p><p>假定离散属性 $a$ 有 $V$ 个可能的取值 ${a^1,a^2, …,a^V}$ ，若使用 $a$ 来对样本集 $D$ 进行划分，则会产生 $V$ 个分支结点，其中第 $v$ 个分支结点包含了 $D$ 中所有在属性 $a$ 上取值为 $a^v$ 的样本，记为 $D^v$ 。我们可根据式（4.1）计算出 $D^v$ 的信息熵，再考虑到不同的分支结点所包含的样本数不同，给分支结点赋予权重 $|D^v|/|D|$，即样本数越多的分支结点对提升纯度的帮助越大，于是可计算出用属性 $a$ 对样本集 $D$ 进行划分所获得的“信息增益”，<strong>求和项也称为“条件熵”</strong>：</p><div>    $$Gain(D,a)=Ent(D)-\sum^V_{v=1}\frac{|D^v|}{|D|}Ent(D^v)$$</div><p>一般地，信息增益越大，则使用属性 $a$ 来进行划分所获得的“纯度提升”越大。因此可用信息增益来进行决策树的划分属性选择，即在决策树算法中选择属性 $a_* = arg_{a∈A}max Gain(D,a)$。</p><p><strong>$ID3$ 算法就是以信息增益为准则来选择划分属性。</strong></p><h3 id="ID3-算法的步骤："><a href="#ID3-算法的步骤：" class="headerlink" title="$ID3$ 算法的步骤："></a>$ID3$ 算法的步骤：</h3><pre><code>参数：训练集 D，特征集 A，阈值 ε返回：决策树 T</code></pre><ol><li>若 $D$ 中全部实例同属一类 $C$，则用 $C$ 作为该结点的标注，返回 $T$。（异常处理）</li><li>若 $A$ 为空，则将 $D$ 中实例数最多的类 $C$ 作为该结点的标注，并返回 $T$。（异常处理）</li><li>计算 $A$ 中每个特征对 $D$ 的信息增益，并选择信息增益最大的特征 $a$。（最优决策）</li><li>如果 $a$ 带来的信息增益小于阈值 $e$，则将 $D$ 中实例数最多的类 $C$ 作为该结点的标注，并返回 $T$ 。</li><li>对特征 $a$ 的每个可能取值 $a_i$，将数据集 $D$ 分割为几个子集 $D_i$ 构建子节点，由结点、子结点、$a$、每个 $a_i$ 构建决策树 $T$。</li><li>对每个子集，以 $D_i$ 为数据集，以 $A- {a}$ 为特征集，递归调用1~5步。</li></ol><h2 id="什么是-C4-5-算法？"><a href="#什么是-C4-5-算法？" class="headerlink" title="什么是 $C4.5$ 算法？"></a>什么是 $C4.5$ 算法？</h2><h6 id="C4-5-算法是基于-ID3-算法的改良，-C4-5-算法不直接使用信息增益，而是使用“信息增益率”来选择最优划分属性。"><a href="#C4-5-算法是基于-ID3-算法的改良，-C4-5-算法不直接使用信息增益，而是使用“信息增益率”来选择最优划分属性。" class="headerlink" title="$C4.5$ 算法是基于 $ID3$ 算法的改良，$C4.5$ 算法不直接使用信息增益，而是使用“信息增益率”来选择最优划分属性。"></a>$C4.5$ 算法是基于 $ID3$ 算法的改良，$C4.5$ 算法不直接使用信息增益，而是使用“信息增益率”来选择最优划分属性。</h6><h6 id="基于-ID3-算法的优化："><a href="#基于-ID3-算法的优化：" class="headerlink" title="基于 $ID3$ 算法的优化："></a>基于 $ID3$ 算法的优化：</h6><pre><code>1) 用信息增益率来选择属性，克服了用信息增益选择属性时偏向选择取值多的属性的不足；2) 在树构造过程中进行剪枝；3) 能够完成对连续属性的离散化处理；4) 能够对不完整数据进行处理。</code></pre><h3 id="信息增益率"><a href="#信息增益率" class="headerlink" title="信息增益率"></a>信息增益率</h3><p>信息增益准则对可取值数目较多的属性有所偏好，然而这样的决策树显然不具有泛化能力，无法对新样本进行有效预测。而 $C4.5$ 算法不直接使用信息增益，而是使用“信息增益率”来选择最优划分属性，假定当前样本集合为 $D$，信息增益率定义为：</p><div>    $$Gain\_ratio(D,a)=\frac{Gain(D,a)}{IV(a)}$$</div><p>其中</p><div>    $$IV(a)=-\sum^V_{v=1}\frac{|D^v|}{|D|}log_2\frac{|D^v|}{|D|}$$</div><p>称为属性 $a$ 的“固有值”。它的定义与信息熵类似，信息熵衡量的是样本集在类别上的混乱程度，而 <strong>固有值衡量的是样本集在某个属性上的混乱程度</strong>。若属性 $a$ 的可能取值数目 $V$ 越大，$IV(a)$ 的值通常会越大，即该属性混乱程度越高。</p><p>需要注意的是，信息增益率准则对可取值数目较少的属性有所偏好。因此，$C4.5$ 算法并不是直接选择信息增益率最大的候选划分属性，而是使用了一个启发式：<strong>先从候选划分属性中找出信息增益高于平均水平的属性，再从中选择增益率最高的</strong>。</p><h6 id="C4-5-的不足之处："><a href="#C4-5-的不足之处：" class="headerlink" title="$C4.5$ 的不足之处："></a>$C4.5$ 的不足之处：</h6><ul><li>$C4.5$ 生成的是多叉树，一个父节点可以有多个子节点，运算效率没有二叉树高；</li><li>$C4.5$ 使用了熵模型，里面有大量的对数运算。如果有连续值的属性，还涉及到排序运算，运算量很大。</li></ul><h2 id="CART-算法"><a href="#CART-算法" class="headerlink" title="$CART$ 算法"></a>$CART$ 算法</h2><p>$CART$（Classification and Regression Tree，即分类回归树算法）是一种著名的决策树学习算法，可用于分类和回归任务。</p><p>$CART$ 算法使用“基尼指数”来选择划分属性。</p><h3 id="基尼指数"><a href="#基尼指数" class="headerlink" title="基尼指数"></a>基尼指数</h3><p>假定当前样本集合 $D$ 中第 $k$ 类样本所占的比例为$P_k (k=1,2,…,|y|)$。</p><p>数据集 $D$ 的纯度可用基尼值来度量：</p><div>    $$Gini(D)=\sum^{|y|}_{k=1}\sum_{k'≠k}p_kp_{k'}=\sum^{|y|}_{k=1}p_k(1-p_k)=1-\sum^{|y|}_{k=1}p^2_k$$</div><p>直观来说，**$Gini(D)$ 反映了从数据集 $D$ 中随机抽取 $2$ 个样本，其类别标记不一致的概率**。因此，$Gini(D) $ 越小，基尼值越小，则数据集 $D$ 的纯度越高。属性 $α$ 的基尼指数定义：</p><div>    $$Gini\_index(D,a)=\sum^V_{v=1}\frac{|D^v|}{|D|}Gini(D^v)$$</div><p>基尼指数越小，表示使用属性 $a$ 划分后纯度的提升越大。因此，在属性集合 $A$ 中，选择基尼指数最小的属性 $a$ 作为最优划分属性，即 $a_*=arg_{a∈A}minGini_index(D,a)$。</p><h4 id="CART-算法中主要分为两个步骤"><a href="#CART-算法中主要分为两个步骤" class="headerlink" title="$CART$ 算法中主要分为两个步骤"></a>$CART$ 算法中主要分为两个步骤</h4><ol><li><p>将样本递归划分进行建树过程</p></li><li><p>用验证数据进行剪枝</p></li></ol><p>Reference：《机器学习》</p>]]></content>
      
      
      <categories>
          
          <category> MachineLearning </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MachineLearning </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>GBDT 模型简介及数学推导</title>
      <link href="/posts/c9d19075/"/>
      <url>/posts/c9d19075/</url>
      
        <content type="html"><![CDATA[<h4 id="什么是-GBDT-？"><a href="#什么是-GBDT-？" class="headerlink" title="什么是 $GBDT$ ？"></a>什么是 $GBDT$ ？</h4><p>$GBDT$ 是机器学习领域中浅层模型的优秀模型，也是各大数据挖掘比赛中经常出现的框架，其全称是 $Gradient Boosting Decision Tree$，中文名是梯度提升树。</p><hr><h4 id="Boosting"><a href="#Boosting" class="headerlink" title="$Boosting$"></a>$Boosting$</h4><p>$Boosting$ 是一族可将弱学习器提升为强学习器的算法。这族算法的工作机制类似：先从初始训练集训练出一个基学习器，再根据基学习器的表现对训练样本分布进行调整，使得先前基学习器做错的训练样本在后续受到更多关注，然后基于调整后的样本分布来训练下一个基学习器；如此重复进行，直至基学习器数目达到事先指定的值 $T$，最终将这 $T$ 个基学习器进行加权结合。</p><hr><h4 id="GBDT-的损失函数："><a href="#GBDT-的损失函数：" class="headerlink" title="$GBDT$ 的损失函数："></a>$GBDT$ 的损失函数：</h4><blockquote><p>$Boosting$ 的模型是个迭代多轮的加法模型。$Boosting$ 每轮迭代输出的是一个基模型 $f_m(x)$，其中 $m$ 表示第 $m$ 轮迭代。最终，每轮迭代输出的模型经过加法求和，就得到了最终 $Boosting$ 模型的输出，也就是：$$y=\sum^{M}_{m=1}f_m(x)$$</p></blockquote><p>$GBDT$ 模型的基模型为 $DT$（决策树），即对于 $GBDT$ 下的每轮迭代，输出的 $f_m(x)$ 为决策树。而最终的 $GBDT$ 模型为所有决策树输出结果之和。$Boosting$ 的基模型采用的都是弱模型，因此，通常 $GBDT$ 基模型的决策树树深不会太深（一般少于 $5$ 层），这些可以在实际实现中灵活处理。</p><p>回归决策树的 <strong>损失函数</strong> 采用平方误差，$GBDT$ 也可以保持一致。平方误差的公式为：</p><div>    $$L(w)=\sum^n_{i=1}(\hat{y}_i-y_i)^2\tag{1}$$</div><p>此处的模型和损失函数都是参数 $w$ 的函数，参数 $w$ 为每个基模型的每个分裂特征和每个分裂阈值。</p><p>考虑此时要最优化的目标变量是什么，此处可以从损失函数入手，对于损失函数中的预测值 $y_i$ 有：</p><div>    $$y_i=\sum_{m=1}^Mf_m(x_i)=\sum^{M-1}_{m=1}f_m(x_i)+f_M(x_i)\tag{2}$$</div><p>将 $(2)$ 式代入 $(1)$ 式，得：</p><div>    $$L(w)=\sum^n_{i=1}(\hat{y}_i-y_i)^2=\sum^n_{i=1}(\hat{y}_i-\sum^{M-1}_{m=1}f_m(x_i)-f_M(x_i))^2\tag{3}$$</div><p>观察式 $(3)$，发现损失函数中有 $3$ 项。第一项是真实值，第二项是截止到第 $M-1$ 棵树的预测值，第三项是第 $M$ 棵树的输出结果，若令：</p><div>    $$r_i=\hat{y}_i-\sum^{M-1}_{m=1}f_m(x_i)\tag{4}$$</div><p>表示的是，在训练第 $M$ 棵树时，截止到当前的残差值（误差），把 $(4)$ 代入 $(3)$，有：</p><div>    $$L(w)=\sum^n_{i=1}(r_i-f_M(x_i))^2\tag{5}$$</div><p>该公式表明，为了让损失函数数值最小，在训练某个基模型时，其训练目标是<strong>去拟合残差 $r_i$。</strong></p><hr><h4 id="GBDT-的最优化求解"><a href="#GBDT-的最优化求解" class="headerlink" title="$GBDT$ 的最优化求解"></a>$GBDT$ 的最优化求解</h4><p>上述讨论是基于损失函数为平方误差的情况。一般地，如果损失函数不是平方误差，则每个基模型的训练目标就不是残差。$GBDT$ 利用损失函数的负梯度在当前模型的值作为残差的近似值，即：</p><div>    $$r_i≈-\bigg[\frac{∂L(w)}{∂f_{M-1}(x)}\bigg]\tag{6}$$</div><p>特别地，当损失函数采用平方误差时，损失函数的负梯度就是先前推导的残差：</p><div>    $$-\bigg[\frac{∂L(w)}{∂f_{M-1}(x)}\bigg]=\hat{y}_i-\sum^{M-1}_{m=1}f_m(x_i)\tag{7}$$</div><p>假设有一个回归问题，特征只有一个维度，取值范围为 $1$ ～ $5$ 的自然数，样本对应的真实值取值为 $-1$ ～ $1$ 的自然数。现利用 $GBDT$ 算法建立模型，假设基模型采用树深为 $1$ 的 $CART$ 回归树算法，损失函数采用平方误差函数，则残差公式为：</p><div>    $$r_i=-\bigg[\frac{∂L(w)}{∂f_{M-1}(x)}\bigg]=\hat{y}_i-\sum^{M-1}_{m=1}f_m(x_i)\tag{8}$$</div><p>建模通过多轮迭代，每一轮都学习一棵 $CART$ 树，学习的目标是残差。对于只有 $1$ 层结点的 $CART$ 树建模，采用选择平方误差最小的分裂点和阈值即可。第一轮输出结果为：<br><img src="https://img-blog.csdnimg.cn/2020080116372072.png" alt="在这里插入图片描述" loading="lazy"><br>经过第一轮的模型，对每个样本计算出残差表如下：</p><table><thead><tr><th>样本序号</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th></tr></thead><tbody><tr><td>特征 x</td><td>1</td><td>2</td><td>3</td><td>4</td><td>5</td></tr><tr><td>真实值 y</td><td>-1</td><td>1</td><td>1</td><td>-1</td><td>1</td></tr><tr><td>预测值 $\hat{y_i}$</td><td>-1</td><td>0.5</td><td>0.5</td><td>0.5</td><td>0.5</td></tr><tr><td>残差值 $r_i$</td><td>0</td><td>0.5</td><td>0.5</td><td>-1.5</td><td>0.5</td></tr></tbody></table><p>第二轮建模以残差值 $r_i$ 为标签，构建模型 $r_i=f(x)$  的一层 $CART$ 回归树，则有：<br><img src="https://img-blog.csdnimg.cn/20200801164107430.png" alt="在这里插入图片描述" loading="lazy"><br>第二轮建模之后的模型如下。同样可以计算残差，并进行第三轮的建模：<br><img src="https://img-blog.csdnimg.cn/20200801164138818.png" alt="在这里插入图片描述" loading="lazy"><br>重复上述过程 $5$ 次后，得到模型。</p><p>以 $x=2$ 为例代入模型，则每个树的输出结果分别为：$0.5$、$0.33$、$-0.25$、$0.25$、$-0.09$，最终预测结果为 $y=0.74$ 。<br><img src="https://img-blog.csdnimg.cn/20200801164312916.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTk2MTc3NA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" loading="lazy"></p><hr><p>对于 $GBDT$ 而言，弱模型可以采用浅层的 $CART$ 树，而提升方法则是一个逐步迭代的加法模型，对于每轮的迭代，采用<strong>损失函数的负梯度</strong>作为学习目标：</p><div>    $$r_i≈-\bigg[\frac{∂L(w)}{∂f_{M-1}(x)}\bigg]\tag{9}$$</div><p>至此，得到 $GBDT$ 模型。</p><hr><p>Reference：<a href="https://kaiwu.lagou.com/course/courseInfo.htm?courseId=15#/detail/pc?id=225">https://kaiwu.lagou.com/course/courseInfo.htm?courseId=15#/detail/pc?id=225</a></p>]]></content>
      
      
      <categories>
          
          <category> MachineLearning </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MachineLearning </tag>
            
            <tag> GBDT </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>什么是推荐系统？</title>
      <link href="/posts/152fc689/"/>
      <url>/posts/152fc689/</url>
      
        <content type="html"><![CDATA[<h3 id="什么是推荐系统？"><a href="#什么是推荐系统？" class="headerlink" title="什么是推荐系统？"></a>什么是推荐系统？</h3><p>随着信息技术和互联网的发展，人们逐渐从信息匮乏的时代走人了信息过载（informationoverload）的时代。</p><p>推荐系统就是解决信息过载的重要工具。它的任务是联系用户和信息，一方面帮助用户发现对自己有价值的信息；另一方面让信息能够展现在对它感兴趣的用户面前，从而实现信息消费者和信息生产者的双赢。</p><hr><h3 id="推荐系统的应用"><a href="#推荐系统的应用" class="headerlink" title="推荐系统的应用"></a>推荐系统的应用</h3><p>电子商务、电影和视频网站、个性化音乐网络电台、社交网络、个性化阅读、广告等等。</p><hr><h3 id="推荐系统的分类"><a href="#推荐系统的分类" class="headerlink" title="推荐系统的分类"></a>推荐系统的分类</h3><table><thead><tr><th>根据实时性分类</th><th>根据推荐是否个性化分类</th><th>根据推荐原则分类</th><th>根据数据源分类</th></tr></thead><tbody><tr><td>离线推荐</td><td>基于统计的推荐</td><td>基于相似度的推荐</td><td>基于人口统计学的推荐</td></tr><tr><td>实时推荐</td><td>个性化推荐</td><td>基于知识的推荐</td><td>基于内容的推荐</td></tr><tr><td></td><td></td><td>基于模型的推荐</td><td>基于协同过滤的推荐</td></tr></tbody></table><blockquote><p>协同过滤（英语：Collaborative Filtering，简称CF），简单来说是利用某兴趣相投、拥有共同经验之群体的喜好来推荐用户感兴趣的信息，个人透过合作的机制给予信息相当程度的回应（如评分）并记录下来以达到过滤的目的进而帮助别人筛选信息，回应不一定局限于特别感兴趣的，特别不感兴趣信息的纪录也相当重要。——维基百科</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> RecommenderSystem </category>
          
      </categories>
      
      
        <tags>
            
            <tag> RecommenderSystem </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用 Selenium 爬取美团网大学城美食并存入 MongoDB 数据库</title>
      <link href="/posts/2bca3d7b/"/>
      <url>/posts/2bca3d7b/</url>
      
        <content type="html"><![CDATA[<h3 id="Selenium是什么？"><a href="#Selenium是什么？" class="headerlink" title="Selenium是什么？"></a>Selenium是什么？</h3><p>Selenium 是一个自动化测试工具，利用它可以驱动浏览器执行特定的动作，如点击、下拉等操作，同时还可以获取浏览器当前呈现的页面源代码，做到可见即可爬。对于一些使用 JavaScript 动态渲染的页面来说，此种抓取方式非常有效。</p><hr><h3 id="Selenium-适用场景"><a href="#Selenium-适用场景" class="headerlink" title="Selenium 适用场景"></a>Selenium 适用场景</h3><p>在网络爬虫中，有的网页可以直接用 requests 来爬取，有的可以直接通过分析 Ajax 来爬取，不同的网站类型有其适用的爬取方法。</p><p>而对于带有 JavaScript 渲染的网页，多数情况下是无法直接用 requests 爬取网页源码的，虽然有些情况下可以直接用 requests 来模拟 Ajax 请求来直接得到数据。但有些情况下 Ajax 的一些请求接口可能带有一些加密参数，如 token、sign 等等，如果不分析清楚这些参数是怎么生成的话，就难以模拟和构造这些参数。</p><p>此时可以直接选择使用 Selenium 驱动浏览器渲染的方式来解决，实现所见即所爬，则无需关心在该网页背后发生了什么请求、得到什么数据以及怎么渲染页面，我们看到的页面就是最终浏览器帮我们模拟了 Ajax 请求和 JavaScript 渲染得到的最终结果，而 Selenium 正好也能拿到这个最终结果，相当于绕过了 Ajax 请求分析和模拟的阶段，直达目标。</p><p>然而 Selenium 也有其局限性，其爬取效率较低，有些爬取需要模拟浏览器的操作，实现相对烦琐。但在某些场景下也是一种有效的爬取手段。</p><hr><h3 id="使用-Selenium-爬取美团网大学城美食"><a href="#使用-Selenium-爬取美团网大学城美食" class="headerlink" title="使用 Selenium 爬取美团网大学城美食"></a>使用 Selenium 爬取美团网大学城美食</h3><h5 id="1-首先分析目标网站"><a href="#1-首先分析目标网站" class="headerlink" title="1. 首先分析目标网站"></a>1. 首先分析目标网站</h5><img src="https://img-blog.csdnimg.cn/20200823130510381.png" width="60%" loading="lazy"><img src="https://img-blog.csdnimg.cn/20200823130603348.png" width="60%" loading="lazy"><p>可以发现 URL 随着页数变化的规律，于是构造一个页面爬取的框架：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> logging<span class="token keyword">import</span> time<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>common<span class="token punctuation">.</span>exceptions <span class="token keyword">import</span> TimeoutException<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver<span class="token punctuation">.</span>support<span class="token punctuation">.</span>wait <span class="token keyword">import</span> WebDriverWait<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver <span class="token keyword">import</span> ChromeOptions<span class="token keyword">from</span> selenium <span class="token keyword">import</span> webdriverlogging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span>level<span class="token operator">=</span>logging<span class="token punctuation">.</span>INFO<span class="token punctuation">,</span> <span class="token builtin">format</span><span class="token operator">=</span><span class="token string">'%(asctime)s - %(levelname)s: %(message)s'</span><span class="token punctuation">)</span>INDEX_URL <span class="token operator">=</span> <span class="token string">'https://gz.meituan.com/meishi/b1184/pn&#123;page&#125;/'</span>TIME_OUT <span class="token operator">=</span> <span class="token number">30</span>TOTAL_PAGE <span class="token operator">=</span> <span class="token number">12</span>option <span class="token operator">=</span> ChromeOptions<span class="token punctuation">(</span><span class="token punctuation">)</span>option<span class="token punctuation">.</span>add_experimental_option<span class="token punctuation">(</span><span class="token string">'excludeSwitches'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'enable-automation'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>option<span class="token punctuation">.</span>add_experimental_option<span class="token punctuation">(</span><span class="token string">'useAutomationExtension'</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span>browser <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Chrome<span class="token punctuation">(</span>options<span class="token operator">=</span>option<span class="token punctuation">)</span>wait <span class="token operator">=</span> WebDriverWait<span class="token punctuation">(</span>browser<span class="token punctuation">,</span> TIME_OUT<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">scrape_page</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> condition<span class="token punctuation">,</span> locator<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    Page scraping framework    Args:        url: pages to be scraped        condition: judgement conditions for page loading        locator: locator    Returns:        None    """</span>    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'scraping %s'</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        browser<span class="token punctuation">.</span>execute_cdp_cmd<span class="token punctuation">(</span><span class="token string">'Page.addScriptToEvaluateOnNewDocument'</span><span class="token punctuation">,</span>                                <span class="token punctuation">&#123;</span><span class="token string">'source'</span><span class="token punctuation">:</span> <span class="token string">'Object.defineProperty(navigator, "webdriver", &#123;get: () => undefined&#125;)'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        browser<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span>        wait<span class="token punctuation">.</span>until<span class="token punctuation">(</span>condition<span class="token punctuation">(</span>locator<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">except</span> TimeoutException<span class="token punctuation">:</span>        logging<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">'error occurred while scraping %s'</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> exc_info<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">scrape_index</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    Scrape every page    Args:        page:    Returns:        None    """</span>    url <span class="token operator">=</span> INDEX_URL<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>page<span class="token operator">=</span>page<span class="token punctuation">)</span>    scrape_page<span class="token punctuation">(</span>url<span class="token punctuation">,</span> condition<span class="token operator">=</span>EC<span class="token punctuation">.</span>visibility_of_all_elements_located<span class="token punctuation">,</span>                locator<span class="token operator">=</span><span class="token punctuation">(</span>By<span class="token punctuation">.</span>XPATH<span class="token punctuation">,</span> <span class="token string">'/html/body/div/section/div/div[2]/div[2]/div[1]/ul/li'</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><h5 id="2-接着分析每个页面中每个商家的-URL-链接"><a href="#2-接着分析每个页面中每个商家的-URL-链接" class="headerlink" title="2. 接着分析每个页面中每个商家的 URL 链接"></a>2. 接着分析每个页面中每个商家的 URL 链接</h5><img src="https://img-blog.csdnimg.cn/20200823142056540.png" width="60%" loading="lazy"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">parse_index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    Get the url of each business    Args:        None    Returns:        generator    """</span>    elements <span class="token operator">=</span> browser<span class="token punctuation">.</span>find_elements_by_xpath<span class="token punctuation">(</span><span class="token string">'/html/body/div/section/div/div[2]/div[2]/div[1]/ul/li/div[1]/a'</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> element <span class="token keyword">in</span> elements<span class="token punctuation">:</span>        url <span class="token operator">=</span> element<span class="token punctuation">.</span>get_attribute<span class="token punctuation">(</span><span class="token string">'href'</span><span class="token punctuation">)</span>        <span class="token keyword">yield</span> url</code></pre><h5 id="3-然后爬取每个商家的页面"><a href="#3-然后爬取每个商家的页面" class="headerlink" title="3. 然后爬取每个商家的页面"></a>3. 然后爬取每个商家的页面</h5><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">scrape_detail</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    Scrape the page of each business    Args:        url    Returns:        None    """</span>    scrape_page<span class="token punctuation">(</span>url<span class="token punctuation">,</span> condition<span class="token operator">=</span>EC<span class="token punctuation">.</span>visibility_of_element_located<span class="token punctuation">,</span>                locator<span class="token operator">=</span><span class="token punctuation">(</span>By<span class="token punctuation">.</span>XPATH<span class="token punctuation">,</span> <span class="token string">'/html/body/div/section/div/div[2]/div[1]/div[@class="name"]'</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><h5 id="4-然后使用开发者工具解析商家页面信息"><a href="#4-然后使用开发者工具解析商家页面信息" class="headerlink" title="4. 然后使用开发者工具解析商家页面信息"></a>4. 然后使用开发者工具解析商家页面信息</h5><img src="https://img-blog.csdnimg.cn/20200823143148265.png" width="60%" loading="lazy"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">parse_detail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    Parse the information of each business    Args:        None    Returns:        data    """</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        name <span class="token operator">=</span> browser<span class="token punctuation">.</span>find_element_by_xpath<span class="token punctuation">(</span>            <span class="token string">"/html/body/div[1]/section/div/div[2]/div[1]/div[1]"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token string">'食品安全档案'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">except</span><span class="token punctuation">:</span>        name <span class="token operator">=</span> <span class="token string">'无'</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        star <span class="token operator">=</span> browser<span class="token punctuation">.</span>find_element_by_xpath<span class="token punctuation">(</span><span class="token string">"/html/body/div/section/div/div[2]/div[1]/div[2]/p"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    <span class="token keyword">except</span><span class="token punctuation">:</span>        star <span class="token operator">=</span> <span class="token string">'无'</span>    <span class="token keyword">if</span> star <span class="token operator">==</span> <span class="token string">'暂'</span><span class="token punctuation">:</span>        star <span class="token operator">=</span> <span class="token string">'无'</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        per_capita_consumption <span class="token operator">=</span> browser<span class="token punctuation">.</span>find_element_by_xpath<span class="token punctuation">(</span>            <span class="token string">"/html/body/div/section/div/div[2]/div[1]/div[2]/p/span"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token string">'人均'</span><span class="token punctuation">)</span>    <span class="token keyword">except</span><span class="token punctuation">:</span>        per_capita_consumption <span class="token operator">=</span> <span class="token string">'无'</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        address <span class="token operator">=</span> browser<span class="token punctuation">.</span>find_element_by_xpath<span class="token punctuation">(</span><span class="token string">"/html/body/div/section/div/div[2]/div[1]/div[3]/p[1]"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">.</span>strip<span class="token punctuation">(</span>            <span class="token string">'地址：'</span><span class="token punctuation">)</span>    <span class="token keyword">except</span><span class="token punctuation">:</span>        address <span class="token operator">=</span> <span class="token string">'无'</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        telephone <span class="token operator">=</span> browser<span class="token punctuation">.</span>find_element_by_xpath<span class="token punctuation">(</span><span class="token string">"/html/body/div/section/div/div[2]/div[1]/div[3]/p[2]"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">.</span>strip<span class="token punctuation">(</span>            <span class="token string">'电话：'</span><span class="token punctuation">)</span>    <span class="token keyword">except</span><span class="token punctuation">:</span>        telephone <span class="token operator">=</span> <span class="token string">'无'</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        business_hours <span class="token operator">=</span> browser<span class="token punctuation">.</span>find_element_by_xpath<span class="token punctuation">(</span>            <span class="token string">"/html/body/div/section/div/div[2]/div[1]/div[3]/p[3]"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token string">'营业时间：'</span><span class="token punctuation">)</span>    <span class="token keyword">except</span><span class="token punctuation">:</span>        business_hours <span class="token operator">=</span> <span class="token string">'无'</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        raw_recommended_dishes <span class="token operator">=</span> browser<span class="token punctuation">.</span>find_element_by_xpath<span class="token punctuation">(</span>            <span class="token string">"/html/body/div/section/div/div[3]/div[1]/div[2]/div/ul"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text        recommended_dishes <span class="token operator">=</span> <span class="token string">','</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">u"[\u4e00-\u9fa5]+"</span><span class="token punctuation">,</span> raw_recommended_dishes<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">except</span><span class="token punctuation">:</span>        recommended_dishes <span class="token operator">=</span> <span class="token string">'无'</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        review_people <span class="token operator">=</span> browser<span class="token punctuation">.</span>find_element_by_xpath<span class="token punctuation">(</span>            <span class="token string">"/html/body/div/section/div/div[3]/div[1]/div[3]/div[1]"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">.</span>strip<span class="token punctuation">(</span>            <span class="token string">'条网友点评'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token string">'质量排序时间排序'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">except</span><span class="token punctuation">:</span>        review_people <span class="token operator">=</span> <span class="token string">'无'</span>    url <span class="token operator">=</span> browser<span class="token punctuation">.</span>current_url    <span class="token keyword">try</span><span class="token punctuation">:</span>        cover <span class="token operator">=</span> browser<span class="token punctuation">.</span>find_element_by_xpath<span class="token punctuation">(</span>            <span class="token string">"/html/body/div/section/div/div[2]/div[2]/div/div/img"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get_attribute<span class="token punctuation">(</span><span class="token string">'src'</span><span class="token punctuation">)</span>    <span class="token keyword">except</span><span class="token punctuation">:</span>        cover <span class="token operator">=</span> <span class="token string">'无'</span>    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">"NAME"</span><span class="token punctuation">:</span> name<span class="token punctuation">,</span> <span class="token string">"STAR"</span><span class="token punctuation">:</span> star<span class="token punctuation">,</span> <span class="token string">"PER_CAPITA_CONSUMPTION"</span><span class="token punctuation">:</span> per_capita_consumption<span class="token punctuation">,</span> <span class="token string">"ADDRESS"</span><span class="token punctuation">:</span> address<span class="token punctuation">,</span>            <span class="token string">"TELEPHONE"</span><span class="token punctuation">:</span> telephone<span class="token punctuation">,</span> <span class="token string">"BUSINESS_HOURS"</span><span class="token punctuation">:</span> business_hours<span class="token punctuation">,</span> <span class="token string">"RECOMMENDED_DISHES"</span><span class="token punctuation">:</span> recommended_dishes<span class="token punctuation">,</span>            <span class="token string">"REVIEW_PEOPLE"</span><span class="token punctuation">:</span> review_people<span class="token punctuation">,</span> <span class="token string">"URL"</span><span class="token punctuation">:</span> url<span class="token punctuation">,</span> <span class="token string">"COVER"</span><span class="token punctuation">:</span> cover<span class="token punctuation">&#125;</span></code></pre><h5 id="5-最后将爬取的数据存入-MongoDB-数据库"><a href="#5-最后将爬取的数据存入-MongoDB-数据库" class="headerlink" title="5. 最后将爬取的数据存入 MongoDB 数据库"></a>5. 最后将爬取的数据存入 MongoDB 数据库</h5><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">save_to_MongoDB</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    Store data in MongoDB database    Args:        data    Returns:        None    """</span>    collection<span class="token punctuation">.</span>update_one<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>        <span class="token string">'NAME'</span><span class="token punctuation">:</span> data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'NAME'</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>        <span class="token string">'$set'</span><span class="token punctuation">:</span> data    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> upsert<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></code></pre><h5 id="6-主函数"><a href="#6-主函数" class="headerlink" title="6. 主函数"></a>6. 主函数</h5><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>    <span class="token keyword">for</span> each_page <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> TOTAL_PAGE <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        scrape_index<span class="token punctuation">(</span>each_page<span class="token punctuation">)</span>        detail_urls <span class="token operator">=</span> parse_index<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">for</span> detail_url <span class="token keyword">in</span> <span class="token builtin">list</span><span class="token punctuation">(</span>detail_urls<span class="token punctuation">)</span><span class="token punctuation">:</span>            scrape_detail<span class="token punctuation">(</span>detail_url<span class="token punctuation">)</span>            detail_data <span class="token operator">=</span> parse_detail<span class="token punctuation">(</span><span class="token punctuation">)</span>            save_to_MongoDB<span class="token punctuation">(</span>detail_data<span class="token punctuation">)</span>            logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'save data %s'</span><span class="token punctuation">,</span> detail_data<span class="token punctuation">)</span></code></pre><h5 id="7-爬取结果"><a href="#7-爬取结果" class="headerlink" title="7. 爬取结果"></a>7. 爬取结果</h5><p><img src="https://img-blog.csdnimg.cn/20200823143715566.png?1x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTk2MTc3NA==,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述" loading="lazy"></p><hr><h5 id="完整源代码："><a href="#完整源代码：" class="headerlink" title="完整源代码："></a>完整源代码：</h5><p><a href="https://github.com/Giyn/PythonSpider/blob/master/MeiTuan/CollegeTownFood/college_town_food.py">https://github.com/Giyn/PythonSpider/blob/master/MeiTuan/CollegeTownFood/college_town_food.py</a></p>]]></content>
      
      
      <categories>
          
          <category> WebScraper </category>
          
      </categories>
      
      
        <tags>
            
            <tag> WebScraper </tag>
            
            <tag> Selenium </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多进程爬取豆瓣电影 Top250 并存入 MongoDB 数据库</title>
      <link href="/posts/9b785215/"/>
      <url>/posts/9b785215/</url>
      
        <content type="html"><![CDATA[<h2 id="该爬虫大致分为以下步骤："><a href="#该爬虫大致分为以下步骤：" class="headerlink" title="该爬虫大致分为以下步骤："></a>该爬虫大致分为以下步骤：</h2><h5 id="1-获取豆瓣电影-Top250-页面的-10-个分页的-URL。"><a href="#1-获取豆瓣电影-Top250-页面的-10-个分页的-URL。" class="headerlink" title="1. 获取豆瓣电影 Top250 页面的 10 个分页的 URL。"></a>1. <strong>获取豆瓣电影 Top250 页面的 10 个分页的 URL</strong>。</h5><h5 id="2-通过解析-10-个分页的-HTML-获取每个分页-25-部电影的-URL。"><a href="#2-通过解析-10-个分页的-HTML-获取每个分页-25-部电影的-URL。" class="headerlink" title="2. 通过解析 10 个分页的 HTML 获取每个分页 25 部电影的 URL。"></a>2. <strong>通过解析 10 个分页的 HTML 获取每个分页 25 部电影的 URL。</strong></h5><h5 id="3-获取每部电影的-HTML-代码并解析提取电影信息。"><a href="#3-获取每部电影的-HTML-代码并解析提取电影信息。" class="headerlink" title="3. 获取每部电影的 HTML 代码并解析提取电影信息。"></a>3. <strong>获取每部电影的 HTML 代码并解析提取电影信息</strong>。</h5><h5 id="4-将提取的信息保存为-dict-形式并存入-MongoDB-数据库。"><a href="#4-将提取的信息保存为-dict-形式并存入-MongoDB-数据库。" class="headerlink" title="4. 将提取的信息保存为 dict 形式并存入 MongoDB 数据库。"></a>4. <strong>将提取的信息保存为 dict 形式并存入 MongoDB 数据库。</strong></h5><blockquote><p>MySQL 对于一些结构化或嵌套类型的数据存储起来不太方便，且需要额外维护字段信息，相对麻烦。而 MongoDB 相对更方便，性能也很强，适合存储该类数据。</p></blockquote><h5 id="5-设计多进程爬虫以提高效率。"><a href="#5-设计多进程爬虫以提高效率。" class="headerlink" title="5. 设计多进程爬虫以提高效率。"></a>5. <strong>设计多进程爬虫以提高效率</strong>。</h5><hr><h3 id="一、首先分析-10-个分页的-URL-规律"><a href="#一、首先分析-10-个分页的-URL-规律" class="headerlink" title="一、首先分析 10 个分页的 URL 规律"></a>一、首先分析 10 个分页的 URL 规律</h3><img src="https://img-blog.csdnimg.cn/20200609214652613.png" width="50%" loading="lazy"><p>进入第二页之后，查看此时的 URL 为 <code>https://movie.douban.com/top250?start=25&amp;filter=</code></p><img src="https://img-blog.csdnimg.cn/20200609214842677.png" width="50%" loading="lazy"><p>进入第二页之后，查看此时的 URL 为 <code>https://movie.douban.com/top250?start=50&amp;filter=</code></p><p>……</p><p><strong>显然此处通过 start 参数来控制分页，因此我们通过如下代码来获取 10 个分页：</strong></p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">get_html</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    @功能: 爬取网页并获取其HTML代码    @参数: 网页URL    @返回: 网页的HTML代码    """</span>    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'scraping %s...'</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">,</span> headers<span class="token operator">=</span>random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>headers<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> response<span class="token punctuation">.</span>text        logging<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">'get invalid status code %s while scraping %s'</span><span class="token punctuation">,</span> response<span class="token punctuation">.</span>status_code<span class="token punctuation">,</span> url<span class="token punctuation">)</span>    <span class="token keyword">except</span> requests<span class="token punctuation">.</span>RequestException<span class="token punctuation">:</span>        logging<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">'error occurred while scraping %s'</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> exc_info<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">get_page_html</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    @功能: 获取外部页面的HTML代码    @参数: 页面索引    @返回: 外部页面的HTML代码    """</span>    page_url <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"https://movie.douban.com/top250?start=</span><span class="token interpolation"><span class="token punctuation">&#123;</span>index<span class="token punctuation">&#125;</span></span><span class="token string">&amp;filter="</span></span>    <span class="token keyword">return</span> get_html<span class="token punctuation">(</span>page_url<span class="token punctuation">)</span></code></pre><hr><h3 id="二、解析分页的-HTML-并获取每个分页-25-部电影的-URL"><a href="#二、解析分页的-HTML-并获取每个分页-25-部电影的-URL" class="headerlink" title="二、解析分页的 HTML 并获取每个分页 25 部电影的 URL"></a>二、解析分页的 HTML 并获取每个分页 25 部电影的 URL</h3><p>分析 HTML 代码并提取出每部电影的 URL：<br><img src="https://img-blog.csdnimg.cn/20200609215654112.png" width="100%" loading="lazy"></p><p>使用 XPath Helper 检验一下：<br><img src="https://img-blog.csdnimg.cn/20200609215932690.png" alt="在这里插入图片描述" loading="lazy"></p><p><strong>代码如下：</strong></p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">get_movies_url</span><span class="token punctuation">(</span>page_html<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    @功能: 从外部页面获取每部电影的URL    @参数: 每个外部页面的HTML代码    @返回: 每个外部页面的URL    """</span>    doc <span class="token operator">=</span> etree<span class="token punctuation">.</span>HTML<span class="token punctuation">(</span>page_html<span class="token punctuation">)</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">26</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        movie_url <span class="token operator">=</span> doc<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'//ol/li[&#123;&#125;]/div/div[2]/div[1]/a/@href'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># 提取每部电影的URL</span>        logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'get movie url %s'</span><span class="token punctuation">,</span> movie_url<span class="token punctuation">)</span>        <span class="token keyword">yield</span> movie_url</code></pre><hr><h3 id="三、解析每部电影并提取信息，然后将提取的信息保存为-dict-形式"><a href="#三、解析每部电影并提取信息，然后将提取的信息保存为-dict-形式" class="headerlink" title="三、解析每部电影并提取信息，然后将提取的信息保存为 dict 形式"></a>三、解析每部电影并提取信息，然后将提取的信息保存为 dict 形式</h3><p><strong>代码如下：</strong></p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">parse_movie</span><span class="token punctuation">(</span>movie_html<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    @功能: 解析每部电影的信息并提取    @参数: 对应电影的HTML代码    @返回: dict形式的电影信息    """</span>    doc <span class="token operator">=</span> etree<span class="token punctuation">.</span>HTML<span class="token punctuation">(</span>movie_html<span class="token punctuation">)</span>  <span class="token comment"># 解析电影HTML代码</span>    cover <span class="token operator">=</span> doc<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">"//div[3]/div[1]/div[3]/div[1]/div[1]/div[1]/div[1]/div[1]/a/img/@src"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    name <span class="token operator">=</span> doc<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">"//div[3]/div[1]/h1/span[1]/text()"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    rating_num <span class="token operator">=</span> doc<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">"//div[3]/div[1]/div[3]/div[1]/div[1]/div[1]/div[2]/div[1]/div[2]/div/div[2]/a/span/text()"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    date <span class="token operator">=</span> doc<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">"//div[3]/div[1]/h1/span[2]/text()"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    info <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>doc<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">"//div[@class='related-info']/div[@id='link-report']/span/text()"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'\xa0'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">u'\u3000'</span><span class="token punctuation">,</span> <span class="token string">u' '</span><span class="token punctuation">)</span>    score <span class="token operator">=</span> doc<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">"//div[3]/div[1]/div[3]/div[1]/div[1]/div[1]/div[2]/div[1]/div[2]/strong/text()"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    score <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>score<span class="token punctuation">)</span> <span class="token keyword">if</span> score <span class="token keyword">else</span> <span class="token boolean">None</span>       <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>        <span class="token string">'cover'</span><span class="token punctuation">:</span> cover<span class="token punctuation">,</span>        <span class="token string">'name'</span><span class="token punctuation">:</span> name<span class="token punctuation">,</span>        <span class="token string">'rating_num'</span><span class="token punctuation">:</span> rating_num<span class="token punctuation">,</span>        <span class="token string">'date'</span><span class="token punctuation">:</span> date<span class="token punctuation">,</span>        <span class="token string">'info'</span><span class="token punctuation">:</span> info<span class="token punctuation">,</span>        <span class="token string">'score'</span><span class="token punctuation">:</span> score    <span class="token punctuation">&#125;</span></code></pre><h3 id="四、将提取到的电影信息存入-MongoDB-数据库"><a href="#四、将提取到的电影信息存入-MongoDB-数据库" class="headerlink" title="四、将提取到的电影信息存入 MongoDB 数据库"></a>四、将提取到的电影信息存入 MongoDB 数据库</h3><pre class="language-python" data-language="python"><code class="language-python">MONGO_CONNECTION_STRING <span class="token operator">=</span> <span class="token string">'mongodb://localhost:27017'</span>  <span class="token comment"># MongoDB的连接字符串</span>MONGO_DB_NAME <span class="token operator">=</span> <span class="token string">'movies'</span>  <span class="token comment"># 数据库名称</span>MONGO_COLLECTION_NAME <span class="token operator">=</span> <span class="token string">'movies1'</span>  <span class="token comment"># 集合名称</span>client <span class="token operator">=</span> pymongo<span class="token punctuation">.</span>MongoClient<span class="token punctuation">(</span>MONGO_CONNECTION_STRING<span class="token punctuation">)</span>  <span class="token comment"># 创建MongoDB的连接对象</span>db <span class="token operator">=</span> client<span class="token punctuation">[</span><span class="token string">'movies'</span><span class="token punctuation">]</span>  <span class="token comment"># 指定数据库</span>collection <span class="token operator">=</span> db<span class="token punctuation">[</span><span class="token string">'douban_movies'</span><span class="token punctuation">]</span>  <span class="token comment"># 指定集合</span><span class="token keyword">def</span> <span class="token function">save_to_MongoDB</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    @功能: 把电影数据存入MongoDB数据库    @参数: dict形式的电影信息    @返回: 无    """</span>    collection<span class="token punctuation">.</span>update_one<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>        <span class="token string">'name'</span><span class="token punctuation">:</span> data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>        <span class="token string">'$set'</span><span class="token punctuation">:</span> data    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> upsert<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></code></pre><hr><h3 id="五、设计多进程爬虫以提高效率"><a href="#五、设计多进程爬虫以提高效率" class="headerlink" title="五、设计多进程爬虫以提高效率"></a>五、设计多进程爬虫以提高效率</h3><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">scrape_html</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    @功能: 爬取网页并获取其HTML代码    @参数: 网页URL    @返回: 网页的HTML代码    """</span>    <span class="token keyword">return</span> get_html<span class="token punctuation">(</span>url<span class="token punctuation">)</span>  <span class="token comment"># 代码复用,降低耦合度</span><span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span>page_index<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    @功能: 每个线程    @参数: 电影页面索引    @返回: 无    """</span>    page_html <span class="token operator">=</span> get_page_html<span class="token punctuation">(</span>page_index<span class="token punctuation">)</span>    movies_url <span class="token operator">=</span> get_movies_url<span class="token punctuation">(</span>page_html<span class="token punctuation">)</span>    <span class="token keyword">for</span> movie_url <span class="token keyword">in</span> movies_url<span class="token punctuation">:</span>        movie_html <span class="token operator">=</span> scrape_html<span class="token punctuation">(</span>movie_url<span class="token punctuation">)</span>        data <span class="token operator">=</span> parse_movie<span class="token punctuation">(</span>movie_html<span class="token punctuation">)</span>                logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'get data %s'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>        logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'saving data to mongodb'</span><span class="token punctuation">)</span>        save_to_MongoDB<span class="token punctuation">(</span>data<span class="token punctuation">)</span>        logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'data saved successfully'</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    pool <span class="token operator">=</span> multiprocessing<span class="token punctuation">.</span>Pool<span class="token punctuation">(</span><span class="token punctuation">)</span>    page_indexs <span class="token operator">=</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">250</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">)</span>    pool<span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span>main<span class="token punctuation">,</span> page_indexs<span class="token punctuation">)</span>    pool<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><hr><p><strong>运行代码，结果如下：</strong></p><img src="https://img-blog.csdnimg.cn/20200609220745209.png" width="100%" loading="lazy"><p>可以看到电影数据已经成功存入 MongoDB 数据库，此处使用 Robo 3T 进行可视化。</p><hr><h4 id="完整源代码"><a href="#完整源代码" class="headerlink" title="完整源代码"></a><a href="https://github.com/Giyn/PythonSpider/blob/master/DouBanMoviesSpiders/crawl%20douban_movies%20%26%20store%20to%20MongoDB.py">完整源代码</a></h4>]]></content>
      
      
      <categories>
          
          <category> WebScraper </category>
          
      </categories>
      
      
        <tags>
            
            <tag> requests </tag>
            
            <tag> WebScraper </tag>
            
            <tag> MultiProcessing </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Selenium 的基本使用</title>
      <link href="/posts/9c128aa7/"/>
      <url>/posts/9c128aa7/</url>
      
        <content type="html"><![CDATA[<h2 id="为何使用-Selenium"><a href="#为何使用-Selenium" class="headerlink" title="为何使用 Selenium"></a>为何使用 Selenium</h2><p>在很多情况下，Ajax 请求的接口通常会包含加密的参数。由于接口的请求加上了参数，如果不深入分析并找到构造逻辑，是难以直接模拟这些 Ajax 请求的。</p><p>此时解决方法通常有两种，一种是深挖其中的逻辑，把其中的构造逻辑完全找出来，再用 Python 复现，构造 Ajax 请求；另外一种方法就是直接通过模拟浏览器的方式，绕过这个过程。</p><p>此处可以使用 Selenium 工具模拟浏览器爬取。</p><blockquote><p>Selenium 是一个自动化测试工具，利用它可以驱动浏览器执行特定的动作，如点击、下拉等操作，同时还可以获取浏览器当前呈现的页面源代码，做到可见即可爬。对于一些使用 JavaScript 动态渲染的页面来说，此种抓取方式非常有效。</p></blockquote><hr><h2 id="Selenium的用法"><a href="#Selenium的用法" class="headerlink" title="Selenium的用法"></a>Selenium的用法</h2><h5 id="声明浏览器对象："><a href="#声明浏览器对象：" class="headerlink" title="声明浏览器对象："></a>声明浏览器对象：</h5><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> selenium <span class="token keyword">import</span> webdriverbrowser <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Chrome<span class="token punctuation">(</span><span class="token punctuation">)</span> browser <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Firefox<span class="token punctuation">(</span><span class="token punctuation">)</span> browser <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Edge<span class="token punctuation">(</span><span class="token punctuation">)</span> browser <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Safari<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>这样就完成了浏览器对象的初始化并将其赋值为 browser 对象。接下来要做的就是调用 browser 对象，让其执行各个动作以模拟浏览器操作。</p><hr><h5 id="访问页面："><a href="#访问页面：" class="headerlink" title="访问页面："></a>访问页面：</h5><p>可以用 get 方法来请求网页，只需要把参数传入链接 URL 即可。比如，这里用 get 方法访问百度，然后打印出源代码，代码如下：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> time<span class="token keyword">from</span> selenium <span class="token keyword">import</span> webdriverbrowser <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Chrome<span class="token punctuation">(</span><span class="token punctuation">)</span>browser<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'https://www.baidu.com'</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>browser<span class="token punctuation">.</span>page_source<span class="token punctuation">)</span>time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>browser<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>运行代码后会弹出 Chrome 浏览器并且自动访问百度，然后控制台会输出百度页面的源代码，10 秒后浏览器关闭。</p><img src="https://img-blog.csdnimg.cn/20200712223004852.png" width="80%" loading="lazy"><img src="https://img-blog.csdnimg.cn/20200712223506994.png" width="80%" loading="lazy"><hr><h5 id="查找节点"><a href="#查找节点" class="headerlink" title="查找节点"></a>查找节点</h5><p>Selenium 可以驱动浏览器完成各种操作，比如填充表单、模拟点击等。当我们想要完成向某个输入框输入文字的操作时，首先需要知道这个输入框在哪，而 Selenium 提供了一系列查找节点的方法，可以用这些方法来获取想要的节点，以便执行下一步动作或者提取信息。</p><h6 id="单个节点"><a href="#单个节点" class="headerlink" title="单个节点"></a>单个节点</h6><p>当我们想要从百度页面中提取搜索框节点，首先要观察它的源代码：<br><img src="https://img-blog.csdnimg.cn/20200712223843444.png?0x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTk2MTc3NA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" loading="lazy"></p><p>可以发现，它的 id 是 kw，name 是 wd，此外还有许多其他属性。此时我们就可以用多种方式获取它了。比如，find_element_by_name 代表根据 name 值获取，find_element_by_id 则是根据 id 获取，另外，还有根据 XPath、CSS 选择器等获取的方式：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> selenium <span class="token keyword">import</span> webdriverbrowser<span class="token operator">=</span>webdriver<span class="token punctuation">.</span>Chrome<span class="token punctuation">(</span><span class="token punctuation">)</span>browser<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'https://www.baidu.com'</span><span class="token punctuation">)</span>input_first <span class="token operator">=</span> browser<span class="token punctuation">.</span>find_element_by_id<span class="token punctuation">(</span><span class="token string">'kw'</span><span class="token punctuation">)</span>input_second <span class="token operator">=</span> browser<span class="token punctuation">.</span>find_element_by_xpath<span class="token punctuation">(</span><span class="token string">'//*[@id="kw"]'</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>input_first<span class="token punctuation">,</span> input_second<span class="token punctuation">)</span>browser<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p><strong>Output：</strong></p><pre class="language-none"><code class="language-none">&lt;selenium.webdriver.remote.webelement.WebElement (session&#x3D;&quot;d2f6a6403d125ae6df4055652621ac0e&quot;, element&#x3D;&quot;27afc75f-3751-482e-b62b-2721b02c9e98&quot;)&gt;&lt;selenium.webdriver.remote.webelement.WebElement (session&#x3D;&quot;d2f6a6403d125ae6df4055652621ac0e&quot;, element&#x3D;&quot;27afc75f-3751-482e-b62b-2721b02c9e98&quot;)&gt;</code></pre><pre class="language-none"><code class="language-none">这里列出所有获取单个节点的方法：find_element_by_id find_element_by_name find_element_by_xpath find_element_by_link_text find_element_by_partial_link_text find_element_by_tag_name find_element_by_class_name find_element_by_css_selector</code></pre><p>另外，Selenium 还提供了 find_element 这个通用方法，它需要传入两个参数：查找方式 By 和值：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> selenium <span class="token keyword">import</span> webdriver<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver<span class="token punctuation">.</span>common<span class="token punctuation">.</span>by <span class="token keyword">import</span> Bybrowser <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Chrome<span class="token punctuation">(</span><span class="token punctuation">)</span>browser<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'https://www.taobao.com'</span><span class="token punctuation">)</span>input_ <span class="token operator">=</span> browser<span class="token punctuation">.</span>find_element<span class="token punctuation">(</span>By<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> <span class="token string">'q'</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>input_<span class="token punctuation">)</span>browser<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>这种查找方式的功能和上面列举的查找函数完全一致，不过参数更加灵活。</p><h6 id="多个节点"><a href="#多个节点" class="headerlink" title="多个节点"></a>多个节点</h6><p>如果在网页中有多个节点需要查找，要用 find_elements 这样的方法，例如要获取百度热榜的内容：</p><img src="https://img-blog.csdnimg.cn/20200712231820492.png" width="40%" loading="lazy"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> time<span class="token keyword">from</span> selenium <span class="token keyword">import</span> webdriverbrowser <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Chrome<span class="token punctuation">(</span><span class="token punctuation">)</span>browser<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'https://www.baidu.com'</span><span class="token punctuation">)</span>lis<span class="token operator">=</span>browser<span class="token punctuation">.</span>find_elements_by_xpath<span class="token punctuation">(</span><span class="token string">"//div[1]/div[1]/div[5]/div/div/div[3]/ul/li"</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>lis<span class="token punctuation">)</span>time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>browser<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p><strong>Output：</strong></p><pre class="language-none"><code class="language-none">[&lt;selenium.webdriver.remote.webelement.WebElement (session&#x3D;&quot;e72283ba0c520929c93f1a9075ebdd8f&quot;, element&#x3D;&quot;d48cc9a8-c10b-4762-a8c3-b333d16c0050&quot;)&gt;, &lt;selenium.webdriver.remote.webelement.WebElement (session&#x3D;&quot;e72283ba0c520929c93f1a9075ebdd8f&quot;, element&#x3D;&quot;b130131c-fdd7-4e3f-af04-20a4b9007d5d&quot;)&gt;, &lt;selenium.webdriver.remote.webelement.WebElement (session&#x3D;&quot;e72283ba0c520929c93f1a9075ebdd8f&quot;, element&#x3D;&quot;b2251221-348d-4f28-ba07-46f22e14de1f&quot;)&gt;, &lt;selenium.webdriver.remote.webelement.WebElement (session&#x3D;&quot;e72283ba0c520929c93f1a9075ebdd8f&quot;, element&#x3D;&quot;98b63893-bdc6-473a-bcad-68301ad5e5de&quot;)&gt;, &lt;selenium.webdriver.remote.webelement.WebElement (session&#x3D;&quot;e72283ba0c520929c93f1a9075ebdd8f&quot;, element&#x3D;&quot;aa0d225e-fd9a-4b94-8900-7cad59849755&quot;)&gt;, &lt;selenium.webdriver.remote.webelement.WebElement (session&#x3D;&quot;e72283ba0c520929c93f1a9075ebdd8f&quot;, element&#x3D;&quot;667d8cb3-8500-4d7f-868b-38c0d90af961&quot;)&gt;]</code></pre><p>可以看到，得到的内容变成了列表类型，列表中的每个节点都是 WebElement 类型。</p><blockquote><p>如果用 find_element 方法，只能获取匹配的第一个节点，结果是 WebElement 类型。<br>如果用 find_elements 方法，则结果是列表类型，列表中的每个节点是 WebElement 类型。</p></blockquote><pre class="language-none"><code class="language-none">这里列出所有获取多个节点的方法：find_elements_by_id find_elements_by_name find_elements_by_xpath find_elements_by_link_text find_elements_by_partial_link_text find_elements_by_tag_name find_elements_by_class_name find_elements_by_css_selector</code></pre><hr><h5 id="节点交互"><a href="#节点交互" class="headerlink" title="节点交互"></a>节点交互</h5><p>Selenium 可以驱动浏览器来执行一些操作，或者说可以让浏览器模拟执行一些动作。比较常见的用法有：输入文字时用 send_keys 方法，清空文字时用 clear 方法，点击按钮时用 click 方法，举个例子：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> selenium <span class="token keyword">import</span> webdriver<span class="token keyword">import</span> timebrowser <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Chrome<span class="token punctuation">(</span><span class="token punctuation">)</span>browser<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'https://www.baidu.com'</span><span class="token punctuation">)</span>input_ <span class="token operator">=</span> browser<span class="token punctuation">.</span>find_element_by_xpath<span class="token punctuation">(</span><span class="token string">'//div[1]/div[1]/div[5]/div/div/form/span[1]/input'</span><span class="token punctuation">)</span>input_<span class="token punctuation">.</span>send_keys<span class="token punctuation">(</span><span class="token string">'Python'</span><span class="token punctuation">)</span>time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>input_<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>input_<span class="token punctuation">.</span>send_keys<span class="token punctuation">(</span><span class="token string">'许继元'</span><span class="token punctuation">)</span>button <span class="token operator">=</span> browser<span class="token punctuation">.</span>find_element_by_xpath<span class="token punctuation">(</span><span class="token string">'//div[1]/div[1]/div[5]/div/div/form/span[2]/input'</span><span class="token punctuation">)</span>button<span class="token punctuation">.</span>click<span class="token punctuation">(</span><span class="token punctuation">)</span>time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>browser<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><hr><h5 id="动作链"><a href="#动作链" class="headerlink" title="动作链"></a>动作链</h5><p>除了针对某个节点执行的一些交互动作，还有另外一些操作，它们没有特定的执行对象，比如鼠标拖拽、键盘按键等，这些动作用另一种方式来执行，那就是动作链。举个例子，现在要实现将某个节点从一处拖拽到另外一处：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> selenium <span class="token keyword">import</span> webdriver<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver <span class="token keyword">import</span> ActionChainsbrowser <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Chrome<span class="token punctuation">(</span><span class="token punctuation">)</span>url <span class="token operator">=</span> <span class="token string">'http://www.runoob.com/try/try.php?filename=jqueryui-api-droppable'</span>browser<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span>browser<span class="token punctuation">.</span>switch_to<span class="token punctuation">.</span>frame<span class="token punctuation">(</span><span class="token string">'iframeResult'</span><span class="token punctuation">)</span>source <span class="token operator">=</span> browser<span class="token punctuation">.</span>find_element_by_xpath<span class="token punctuation">(</span><span class="token string">'//*[@id="draggable"]'</span><span class="token punctuation">)</span>target <span class="token operator">=</span> browser<span class="token punctuation">.</span>find_element_by_xpath<span class="token punctuation">(</span><span class="token string">'//*[@id="droppable"]'</span><span class="token punctuation">)</span>actions <span class="token operator">=</span> ActionChains<span class="token punctuation">(</span>browser<span class="token punctuation">)</span>actions<span class="token punctuation">.</span>drag_and_drop<span class="token punctuation">(</span>source<span class="token punctuation">,</span> target<span class="token punctuation">)</span>actions<span class="token punctuation">.</span>perform<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><hr><h5 id="执行-JavaScript"><a href="#执行-JavaScript" class="headerlink" title="执行 JavaScript"></a>执行 JavaScript</h5><p>Selenium API 并没有提供实现某些操作的方法，比如下拉进度条。但它可以直接模拟运行 JavaScript，此时使用 execute_script 方法即可实现：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> selenium <span class="token keyword">import</span> webdriverbrowser <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Chrome<span class="token punctuation">(</span><span class="token punctuation">)</span>browser<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'https://www.zhihu.com/explore'</span><span class="token punctuation">)</span>browser<span class="token punctuation">.</span>execute_script<span class="token punctuation">(</span><span class="token string">'window.scrollTo(0, document.body.scrollHeight)'</span><span class="token punctuation">)</span>browser<span class="token punctuation">.</span>execute_script<span class="token punctuation">(</span><span class="token string">'alert("To Bottom")'</span><span class="token punctuation">)</span></code></pre><p>这里利用 execute_script 方法将进度条下拉到最底部，然后弹出 alert 提示框。</p><p>有了这个方法，基本上 API 没有提供的所有功能都可以用执行 JavaScript 的方式来实现了。</p><hr><h5 id="获取节点信息"><a href="#获取节点信息" class="headerlink" title="获取节点信息"></a>获取节点信息</h5><p>通过 page_source 属性可以获取网页的源代码，接着使用解析库提取信息。但 Selenium 提供了选择节点的方法，并且返回的是 WebElement 类型，则它也有相关的方法和属性来直接提取节点信息，如属性、文本等。这样就可以不用通过解析源代码来提取信息了。</p><h6 id="获取属性"><a href="#获取属性" class="headerlink" title="获取属性"></a>获取属性</h6><p>先选中节点，再使用 get_attribute 方法来获取节点的属性：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> selenium <span class="token keyword">import</span> webdriverbrowser <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Chrome<span class="token punctuation">(</span><span class="token punctuation">)</span>url <span class="token operator">=</span> <span class="token string">'https://www.baidu.com/'</span>browser<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span>logo <span class="token operator">=</span> browser<span class="token punctuation">.</span>find_element_by_class_name<span class="token punctuation">(</span><span class="token string">'s-hotsearch-content'</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>logo<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>logo<span class="token punctuation">.</span>get_attribute<span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><p><strong>Output：</strong></p><pre class="language-none"><code class="language-none">&lt;selenium.webdriver.remote.webelement.WebElement (session&#x3D;&quot;93869ad40b93b047111cb97606815423&quot;, element&#x3D;&quot;8b32fd1f-b592-4c4f-a651-63f19caaa524&quot;)&gt;hotsearch-content-wrapper</code></pre><h6 id="获取文本值"><a href="#获取文本值" class="headerlink" title="获取文本值"></a>获取文本值</h6><p>每个 WebElement 节点都有 text 属性，直接调用这个属性就可以得到节点内部的文本信息：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> selenium <span class="token keyword">import</span> webdriverbrowser <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Chrome<span class="token punctuation">(</span><span class="token punctuation">)</span>url <span class="token operator">=</span> <span class="token string">'https://www.baidu.com/'</span>browser<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span>input_ <span class="token operator">=</span> browser<span class="token punctuation">.</span>find_element_by_class_name<span class="token punctuation">(</span><span class="token string">'hot-title'</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>input_<span class="token punctuation">.</span>text<span class="token punctuation">)</span></code></pre><p><strong>Output：</strong></p><pre class="language-none"><code class="language-none">百度热榜</code></pre><hr><h5 id="获取-ID、位置、标签名、大小"><a href="#获取-ID、位置、标签名、大小" class="headerlink" title="获取 ID、位置、标签名、大小"></a>获取 ID、位置、标签名、大小</h5><p>WebElement 节点还有其他属性，比如 id 属性可以获取节点 id，location 属性可以获取该节点在页面中的相对位置，tag_name 属性可以获取标签名称，size 属性可以获取节点的大小，也就是宽高，例如：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> selenium <span class="token keyword">import</span> webdriverbrowser <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Chrome<span class="token punctuation">(</span><span class="token punctuation">)</span>url <span class="token operator">=</span> <span class="token string">'https://www.bilibili.com/'</span>browser<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span>input_ <span class="token operator">=</span> browser<span class="token punctuation">.</span>find_element_by_class_name<span class="token punctuation">(</span><span class="token string">'primary-menu-itnl'</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>input_<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>input_<span class="token punctuation">.</span>location<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>input_<span class="token punctuation">.</span>tag_name<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>input_<span class="token punctuation">.</span>size<span class="token punctuation">)</span></code></pre><p>Output：</p><pre class="language-none"><code class="language-none">7ad2640f-b1cf-4635-8178-eddce14e73b4&#123;&#39;x&#39;: 10, &#39;y&#39;: 155&#125;div&#123;&#39;height&#39;: 108, &#39;width&#39;: 999&#125;</code></pre><hr><h5 id="切换-Frame"><a href="#切换-Frame" class="headerlink" title="切换 Frame"></a>切换 Frame</h5><p>网页中有一种节点叫作 iframe，也就是子 Frame，相当于页面的子页面，它的结构和外部网页的结构完全一致。Selenium 打开页面后，默认是在父级 Frame 里面操作，而此时如果页面中还有子 Frame，Selenium 是不能获取到子 Frame 里面的节点的。这时就需要使用 switch_to.frame 方法来切换 Frame：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> selenium <span class="token keyword">import</span> webdriver<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>common<span class="token punctuation">.</span>exceptions <span class="token keyword">import</span> NoSuchElementExceptionbrowser <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Chrome<span class="token punctuation">(</span><span class="token punctuation">)</span>url <span class="token operator">=</span> <span class="token string">'http://www.runoob.com/try/try.php?filename=jqueryui-api-droppable'</span>browser<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span>browser<span class="token punctuation">.</span>switch_to<span class="token punctuation">.</span>frame<span class="token punctuation">(</span><span class="token string">'iframeResult'</span><span class="token punctuation">)</span><span class="token keyword">try</span><span class="token punctuation">:</span>    logo <span class="token operator">=</span> browser<span class="token punctuation">.</span>find_element_by_class_name<span class="token punctuation">(</span><span class="token string">'logo'</span><span class="token punctuation">)</span><span class="token keyword">except</span> NoSuchElementException<span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'NO LOGO'</span><span class="token punctuation">)</span>browser<span class="token punctuation">.</span>switch_to<span class="token punctuation">.</span>parent_frame<span class="token punctuation">(</span><span class="token punctuation">)</span>logo <span class="token operator">=</span> browser<span class="token punctuation">.</span>find_element_by_class_name<span class="token punctuation">(</span><span class="token string">'logo'</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>logo<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>logo<span class="token punctuation">.</span>text<span class="token punctuation">)</span></code></pre><p>首先通过 switch_to.frame 方法切换到子 Frame 里面，然后尝试获取子 Frame 里的 logo 节点（实际上是不能找到的），若找不到，就会抛出 NoSuchElementException 异常。接下来切换回父级 Frame，然后重新获取节点，则可以成功获取。</p><p><strong>Output：</strong></p><pre class="language-none"><code class="language-none">NO LOGO&lt;selenium.webdriver.remote.webelement.WebElement (session&#x3D;&quot;70eb5ef47851fceefb1b7cd9a0c5026e&quot;, element&#x3D;&quot;a4000bc2-1bb7-4e88-960d-a61a7b69eb7c&quot;)&gt;RUNOOB.COM</code></pre><p>当页面中包含子 Frame 时，如果想获取子 Frame 中的节点，需要先调用 switch_to.frame 方法切换到对应的 Frame，然后再进行操作。</p><hr><h5 id="延时等待"><a href="#延时等待" class="headerlink" title="延时等待"></a>延时等待</h5><p>在 Selenium 中，get 方法会在网页框架加载结束后结束执行，此时如果获取 page_source，可能并不是浏览器完全加载完成的页面，如果某些页面有额外的 Ajax 请求，我们在网页源代码中不一定能成功获取到。所以，这里需要延时等待一定时间，确保节点已经加载出来。</p><p>这里等待的方式有两种：一种是隐式等待，一种是显式等待。</p><h6 id="隐式等待"><a href="#隐式等待" class="headerlink" title="隐式等待"></a>隐式等待</h6><p>当使用隐式等待执行测试的时候，如果 Selenium 没有在 DOM 中找到节点，将继续等待，超出设定时间后，则抛出找不到节点的异常。换句话说，隐式等待可以在我们查找节点而节点并没有立即出现的时候，等待一段时间再查找 DOM，默认的时间是 0。例如：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> selenium <span class="token keyword">import</span> webdriverbrowser <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Chrome<span class="token punctuation">(</span><span class="token punctuation">)</span>browser<span class="token punctuation">.</span>implicitly_wait<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>browser<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'https://www.bilibili.com/'</span><span class="token punctuation">)</span>input_ <span class="token operator">=</span> browser<span class="token punctuation">.</span>find_element_by_class_name<span class="token punctuation">(</span><span class="token string">'logo-img'</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>input_<span class="token punctuation">)</span></code></pre><p><strong>Output：</strong></p><pre class="language-none"><code class="language-none">&lt;selenium.webdriver.remote.webelement.WebElement (session&#x3D;&quot;f8a1bdd5fca3e2e3f1d1081bdf8dd94a&quot;, element&#x3D;&quot;dd78cc2c-bab0-4a8e-8215-d9d0dcdab8eb&quot;)&gt;</code></pre><h6 id="显式等待"><a href="#显式等待" class="headerlink" title="显式等待"></a>显式等待</h6><p>隐式等待的效果并没有那么好，因为只规定了一个固定时间，而页面的加载时间会受到网络条件的影响。</p><p>有一种更合适的显式等待方法，它指定要查找的节点，然后指定一个最长等待时间。如果在规定时间内加载出来了这个节点，就返回查找的节点；如果到了规定时间依然没有加载出该节点，则抛出超时异常。例如：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> selenium <span class="token keyword">import</span> webdriver<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver<span class="token punctuation">.</span>common<span class="token punctuation">.</span>by <span class="token keyword">import</span> By<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver<span class="token punctuation">.</span>support<span class="token punctuation">.</span>ui <span class="token keyword">import</span> WebDriverWait<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver<span class="token punctuation">.</span>support <span class="token keyword">import</span> expected_conditions <span class="token keyword">as</span> ECbrowser <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Chrome<span class="token punctuation">(</span><span class="token punctuation">)</span>browser<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'https://www.taobao.com/'</span><span class="token punctuation">)</span>wait <span class="token operator">=</span> WebDriverWait<span class="token punctuation">(</span>browser<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>input_ <span class="token operator">=</span> wait<span class="token punctuation">.</span>until<span class="token punctuation">(</span>EC<span class="token punctuation">.</span>presence_of_element_located<span class="token punctuation">(</span><span class="token punctuation">(</span>By<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> <span class="token string">'q'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>button <span class="token operator">=</span>  wait<span class="token punctuation">.</span>until<span class="token punctuation">(</span>EC<span class="token punctuation">.</span>element_to_be_clickable<span class="token punctuation">(</span><span class="token punctuation">(</span>By<span class="token punctuation">.</span>XPATH<span class="token punctuation">,</span> <span class="token string">'/html/body/div[2]/div/div/div[2]/div/div[1]/div[2]/form/div[1]/button'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>input_<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>button<span class="token punctuation">)</span></code></pre><p>首先引入 WebDriverWait 对象，指定最长等待时间，然后调用它的 until() 方法，传入要等待条件 expected_conditions。此处传入了 presence_of_element_located 条件，代表节点出现，其参数是节点的定位元组，也就是 ID 为 q 的节点搜索框。</p><p>因此，在 10 秒内如果 ID 为 q 的节点（即搜索框）成功加载出来，就返回该节点；如果超过 10 秒还没有加载出来，就抛出异常。</p><p>对于按钮，可以更改等待条件为 element_to_be_clickable（可点击），所以查找按钮时先查找 Xpath 为 <code>/html/body/div[2]/div/div/div[2]/div/div[1]/div[2]/form/div[1]/button</code> 的按钮，如果 10 秒内它是可点击的，就代表它成功加载出来了，则返回这个按钮节点；如果超过 10 秒还不可点击，也就是没有加载出来，就抛出异常。</p><p><strong>Output：</strong></p><pre class="language-none"><code class="language-none">&lt;selenium.webdriver.remote.webelement.WebElement (session&#x3D;&quot;1dd8bab4f5f4e1d26dc29e6fd9e33275&quot;, element&#x3D;&quot;305397ec-fc99-4c4b-9762-cd1d4c94090c&quot;)&gt; &lt;selenium.webdriver.remote.webelement.WebElement (session&#x3D;&quot;1dd8bab4f5f4e1d26dc29e6fd9e33275&quot;, element&#x3D;&quot;d4118061-c3b4-44b0-8fea-0745d73c58fc&quot;)&gt;</code></pre><p>如果 10 秒内没有成功加载，则抛出 TimeoutException 异常。</p><h6 id="等待条件："><a href="#等待条件：" class="headerlink" title="等待条件："></a>等待条件：</h6><table><thead><tr><th>等待条件</th><th>含义</th></tr></thead><tbody><tr><td>title_is</td><td>标题是某内容</td></tr><tr><td>title_contains</td><td>标题包含某内容</td></tr><tr><td>presence_of_element_located</td><td>节点加载出，传入定位元组，如 (By.ID, ‘p’)</td></tr><tr><td>visibility_of_element_located</td><td>节点可见，传入定位元组</td></tr><tr><td>visibility_of</td><td>可见，传入节点对象</td></tr><tr><td>presence_of_all_elements_located</td><td>所有节点加载出</td></tr><tr><td>text_to_be_present_in_element</td><td>某个节点文本包含某文字</td></tr><tr><td>text_to_be_present_in_element_value</td><td>某个节点值包含某文字</td></tr><tr><td>frame_to_be_available_and_switch_to_it frame</td><td>加载并切换</td></tr><tr><td>invisibility_of_element_located</td><td>节点不可见</td></tr><tr><td>element_to_be_clickable</td><td>节点可点击</td></tr><tr><td>staleness_of</td><td>判断一个节点是否仍在 DOM，可判断页面是否已经刷新</td></tr><tr><td>element_to_be_selected</td><td>节点可选择，传节点对象</td></tr><tr><td>element_located_to_be_selected</td><td>节点可选择，传入定位元组</td></tr><tr><td>element_selection_state_to_be</td><td>传入节点对象以及状态，相等返回 True，否则返回 False</td></tr><tr><td>element_located_selection_state_to_be</td><td>传入定位元组以及状态，相等返回 True，否则返回 False</td></tr><tr><td>alert_is_present</td><td>是否出现 Alert</td></tr><tr><td>invisibility_of_element_located</td><td>节点不可见</td></tr></tbody></table><hr><h5 id="前进后退"><a href="#前进后退" class="headerlink" title="前进后退"></a>前进后退</h5><p>Selenium 使用 back 方法后退，使用 forward 方法前进：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> time<span class="token keyword">from</span> selenium <span class="token keyword">import</span> webdriverbrowser <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Chrome<span class="token punctuation">(</span><span class="token punctuation">)</span>browser<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'https://www.baidu.com/'</span><span class="token punctuation">)</span>browser<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'https://www.taobao.com/'</span><span class="token punctuation">)</span>browser<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'https://www.python.org/'</span><span class="token punctuation">)</span>browser<span class="token punctuation">.</span>back<span class="token punctuation">(</span><span class="token punctuation">)</span>time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>browser<span class="token punctuation">.</span>forward<span class="token punctuation">(</span><span class="token punctuation">)</span>time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>browser<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><hr><h5 id="Cookies"><a href="#Cookies" class="headerlink" title="Cookies"></a>Cookies</h5><p>Selenium 可以方便地对 Cookies 进行操作，例如获取、添加、删除 Cookies 等：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> selenium <span class="token keyword">import</span> webdriverbrowser <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Chrome<span class="token punctuation">(</span><span class="token punctuation">)</span>browser<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'https://www.zhihu.com/explore'</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>browser<span class="token punctuation">.</span>get_cookies<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>browser<span class="token punctuation">.</span>add_cookie<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'domain'</span><span class="token punctuation">:</span> <span class="token string">'www.zhihu.com'</span><span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">:</span> <span class="token string">'germey'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>browser<span class="token punctuation">.</span>get_cookies<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>browser<span class="token punctuation">.</span>delete_all_cookies<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>browser<span class="token punctuation">.</span>get_cookies<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><p><strong>Output：</strong></p><pre class="language-none"><code class="language-none">[&#123;&#39;domain&#39;: &#39;.zhihu.com&#39;, &#39;expiry&#39;: 1594790583, &#39;httpOnly&#39;: False, &#39;name&#39;: &#39;_gid&#39;, &#39;path&#39;: &#39;&#x2F;&#39;, &#39;secure&#39;: False, &#39;value&#39;: &#39;GA1.2.1462052348.1594704184&#39;&#125;, &#123;&#39;domain&#39;: &#39;.zhihu.com&#39;, &#39;expiry&#39;: 1657776183, &#39;httpOnly&#39;: False, &#39;name&#39;: &#39;_ga&#39;, &#39;path&#39;: &#39;&#x2F;&#39;, &#39;secure&#39;: False, &#39;value&#39;: &#39;GA1.2.1542833660.1594704184&#39;&#125;, &#123;&#39;domain&#39;: &#39;www.zhihu.com&#39;, &#39;httpOnly&#39;: False, &#39;name&#39;: &#39;KLBRSID&#39;, &#39;path&#39;: &#39;&#x2F;&#39;, &#39;secure&#39;: False, &#39;value&#39;: &#39;031b5396d5ab406499e2ac6fe1bb1a43|1594704183|1594704182&#39;&#125;, &#123;&#39;domain&#39;: &#39;.zhihu.com&#39;, &#39;expiry&#39;: 1626240183, &#39;httpOnly&#39;: False, &#39;name&#39;: &#39;Hm_lvt_98beee57fd2ef70ccdd5ca52b9740c49&#39;, &#39;path&#39;: &#39;&#x2F;&#39;, &#39;secure&#39;: False, &#39;value&#39;: &#39;1594704184&#39;&#125;, &#123;&#39;domain&#39;: &#39;.zhihu.com&#39;, &#39;httpOnly&#39;: False, &#39;name&#39;: &#39;Hm_lpvt_98beee57fd2ef70ccdd5ca52b9740c49&#39;, &#39;path&#39;: &#39;&#x2F;&#39;, &#39;secure&#39;: False, &#39;value&#39;: &#39;1594704184&#39;&#125;, &#123;&#39;domain&#39;: &#39;.zhihu.com&#39;, &#39;expiry&#39;: 1594704243, &#39;httpOnly&#39;: False, &#39;name&#39;: &#39;_gat_gtag_UA_149949619_1&#39;, &#39;path&#39;: &#39;&#x2F;&#39;, &#39;secure&#39;: False, &#39;value&#39;: &#39;1&#39;&#125;, &#123;&#39;domain&#39;: &#39;.zhihu.com&#39;, &#39;expiry&#39;: 1689312182, &#39;httpOnly&#39;: False, &#39;name&#39;: &#39;d_c0&#39;, &#39;path&#39;: &#39;&#x2F;&#39;, &#39;secure&#39;: False, &#39;value&#39;: &#39;&quot;ABBSJ1oFkxGPTirgBoF55isXJsyZ7AHpPfI&#x3D;|1594704182&quot;&#39;&#125;, &#123;&#39;domain&#39;: &#39;www.zhihu.com&#39;, &#39;httpOnly&#39;: False, &#39;name&#39;: &#39;SESSIONID&#39;, &#39;path&#39;: &#39;&#x2F;&#39;, &#39;secure&#39;: False, &#39;value&#39;: &#39;9dviPRsE7McwBJnMo9mpFtJwci26vXThpMAk4aguPv2&#39;&#125;, &#123;&#39;domain&#39;: &#39;.zhihu.com&#39;, &#39;httpOnly&#39;: False, &#39;name&#39;: &#39;_xsrf&#39;, &#39;path&#39;: &#39;&#x2F;&#39;, &#39;secure&#39;: False, &#39;value&#39;: &#39;99a2430a-941e-49f1-bc70-132ac12adda6&#39;&#125;, &#123;&#39;domain&#39;: &#39;.zhihu.com&#39;, &#39;expiry&#39;: 1657776182, &#39;httpOnly&#39;: False, &#39;name&#39;: &#39;_zap&#39;, &#39;path&#39;: &#39;&#x2F;&#39;, &#39;secure&#39;: False, &#39;value&#39;: &#39;44078cd7-5d9b-4f68-a673-6dd9532aad61&#39;&#125;][&#123;&#39;domain&#39;: &#39;.www.zhihu.com&#39;, &#39;httpOnly&#39;: False, &#39;name&#39;: &#39;name&#39;, &#39;path&#39;: &#39;&#x2F;&#39;, &#39;secure&#39;: True, &#39;value&#39;: &#39;germey&#39;&#125;, &#123;&#39;domain&#39;: &#39;.zhihu.com&#39;, &#39;expiry&#39;: 1594790583, &#39;httpOnly&#39;: False, &#39;name&#39;: &#39;_gid&#39;, &#39;path&#39;: &#39;&#x2F;&#39;, &#39;secure&#39;: False, &#39;value&#39;: &#39;GA1.2.1462052348.1594704184&#39;&#125;, &#123;&#39;domain&#39;: &#39;.zhihu.com&#39;, &#39;expiry&#39;: 1657776183, &#39;httpOnly&#39;: False, &#39;name&#39;: &#39;_ga&#39;, &#39;path&#39;: &#39;&#x2F;&#39;, &#39;secure&#39;: False, &#39;value&#39;: &#39;GA1.2.1542833660.1594704184&#39;&#125;, &#123;&#39;domain&#39;: &#39;www.zhihu.com&#39;, &#39;httpOnly&#39;: False, &#39;name&#39;: &#39;KLBRSID&#39;, &#39;path&#39;: &#39;&#x2F;&#39;, &#39;secure&#39;: False, &#39;value&#39;: &#39;031b5396d5ab406499e2ac6fe1bb1a43|1594704183|1594704182&#39;&#125;, &#123;&#39;domain&#39;: &#39;.zhihu.com&#39;, &#39;expiry&#39;: 1626240183, &#39;httpOnly&#39;: False, &#39;name&#39;: &#39;Hm_lvt_98beee57fd2ef70ccdd5ca52b9740c49&#39;, &#39;path&#39;: &#39;&#x2F;&#39;, &#39;secure&#39;: False, &#39;value&#39;: &#39;1594704184&#39;&#125;, &#123;&#39;domain&#39;: &#39;.zhihu.com&#39;, &#39;httpOnly&#39;: False, &#39;name&#39;: &#39;Hm_lpvt_98beee57fd2ef70ccdd5ca52b9740c49&#39;, &#39;path&#39;: &#39;&#x2F;&#39;, &#39;secure&#39;: False, &#39;value&#39;: &#39;1594704184&#39;&#125;, &#123;&#39;domain&#39;: &#39;.zhihu.com&#39;, &#39;expiry&#39;: 1594704243, &#39;httpOnly&#39;: False, &#39;name&#39;: &#39;_gat_gtag_UA_149949619_1&#39;, &#39;path&#39;: &#39;&#x2F;&#39;, &#39;secure&#39;: False, &#39;value&#39;: &#39;1&#39;&#125;, &#123;&#39;domain&#39;: &#39;.zhihu.com&#39;, &#39;expiry&#39;: 1689312182, &#39;httpOnly&#39;: False, &#39;name&#39;: &#39;d_c0&#39;, &#39;path&#39;: &#39;&#x2F;&#39;, &#39;secure&#39;: False, &#39;value&#39;: &#39;&quot;ABBSJ1oFkxGPTirgBoF55isXJsyZ7AHpPfI&#x3D;|1594704182&quot;&#39;&#125;, &#123;&#39;domain&#39;: &#39;www.zhihu.com&#39;, &#39;httpOnly&#39;: False, &#39;name&#39;: &#39;SESSIONID&#39;, &#39;path&#39;: &#39;&#x2F;&#39;, &#39;secure&#39;: False, &#39;value&#39;: &#39;9dviPRsE7McwBJnMo9mpFtJwci26vXThpMAk4aguPv2&#39;&#125;, &#123;&#39;domain&#39;: &#39;.zhihu.com&#39;, &#39;httpOnly&#39;: False, &#39;name&#39;: &#39;_xsrf&#39;, &#39;path&#39;: &#39;&#x2F;&#39;, &#39;secure&#39;: False, &#39;value&#39;: &#39;99a2430a-941e-49f1-bc70-132ac12adda6&#39;&#125;, &#123;&#39;domain&#39;: &#39;.zhihu.com&#39;, &#39;expiry&#39;: 1657776182, &#39;httpOnly&#39;: False, &#39;name&#39;: &#39;_zap&#39;, &#39;path&#39;: &#39;&#x2F;&#39;, &#39;secure&#39;: False, &#39;value&#39;: &#39;44078cd7-5d9b-4f68-a673-6dd9532aad61&#39;&#125;][]</code></pre><hr><h5 id="选项卡管理"><a href="#选项卡管理" class="headerlink" title="选项卡管理"></a>选项卡管理</h5><p>在访问网页的时候，我们通常会开启多个选项卡。而在 Selenium 中也可以对选项卡进行操作：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> time<span class="token keyword">from</span> selenium <span class="token keyword">import</span> webdriverbrowser <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Chrome<span class="token punctuation">(</span><span class="token punctuation">)</span>browser<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'https://www.baidu.com'</span><span class="token punctuation">)</span>browser<span class="token punctuation">.</span>execute_script<span class="token punctuation">(</span><span class="token string">'window.open()'</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>browser<span class="token punctuation">.</span>window_handles<span class="token punctuation">)</span>browser<span class="token punctuation">.</span>switch_to<span class="token punctuation">.</span>window<span class="token punctuation">(</span>browser<span class="token punctuation">.</span>window_handles<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>browser<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'https://www.taobao.com'</span><span class="token punctuation">)</span>time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>browser<span class="token punctuation">.</span>switch_to<span class="token punctuation">.</span>window<span class="token punctuation">(</span>browser<span class="token punctuation">.</span>window_handles<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>browser<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'https://python.org'</span><span class="token punctuation">)</span></code></pre><p><strong>Output：</strong></p><pre class="language-none"><code class="language-none">[&#39;CDwindow-9833CBA347F30F83AA57A71A2D98ECC7&#39;, &#39;CDwindow-4542CB4D2539341C9EF511F46A46EE6A&#39;]</code></pre><p>首先访问百度，然后调用 execute_script 方法，传入 JavaScript 语句 window.open，新开启一个选项卡，调用 window_handles 属性获取当前开启的所有选项卡的代号列表。调用 switch_to.window 方法即可切换选项卡，参数是选项卡的代号。此处将第 2 个选项卡代号传入，即跳转到第 2 个选项卡，接下来在第 2 个选项卡下访问淘宝，然后重新调用 switch_to.window 方法返回第 1 个选项卡，再访问 Python 官网。</p><hr><h5 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h5><p>在使用 Selenium 的过程中，难免会遇到一些异常，例如超时、节点未找到等错误，一旦出现此类错误，程序便不会继续运行了。这里我们可以使用 try except 语句来捕获各种异常。</p><p>首先，演示一下节点未找到的异常：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> selenium <span class="token keyword">import</span> webdriverbrowser <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Chrome<span class="token punctuation">(</span><span class="token punctuation">)</span>browser<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'https://www.baidu.com'</span><span class="token punctuation">)</span>browser<span class="token punctuation">.</span>find_element_by_id<span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span></code></pre><p><strong>Output：</strong></p><pre class="language-none"><code class="language-none">NoSuchElementException: no such element: Unable to locate element: &#123;&quot;method&quot;:&quot;css selector&quot;,&quot;selector&quot;:&quot;[id&#x3D;&quot;hello&quot;]&quot;&#125;  (Session info: chrome&#x3D;83.0.4103.116)</code></pre><p>此处抛出了 NoSuchElementException 异常，通常代表节点未找到。</p><p>为了防止程序遇到异常而中断，我们需要捕获异常：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> selenium <span class="token keyword">import</span> webdriver<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>common<span class="token punctuation">.</span>exceptions <span class="token keyword">import</span> TimeoutException<span class="token punctuation">,</span> NoSuchElementExceptionbrowser <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Chrome<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">try</span><span class="token punctuation">:</span>    browser<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'https://www.baidu.com'</span><span class="token punctuation">)</span><span class="token keyword">except</span> TimeoutException<span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Time Out'</span><span class="token punctuation">)</span><span class="token keyword">try</span><span class="token punctuation">:</span>    browser<span class="token punctuation">.</span>find_element_by_id<span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span><span class="token keyword">except</span> NoSuchElementException<span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'No Element'</span><span class="token punctuation">)</span><span class="token keyword">finally</span><span class="token punctuation">:</span>    browser<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p><strong>Output：</strong></p><pre class="language-none"><code class="language-none">No Element</code></pre><hr><h5 id="反屏蔽"><a href="#反屏蔽" class="headerlink" title="反屏蔽"></a>反屏蔽</h5><p>如今很多网站都加上了对 Selenium 的检测，来防止一些爬虫的恶意爬取。检测的基本原理是检测当前浏览器窗口下的 window.navigator 对象是否包含 webdriver 属性。在正常使用浏览器的情况下，这个属性是 undefined，一旦我们使用了 Selenium，Selenium 会给 window.navigator 设置 webdriver 属性。很多网站就通过 JavaScript 判断，如果 webdriver 属性存在，则直接屏蔽。</p><p>有一个典型的案例网站：<code>https://antispider1.scrape.cuiqingcai.com/</code>，它使用了上述原理实现了 WebDriver 的检测，如果使用 Selenium 直接爬取的话，则返回如下页面：<br><img src="https://img-blog.csdnimg.cn/20200714152051399.png?0x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTk2MTc3NA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" loading="lazy"><br>或许可以使用 JavaScript，通过调用 execute_script 方法把 webdriver 属性置空：</p><pre class="language-javascript" data-language="javascript"><code class="language-javascript">Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>navigator<span class="token punctuation">,</span> <span class="token string">"webdriver"</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">undefined</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></code></pre><p>该 JavaScript 代码的确可以把 webdriver 属性置空，但 execute_script 调用该 JavaScript 语句实际上是在页面加载完毕之后才执行的，这太迟了，网站早在最初页面渲染之前就已经对 webdriver 属性进行了检测，所以上述方法不能达到效果。</p><p>然而在 Selenium 中可以使用 CDP（Chrome Devtools-Protocol，Chrome 开发工具协议）来解决该问题，通过 CDP 可以实现在每个页面刚加载时执行 JavaScript 代码，执行的 CDP 方法为 Page.addScriptToEvaluateOnNewDocument，然后传入上述的 JavaScript 代码即可在每次页面加载之前将 webdriver 属性置空。另外可以加入几个选项来隐藏 WebDriver 提示条和自动化扩展信息：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> selenium <span class="token keyword">import</span> webdriver<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver <span class="token keyword">import</span> ChromeOptionsoption <span class="token operator">=</span> ChromeOptions<span class="token punctuation">(</span><span class="token punctuation">)</span>option<span class="token punctuation">.</span>add_experimental_option<span class="token punctuation">(</span><span class="token string">'excludeSwitches'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'enable-automation'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>option<span class="token punctuation">.</span>add_experimental_option<span class="token punctuation">(</span><span class="token string">'useAutomationExtension'</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span>browser <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Chrome<span class="token punctuation">(</span>options<span class="token operator">=</span>option<span class="token punctuation">)</span>browser<span class="token punctuation">.</span>execute_cdp_cmd<span class="token punctuation">(</span><span class="token string">'Page.addScriptToEvaluateOnNewDocument'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>   <span class="token string">'source'</span><span class="token punctuation">:</span> <span class="token string">'Object.defineProperty(navigator, "webdriver", &#123;get: () => undefined&#125;)'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>browser<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'https://antispider1.scrape.cuiqingcai.com/'</span><span class="token punctuation">)</span></code></pre><p><strong>Output：</strong></p><p><img src="https://img-blog.csdnimg.cn/20200714155451753.png?0x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTk2MTc3NA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" loading="lazy"></p><p>对于大多数的情况，以上方法均可以实现 Selenium 反屏蔽。但对于一些特殊的网站，如果其有更多的 WebDriver 特征检测，则需具体排查。</p><hr><h5 id="无头模式"><a href="#无头模式" class="headerlink" title="无头模式"></a>无头模式</h5><p>上述案例运行时，总会弹出一个浏览器窗口，虽然有助于观察页面爬取状况，但有时窗口弹来弹去也会形成干扰。</p><p>Chrome 浏览器从 60 版本已经支持了无头模式，即 Headless。无头模式在运行时不会弹出浏览器窗口，减少了干扰和一些资源（如图片等）的加载，所以在一定程度上节省了资源加载时间和网络带宽。</p><p>我们可以借助 ChromeOptions 来开启 Chrome Headless 模式：</p><pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">from</span> selenium <span class="token keyword">import</span> webdriver<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver <span class="token keyword">import</span> ChromeOptionsoption <span class="token operator">=</span> <span class="token function">ChromeOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span>option<span class="token punctuation">.</span><span class="token function">add_argument</span><span class="token punctuation">(</span><span class="token string">'--headless'</span><span class="token punctuation">)</span>browser <span class="token operator">=</span> webdriver<span class="token punctuation">.</span><span class="token function">Chrome</span><span class="token punctuation">(</span>options<span class="token operator">=</span>option<span class="token punctuation">)</span>browser<span class="token punctuation">.</span><span class="token function">set_window_size</span><span class="token punctuation">(</span><span class="token number">1366</span><span class="token punctuation">,</span> <span class="token number">768</span><span class="token punctuation">)</span>browser<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'https://www.baidu.com'</span><span class="token punctuation">)</span>browser<span class="token punctuation">.</span><span class="token function">get_screenshot_as_file</span><span class="token punctuation">(</span><span class="token string">'preview.png'</span><span class="token punctuation">)</span></code></pre><p>此处通过 ChromeOptions 的 add_argument 方法添加了参数 –headless，开启了无头模式。在无头模式下，最好设置窗口大小，接着打开页面，最后调用 get_screenshot_as_file 方法输出页面截图。</p><p>运行代码，Chrome 窗口没有弹出来，而代码依然正常运行，最后输出页面截图 <strong><code>preview.png</code>：</strong><br><img src="https://img-blog.csdnimg.cn/20200714160036407.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTk2MTc3NA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" loading="lazy"></p><p>这样就在无头模式下完成了页面的抓取和截图操作。</p><p>以上就是 Selenium 的基本使用，有了 Selenium，处理 JavaScript 渲染的页面就不难了。</p><hr><p>Reference：<a href="https://kaiwu.lagou.com/course/courseInfo.htm?courseId=46#/detail/pc?id=1675">https://kaiwu.lagou.com/course/courseInfo.htm?courseId=46#/detail/pc?id=1675</a></p>]]></content>
      
      
      <categories>
          
          <category> Selenium </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> Selenium </tag>
            
            <tag> WebCrawler </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ajax 的原理和分析</title>
      <link href="/posts/abf1e3d2/"/>
      <url>/posts/abf1e3d2/</url>
      
        <content type="html"><![CDATA[<h4 id="什么是-Ajax"><a href="#什么是-Ajax" class="headerlink" title="什么是 Ajax"></a>什么是 Ajax</h4><p>Ajax，全称为 Asynchronous JavaScript and XML，即异步的 JavaScript 和 XML。它是一种利用 JavaScript 在保证页面不被刷新、页面链接不改变的情况下与服务器交换数据并更新部分网页的技术。</p><h4 id="Ajax-的优点"><a href="#Ajax-的优点" class="headerlink" title="Ajax 的优点"></a>Ajax 的优点</h4><p>对于传统的网页，如果想更新其内容则必须刷新整个页面。有了 Ajax，便可以在页面不被全部刷新的情况下更新其内容。在此过程中，页面实际上在后台与服务器进行了数据交互，获取到数据之后，再利用 JavaScript 改变网页，这样网页内容就会更新了。如果网页的原始 HTML 不包含任何数据，数据都是通过 Ajax 统一加载后再呈现出来的，这在 Web 开发上可以做到前后端分离，并且降低服务器直接渲染页面带来的压力，也可以有效防止爬虫。</p><h4 id="尝试抓取-Ajax-加载的页面"><a href="#尝试抓取-Ajax-加载的页面" class="headerlink" title="尝试抓取 Ajax 加载的页面"></a>尝试抓取 Ajax 加载的页面</h4><p>在看到浏览器中正常显示的页面之后，尝试使用 requests 抓取页面时，得到的结果如果和在浏览器中看到的不一样，可能是因为 requests 获取的是原始 HTML 文档，而浏览器中的页面是经过 JavaScript 数据处理后生成的结果，这些数据的来源可能是通过 Ajax 加载的。</p><h4 id="如何抓取-Ajax-加载的页面"><a href="#如何抓取-Ajax-加载的页面" class="headerlink" title="如何抓取 Ajax 加载的页面"></a>如何抓取 Ajax 加载的页面</h4><p>对于 Ajax，数据加载是一种异步加载方式，原始页面不会包含某些数据，只有在加载完后，才会向服务器请求某个接口获取数据，然后数据才被处理从而呈现到网页上，这个过程实际上就是向服务器接口发送了一个 Ajax 请求。此时我们需要分析网页后台向接口发送的 Ajax 请求，用 requests 来模拟 Ajax 请求，就可以成功抓取页面了。</p><h4 id="Ajax-基本原理"><a href="#Ajax-基本原理" class="headerlink" title="Ajax 基本原理"></a>Ajax 基本原理</h4><p>发送 Ajax 请求到网页更新的过程可以简单分为以下 3 步：</p><ol><li>发送请求</li><li>解析内容</li><li>渲染网页</li></ol><p>这 3 个步骤其实都是由 JavaScript 完成的。</p><h4 id="Ajax-分析"><a href="#Ajax-分析" class="headerlink" title="Ajax 分析"></a>Ajax 分析</h4><p>下面以豆瓣电影为例，我们进入电影分类页面：</p><img src="https://img-blog.csdnimg.cn/20200712154101276.png" width="70%" loading="lazy"><p>下拉到页面底部，我们可以看到 <code>加载更多</code> 的按钮：</p><img src="https://img-blog.csdnimg.cn/20200712154757912.png" width="70%" loading="lazy"><p>点击 <code>加载更多</code> 之后，加载了一些新的电影，而页面的 URL 并没有发生改变：</p><img src="https://img-blog.csdnimg.cn/20200712154715362.png" width="70%" loading="lazy"><h4 id="如何查看-Ajax-请求"><a href="#如何查看-Ajax-请求" class="headerlink" title="如何查看 Ajax 请求"></a>如何查看 Ajax 请求</h4><p>要想查看 Ajax 请求，我们可以借助 Chrome 的开发者工具，借助它可以看到页面加载过程中浏览器与服务器之间发送请求和接收响应的所有记录。</p><blockquote><p>Ajax 有其特殊的请求类型，它叫作 XHR（XMLHttpRequest）。</p></blockquote><p>点击 <code>加载更多</code> 后，可以发现一个新的请求，其 Type 为 xhr，这就是一个 Ajax 请求。</p><p><img src="https://img-blog.csdnimg.cn/20200712162826512.png?0x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTk2MTc3NA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" loading="lazy"></p><p>用鼠标点击这个请求，可以查看这个请求的详细信息：</p><p><img src="https://img-blog.csdnimg.cn/20200712162902330.png?0x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTk2MTc3NA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" loading="lazy"></p><p>在右侧我们可以观察到 Request Headers、URL 和 Response Headers 等信息。</p><p>点击 Preview，即可看到响应的内容，它是 JSON 格式的。此处 Chrome 自动做了解析，点击箭头即可展开和收起相应内容：</p><p><img src="https://img-blog.csdnimg.cn/20200712164430440.png?0x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTk2MTc3NA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" loading="lazy"></p><p>JavaScript 接收到这些数据之后，再执行相应的渲染方法，整个页面就渲染出来了。</p><p>另外，我们也可以切换到 Response 选项卡，从中观察到真实的返回数据：</p><p><img src="https://img-blog.csdnimg.cn/20200712164531410.png" alt="在这里插入图片描述" loading="lazy"></p><p>接下来，切回到第一个请求，观察一下它的 Response：</p><p><img src="https://img-blog.csdnimg.cn/20200712164656808.png?0x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTk2MTc3NA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" loading="lazy"></p><p>这就是最原始 URL 返回的结果，其代码结构也非常简单，只是执行了一些 JavaScript。</p><p>因此，我们看到的页面的真实数据并不是最原始的页面返回的，而是在执行 JavaScript 后再次向后台发送 Ajax 请求，浏览器拿到数据后进一步渲染出来的。</p><h4 id="如何模拟-Ajax-请求"><a href="#如何模拟-Ajax-请求" class="headerlink" title="如何模拟 Ajax 请求"></a>如何模拟 Ajax 请求</h4><p>利用 Chrome 开发者工具的筛选功能筛选出所有的 Ajax 请求。在请求的上方有一层筛选栏，直接点击 XHR，此时在下方显示的所有请求都是 Ajax 请求，然后不断点击 <code>加载更多</code>，就能捕获所有的 Ajax请求了：<br><img src="https://img-blog.csdnimg.cn/20200712165230656.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTk2MTc3NA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" loading="lazy"></p><p>随意点开一个条目，都可以清楚地看到其 Request URL、Request Headers、Response Headers、Response Body 等内容，此时只需要用程序模拟这些 Ajax 请求，就可以轻松提取我们所需要的信息了。</p><p>Reference：<a href="https://kaiwu.lagou.com/course/courseInfo.htm?courseId=46#/detail/pc?id=1673">https://kaiwu.lagou.com/course/courseInfo.htm?courseId=46#/detail/pc?id=1673</a></p>]]></content>
      
      
      <categories>
          
          <category> HTTP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> HTTP </tag>
            
            <tag> Ajax </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多进程基本原理及 Python 实现</title>
      <link href="/posts/ad732d83/"/>
      <url>/posts/ad732d83/</url>
      
        <content type="html"><![CDATA[<h3 id="多进程的含义"><a href="#多进程的含义" class="headerlink" title="多进程的含义"></a>多进程的含义</h3><p><strong>进程（Process）</strong><br>是具有一定独立功能的程序关于某个数据集合上的一次运行活动，是系统进行资源分配和调度的一个独立单位。</p><p>多进程就是启用多个进程同时运行。</p><h3 id="Python-多进程的优势"><a href="#Python-多进程的优势" class="headerlink" title="Python 多进程的优势"></a>Python 多进程的优势</h3><p>由于进程中 GIL 的存在，Python 中的多线程并不能很好地发挥多核优势，<strong>一个进程中的多个线程，同一时刻只能有一个线程运行</strong>。</p><blockquote><p>在 Python 多线程下，每个线程的执行方式如下：</p><ul><li>获取 GIL。</li><li>执行对应线程的代码。</li><li>释放 GIL。</li></ul></blockquote><p>对于多进程来说，<strong>每个进程都有属于自己的 GIL</strong>，所以在多核处理器下，多进程的运行是不会受 GIL 的影响的，<strong>多进程能更好地发挥多核的优势</strong>。</p><p>Python 的多进程整体来看是比多线程更有优势，在条件允许的情况下，能用多进程就尽量用多进程。</p><p>由于进程是系统进行资源分配和调度的一个独立单位，所以各个进程之间的数据是无法共享的。</p><h3 id="多进程的实现"><a href="#多进程的实现" class="headerlink" title="多进程的实现"></a>多进程的实现</h3><img src="https://img-blog.csdnimg.cn/20200603205921259.png" width="50%" loading="lazy"><ul><li><h4 id="直接使用-Process-类"><a href="#直接使用-Process-类" class="headerlink" title="直接使用 Process 类"></a>直接使用 Process 类</h4></li></ul><p>在 multiprocessing 中，每进程都用一个 Process 类来表示。</p><p>API 调用：Process([group [, target [, name [, args [, kwargs]]]]])</p><ul><li><strong>target</strong> 表示调用对象，可以传入方法的名字。</li><li><strong>args</strong> 表示被调用对象的位置参数元组。<br>比如 target 是函数 func，它有两个参数 m，n，那么 args 就传入 [m, n] 即可。</li><li><strong>kwargs</strong> 表示调用对象的字典。</li><li><strong>name</strong> 是别名，相当于给这个进程取一个名字。</li><li><strong>group</strong> 分组。</li></ul><p><strong>实例：</strong></p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> multiprocessing<span class="token keyword">def</span> <span class="token function">process</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Process: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>index<span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        p <span class="token operator">=</span> multiprocessing<span class="token punctuation">.</span>Process<span class="token punctuation">(</span>target<span class="token operator">=</span>process<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        p<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p><strong>运行结果：</strong></p><pre class="language-none"><code class="language-none">Process: 0Process: 1Process: 2Process: 3Process: 4</code></pre><p><strong>multiprocessing 还提供了几个比较有用的方法：</strong></p><ul><li>通过 cpu_count 方法来获取当前机器 CPU 的核心数量</li><li>通过 active_children 方法获取当前还在运行的所有进程</li></ul><p><strong>实例：</strong></p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> multiprocessing<span class="token keyword">import</span> time<span class="token keyword">def</span> <span class="token function">process</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span>index<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Process: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>index<span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        p <span class="token operator">=</span> multiprocessing<span class="token punctuation">.</span>Process<span class="token punctuation">(</span>target<span class="token operator">=</span>process<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>        p<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'CPU number: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>multiprocessing<span class="token punctuation">.</span>cpu_count<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>        <span class="token keyword">for</span> p <span class="token keyword">in</span> multiprocessing<span class="token punctuation">.</span>active_children<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Child process name: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>p<span class="token punctuation">.</span>name<span class="token punctuation">&#125;</span></span><span class="token string"> id: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>p<span class="token punctuation">.</span>pid<span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Process Ended'</span><span class="token punctuation">)</span></code></pre><p><strong>运行结果：</strong></p><pre class="language-none"><code class="language-none">Process: 0CPU number: 8Child process name: Process-5 id: 73595Child process name: Process-2 id: 73592Child process name: Process-3 id: 73593Child process name: Process-4 id: 73594Process EndedProcess: 1Process: 2Process: 3Process: 4</code></pre><ul><li><h4 id="继承Process类"><a href="#继承Process类" class="headerlink" title="继承Process类"></a>继承Process类</h4><p>创建进程的方式不止一种，也可以像线程 Thread 一样，通过继承的方式创建一个进程类，进程的基本操作在子类的 run 方法中实现即可。</p></li></ul><p><strong>实例：</strong></p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Process<span class="token keyword">import</span> time<span class="token keyword">class</span> <span class="token class-name">MyProcess</span><span class="token punctuation">(</span>Process<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> loop<span class="token punctuation">)</span><span class="token punctuation">:</span>        Process<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>loop <span class="token operator">=</span> loop    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">for</span> count <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>loop<span class="token punctuation">)</span><span class="token punctuation">:</span>            time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Pid: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>self<span class="token punctuation">.</span>pid<span class="token punctuation">&#125;</span></span><span class="token string"> LoopCount: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>count<span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        p <span class="token operator">=</span> MyProcess<span class="token punctuation">(</span>i<span class="token punctuation">)</span>        p<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><blockquote><p>这里进程的执行逻辑需要在 run 方法中实现，启动进程需要调用 start 方法，调用之后 run 方法便会执行。</p></blockquote><p><strong>运行结果：</strong></p><pre class="language-none"><code class="language-none">Pid: 73667 LoopCount: 0Pid: 73668 LoopCount: 0Pid: 73669 LoopCount: 0Pid: 73667 LoopCount: 1Pid: 73668 LoopCount: 1Pid: 73669 LoopCount: 1Pid: 73668 LoopCount: 2Pid: 73669 LoopCount: 2Pid: 73669 LoopCount: 3</code></pre><blockquote><p>这里的进程 pid 代表进程号，不同机器、不同时刻运行结果可能不同。</p></blockquote><blockquote><p>通过上面的方式，我们也非常方便地实现了一个进程的定义。<br>为了复用方便，我们可以把一些方法写在每个进程类里封装好，在使用时直接初始化一个进程类运行即可。</p></blockquote><h3 id="守护进程"><a href="#守护进程" class="headerlink" title="守护进程"></a>守护进程</h3><p>在多进程中，同样存在守护进程的概念，如果一个进程被设置为守护进程，当父进程结束后，子进程会自动被终止，我们可以通过设置 daemon 属性来控制是否为守护进程。</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Process<span class="token keyword">import</span> time<span class="token keyword">class</span> <span class="token class-name">MyProcess</span><span class="token punctuation">(</span>Process<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> loop<span class="token punctuation">)</span><span class="token punctuation">:</span>        Process<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>loop <span class="token operator">=</span> loop    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">for</span> count <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>loop<span class="token punctuation">)</span><span class="token punctuation">:</span>            time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Pid: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>self<span class="token punctuation">.</span>pid<span class="token punctuation">&#125;</span></span><span class="token string"> LoopCount: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>count<span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        p <span class="token operator">=</span> MyProcess<span class="token punctuation">(</span>i<span class="token punctuation">)</span>        p<span class="token punctuation">.</span>daemon <span class="token operator">=</span> <span class="token boolean">True</span>        p<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Main Process ended'</span><span class="token punctuation">)</span></code></pre><p><strong>运行结果：</strong></p><pre class="language-none"><code class="language-none">Main Process ended</code></pre><p>结果很简单，因为主进程没有做任何事情，直接输出一句话结束，所以在这时也直接终止了子进程的运行。</p><p>这样可以有效防止无控制地生成子进程。这样的写法可以让我们在主进程运行结束后无需额外担心子进程是否关闭，避免了独立子进程的运行。</p><h3 id="进程等待"><a href="#进程等待" class="headerlink" title="进程等待"></a>进程等待</h3><p>上面的运行效果其实不太符合我们预期：主进程运行结束时，子进程（守护进程）也都退出了，子进程什么都没来得及执行。</p><p>加入 join 方法即可让所有子进程都执行完再结束：</p><pre class="language-python" data-language="python"><code class="language-python">processes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    p <span class="token operator">=</span> MyProcess<span class="token punctuation">(</span>i<span class="token punctuation">)</span>    processes<span class="token punctuation">.</span>append<span class="token punctuation">(</span>p<span class="token punctuation">)</span>    p<span class="token punctuation">.</span>daemon <span class="token operator">=</span> <span class="token boolean">True</span>    p<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> p <span class="token keyword">in</span> processes<span class="token punctuation">:</span>    p<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p><strong>运行结果：</strong></p><pre class="language-none"><code class="language-none">Pid: 40866 LoopCount: 0Pid: 40867 LoopCount: 0Pid: 40868 LoopCount: 0Pid: 40866 LoopCount: 1Pid: 40867 LoopCount: 1Pid: 40868 LoopCount: 1Pid: 40867 LoopCount: 2Pid: 40868 LoopCount: 2Pid: 40868 LoopCount: 3Main Process ended</code></pre><p>在调用 start 和 join 方法后，父进程就可以等待所有子进程都执行完毕后，再打印出结束的结果。</p><p>默认情况下，join 是无限期的。也就是说，如果有子进程没有运行完毕，主进程会一直等待。这种情况下，如果子进程出现问题陷入了死循环，主进程也会无限等待下去。怎么解决这个问题呢？可以给 join 方法传递一个超时参数，代表最长等待秒数。如果子进程没有在这个指定秒数之内完成，会被强制返回，主进程不再会等待。也就是说这个参数设置了主进程等待该子进程的最长时间。</p><p>例如这里我们传入 1，代表最长等待 1 秒，代码改写如下：</p><pre class="language-python" data-language="python"><code class="language-python">processes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    p <span class="token operator">=</span> MyProcess<span class="token punctuation">(</span>i<span class="token punctuation">)</span>    processes<span class="token punctuation">.</span>append<span class="token punctuation">(</span>p<span class="token punctuation">)</span>    p<span class="token punctuation">.</span>daemon <span class="token operator">=</span> <span class="token boolean">True</span>    p<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> p <span class="token keyword">in</span> processes<span class="token punctuation">:</span>    p<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></code></pre><p><strong>运行结果：</strong></p><pre class="language-none"><code class="language-none">Pid: 40970 LoopCount: 0Pid: 40971 LoopCount: 0Pid: 40970 LoopCount: 1Pid: 40971 LoopCount: 1Main Process ended</code></pre><p>可以看到，有的子进程本来要运行 3 秒，结果运行 1 秒就被强制返回了，由于是守护进程，该子进程被终止了。</p><h3 id="终止进程"><a href="#终止进程" class="headerlink" title="终止进程"></a>终止进程</h3><p>终止进程不止有守护进程这一种做法，也可以通过 terminate 方法来终止某个子进程，另外还可以通过 is_alive 方法判断进程是否还在运行：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> multiprocessing<span class="token keyword">import</span> time<span class="token keyword">def</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Starting'</span><span class="token punctuation">)</span>    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Finished'</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    p <span class="token operator">=</span> multiprocessing<span class="token punctuation">.</span>Process<span class="token punctuation">(</span>target<span class="token operator">=</span>process<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Before:'</span><span class="token punctuation">,</span> p<span class="token punctuation">,</span> p<span class="token punctuation">.</span>is_alive<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    p<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'During:'</span><span class="token punctuation">,</span> p<span class="token punctuation">,</span> p<span class="token punctuation">.</span>is_alive<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    p<span class="token punctuation">.</span>terminate<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Terminate:'</span><span class="token punctuation">,</span> p<span class="token punctuation">,</span> p<span class="token punctuation">.</span>is_alive<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    p<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Joined:'</span><span class="token punctuation">,</span> p<span class="token punctuation">,</span> p<span class="token punctuation">.</span>is_alive<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><p>此处用 Process 创建了一个进程，接着调用 start 方法启动这个进程，然后调用 terminate 方法将进程终止，最后调用 join 方法。</p><p>另外，在进程运行不同的阶段，还通过 is_alive 方法判断当前进程是否还在运行。</p><p><strong>运行结果：</strong></p><pre class="language-none"><code class="language-none">Before: &lt;Process(Process-1, initial)&gt; FalseDuring: &lt;Process(Process-1, started)&gt; TrueTerminate: &lt;Process(Process-1, started)&gt; TrueJoined: &lt;Process(Process-1, stopped[SIGTERM])&gt; False</code></pre><p>这里有一个值得注意的地方，在调用 terminate 方法之后，用 is_alive 方法获取进程的状态发现依然还是运行状态。在调用 join 方法之后，is_alive 方法获取进程的运行状态才变为终止状态。</p><p>所以，在调用 terminate 方法之后，记得要调用一下 join 方法，这里调用 join 方法可以为进程提供时间来更新对象状态，用来反映出最终的进程终止效果。</p><h3 id="进程互斥锁"><a href="#进程互斥锁" class="headerlink" title="进程互斥锁"></a>进程互斥锁</h3><p>在上面的一些实例中，可能会遇到如下的运行结果：</p><pre class="language-none"><code class="language-none">Pid: 73993 LoopCount: 0Pid: 73993 LoopCount: 1Pid: 73994 LoopCount: 0Pid: 73994 LoopCount: 1Pid: 73994 LoopCount: 2Pid: 73995 LoopCount: 0Pid: 73995 LoopCount: 1Pid: 73995 LoopCount: 2Pid: 73995 LoopCount: 3Main Process ended</code></pre><p><strong>有的输出结果没有换行。</strong></p><p>这种情况是由多个进程并行执行导致的，两个进程同时进行了输出，结果第一个进程的换行没有来得及输出，第二个进程就输出了结果，导致最终输出没有换行。</p><p>如果能保证多个进程运行期间的任一时间，只能一个进程输出，其他进程等待，等刚才那个进程输出完毕之后，另一个进程再进行输出，这样就不会出现输出没有换行的现象了。</p><p>这种解决方案实际上就是实现了进程互斥，避免了多个进程同时抢占临界区（输出）资源。</p><p><strong>可以通过 multiprocessing 中的 Lock 来实现。</strong></p><p>Lock，即锁，在一个进程输出时，加锁，其他进程等待。等此进程执行结束后，释放锁，其他进程可以进行输出。</p><p><strong>首先实现一个不加锁的实例：</strong></p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Process<span class="token punctuation">,</span> Lock<span class="token keyword">import</span> time<span class="token keyword">class</span> <span class="token class-name">MyProcess</span><span class="token punctuation">(</span>Process<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> loop<span class="token punctuation">,</span> lock<span class="token punctuation">)</span><span class="token punctuation">:</span>        Process<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>loop <span class="token operator">=</span> loop        self<span class="token punctuation">.</span>lock <span class="token operator">=</span> lock    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">for</span> count <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>loop<span class="token punctuation">)</span><span class="token punctuation">:</span>            time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>            <span class="token comment"># self.lock.acquire()</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Pid: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>self<span class="token punctuation">.</span>pid<span class="token punctuation">&#125;</span></span><span class="token string"> LoopCount: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>count<span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>            <span class="token comment"># self.lock.release()</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    lock <span class="token operator">=</span> Lock<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        p <span class="token operator">=</span> MyProcess<span class="token punctuation">(</span>i<span class="token punctuation">,</span> lock<span class="token punctuation">)</span>        p<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p><strong>运行结果：</strong></p><pre class="language-none"><code class="language-none">Pid: 74030 LoopCount: 0Pid: 74031 LoopCount: 0Pid: 74032 LoopCount: 0Pid: 74033 LoopCount: 0Pid: 74034 LoopCount: 0Pid: 74030 LoopCount: 1Pid: 74031 LoopCount: 1Pid: 74032 LoopCount: 1Pid: 74033 LoopCount: 1Pid: 74034 LoopCount: 1Pid: 74030 LoopCount: 2...</code></pre><p>可以看到运行结果中有些输出已经出现了不换行的问题。</p><p>对其加锁，取消掉刚才代码中的两行注释，重新运行。</p><p><strong>运行结果：</strong></p><pre class="language-none"><code class="language-none">Pid: 74061 LoopCount: 0Pid: 74062 LoopCount: 0Pid: 74063 LoopCount: 0Pid: 74064 LoopCount: 0Pid: 74065 LoopCount: 0Pid: 74061 LoopCount: 1Pid: 74062 LoopCount: 1Pid: 74063 LoopCount: 1Pid: 74064 LoopCount: 1Pid: 74065 LoopCount: 1Pid: 74061 LoopCount: 2Pid: 74062 LoopCount: 2Pid: 74064 LoopCount: 2...</code></pre><p>这时输出效果就正常了。</p><p>所以，在访问一些临界区资源时，使用 Lock 可以有效避免进程同时占用资源而导致的一些问题。</p><h3 id="信号量"><a href="#信号量" class="headerlink" title="信号量"></a>信号量</h3><p>进程互斥锁可以使同一时刻只有一个进程能访问共享资源，如上面的例子所展示的那样，在同一时刻只能有一个进程输出结果。但有时候需要允许多个进程来访问共享资源，同时还需要限制能访问共享资源的进程的数量。</p><p>这种需求该如何实现呢？可以用信号量，信号量是进程同步过程中一个比较重要的角色。它可以控制临界资源的数量，实现多个进程同时访问共享资源，限制进程的并发量。</p><p><strong>可以用 multiprocessing 库中的 Semaphore 来实现信号量。</strong></p><p>进程之间利用 Semaphore 做到多个进程共享资源，同时又限制同时可访问的进程数量：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Process<span class="token punctuation">,</span> Semaphore<span class="token punctuation">,</span> Lock<span class="token punctuation">,</span> Queue<span class="token keyword">import</span> time<span class="token builtin">buffer</span> <span class="token operator">=</span> Queue<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>empty <span class="token operator">=</span> Semaphore<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>full <span class="token operator">=</span> Semaphore<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>lock <span class="token operator">=</span> Lock<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">class</span> <span class="token class-name">Consumer</span><span class="token punctuation">(</span>Process<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">global</span> <span class="token builtin">buffer</span><span class="token punctuation">,</span> empty<span class="token punctuation">,</span> full<span class="token punctuation">,</span> lock        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>            full<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>            lock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token builtin">buffer</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Consumer pop an element'</span><span class="token punctuation">)</span>            time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>            lock<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>            empty<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">class</span> <span class="token class-name">Producer</span><span class="token punctuation">(</span>Process<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">global</span> <span class="token builtin">buffer</span><span class="token punctuation">,</span> empty<span class="token punctuation">,</span> full<span class="token punctuation">,</span> lock        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>            empty<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>            lock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token builtin">buffer</span><span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Producer append an element'</span><span class="token punctuation">)</span>            time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>            lock<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>            full<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    p <span class="token operator">=</span> Producer<span class="token punctuation">(</span><span class="token punctuation">)</span>    c <span class="token operator">=</span> Consumer<span class="token punctuation">(</span><span class="token punctuation">)</span>    p<span class="token punctuation">.</span>daemon <span class="token operator">=</span> c<span class="token punctuation">.</span>daemon <span class="token operator">=</span> <span class="token boolean">True</span>    p<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>    c<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>    p<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>    c<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Main Process Ended'</span><span class="token punctuation">)</span></code></pre><blockquote><p>如上代码实现了经典的生产者和消费者问题。它定义了两个进程类，一个是消费者，一个是生产者。</p></blockquote><p>另外，这里使用 multiprocessing 中的 Queue 定义了一个共享队列，然后定义了两个信号量 Semaphore，一个代表缓冲区空余数，一个表示缓冲区占用数。</p><p>生产者 Producer 使用 acquire 方法来占用一个缓冲区位置，缓冲区空闲区大小减 1，接下来进行加锁，对缓冲区进行操作，然后释放锁，最后让代表占用的缓冲区位置数量加 1，消费者则相反。</p><p><strong>运行结果：</strong></p><pre class="language-none"><code class="language-none">Producer append an elementProducer append an elementConsumer pop an elementConsumer pop an elementProducer append an elementProducer append an elementConsumer pop an elementConsumer pop an elementProducer append an elementProducer append an elementConsumer pop an elementConsumer pop an elementProducer append an elementProducer append an element</code></pre><p>可以发现两个进程在交替运行，生产者先放入缓冲区物品，然后消费者取出，不停地进行循环。 可以通过上面的例子来体会信号量 Semaphore 的用法，通过 Semaphore 很好地控制了进程对资源的并发访问数量。</p><h3 id="队列"><a href="#队列" class="headerlink" title="队列"></a>队列</h3><p>在上面的例子中使用 Queue 作为进程通信的共享队列使用。</p><p>而如果把上面程序中的 Queue 换成普通的 list，是完全起不到效果的，因为进程和进程之间的资源是不共享的。即使在一个进程中改变了这个 list，在另一个进程也不能获取到这个 list 的状态，所以声明全局变量对多进程是没有用处的。</p><p>那进程如何共享数据呢？可以用 Queue，即队列。<strong>这里的队列指的是 multiprocessing 里面的 Queue。</strong></p><p>依然用上面的例子，<strong>一个进程向队列中放入随机数据，然后另一个进程取出数据：</strong></p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Process<span class="token punctuation">,</span> Semaphore<span class="token punctuation">,</span> Lock<span class="token punctuation">,</span> Queue<span class="token keyword">import</span> time<span class="token keyword">from</span> random <span class="token keyword">import</span> random<span class="token builtin">buffer</span> <span class="token operator">=</span> Queue<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>empty <span class="token operator">=</span> Semaphore<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>full <span class="token operator">=</span> Semaphore<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>lock <span class="token operator">=</span> Lock<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">class</span> <span class="token class-name">Consumer</span><span class="token punctuation">(</span>Process<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">global</span> <span class="token builtin">buffer</span><span class="token punctuation">,</span> empty<span class="token punctuation">,</span> full<span class="token punctuation">,</span> lock        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>            full<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>            lock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Consumer get </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">buffer</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>            time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>            lock<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>            empty<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">class</span> <span class="token class-name">Producer</span><span class="token punctuation">(</span>Process<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">global</span> <span class="token builtin">buffer</span><span class="token punctuation">,</span> empty<span class="token punctuation">,</span> full<span class="token punctuation">,</span> lock        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>            empty<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>            lock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>            num <span class="token operator">=</span> random<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Producer put </span><span class="token interpolation"><span class="token punctuation">&#123;</span>num<span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>            <span class="token builtin">buffer</span><span class="token punctuation">.</span>put<span class="token punctuation">(</span>num<span class="token punctuation">)</span>            time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>            lock<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>            full<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    p <span class="token operator">=</span> Producer<span class="token punctuation">(</span><span class="token punctuation">)</span>    c <span class="token operator">=</span> Consumer<span class="token punctuation">(</span><span class="token punctuation">)</span>    p<span class="token punctuation">.</span>daemon <span class="token operator">=</span> c<span class="token punctuation">.</span>daemon <span class="token operator">=</span> <span class="token boolean">True</span>    p<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>    c<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>    p<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>    c<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Main Process Ended'</span><span class="token punctuation">)</span></code></pre><p><strong>运行结果：</strong></p><pre class="language-none"><code class="language-none">Producer put  0.719213647437Producer put  0.44287326683Consumer get 0.719213647437Consumer get 0.44287326683Producer put  0.722859424381Producer put  0.525321338921Consumer get 0.722859424381Consumer get 0.525321338921</code></pre><p>在上面的例子中声明了两个进程，一个进程为生产者 Producer，另一个为消费者 Consumer，生产者不断向 Queue 里面添加随机数，消费者不断从队列里面取随机数。</p><p>生产者在放数据的时候调用了 Queue 的 put 方法，消费者在取的时候使用了 get 方法，这样就通过 Queue 实现两个进程的数据共享了。</p><h3 id="管道"><a href="#管道" class="headerlink" title="管道"></a>管道</h3><p>刚才使用 Queue 实现了进程间的数据共享，那么进程之间直接通信，如收发信息，用什么比较好呢？可以用 Pipe，管道。</p><p>管道，可以把它理解为两个进程之间通信的通道。管道可以是单向的，即 half-duplex：一个进程负责发消息，另一个进程负责收消息；也可以是双向的 duplex，即互相收发消息。</p><p>默认声明 Pipe 对象是双向管道，如果要创建单向管道，可以在初始化的时候传入 deplex 参数为 False。</p><p><strong>实例：</strong></p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Process<span class="token punctuation">,</span> Pipe<span class="token keyword">class</span> <span class="token class-name">Consumer</span><span class="token punctuation">(</span>Process<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> pipe<span class="token punctuation">)</span><span class="token punctuation">:</span>        Process<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>pipe <span class="token operator">=</span> pipe    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>pipe<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">'Consumer Words'</span><span class="token punctuation">)</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Consumer Received: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>self<span class="token punctuation">.</span>pipe<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span><span class="token keyword">class</span> <span class="token class-name">Producer</span><span class="token punctuation">(</span>Process<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> pipe<span class="token punctuation">)</span><span class="token punctuation">:</span>        Process<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>pipe <span class="token operator">=</span> pipe    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Producer Received: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>self<span class="token punctuation">.</span>pipe<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>pipe<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">'Producer Words'</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    pipe <span class="token operator">=</span> Pipe<span class="token punctuation">(</span><span class="token punctuation">)</span>    p <span class="token operator">=</span> Producer<span class="token punctuation">(</span>pipe<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    c <span class="token operator">=</span> Consumer<span class="token punctuation">(</span>pipe<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    p<span class="token punctuation">.</span>daemon <span class="token operator">=</span> c<span class="token punctuation">.</span>daemon <span class="token operator">=</span> <span class="token boolean">True</span>    p<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>    c<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>    p<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>    c<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Main Process Ended'</span><span class="token punctuation">)</span></code></pre><p>在这个例子里声明了一个默认为双向的管道，然后将管道的两端分别传给两个进程。两个进程互相收发。</p><p><strong>运行结果：</strong></p><pre class="language-none"><code class="language-none">Producer Received: Consumer WordsConsumer Received: Producer WordsMain Process Ended</code></pre><p>管道 Pipe 就像进程之间搭建的桥梁，利用它就可以很方便地实现进程间通信了。</p><h3 id="进程池"><a href="#进程池" class="headerlink" title="进程池"></a>进程池</h3><p>根据前面知道了可以使用 Process 来创建进程，同时也知道了如何用 Semaphore 来控制进程的并发执行数量。</p><p>假如现在有 10000 个任务，每个任务需要启动一个进程来执行，并且一个进程运行完毕之后要紧接着启动下一个进程，同时还需要控制进程的并发数量，不能并发太高，不然 CPU 处理不过来（如果同时运行的进程能维持在一个最高恒定值当然利用率是最高的）。</p><p>那么该如何来实现这个需求呢？</p><p>用 Process 和 Semaphore 可以实现，但是实现起来比较烦琐。而这种需求在平时又是非常常见的。此时就可以派上进程池了，即 multiprocessing 中的 Pool。</p><p>Pool 可以提供指定数量的进程，供用户调用，当有新的请求提交到 pool 中时，如果池还没有满，就会创建一个新的进程用来执行该请求；但如果池中的进程数已经达到规定最大值，那么该请求就会等待，直到池中有进程结束，才会创建新的进程来执行它。</p><p><strong>实例：</strong></p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Pool<span class="token keyword">import</span> time<span class="token keyword">def</span> <span class="token function">function</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Start process: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>index<span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'End process </span><span class="token interpolation"><span class="token punctuation">&#123;</span>index<span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    pool <span class="token operator">=</span> Pool<span class="token punctuation">(</span>processes<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        pool<span class="token punctuation">.</span>apply_async<span class="token punctuation">(</span>function<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Main Process started'</span><span class="token punctuation">)</span>    pool<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>    pool<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Main Process ended'</span><span class="token punctuation">)</span></code></pre><p>在这个例子中声明了一个大小为 3 的进程池，通过 processes 参数来指定，如果不指定，那么会自动根据处理器内核来分配进程数。接着使用 apply_async 方法将进程添加进去，args 可以用来传递参数。</p><p><strong>运行结果：</strong></p><pre class="language-none"><code class="language-none">Main Process startedStart process: 0Start process: 1Start process: 2End process 0End process 1End process 2Start process: 3End process 3Main Process ended</code></pre><p>进程池大小为 3，所以最初可以看到有 3 个进程同时执行，第4个进程在等待，在有进程运行完毕之后，第4个进程马上跟着运行，出现了如上的运行效果。</p><p>最后，要记得调用 close 方法来关闭进程池，使其不再接受新的任务，然后调用 join 方法让主进程等待子进程的退出，等子进程运行完毕之后，主进程接着运行并结束。</p><p>不过上面的写法多少有些烦琐，这里再介绍进程池一个更好用的 map 方法，可以将上述写法简化很多。</p><p>map 方法是怎么用的呢？第一个参数就是要启动的进程对应的执行方法，第 2 个参数是一个可迭代对象，其中的每个元素会被传递给这个执行方法。</p><p>举个例子：现在有一个 list，里面包含了很多 URL，另外也定义了一个方法用来抓取每个 URL 内容并解析，那么可以直接在 map 的第一个参数传入方法名，第 2 个参数传入 URL 数组。</p><p><strong>实例：</strong></p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Pool<span class="token keyword">import</span> urllib<span class="token punctuation">.</span>request<span class="token keyword">import</span> urllib<span class="token punctuation">.</span>error<span class="token keyword">def</span> <span class="token function">scrape</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        urllib<span class="token punctuation">.</span>request<span class="token punctuation">.</span>urlopen<span class="token punctuation">(</span>url<span class="token punctuation">)</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'URL </span><span class="token interpolation"><span class="token punctuation">&#123;</span>url<span class="token punctuation">&#125;</span></span><span class="token string"> Scraped'</span></span><span class="token punctuation">)</span>    <span class="token keyword">except</span> <span class="token punctuation">(</span>urllib<span class="token punctuation">.</span>error<span class="token punctuation">.</span>HTTPError<span class="token punctuation">,</span> urllib<span class="token punctuation">.</span>error<span class="token punctuation">.</span>URLError<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'URL </span><span class="token interpolation"><span class="token punctuation">&#123;</span>url<span class="token punctuation">&#125;</span></span><span class="token string"> not Scraped'</span></span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    pool <span class="token operator">=</span> Pool<span class="token punctuation">(</span>processes<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>    urls <span class="token operator">=</span> <span class="token punctuation">[</span>        <span class="token string">'https://www.baidu.com'</span><span class="token punctuation">,</span>        <span class="token string">'http://www.meituan.com/'</span><span class="token punctuation">,</span>        <span class="token string">'http://blog.csdn.net/'</span><span class="token punctuation">,</span>        <span class="token string">'http://xxxyxxx.net'</span>    <span class="token punctuation">]</span>    pool<span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span>scrape<span class="token punctuation">,</span> urls<span class="token punctuation">)</span>    pool<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>这个例子中先定义了一个 scrape 方法，它接收一个参数 url，这里就是请求了一下这个链接，然后输出爬取成功的信息，如果发生错误，则会输出爬取失败的信息。</p><p>首先要初始化一个 Pool，指定进程数为 3。然后声明一个 urls 列表，接着调用了 map 方法，第 1 个参数就是进程对应的执行方法，第 2 个参数就是 urls 列表，map 方法会依次将 urls 的每个元素作为 scrape 的参数传递并启动一个新的进程，加到进程池中执行。</p><p><strong>运行结果：</strong></p><pre class="language-none"><code class="language-none">URL https:&#x2F;&#x2F;www.baidu.com ScrapedURL http:&#x2F;&#x2F;xxxyxxx.net not ScrapedURL http:&#x2F;&#x2F;blog.csdn.net&#x2F; ScrapedURL http:&#x2F;&#x2F;www.meituan.com&#x2F; Scraped</code></pre><p>这样就可以实现 3 个进程并行运行。不同的进程相互独立地输出了对应的爬取结果。</p><p>可以看到，利用 Pool 的 map 方法非常方便地实现了多进程的执行。</p><p>Reference：<a href="https://kaiwu.lagou.com/course/courseInfo.htm?courseId=46#/detail/pc?id=1667">https://kaiwu.lagou.com/course/courseInfo.htm?courseId=46#/detail/pc?id=1667</a></p>]]></content>
      
      
      <categories>
          
          <category> MultiProcessing </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> MultiProcessing </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多线程基本原理及 Python 实现</title>
      <link href="/posts/61d9b63a/"/>
      <url>/posts/61d9b63a/</url>
      
        <content type="html"><![CDATA[<h3 id="多线程的含义"><a href="#多线程的含义" class="headerlink" title="多线程的含义"></a>多线程的含义</h3><p><strong>进程可以理解为是一个可以独立运行的程序单位。</strong></p><p>比如：</p><ul><li>打开一个浏览器，就开启了一个浏览器进程。</li><li>打开一个文本编辑器，就开启了一个文本编辑器进程。</li></ul><p><strong>一个进程中可以同时处理很多事情。</strong></p><p>比如：</p><ul><li>浏览器中可以在多个选项卡中打开多个页面，有的页面在播放音乐，有的页面在播放视频，有的网页在播放动画，可以同时运行，互不干扰。</li></ul><h6 id="为什么能同时做到同时运行这么多的任务呢？"><a href="#为什么能同时做到同时运行这么多的任务呢？" class="headerlink" title="为什么能同时做到同时运行这么多的任务呢？"></a>为什么能同时做到同时运行这么多的任务呢？</h6><p>任务对应着线程的执行。</p><p><strong>进程</strong> 是线程的集合，是由一个或多个线程构成的。<br><strong>线程</strong> 是操作系统进行运算调度的最小单位，是进程中的一个最小运行单元。</p><h3 id="并发和并行"><a href="#并发和并行" class="headerlink" title="并发和并行"></a>并发和并行</h3><h5 id="并发（concurrency）"><a href="#并发（concurrency）" class="headerlink" title="并发（concurrency）"></a>并发（concurrency）</h5><p>指同一时刻只能有一条指令执行，但多个线程的对应的指令被快速轮换地执行，宏观上看起来多个线程在同时运行，但微观上只是这个处理器在连续不断地、在多个线程之间切换和执行。</p><blockquote><p>在单处理器和多处理器系统中都可以存在，仅靠一个核，就可以实现并发。</p></blockquote><h5 id="并行（parallel）"><a href="#并行（parallel）" class="headerlink" title="并行（parallel）"></a>并行（parallel）</h5><p>指同一时刻有多条指令在多个处理器上同时执行，并行必须要依赖于多个处理器，不论宏观上还是微观上，多个线程都是在同一时刻一起执行的。</p><blockquote><p>只能在多处理器系统中存在，如果计算机处理器只有一个核，就不可能实现并行。</p></blockquote><h3 id="多线程适用场景"><a href="#多线程适用场景" class="headerlink" title="多线程适用场景"></a>多线程适用场景</h3><p>在一个程序进程中，有些操作是比较耗时或者需要等待的。</p><p>比如：</p><ul><li>等待数据库的查询结果的返回</li><li>等待网页结果的响应</li></ul><p><strong>使用单线程：</strong><br>处理器必须要等到这些操作完成之后才能继续往下执行其他操作，而这个线程在等待的过程中，处理器明显是可以来执行其他操作的。</p><p><strong>使用多线程：</strong><br>处理器就可以在某个线程等待时，去执行其他的线程，从而从整体上提高执行效率。</p><p><strong>网络爬虫就是一个非常典型的例子</strong><br>爬虫在向服务器发起请求之后，有一段时间必须要等待服务器的响应返回，这种任务就属于 IO 密集型任务。</p><p><strong>但不是所有的任务都是 IO 密集型任务</strong><br>有一种任务叫作计算密集型任务，也可以称之为 CPU 密集型任务，就是任务的运行一直需要处理器的参与。</p><p>这时如果开启多线程，一个处理器从一个计算密集型任务切换到切换到另一个计算密集型任务上，处理器依然不会停下来，始终会忙于计算。</p><p>如果任务不全是计算密集型任务，可以使用多线程来提高程序整体的执行效率，尤其对于网络爬虫这种 IO 密集型任务来说，使用多线程会大大提高程序整体的爬取效率。</p><h3 id="Python-实现多线程"><a href="#Python-实现多线程" class="headerlink" title="Python 实现多线程"></a>Python 实现多线程</h3><blockquote><p><strong>在 Python 中，实现多线程的模块叫作 threading，是 Python 自带的模块。</strong></p></blockquote><h4 id="使用-threading-实现多线程的方法："><a href="#使用-threading-实现多线程的方法：" class="headerlink" title="使用 threading 实现多线程的方法："></a>使用 threading 实现多线程的方法：</h4><ul><li><h5 id="Thread-直接创建子线程"><a href="#Thread-直接创建子线程" class="headerlink" title="Thread 直接创建子线程"></a>Thread 直接创建子线程</h5><p>首先可以使用 Thread 类来创建一个线程，创建时需要指定 target 参数为运行的方法名称，如果被调用的方法需要传入额外的参数，则可以通过 Thread 的 args 参数来指定。</p></li></ul><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> threading<span class="token keyword">import</span> time<span class="token keyword">def</span> <span class="token function">target</span><span class="token punctuation">(</span>second<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Threading </span><span class="token interpolation"><span class="token punctuation">&#123;</span>threading<span class="token punctuation">.</span>current_thread<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">&#125;</span></span><span class="token string"> is running'</span></span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Threading </span><span class="token interpolation"><span class="token punctuation">&#123;</span>threading<span class="token punctuation">.</span>current_thread<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">&#125;</span></span><span class="token string"> sleep </span><span class="token interpolation"><span class="token punctuation">&#123;</span>second<span class="token punctuation">&#125;</span></span><span class="token string">s'</span></span><span class="token punctuation">)</span>    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span>second<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Threading </span><span class="token interpolation"><span class="token punctuation">&#123;</span>threading<span class="token punctuation">.</span>current_thread<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">&#125;</span></span><span class="token string"> is ended'</span></span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Threading </span><span class="token interpolation"><span class="token punctuation">&#123;</span>threading<span class="token punctuation">.</span>current_thread<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">&#125;</span></span><span class="token string"> is running'</span></span><span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">:</span>    thread <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>target<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>    thread<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Threading </span><span class="token interpolation"><span class="token punctuation">&#123;</span>threading<span class="token punctuation">.</span>current_thread<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">&#125;</span></span><span class="token string"> is ended'</span></span><span class="token punctuation">)</span></code></pre><p><strong>运行结果：</strong></p><pre class="language-none"><code class="language-none">Threading MainThread is runningThreading Thread-1 is runningThreading Thread-1 sleep 1sThreading Thread-2 is runningThreading Thread-2 sleep 5sThreading MainThread is endedThreading Thread-1 is endedThreading Thread-2 is ended</code></pre><p><strong>如果想要主线程等待子线程运行完毕之后才退出，可以让每个子线程对象都调用下 join 方法：</strong></p><pre class="language-python" data-language="python"><code class="language-python">threads <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">:</span>    thread <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>target<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>    threads<span class="token punctuation">.</span>append<span class="token punctuation">(</span>thread<span class="token punctuation">)</span>    thread<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> thread <span class="token keyword">in</span> threads<span class="token punctuation">:</span>    thread<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p><strong>运行结果：</strong></p><pre class="language-none"><code class="language-none">Threading MainThread is runningThreading Thread-1 is runningThreading Thread-1 sleep 1sThreading Thread-2 is runningThreading Thread-2 sleep 5sThreading Thread-1 is endedThreading Thread-2 is endedThreading MainThread is ended</code></pre><ul><li><h5 id="继承-Thread-类创建子线程"><a href="#继承-Thread-类创建子线程" class="headerlink" title="继承 Thread 类创建子线程"></a>继承 Thread 类创建子线程</h5><p>另外也可以通过继承 Thread 类的方式创建一个线程，该线程需要执行的方法写在类的 run 方法里面即可。上面的例子的等价改写为：</p></li></ul><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> threading<span class="token keyword">import</span> time<span class="token keyword">class</span> <span class="token class-name">MyThread</span><span class="token punctuation">(</span>threading<span class="token punctuation">.</span>Thread<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> second<span class="token punctuation">)</span><span class="token punctuation">:</span>        threading<span class="token punctuation">.</span>Thread<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>second <span class="token operator">=</span> second        <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Threading </span><span class="token interpolation"><span class="token punctuation">&#123;</span>threading<span class="token punctuation">.</span>current_thread<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">&#125;</span></span><span class="token string"> is running'</span></span><span class="token punctuation">)</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Threading </span><span class="token interpolation"><span class="token punctuation">&#123;</span>threading<span class="token punctuation">.</span>current_thread<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">&#125;</span></span><span class="token string"> sleep </span><span class="token interpolation"><span class="token punctuation">&#123;</span>self<span class="token punctuation">.</span>second<span class="token punctuation">&#125;</span></span><span class="token string">s'</span></span><span class="token punctuation">)</span>        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span>self<span class="token punctuation">.</span>second<span class="token punctuation">)</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Threading </span><span class="token interpolation"><span class="token punctuation">&#123;</span>threading<span class="token punctuation">.</span>current_thread<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">&#125;</span></span><span class="token string"> is ended'</span></span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Threading </span><span class="token interpolation"><span class="token punctuation">&#123;</span>threading<span class="token punctuation">.</span>current_thread<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">&#125;</span></span><span class="token string"> is running'</span></span><span class="token punctuation">)</span>threads <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">:</span>    thread <span class="token operator">=</span> MyThread<span class="token punctuation">(</span>i<span class="token punctuation">)</span>    threads<span class="token punctuation">.</span>append<span class="token punctuation">(</span>thread<span class="token punctuation">)</span>    thread<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> thread <span class="token keyword">in</span> threads<span class="token punctuation">:</span>    thread<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Threading </span><span class="token interpolation"><span class="token punctuation">&#123;</span>threading<span class="token punctuation">.</span>current_thread<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">&#125;</span></span><span class="token string"> is ended'</span></span><span class="token punctuation">)</span></code></pre><p><strong>运行结果：</strong></p><pre class="language-none"><code class="language-none">Threading MainThread is runningThreading Thread-1 is running Threading Thread-1 sleep 1s Threading Thread-2 is running Threading Thread-2 sleep 5s Threading Thread-1 is ended Threading Thread-2 is ended Threading MainThread is ended </code></pre><h4 id="守护线程"><a href="#守护线程" class="headerlink" title="守护线程"></a>守护线程</h4><p>在线程中有一个叫作守护线程的概念，如果一个线程被设置为守护线程，那么意味着这个线程是“不重要”的，这意味着，如果主线程结束了而该守护线程还没有运行完，那么它将会被强制结束。</p><p>在 Python 中我们可以通过 setDaemon 方法来将某个线程设置为守护线程：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> threading<span class="token keyword">import</span> time<span class="token keyword">def</span> <span class="token function">target</span><span class="token punctuation">(</span>second<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Threading </span><span class="token interpolation"><span class="token punctuation">&#123;</span>threading<span class="token punctuation">.</span>current_thread<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">&#125;</span></span><span class="token string"> is running'</span></span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Threading </span><span class="token interpolation"><span class="token punctuation">&#123;</span>threading<span class="token punctuation">.</span>current_thread<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">&#125;</span></span><span class="token string"> sleep </span><span class="token interpolation"><span class="token punctuation">&#123;</span>second<span class="token punctuation">&#125;</span></span><span class="token string">s'</span></span><span class="token punctuation">)</span>    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span>second<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Threading </span><span class="token interpolation"><span class="token punctuation">&#123;</span>threading<span class="token punctuation">.</span>current_thread<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">&#125;</span></span><span class="token string"> is ended'</span></span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Threading </span><span class="token interpolation"><span class="token punctuation">&#123;</span>threading<span class="token punctuation">.</span>current_thread<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">&#125;</span></span><span class="token string"> is running'</span></span><span class="token punctuation">)</span>t1 <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>target<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>t1<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>t2 <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>target<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>t2<span class="token punctuation">.</span>setDaemon<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span>t2<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Threading </span><span class="token interpolation"><span class="token punctuation">&#123;</span>threading<span class="token punctuation">.</span>current_thread<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">&#125;</span></span><span class="token string"> is ended'</span></span><span class="token punctuation">)</span></code></pre><p><strong>运行结果：</strong></p><pre class="language-none"><code class="language-none">Threading MainThread is running Threading Thread-1 is running Threading Thread-1 sleep 2s Threading Thread-2 is running Threading Thread-2 sleep 5s Threading MainThread is ended Threading Thread-1 is ended </code></pre><blockquote><p>这里并没有调用 join 方法，如果让 t1 和 t2 都调用 join 方法，主线程就会仍然等待各个子线程执行完毕再退出，不论其是否是守护线程。</p></blockquote><h4 id="互斥锁"><a href="#互斥锁" class="headerlink" title="互斥锁"></a>互斥锁</h4><p>在一个进程中的多个线程是共享资源的，比如在一个进程中，有一个全局变量 count 用来计数，现在声明多个线程，每个线程运行时都给 count 加 1，代码实现如下：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> threading<span class="token keyword">import</span> timecount <span class="token operator">=</span> <span class="token number">0</span><span class="token keyword">class</span> <span class="token class-name">MyThread</span><span class="token punctuation">(</span>threading<span class="token punctuation">.</span>Thread<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        threading<span class="token punctuation">.</span>Thread<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">global</span> count        temp <span class="token operator">=</span> count <span class="token operator">+</span> <span class="token number">1</span>        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.001</span><span class="token punctuation">)</span>        count <span class="token operator">=</span> tempthreads <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    thread <span class="token operator">=</span> MyThread<span class="token punctuation">(</span><span class="token punctuation">)</span>    thread<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>    threads<span class="token punctuation">.</span>append<span class="token punctuation">(</span>thread<span class="token punctuation">)</span><span class="token keyword">for</span> thread <span class="token keyword">in</span> threads<span class="token punctuation">:</span>    thread<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Final count: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>count<span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span></code></pre><p><strong>运行结果：</strong></p><pre class="language-none"><code class="language-none">Final count: 69 </code></pre><p>由于 count 这个值是共享的，每个线程都可以在执行 temp = count 这行代码时拿到当前 count 的值，但是这些线程中的一些线程可能是并发或者并行执行的，这就导致不同的线程拿到的可能是同一个 count 值，最后导致有些线程的 count 的加 1 操作并没有生效，导致最后的结果偏小。</p><p>所以，如果多个线程同时对某个数据进行读取或修改，就会出现不可预料的结果。为了避免这种情况，我们需要对多个线程进行同步，要实现同步，我们可以对需要操作的数据进行加锁保护，这里就需要用到 threading.Lock 了。</p><h4 id="加锁保护"><a href="#加锁保护" class="headerlink" title="加锁保护"></a>加锁保护</h4><p>某个线程在对数据进行操作前，需要先加锁，这样其他的线程发现被加锁了之后，就无法继续向下执行，会一直等待锁被释放，只有加锁的线程把锁释放了，其他的线程才能继续加锁并对数据做修改，修改完了再释放锁。</p><p>这样可以确保同一时间只有一个线程操作数据，多个线程不会再同时读取和修改同一个数据。</p><h3 id="Python多线程的问题"><a href="#Python多线程的问题" class="headerlink" title="Python多线程的问题"></a>Python多线程的问题</h3><p>GIL 全称为 Global Interpreter Lock，译为全局解释器锁。</p><p>在 Python 多线程下，每个线程的执行方式如下：</p><ul><li>获取 GIL。</li><li>执行对应线程的代码。</li><li>释放 GIL。</li></ul><p>可见，某个线程想要执行，必须先拿到 GIL，可以把 GIL 看作是通行证，并且在一个 Python 进程中，GIL 只有一个。拿不到通行证的线程，就不允许执行。这样就会导致，即使是多核条件下，一个 Python 进程下的多个线程，同一时刻也只能执行一个线程。</p><p>对于爬虫这种 IO 密集型任务来说，这个问题影响并不大；而对于计算密集型任务来说，由于 GIL 的存在，多线程总体的运行效率相比可能反而比单线程更低。</p><p>Reference：<a href="https://kaiwu.lagou.com/course/courseInfo.htm?courseId=46#/detail/pc?id=1666">https://kaiwu.lagou.com/course/courseInfo.htm?courseId=46#/detail/pc?id=1666</a></p>]]></content>
      
      
      <categories>
          
          <category> MultiThreading </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> MultiThreading </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Session与Cookies</title>
      <link href="/posts/a5d7ebc3/"/>
      <url>/posts/a5d7ebc3/</url>
      
        <content type="html"><![CDATA[<h3 id="静态网页和动态网页"><a href="#静态网页和动态网页" class="headerlink" title="静态网页和动态网页"></a>静态网页和动态网页</h3><h5 id="静态网页"><a href="#静态网页" class="headerlink" title="静态网页"></a>静态网页</h5><pre class="language-html" data-language="html"><code class="language-html"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>This is a Demo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>container<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>wrapper<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>title<span class="token punctuation">"</span></span><span class="token punctuation">></span></span> Hello World<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Hello,this is a paragraph.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span> </code></pre><p>这种网页内容由 HTML 代码编写，文字、图片等内容均通过写好的 HTML 代码来指定，页面叫作静态网页，加载速度快，编写简单。</p><p>但存在很大的缺陷，如可维护性差，不能根据URL灵活多变地显示内容等。因此，动态网页应运而生，它可以动态解析 URL 中参数的变化，关联数据库并动态呈现不同的页面内容，非常灵活多变。</p><p>而现在遇到的大多数网站都是动态网站，不再是一个简单的 HTML，可能是由 JSP、PHP、 Python 等语言编写的，其功能比静态网页强大和丰富太多。<strong>动态网站还可以实现用户登录和注册的功能</strong>。</p><h4 id="无状态-HTTP"><a href="#无状态-HTTP" class="headerlink" title="无状态 HTTP"></a>无状态 HTTP</h4><p>HTTP 特点之一就是无状态。</p><p>无状态是指 HTTP 协议对事务处理是没有记忆能力的，也就是说服务器不知道客户端是什么状态，意味着如果后续需要处理前面的信息，则必须重传，这也导致需要额外传递一些前面的重复请求，才能获取后续响应。</p><h3 id="Session"><a href="#Session" class="headerlink" title="Session"></a>Session</h3><p>在服务端（网站的服务器）<br>用来保存用户的 Session 信息。</p><p>Session（会话） 本身的含义是指有始有终的一系列动作 / 消息。比如打电话时，从拿起电话拨号到挂断电话这中间的一系列过程可以称为一个 Session，在 Web 中，Session 对象用来存储特定用户 Session 所需的属性及配置信息。</p><h3 id="Cookies"><a href="#Cookies" class="headerlink" title="Cookies"></a>Cookies</h3><p>在客户端（可以理解为浏览器端）<br>浏览器在下次访问网页时会自动附带上。<br>它发送给服务器，服务器通过识别 Cookies 并鉴定出是哪个用户，然后再判断用户是否是登录状态，进而返回对应的响应。</p><p>Cookies 指某些网站为了辨别用户身份、进行 Session 跟踪而存储在用户本地终端上的数据。</p><p><strong>当客户端第一次请求服务器时</strong><br>服务器会返回一个响应头中带有 Set-Cookie 字段的响应给客户端，用来标记是哪一个用户，客户端浏览器会把 Cookies 保存起来。</p><p><strong>当浏览器下一次再请求该网站时</strong><br>浏览器会把此 Cookies 放到请求头一起提交给服务器，Cookies 携带了 Session ID 信息，服务器检查 Cookies 即可找到对应的 Session 是什么，然后判断 Session 以此来辨认用户状态。</p><p><strong>在成功登录某个网站时</strong><br>服务器会告诉客户端设置哪些 Cookies 信息，在后续访问页面时客户端会把 Cookies 发送给服务器，服务器再找到对应的 Session 加以判断。如果 Session 中的某些设置登录状态的变量是有效的，就证明用户处于登录状态。<br>此时返回登录之后才可以查看的网页内容，浏览器再进行解析便可以看到了。</p><pre><code>Session（在服务端）、Cookies（在客户端），二者共同协作，实现了登录 Session 控制。</code></pre><img src="https://img-blog.csdnimg.cn/20200603092616239.png" width="50%" loading="lazy"><p>会话 Cookie 就是把 Cookie 放在浏览器内存里，浏览器在关闭之后该 Cookie 即失效。<br>持久 Cookie 则会保存到客户端的硬盘中，下次还可以继续使用，用于长久保持用户登录状态。</p><blockquote><p>实际上，没有会话 Cookie 和持久 Cookie 之分，只是由 Cookie 的 Max Age 或 Expires 字段决定了过期的时间。</p></blockquote><blockquote><p>在谈论 Session 机制时，常听到这样一种误解 —— “只要关闭浏览器，Session 就消失了”。对Session来说，除非程序通知服务器删除一个 Session，否则服务器会一直保留，比如程序一般都是在我们做注销操作时才去删除 Session。当关闭浏览器时，浏览器不会主动在关闭之前通知服务器它将要关闭，所以服务器根本不会有机会知道浏览器已经关闭。</p></blockquote><blockquote><p>由于关闭浏览器不会导致 Session 被删除，这就需要服务器为 Session 设置一个失效时间，当距离客户端上一次使用 Session 的时间超过这个失效时间时，服务器就可以认为客户端已经停止了活动，才会把 Session 删除以节省存储空间。</p></blockquote><p>Reference：<a href="https://kaiwu.lagou.com/course/courseInfo.htm?courseId=46#/detail/pc?id=1665">https://kaiwu.lagou.com/course/courseInfo.htm?courseId=46#/detail/pc?id=1665</a></p>]]></content>
      
      
      <categories>
          
          <category> HTTP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> HTTP </tag>
            
            <tag> Session </tag>
            
            <tag> Cookies </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Web 网页基础</title>
      <link href="/posts/e332566f/"/>
      <url>/posts/e332566f/</url>
      
        <content type="html"><![CDATA[<h3 id="网页的组成"><a href="#网页的组成" class="headerlink" title="网页的组成"></a>网页的组成</h3><p>网页可以分为三大部分：HTML、CSS 和 JavaScript。</p><ul><li>HTML 相当于骨架。</li><li>JavaScript 相当于肌肉。</li><li>CSS 相当于皮肤。</li></ul><h3 id="HTML"><a href="#HTML" class="headerlink" title="HTML"></a>HTML</h3><p>HTML 是用来描述网页的一种语言，全称为 Hyper Text Markup Language 超文本标记语言<br>不同类型的元素通过不同类型的标签来表示：</p><ul><li>图片用 <code>img</code> 标签表示。</li><li>视频用 <code>video</code> 标签表示。</li><li>段落用 <code>p</code> 标签表示。</li><li>它们之间的布局又常通过布局标签 <code>div</code> 嵌套组合而成。</li></ul><h3 id="CSS"><a href="#CSS" class="headerlink" title="CSS"></a>CSS</h3><p>CSS 全称叫作 Cascading Style Sheets，即层叠样式表</p><ul><li>“层叠” 指当在 HTML 中引用了数个样式文件，并且样式发生冲突时，浏览器能依据层叠顺序处理。</li><li>“样式”指网页中文字大小、颜色、元素间距、排列等格式。</li></ul><blockquote><p>CSS 是目前唯一的网页页面排版样式标准。</p></blockquote><ul><li>在网页中，一般会统一定义整个网页的样式规则，并写入 CSS 文件中（其后缀为 css）。</li><li>在 HTML 中，只需要用 link 标签即可引入写好的 CSS 文件。</li></ul><h3 id="JavaScript"><a href="#JavaScript" class="headerlink" title="JavaScript"></a>JavaScript</h3><p>JavaScript 简称 JS，是一种脚本语言。</p><p>在网页里看到的一些交互和动画效果，如下载进度条、提示框、轮播图等，通常就是利用 JavaScript。</p><p>JavaScript 使得用户与信息之间不只是一种浏览与显示的关系，而是实现了一种实时、动态、交互的页面功能。</p><p>JavaScript 通常是以单独的文件形式加载的，后缀为 js，在 HTML 中通过 script 标签即可引入。</p><ul><li>HTML 定义网页的内容和结构。</li><li>CSS 描述网页的布局。</li><li>JavaScript 定义网页的行为。</li></ul><h3 id="网页的结构"><a href="#网页的结构" class="headerlink" title="网页的结构"></a>网页的结构</h3><pre class="language-html" data-language="html"><code class="language-html"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>This is a Demo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>container<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>wrapper<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>title<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Hello World<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Hello, this is a paragraph.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre><ul><li>head 标签内定义一些页面的配置和引用。</li><li>title 标签则定义网页的标题，会显示在网页的选项卡中，不会显示在正文中。</li><li>body 标签内是在网页正文中显示的内容。</li><li>div 标签定义网页中的区块。</li><li>h2 标签代表一个二级标题。</li></ul><p><strong>代码保存后，在浏览器中打开该文件：</strong></p><img src="https://img-blog.csdnimg.cn/20200602024954702.png" width="50%" loading="lazy"><p><strong>一个网页的标准形式：</strong></p><ul><li>html 标签内嵌套 head 和 body 标签。</li><li>head 内定义网页的配置和引用。</li><li>body 内定义网页的正文。</li></ul><h3 id="节点树及节点间的关系"><a href="#节点树及节点间的关系" class="headerlink" title="节点树及节点间的关系"></a>节点树及节点间的关系</h3><p>在 HTML 中，所有标签定义的内容都是节点，它们构成了一个 HTML DOM 树。<br>DOM 是 W3C（万维网联盟）的标准，其英文全称 Document Object Model，即文档对象模型。</p><p><strong>访问 HTML 和 XML 文档的标准：</strong><br>W3C 文档对象模型（DOM）是中立于平台和语言的接口，它允许程序和脚本动态地访问和更新文档的内容、结构和样式。</p><p><strong>W3C DOM 标准被分为 3 个不同的部分:</strong><br>核心 DOM - 针对任何结构化文档的标准模型。<br>XML DOM - 针对 XML 文档的标准模型。<br>HTML DOM - 针对 HTML 文档的标准模型。</p><p>根据 W3C 的 HTML DOM 标准，<strong>HTML 文档中的所有内容都是节点：</strong></p><ul><li>整个文档是一个文档节点</li><li>每个 HTML 元素是元素节点</li><li>HTML 元素内的文本是文本节点</li><li>每个 HTML 属性是属性节点</li><li>注释是注释节点</li></ul><p>HTML DOM 将 HTML 文档视作树结构，这种结构被称为节点树。<br>通过 HTML DOM，树中的所有节点均可通过 JavaScript 访问所有 HTML 节点元素均可被修改也可以被创建或删除。</p><img src="https://img-blog.csdnimg.cn/20200602025703691.png" width="50%" loading="lazy"><h3 id="节点树中的节点彼此拥有层级关系"><a href="#节点树中的节点彼此拥有层级关系" class="headerlink" title="节点树中的节点彼此拥有层级关系"></a>节点树中的节点彼此拥有层级关系</h3><p>常用父（parent） 、子（child）和兄弟（sibling）等术语描述这些关系。</p><p>父节点拥有子节点，同级的子节点被称为兄弟节点。</p><p>顶端节点称为根（root）。<br>除根节点外，每个节点都有父节点，同时可拥有任意数量的子节点或兄弟节点。</p><img src="https://img-blog.csdnimg.cn/20200602025939445.png" width="50%" loading="lazy"><h3 id="选择器"><a href="#选择器" class="headerlink" title="选择器"></a>选择器</h3><p>在 CSS 中，我们使用 CSS 选择器来定位节点。</p><pre class="language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>container<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></code></pre><p>表示为 #container。<br>其中 # 开头代表选择 id，其后紧跟 id 的名称。</p><p>可使用 wrapper 以点 “.”，开头代表选择 class，其后紧跟 class 的名称。</p><p>另外还可使用根据标签名筛选：</p><blockquote><p>例如想选择二级标题，直接用 h2 即可。</p></blockquote><p><strong>最常用的 3 种表示：</strong><br>根据 id、class、标签名筛选</p><p>CSS 选择器还支持嵌套选择，各个选择器之间加上空格分隔开可以代表嵌套关系。</p><blockquote><p>如 #container.wrapper p</p></blockquote><ul><li>代表先选择 id 为 container 的节点。</li><li>然后选中其内部的 class 为 wrapper 的节点。</li><li>然后再进一步选中其内部的 p 节点。</li></ul><p>不加空格，则代表并列关系</p><blockquote><p>如 div#container.wrapper p.text。</p></blockquote><ul><li>代表先选择 id 为 container 的 div 节点。</li><li>然后选中其内部的 class 为 wrapper 的节点。</li><li>再进一步选中其内部的 class 为 text 的 p 节点。</li></ul><p>Reference：<a href="https://kaiwu.lagou.com/course/courseInfo.htm?courseId=46#/detail/pc?id=1663">https://kaiwu.lagou.com/course/courseInfo.htm?courseId=46#/detail/pc?id=1663</a></p>]]></content>
      
      
      <categories>
          
          <category> Web </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Web </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HTTP 基本原理</title>
      <link href="/posts/380fcb48/"/>
      <url>/posts/380fcb48/</url>
      
        <content type="html"><![CDATA[<h3 id="URI-和-URL"><a href="#URI-和-URL" class="headerlink" title="URI 和 URL"></a>URI 和 URL</h3><p>URI（Uniform Resource Identifier）即统一资源标志符。<br>URL（Universal Resource Locator）即统一资源定位符。</p><p>例如：<br><code>https://github.com/favicon.ico</code> 既是一个URL，也是一个 URI。</p><blockquote><p>即有这样的一个图标资源<br>用 URL/URI 来唯一指定它的访问方式<br>这其中包括了访问协议 HTTPS、访问路径（即根目录）和资源名称 favicon.ico</p></blockquote><h3 id="URL-是-URI-的一个子集"><a href="#URL-是-URI-的一个子集" class="headerlink" title="URL 是 URI 的一个子集"></a>URL 是 URI 的一个子集</h3><p>URI 还包括一个子类 URN（Universal Resource Name），即统一资源名称。</p><p>URN 只命名资源而不指定如何定位资源。</p><p>例如：<br><code>urn:isbn:0451450523</code> 指定了一本书的 ISBN，可以唯一标识这本书，但是没有指定到哪里定位这本书。</p><h3 id="URL、URN-和-URI-的关系图"><a href="#URL、URN-和-URI-的关系图" class="headerlink" title="URL、URN 和 URI 的关系图"></a>URL、URN 和 URI 的关系图</h3><img src="https://img-blog.csdnimg.cn/20200528203523502.png" width="30%" loading="lazy"><h3 id="超文本（Hypertext）"><a href="#超文本（Hypertext）" class="headerlink" title="超文本（Hypertext）"></a>超文本（Hypertext）</h3><p>浏览器里看到的网页就是超文本解析而成的，其网页源代码是一系列 HTML 代码，里面包含了一系列标签。</p><p>例如：</p><ul><li>img 显示图片。</li><li>p 指定显示段落等。</li></ul><p>浏览器解析这些标签后，便形成了我们平常看到的网页，而<strong>网页的源代码 HTML 就可以称作超文本</strong>。</p><h3 id="HTTP-和-HTTPS"><a href="#HTTP-和-HTTPS" class="headerlink" title="HTTP 和 HTTPS"></a>HTTP 和 HTTPS</h3><p><code>https://www.taobao.com/</code> 中，URL 的开头会有 http 或 https。<br>这个就是访问资源需要的协议类型，有时还会看到 ftp、sftp、 smb 开头的 URL。</p><blockquote><p>ftp、sftp、 smb 都是指的协议类型。</p></blockquote><p><strong>HTTP（Hyper Text Transfer Protocol）中文名叫作超文本传输协议。</strong></p><p>用于从网络传输超文本数据到本地浏览器的传送协议，能保证高效而准确地传送超文本文档。</p><p>由万维网协会（World Wide Web Consortium）和 Internet 工作小组 IETF（Internet Engineering Task Force）共同合作制定的规范，目前广泛使用的是 HTTP1.1 版本。</p><p><strong>HTTPS（Hyper Text Transfer Protocol over Secure Socket Layer）</strong></p><p>是以安全为目标的 HTTP 通道，简单讲是 HTTP 的安全版，即 HTTP 下加入 SSL 层，简称为 HTTPS</p><p>安全基础是 SSL，因此通过它传输的内容都是经过 SSL 加密。</p><h6 id="HTTPS-的主要作用可以分为两种"><a href="#HTTPS-的主要作用可以分为两种" class="headerlink" title="HTTPS 的主要作用可以分为两种:"></a>HTTPS 的主要作用可以分为两种:</h6><ul><li>建立一个信息安全通道，来保证数据传输的安全。</li><li>确认网站的真实性，凡是使用了 HTTPS 的网站，都可以通过点击浏览器地址栏的锁头标志来查看网站<br>认证之后的真实信息，也可以通过 CA 机构颁发的安全签章来查询。</li></ul><h3 id="HTTP-请求过程"><a href="#HTTP-请求过程" class="headerlink" title="HTTP 请求过程"></a>HTTP 请求过程</h3><p>在浏览器中输入一个 URL，回车之后便可以在浏览器中观察到页面内容。</p><p>这个过程是<strong>浏览器向网站所在的服务器发送了一个请求</strong>，<strong>网站服务器接收到这个请求后进行处理和解析</strong>，<strong>然后返回对应的响应</strong>，<strong>接着传回给浏览器</strong>。</p><img src="https://img-blog.csdnimg.cn/20200528211056577.png" width="50%" loading="lazy"><h4 id="请求"><a href="#请求" class="headerlink" title="请求"></a>请求</h4><img src="https://img-blog.csdnimg.cn/20200528211534405.png" width="35%" loading="lazy"><h4 id="请求方法"><a href="#请求方法" class="headerlink" title="请求方法"></a>请求方法</h4><p>常见的有：GET 和 POST</p><p><strong>GET</strong></p><p>在浏览器中直接输入 URL 并回车，便发起了一个 GET 请求，请求的参数会直接包含到 URL 里。</p><p>例如：在百度中搜索 Python，这就是一个 GET 请求，链接为 <code>https://www.baidu.com/s?wd=Python</code>，URL 中包含了请求的参数信息，这里参数 wd 表示要搜寻的关键字。</p><p><strong>POST</strong></p><p>POST 请求大多在表单提交时发起。</p><p>例如：对于一个登录表单，输入用户名和密码后，点击“登录”按钮，这时通常会发起一个 POST 请求，其数据通常以表单的形式传输，而不会体现在 URL 中。</p><h3 id="GET-和-POST-请求方法有如下区别"><a href="#GET-和-POST-请求方法有如下区别" class="headerlink" title="GET 和 POST 请求方法有如下区别"></a>GET 和 POST 请求方法有如下区别</h3><ul><li>GET 请求中的参数包含在 URL 里面，数据可以在 URL 中看到，而 POST 请求的 URL 不会包含这些数据，数据都是通过表单形式传输的，会包含在请求体中。</li><li>GET 请求提交的数据最多只有 1024 字节，而 POST 请求没有限制。</li></ul><table><thead><tr><th>方法</th><th>描述</th></tr></thead><tbody><tr><td>GET</td><td>请求页面，并返回页面内容</td></tr><tr><td>HEAD</td><td>类似于 GET 请求，只不过返回的响应中没有具体的内容，用于获取报头</td></tr><tr><td>POST</td><td>大多用于提交表单或上传文件，数据包含在请求体中</td></tr><tr><td>PUT</td><td>从客户端向服务器传送的数据取代指定文档中的内容</td></tr><tr><td>DELETE</td><td>请求服务器删除指定的页面</td></tr><tr><td>CONNECT</td><td>把服务器当作跳板，让服务器代替客户端访问其他网页</td></tr><tr><td>OPTIONS</td><td>允许客户端查看服务器的性能</td></tr><tr><td>TRACE</td><td>回显服务器收到的请求，主要用于测试或诊断</td></tr></tbody></table><h3 id="请求-1"><a href="#请求-1" class="headerlink" title="请求"></a>请求</h3><ul><li><p><strong>请求的网址</strong><br>即统一资源定位符 URL，可以唯一确定我们想请求的资源。</p></li><li><p><strong>请求头</strong><br>用来说明服务器要使用的附加信息，比较重要的信息有 Cookie、Referer、User-Agent。</p></li></ul><ul><li><p><strong>Accept</strong>：请求报头域，用于指定客户端可接受哪些类型的信息。</p></li><li><p><strong>Accept-Language</strong>：指定客户端可接受的语言类型。</p></li><li><p><strong>Accept-Encoding</strong>：指定客户端可接受的内容编码。</p></li><li><p><strong>Host</strong>：用于指定请求资源的主机IP和端口号，其内容为请求URL的原始服务器或网关的位置。<br>从HTTP 1.1版本开始，请求必须包含此内容。</p></li><li><p><strong>Cookie</strong>：也常用复数形式 Cookies，这是网站为了辨别用户进行会话跟踪而存储在用户本地的数据，它的主要功能是维持当前访问会话。<br>例如，我们输入用户名和密码成功登录某个网站后，服务器会用会话保存登录状态信息，后面我们每次刷新或请求该站点的其他页面时，会发现都是登录状态，这就是 Cookies 的功劳。<br>Cookies 里有信息标识了我们所对应的服务器的会话，每次浏览器在请求该站点的页面时，都会在请求头中加上 Cookies 并将其发送给服务器，服务器通过 Cookies 识别出是我们自己，并且查出当前状态是登录状态，所以返回结果就是登录之后才能看到的网页内容。</p></li><li><p><strong>Referer</strong>：此内容用来标识这个请求是从哪个页面发过来的，服务器可以拿到这一信息并做相应的处理。<br>如做来源统计、防盗链处理等。</p></li><li><p><strong>User-Agent</strong>：简称 UA，它是一个特殊的字符串头，可以使服务器识别客户使用的操作系统及版本、浏览器及版本等信息。在做爬虫时加上此信息，可以伪装为浏览器；如果不加，很可能会被识别出为爬虫。</p></li><li><p><strong>Content-Type</strong>：也叫互联网媒体类型（Internet Media Type）或者 MIME 类型，在 HTTP 协议消息头中，它用来表示具体请求中的媒体类型信息。<br>例如，text/html 代表 HTML 格式，image / gif 代表 GIF 图片；application / json 代表 JSON 类型</p></li></ul><p>请求体一般承载的内容是 POST 请求中的表单数据，而对于 GET 请求，请求体则为空。</p><h5 id="表单提交中，需要正确设置-Content-Type："><a href="#表单提交中，需要正确设置-Content-Type：" class="headerlink" title="表单提交中，需要正确设置 Content-Type："></a>表单提交中，需要正确设置 Content-Type：</h5><table><thead><tr><th>Content-Type</th><th>提交数据的方式</th></tr></thead><tbody><tr><td>application / x-www-form-urlencoded</td><td>表单数据</td></tr><tr><td>multipart / form-data</td><td>表单文件上传</td></tr><tr><td>application / json</td><td>序列化 JSON 数据</td></tr><tr><td>text / xml</td><td>XML 数据</td></tr></tbody></table><h3 id="响应"><a href="#响应" class="headerlink" title="响应"></a>响应</h3><p>由服务端返回给客户端，可以分为三部分:</p><ol><li>响应状态码（Response Status Code）</li><li>响应头（Response Headers）</li><li>响应体（Response Body）</li></ol><h5 id="响应状态码表示服务器的响应状态："><a href="#响应状态码表示服务器的响应状态：" class="headerlink" title="响应状态码表示服务器的响应状态："></a>响应状态码表示服务器的响应状态：</h5><table><thead><tr><th>状态码</th><th>说明</th><th>详情</th></tr></thead><tbody><tr><td>100</td><td>继续</td><td>请求者应当继续提出请求，服务器已收到请求的一部分，正在等待其余部分</td></tr><tr><td>101</td><td>切换协议</td><td>请求者已要求服务器切换协议，服务器已确认并准备切换</td></tr><tr><td>200</td><td>成功</td><td>服务器已成功处理了请求</td></tr><tr><td>201</td><td>已创建</td><td>请求成功并且服务器创建了新的资源</td></tr><tr><td>202</td><td>已接受</td><td>服务器已接受请求，但尚未处理</td></tr><tr><td>203</td><td>非授权信息</td><td>服务器已成功处理了请求，但返回的信息可能来自另一个源</td></tr><tr><td>204</td><td>无内容</td><td>服务器成功处理了请求，但没有返回任何内容</td></tr><tr><td>205</td><td>重置内容</td><td>服务器成功处理了请求，内容被重置</td></tr><tr><td>206</td><td>部分内容</td><td>服务器成功处理了部分请求</td></tr><tr><td>300</td><td>多种选择</td><td>针对请求，服务器可执行多种操作</td></tr><tr><td>301</td><td>永久移动</td><td>请求的网页已永久移动到新位置，即永久重定向</td></tr><tr><td>302</td><td>临时移动</td><td>请求的网页暂时跳转到其他页面，即暂时重定向</td></tr><tr><td>303</td><td>查看其他位置</td><td>如果原来的请求是 POST，重定向目标文档应该通过 GET 提取</td></tr><tr><td>304</td><td>未修改</td><td>此次请求返回的网页未修改，继续使用上次的资源</td></tr><tr><td>305</td><td>使用代理</td><td>请求者应该使用代理访问该网页</td></tr><tr><td>307</td><td>临时重定向</td><td>请求的资源临时从其他位置响应</td></tr><tr><td>400</td><td>错误请求</td><td>服务器无法解析该请求</td></tr><tr><td>401</td><td>未授权</td><td>请求没有进行身份验证或验证未通过</td></tr><tr><td>403</td><td>禁止访问</td><td>服务器拒绝此请求</td></tr><tr><td>404</td><td>未找到</td><td>服务器找不到请求的网页</td></tr><tr><td>405</td><td>方法禁用</td><td>服务器禁用了请求中指定的方法</td></tr><tr><td>406</td><td>不接受</td><td>无法使用请求的内容响应请求的网页</td></tr><tr><td>407</td><td>需要代理授权</td><td>请求者需要使用代理授权</td></tr><tr><td>408</td><td>请求超时</td><td>服务器请求超时</td></tr><tr><td>409</td><td>冲突</td><td>服务器在完成请求时发生冲突</td></tr><tr><td>410</td><td>已删除</td><td>请求的资源已永久删除</td></tr><tr><td>411</td><td>需要有效长度</td><td>服务器不接受不含有效内容长度标头字段的请求</td></tr><tr><td>412</td><td>未满足前提条件</td><td>服务器未满足请求者在请求中设置的其中一个前提条件</td></tr><tr><td>413</td><td>请求实体过大</td><td>请求实体过大，超出服务器的处理能力</td></tr><tr><td>414</td><td>请求URI过长</td><td>请求网址过长，服务器无法处理</td></tr><tr><td>415</td><td>不支持类型</td><td>请求格式不被请求页面支持</td></tr><tr><td>416</td><td>请求范围不符</td><td>页面无法提供请求的范围</td></tr><tr><td>417</td><td>未满足期望值</td><td>服务器未满足期望请求标头字段的要求</td></tr><tr><td>500</td><td>服务器内部错误</td><td>服务器遇到错误，无法宗成请求</td></tr><tr><td>501</td><td>未实现</td><td>服务器不具备完成请求的功能</td></tr><tr><td>502</td><td>错误网关</td><td>服务器作为网关或代理，从上游服务器收到无效响应</td></tr><tr><td>503</td><td>服务不可用</td><td>服务器目前无法使用</td></tr><tr><td>504</td><td>网关超时</td><td>服务器作为网关或代理，但是没有及时从上游服务器收到请求</td></tr><tr><td>505</td><td>HTTP版本不支持</td><td>服务器不支持请求中所用的 HTTP 协议版本</td></tr></tbody></table><p><strong>响应头</strong>包含了服务器对请求的应答信息，如 Content-Type、Server、 Set-Cookie 等。</p><p>一些常用的头信息：</p><ul><li><strong>Date</strong>：标识响应产生的时间。</li><li><strong>Last-Modified</strong>：指定资源的最后修改时间。</li><li><strong>Content-Encoding</strong>：指定响应内容的编码。</li><li><strong>Server</strong>：包含服务器的信息，比如名称、版本号等。</li><li><strong>Content-Type</strong>：文档类型,指定返回的数据类型是什么，如 text / html 代表返回 HTML 文档<br>application / x-javascript 则代表返回 JavaScript 文件，image / jpeg 则代表返回图片。</li><li><strong>Set-Cookie</strong>：设置 Cookies。 响应头中的 Set-Cookie 告诉浏览器需要将此内容放在 Cookies 中<br>下次请求携带 Cookies 请求。</li><li><strong>Expires</strong>：指定响应的过期时间，可以使代理服务器或浏览器将加载的内容更新到缓存中。<br>如果再次访问时，就可以直接从缓存中加载，降低服务器负裁，缩短加载时间。</li></ul><p><strong>最重要的当属响应体的内容，响应的正文数据都在响应体中。</strong></p><p>例如：</p><ul><li><p>请求网页时，它的响应体就是网页的 HTML 代码。</p></li><li><p>请求一张图片时，它的响应体就是图片的二进制数据。</p></li></ul><p>Reference：<a href="https://kaiwu.lagou.com/course/courseInfo.htm?courseId=46#/detail/pc?id=1662">https://kaiwu.lagou.com/course/courseInfo.htm?courseId=46#/detail/pc?id=1662</a></p>]]></content>
      
      
      <categories>
          
          <category> HTTP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> HTTP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>requests 库代理的设置</title>
      <link href="/posts/ecfd9a1a/"/>
      <url>/posts/ecfd9a1a/</url>
      
        <content type="html"><![CDATA[<p>在爬虫运行的时候，有时候会出现 <code>403 Forbidden</code> 的情况，也就是我们的<strong>访问次数超过了目标网站设置的阈值</strong>，这样它就会直接拒绝服务，返回一些错误信息，也就是所谓的封 IP。</p><hr><h4 id="基于-requests-的代理的设置："><a href="#基于-requests-的代理的设置：" class="headerlink" title="基于 requests 的代理的设置："></a>基于 requests 的代理的设置：</h4><blockquote><p>requests 的代理设置比 urllib 简单很多，它只需要构造代理字典，然后通过 proxies 参数即可，而不需要重新构建 Opener。</p></blockquote><h5 id="代码如下："><a href="#代码如下：" class="headerlink" title="代码如下："></a>代码如下：</h5><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requestsproxy <span class="token operator">=</span> <span class="token string">'113.194.28.190:9999'</span>proxies <span class="token operator">=</span> <span class="token punctuation">&#123;</span>        <span class="token string">'http'</span><span class="token punctuation">:</span> <span class="token string">'http://'</span> <span class="token operator">+</span> proxy<span class="token punctuation">,</span>        <span class="token string">'https'</span><span class="token punctuation">:</span> <span class="token string">'https://'</span> <span class="token operator">+</span> proxy   <span class="token punctuation">&#125;</span><span class="token keyword">try</span><span class="token punctuation">:</span>    response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'http://httpbin.org/get'</span><span class="token punctuation">,</span> proxies<span class="token operator">=</span>proxies<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token keyword">except</span> requests<span class="token punctuation">.</span>exceptions<span class="token punctuation">.</span>ConnectionError <span class="token keyword">as</span> e<span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Error'</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>args<span class="token punctuation">)</span></code></pre><h4 id="Output："><a href="#Output：" class="headerlink" title="Output："></a>Output：</h4><img src="https://img-blog.csdnimg.cn/20200409234755424.png" width="30%" loading="lazy"><p>运行结果的 origin 是代理的 IP，这证明代理已经设置成功。</p><hr><p>如果代理需要认证，在代理的前面加上用户名和密码即可，即代理的写法变成如下所示：</p><pre class="language-python" data-language="python"><code class="language-python">proxy <span class="token operator">=</span> <span class="token string">'username:password@113.194.28.190:9999'</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> requests </category>
          
      </categories>
      
      
        <tags>
            
            <tag> requests </tag>
            
            <tag> proxy </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>模拟 Ajax 请求爬取 4000 部豆瓣电影</title>
      <link href="/posts/e4ca6198/"/>
      <url>/posts/e4ca6198/</url>
      
        <content type="html"><![CDATA[<h6 id="进入准备爬取的网页："><a href="#进入准备爬取的网页：" class="headerlink" title="进入准备爬取的网页："></a>进入<a href="https://movie.douban.com/tag/#/?sort=U&range=0,10&tags=%E7%94%B5%E5%BD%B1">准备爬取的网页</a>：</h6><img src="https://img-blog.csdnimg.cn/20200712174837865.png" width="60%" loading="lazy"><p><strong>编写一个获取页面的函数：</strong></p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">get_html</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> proxies<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    @功能: 获取页面    @参数: URL链接、代理IP列表    @返回: 页面内容    """</span>    failed <span class="token operator">=</span> <span class="token number">1</span>  <span class="token comment"># 请求失败参数</span>    headers <span class="token operator">=</span> <span class="token punctuation">[</span>                  <span class="token punctuation">&#123;</span><span class="token string">'User-Agent'</span><span class="token punctuation">:</span> <span class="token string">"Mozilla/5.0 (X11; U; Linux x86_64; zh-CN; rv:1.9.2.10) Gecko/20100922 Ubuntu/10.10 (maverick) Firefox/3.6.10"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>                  <span class="token punctuation">&#123;</span><span class="token string">'User-Agent'</span><span class="token punctuation">:</span> <span class="token string">"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/39.0.2171.95 Safari/537.36 OPR/26.0.1656.60"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>                  <span class="token punctuation">&#123;</span><span class="token string">'User-Agent'</span><span class="token punctuation">:</span> <span class="token string">"Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; WOW64; Trident/5.0; SLCC2; .NET CLR 2.0.50727; .NET CLR 3.5.30729; .NET CLR 3.0.30729; Media Center PC 6.0; .NET4.0C; .NET4.0E; QQBrowser/7.0.3698.400)"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>                  <span class="token punctuation">&#123;</span><span class="token string">'User-Agent'</span><span class="token punctuation">:</span> <span class="token string">"Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1; Trident/4.0; SV1; QQDownload 732; .NET4.0C; .NET4.0E; SE 2.X MetaSr 1.0)"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>                  <span class="token punctuation">&#123;</span><span class="token string">'User-Agent'</span><span class="token punctuation">:</span> <span class="token string">"Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; rv:11.0) like Gecko"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>                  <span class="token punctuation">&#123;</span><span class="token string">'User-Agent'</span><span class="token punctuation">:</span> <span class="token string">"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Maxthon/4.4.3.4000 Chrome/30.0.1599.101 Safari/537.36"</span><span class="token punctuation">&#125;</span>              <span class="token punctuation">]</span>    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>        <span class="token keyword">try</span><span class="token punctuation">:</span>            <span class="token keyword">if</span> failed <span class="token operator">%</span> <span class="token number">5</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>                proxies  <span class="token operator">=</span> get_proxy<span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"请求失败次数太多,更新代理IP!"</span><span class="token punctuation">)</span>            time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>            res <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">,</span> headers<span class="token operator">=</span>random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>headers<span class="token punctuation">)</span><span class="token punctuation">,</span> proxies<span class="token operator">=</span>random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>proxies<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">if</span> res<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">:</span>                <span class="token keyword">return</span> res<span class="token punctuation">.</span>text        <span class="token keyword">except</span><span class="token punctuation">:</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"请求失败"</span><span class="token punctuation">)</span>            failed <span class="token operator">=</span> failed <span class="token operator">+</span> <span class="token number">1</span></code></pre><p><strong>打开 Chrome 的开发者工具，并通过点击下面的 <code>加载更多</code>，捕获 Ajax 请求，并发现其规律：</strong></p><img src="https://img-blog.csdnimg.cn/20200712175741183.png" width="60%" loading="lazy"><img src="https://img-blog.csdnimg.cn/20200712180102367.png" width="100%" loading="lazy"><p>可以发现请求 URL 的规律是 <code>https://movie.douban.com/j/new_search_subjects?sort=U&amp;range=0,10&amp;tags=%E7%94%B5%E5%BD%B1&amp;start=</code> + <code>20的整数倍</code> ，每个 Ajax 请求会加载 20 部电影的数据，且数据是 json 格式，因此我们可以通过程序模拟 Ajax 请求，从而获取所需的电影数据：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">crawl_movies</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    @功能: 爬取电影相关信息    @参数: 电影数量/20(一共是20*num部电影)    @返回: 电影的相关信息(json格式)    """</span>    movies_lists <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    update <span class="token operator">=</span> <span class="token number">0</span>  <span class="token comment"># 更新代理IP的参数</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> update <span class="token operator">%</span> <span class="token number">40</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>            proxies <span class="token operator">=</span> get_proxy<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"更新代理IP!"</span><span class="token punctuation">)</span>        url <span class="token operator">=</span> <span class="token string">"https://movie.douban.com/j/new_search_subjects?sort=U&amp;range=0,10&amp;tags=%E7%94%B5%E5%BD%B1&amp;start="</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span>  <span class="token comment"># 每个电影列表的URL(一个页面20部电影)</span>        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>            data <span class="token operator">=</span> get_html<span class="token punctuation">(</span>url<span class="token punctuation">,</span> proxies<span class="token punctuation">)</span>  <span class="token comment"># 获取电影列表页面</span>            dicts <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>data<span class="token punctuation">)</span>  <span class="token comment"># 把数据转换成json格式</span>            <span class="token keyword">if</span> dicts <span class="token operator">!=</span> <span class="token punctuation">&#123;</span><span class="token string">"msg"</span><span class="token punctuation">:</span><span class="token string">"检测到有异常请求从您的IP发出，请登录再试!"</span><span class="token punctuation">,</span><span class="token string">"r"</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">:</span>                <span class="token keyword">break</span>        <span class="token keyword">try</span><span class="token punctuation">:</span>            movies_lists<span class="token punctuation">.</span>append<span class="token punctuation">(</span>dicts<span class="token punctuation">[</span><span class="token string">'data'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"成功获取20部电影的网页!"</span><span class="token punctuation">)</span>            update <span class="token operator">=</span> update <span class="token operator">+</span> <span class="token number">1</span>        <span class="token keyword">except</span><span class="token punctuation">:</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"获取资源失败"</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> movies_lists</code></pre><pre class="language-python" data-language="python"><code class="language-python"><span class="token punctuation">&#123;</span><span class="token string">"data"</span><span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token punctuation">&#123;</span><span class="token string">"directors"</span><span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">"弗兰克·德拉邦特"</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">"rate"</span><span class="token punctuation">:</span><span class="token string">"9.7"</span><span class="token punctuation">,</span><span class="token string">"cover_x"</span><span class="token punctuation">:</span><span class="token number">2000</span><span class="token punctuation">,</span><span class="token string">"star"</span><span class="token punctuation">:</span><span class="token string">"50"</span><span class="token punctuation">,</span><span class="token string">"title"</span><span class="token punctuation">:</span><span class="token string">"肖申克的救赎"</span><span class="token punctuation">,</span><span class="token string">"url"</span><span class="token punctuation">:</span><span class="token string">"https:\/\/movie.douban.com\/subject\/1292052\/"</span><span class="token punctuation">,</span><span class="token string">"casts"</span><span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">"蒂姆·罗宾斯"</span><span class="token punctuation">,</span><span class="token string">"摩根·弗里曼"</span><span class="token punctuation">,</span><span class="token string">"鲍勃·冈顿"</span><span class="token punctuation">,</span><span class="token string">"威廉姆·赛德勒"</span><span class="token punctuation">,</span><span class="token string">"克兰西·布朗"</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">"cover"</span><span class="token punctuation">:</span><span class="token string">"https://img9.doubanio.com\/view\/photo\/s_ratio_poster\/public\/p480747492.webp"</span><span class="token punctuation">,</span><span class="token string">"id"</span><span class="token punctuation">:</span><span class="token string">"1292052"</span><span class="token punctuation">,</span><span class="token string">"cover_y"</span><span class="token punctuation">:</span><span class="token number">2963</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span><span class="token string">"directors"</span><span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">"文牧野"</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">"rate"</span><span class="token punctuation">:</span><span class="token string">"9.0"</span><span class="token punctuation">,</span><span class="token string">"cover_x"</span><span class="token punctuation">:</span><span class="token number">2810</span><span class="token punctuation">,</span><span class="token string">"star"</span><span class="token punctuation">:</span><span class="token string">"45"</span><span class="token punctuation">,</span><span class="token string">"title"</span><span class="token punctuation">:</span><span class="token string">"我不是药神"</span><span class="token punctuation">,</span><span class="token string">"url"</span><span class="token punctuation">:</span><span class="token string">"https:\/\/movie.douban.com\/subject\/26752088\/"</span><span class="token punctuation">,</span><span class="token string">"casts"</span><span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">"徐峥"</span><span class="token punctuation">,</span><span class="token string">"王传君"</span><span class="token punctuation">,</span><span class="token string">"周一围"</span><span class="token punctuation">,</span><span class="token string">"谭卓"</span><span class="token punctuation">,</span><span class="token string">"章宇"</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">"cover"</span><span class="token punctuation">:</span><span class="token string">"https://img9.doubanio.com\/view\/photo\/s_ratio_poster\/public\/p2561305376.webp"</span><span class="token punctuation">,</span><span class="token string">"id"</span><span class="token punctuation">:</span><span class="token string">"26752088"</span><span class="token punctuation">,</span><span class="token string">"cover_y"</span><span class="token punctuation">:</span><span class="token number">3937</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code></pre><p><strong>通过分析上述 json 格式的数据，我们可以进行解析和提取：</strong></p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">parse_movies</span><span class="token punctuation">(</span>movies_lists<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    @功能: 解析电影信息    @参数: 电影的相关信息(json格式)    @返回: 电影信息列表    """</span>    movies <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># 存储每部电影</span>    update <span class="token operator">=</span> <span class="token number">0</span>  <span class="token comment"># 更新代理IP的参数</span>    count <span class="token operator">=</span> <span class="token number">1</span>  <span class="token comment"># 日志参数</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>movies_lists<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">for</span> j <span class="token keyword">in</span> movies_lists<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">:</span>            name <span class="token operator">=</span> j<span class="token punctuation">[</span><span class="token string">'title'</span><span class="token punctuation">]</span>  <span class="token comment"># 电影名称</span>            rate <span class="token operator">=</span> j<span class="token punctuation">[</span><span class="token string">'rate'</span><span class="token punctuation">]</span>  <span class="token comment"># 电影评分</span>            <span class="token keyword">try</span><span class="token punctuation">:</span>                directors <span class="token operator">=</span> j<span class="token punctuation">[</span><span class="token string">'directors'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># 导演</span>            <span class="token keyword">except</span><span class="token punctuation">:</span>                directors <span class="token operator">=</span> <span class="token boolean">None</span>            dataID <span class="token operator">=</span> j<span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">]</span>  <span class="token comment"># 电影ID</span>            url <span class="token operator">=</span> j<span class="token punctuation">[</span><span class="token string">'url'</span><span class="token punctuation">]</span>  <span class="token comment"># 电影链接</span>            pic <span class="token operator">=</span> j<span class="token punctuation">[</span><span class="token string">'cover'</span><span class="token punctuation">]</span>  <span class="token comment"># 电影海报</span>            actors <span class="token operator">=</span> <span class="token string">'  '</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>j<span class="token punctuation">[</span><span class="token string">'casts'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 主演</span>            <span class="token keyword">if</span> update <span class="token operator">%</span> <span class="token number">40</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>                proxies <span class="token operator">=</span> get_proxy<span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"更新代理IP!"</span><span class="token punctuation">)</span></code></pre><p><strong>如果需要提取另外的信息，我们可以获取电影的 URL，并提取其对应页面中的信息：</strong></p><p><img src="https://img-blog.csdnimg.cn/20200712181945612.png?1x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTk2MTc3NA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" loading="lazy"></p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">parse_movies</span><span class="token punctuation">(</span>movies_lists<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    @功能: 解析电影信息    @参数: 电影的相关信息(json格式)    @返回: 电影信息列表    """</span>    movies <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># 存储每部电影</span>    update <span class="token operator">=</span> <span class="token number">0</span>  <span class="token comment"># 更新代理IP的参数</span>    count <span class="token operator">=</span> <span class="token number">1</span>  <span class="token comment"># 日志参数</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>movies_lists<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">for</span> j <span class="token keyword">in</span> movies_lists<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">:</span>            name <span class="token operator">=</span> j<span class="token punctuation">[</span><span class="token string">'title'</span><span class="token punctuation">]</span>  <span class="token comment"># 电影名称</span>            rate <span class="token operator">=</span> j<span class="token punctuation">[</span><span class="token string">'rate'</span><span class="token punctuation">]</span>  <span class="token comment"># 电影评分</span>            <span class="token keyword">try</span><span class="token punctuation">:</span>                directors <span class="token operator">=</span> j<span class="token punctuation">[</span><span class="token string">'directors'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># 导演</span>            <span class="token keyword">except</span><span class="token punctuation">:</span>                directors <span class="token operator">=</span> <span class="token boolean">None</span>            dataID <span class="token operator">=</span> j<span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">]</span>  <span class="token comment"># 电影ID</span>            url <span class="token operator">=</span> j<span class="token punctuation">[</span><span class="token string">'url'</span><span class="token punctuation">]</span>  <span class="token comment"># 电影链接</span>            pic <span class="token operator">=</span> j<span class="token punctuation">[</span><span class="token string">'cover'</span><span class="token punctuation">]</span>  <span class="token comment"># 电影海报</span>            actors <span class="token operator">=</span> <span class="token string">'  '</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>j<span class="token punctuation">[</span><span class="token string">'casts'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 主演</span>            <span class="token keyword">if</span> update <span class="token operator">%</span> <span class="token number">40</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>                proxies <span class="token operator">=</span> get_proxy<span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"更新代理IP!"</span><span class="token punctuation">)</span>            text <span class="token operator">=</span> get_html<span class="token punctuation">(</span>url<span class="token punctuation">,</span> proxies<span class="token punctuation">)</span>  <span class="token comment"># 获取每部电影的页面</span>            html <span class="token operator">=</span> etree<span class="token punctuation">.</span>HTML<span class="token punctuation">(</span>text<span class="token punctuation">)</span>  <span class="token comment"># 解析每部电影的页面</span>            <span class="token comment"># 电影英文名称</span>            english_name <span class="token operator">=</span> html<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">"//*[@id='content']/h1/span[1]/text()"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>            <span class="token comment"># 判断字符串中是否存在英文</span>            <span class="token keyword">if</span> <span class="token builtin">bool</span><span class="token punctuation">(</span>re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">'[A-Za-z]'</span><span class="token punctuation">,</span> english_name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                english_name <span class="token operator">=</span> english_name<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span>  <span class="token comment"># 分割字符串以提取英文名称</span>                <span class="token keyword">del</span> english_name<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># 去除中文名称</span>                english_name <span class="token operator">=</span> <span class="token string">' '</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>english_name<span class="token punctuation">)</span>  <span class="token comment"># 重新以空格连接列表中的字符串</span>            <span class="token keyword">else</span><span class="token punctuation">:</span>                english_name <span class="token operator">=</span> <span class="token boolean">None</span>            info <span class="token operator">=</span> html<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">"//div[@class='subject clearfix']/div[@id='info']//text()"</span><span class="token punctuation">)</span>  <span class="token comment"># 每部电影的相关信息</span>            <span class="token comment"># 编剧</span>            flag <span class="token operator">=</span> <span class="token number">1</span>            writer <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>            <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                <span class="token keyword">if</span> info<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'编剧'</span><span class="token punctuation">:</span>                    <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                        <span class="token keyword">if</span> info<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'主演'</span><span class="token punctuation">:</span>                            flag <span class="token operator">=</span> <span class="token number">0</span>                            <span class="token keyword">break</span>                        <span class="token keyword">for</span> ch <span class="token keyword">in</span> info<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">:</span>                            <span class="token comment"># 判断字符串中是否存在中文或英文</span>                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">u'\u4e00'</span> <span class="token operator">&lt;=</span> ch <span class="token operator">&lt;=</span> <span class="token string">u'\u9fff'</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">(</span>re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">'[a-z]'</span><span class="token punctuation">,</span> info<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                                writer<span class="token punctuation">.</span>append<span class="token punctuation">(</span>info<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                                flag <span class="token operator">=</span> <span class="token number">0</span>                                <span class="token keyword">break</span>                        <span class="token keyword">if</span> flag <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>                            <span class="token keyword">break</span>                <span class="token keyword">if</span> flag <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>                    <span class="token keyword">break</span>            writer <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>writer<span class="token punctuation">)</span>  <span class="token comment"># 转换为字符串形式</span>            <span class="token comment"># 电影类型</span>            flag <span class="token operator">=</span> <span class="token number">1</span>            style <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>            <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                <span class="token keyword">if</span> info<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'类型:'</span><span class="token punctuation">:</span>                    <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                        <span class="token keyword">if</span> <span class="token punctuation">(</span>info<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'制片国家/地区:'</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token punctuation">(</span>info<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'官方网站:'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                            flag <span class="token operator">=</span> <span class="token number">0</span>                            <span class="token keyword">break</span>                        <span class="token keyword">for</span> ch <span class="token keyword">in</span> info<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">:</span>                            <span class="token comment"># 判断字符串中是否存在中文</span>                            <span class="token keyword">if</span> <span class="token string">u'\u4e00'</span> <span class="token operator">&lt;=</span> ch <span class="token operator">&lt;=</span> <span class="token string">u'\u9fff'</span><span class="token punctuation">:</span>                                style<span class="token punctuation">.</span>append<span class="token punctuation">(</span>info<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span>                                <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>style<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">:</span>                                    flag <span class="token operator">=</span> <span class="token number">0</span>                                    <span class="token keyword">break</span>                                <span class="token keyword">break</span>                        <span class="token keyword">if</span> flag <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>                            <span class="token keyword">break</span>                <span class="token keyword">if</span> flag <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>                    <span class="token keyword">break</span>            <span class="token comment"># 把电影类型分开存储</span>            <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>style<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>                style1 <span class="token operator">=</span> style<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>                style2 <span class="token operator">=</span> <span class="token boolean">None</span>                style3 <span class="token operator">=</span> <span class="token boolean">None</span>            <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>style<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">:</span>                style1 <span class="token operator">=</span> style<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>                style2 <span class="token operator">=</span> style<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>                style3 <span class="token operator">=</span> <span class="token boolean">None</span>            <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>style<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">:</span>                style1 <span class="token operator">=</span> style<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>                style2 <span class="token operator">=</span> style<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>                style3 <span class="token operator">=</span> style<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>            <span class="token comment"># 国家</span>            flag <span class="token operator">=</span> <span class="token number">1</span>            country <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>            <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                <span class="token keyword">if</span> info<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">r'制片国家/地区:'</span><span class="token punctuation">:</span>                    <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                        <span class="token keyword">if</span> info<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'语言:'</span><span class="token punctuation">:</span>                            flag <span class="token operator">=</span> <span class="token number">0</span>                            <span class="token keyword">break</span>                        <span class="token keyword">for</span> ch <span class="token keyword">in</span> info<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">:</span>                            <span class="token comment"># 判断字符串中是否存在中文</span>                            <span class="token keyword">if</span> <span class="token string">u'\u4e00'</span> <span class="token operator">&lt;=</span> ch <span class="token operator">&lt;=</span> <span class="token string">u'\u9fff'</span><span class="token punctuation">:</span>                                country<span class="token punctuation">.</span>append<span class="token punctuation">(</span>info<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                                flag <span class="token operator">=</span> <span class="token number">0</span>                                <span class="token keyword">break</span>                        <span class="token keyword">if</span> flag <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>                            <span class="token keyword">break</span>                <span class="token keyword">if</span> flag <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>                    <span class="token keyword">break</span>            country <span class="token operator">=</span> country<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">r'/'</span><span class="token punctuation">)</span>            country <span class="token operator">=</span> country<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>            <span class="token comment"># 电影语言</span>            flag <span class="token operator">=</span> <span class="token number">1</span>            language <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>            <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                <span class="token keyword">if</span> info<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'语言:'</span><span class="token punctuation">:</span>                    <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                        <span class="token keyword">if</span> info<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'上映日期:'</span><span class="token punctuation">:</span>                            flag <span class="token operator">=</span> <span class="token number">0</span>                            <span class="token keyword">break</span>                        <span class="token keyword">for</span> ch <span class="token keyword">in</span> info<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">:</span>                            <span class="token comment"># 判断字符串中是否存在中文</span>                            <span class="token keyword">if</span> <span class="token string">u'\u4e00'</span> <span class="token operator">&lt;=</span> ch <span class="token operator">&lt;=</span> <span class="token string">u'\u9fff'</span><span class="token punctuation">:</span>                                language<span class="token punctuation">.</span>append<span class="token punctuation">(</span>info<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                                flag <span class="token operator">=</span> <span class="token number">0</span>                                <span class="token keyword">break</span>                        <span class="token keyword">if</span> flag <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>                            <span class="token keyword">break</span>                <span class="token keyword">if</span> flag <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>                    <span class="token keyword">break</span>            <span class="token keyword">try</span><span class="token punctuation">:</span>                language <span class="token operator">=</span> language<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">r'/'</span><span class="token punctuation">)</span>                language <span class="token operator">=</span> language<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>            <span class="token keyword">except</span><span class="token punctuation">:</span>                language <span class="token operator">=</span> <span class="token boolean">None</span>            <span class="token comment"># 电影上映日期</span>            flag <span class="token operator">=</span> <span class="token number">1</span>            date <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>            <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                <span class="token keyword">if</span> info<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'上映日期:'</span><span class="token punctuation">:</span>                    <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                        <span class="token keyword">if</span> <span class="token punctuation">(</span>info<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'片长:'</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token punctuation">(</span>info<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'又名:'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                            flag <span class="token operator">=</span> <span class="token number">0</span>                            <span class="token keyword">break</span>                        <span class="token keyword">for</span> ch <span class="token keyword">in</span> info<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">:</span>                            <span class="token comment"># 判断字符串中是否存在中文或英文</span>                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">u'\u4e00'</span> <span class="token operator">&lt;=</span> ch <span class="token operator">&lt;=</span> <span class="token string">u'\u9fff'</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">(</span>re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">'[a-z]'</span><span class="token punctuation">,</span> info<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                                date<span class="token punctuation">.</span>append<span class="token punctuation">(</span>re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">r'\d+'</span><span class="token punctuation">,</span> info<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                                flag <span class="token operator">=</span> <span class="token number">0</span>                                <span class="token keyword">break</span>                        <span class="token keyword">if</span> flag <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>                            <span class="token keyword">break</span>                <span class="token keyword">if</span> flag <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>                    <span class="token keyword">break</span>            date <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>date<span class="token punctuation">)</span>  <span class="token comment"># 转换为字符串形式</span>            <span class="token comment"># 电影片长</span>            flag <span class="token operator">=</span> <span class="token number">1</span>            duration <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>            <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                <span class="token keyword">if</span> info<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'片长:'</span><span class="token punctuation">:</span>                    <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                        <span class="token keyword">if</span> <span class="token punctuation">(</span>info<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'又名:'</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token punctuation">(</span>info<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'IMDb链接:'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                            flag <span class="token operator">=</span> <span class="token number">0</span>                            <span class="token keyword">break</span>                        <span class="token keyword">for</span> ch <span class="token keyword">in</span> info<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">:</span>                            <span class="token comment"># 判断字符串中是否存在中文</span>                            <span class="token keyword">if</span> <span class="token string">u'\u4e00'</span> <span class="token operator">&lt;=</span> ch <span class="token operator">&lt;=</span> <span class="token string">u'\u9fff'</span><span class="token punctuation">:</span>                                info<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> info<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>                                duration<span class="token punctuation">.</span>append<span class="token punctuation">(</span>re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">r'\d+'</span><span class="token punctuation">,</span> info<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                                flag <span class="token operator">=</span> <span class="token number">0</span>                                <span class="token keyword">break</span>                        <span class="token keyword">if</span> flag <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>                            <span class="token keyword">break</span>                <span class="token keyword">if</span> flag <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>                    <span class="token keyword">break</span>            duration <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>duration<span class="token punctuation">)</span>  <span class="token comment"># 转换为字符串形式</span>            <span class="token comment"># 电影简介</span>            introduction <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>html<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">"//div[@class='related-info']/div[@id='link-report']/span/text()"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'\xa0'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">u'\u3000'</span><span class="token punctuation">,</span> <span class="token string">u' '</span><span class="token punctuation">)</span>            <span class="token comment"># 把每部电影的信息存入一个列表，再append进去movies总列表</span>            movies<span class="token punctuation">.</span>append<span class="token punctuation">(</span>                            <span class="token punctuation">[</span>name<span class="token punctuation">,</span> english_name<span class="token punctuation">,</span> directors<span class="token punctuation">,</span> writer<span class="token punctuation">,</span> actors<span class="token punctuation">,</span> rate<span class="token punctuation">,</span> style1<span class="token punctuation">,</span> style2<span class="token punctuation">,</span> style3<span class="token punctuation">,</span>                             country<span class="token punctuation">,</span> language<span class="token punctuation">,</span> date<span class="token punctuation">,</span> duration<span class="token punctuation">,</span> introduction<span class="token punctuation">,</span> dataID<span class="token punctuation">,</span> url<span class="token punctuation">,</span> pic<span class="token punctuation">]</span>                         <span class="token punctuation">)</span>            update <span class="token operator">=</span> update <span class="token operator">+</span> <span class="token number">1</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"成功解析第"</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"部电影的信息!"</span><span class="token punctuation">)</span>            count <span class="token operator">+=</span> <span class="token number">1</span>    <span class="token keyword">return</span> movies</code></pre><hr><h4 id="完整源代码"><a href="#完整源代码" class="headerlink" title="完整源代码"></a><a href="https://github.com/Giyn/PythonSpider/blob/master/DouBanMoviesSpiders/crawl%20dbmovies(5000)/crawl%20dbmovies(4000).py">完整源代码</a></h4>]]></content>
      
      
      <categories>
          
          <category> WebScraper </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Ajax </tag>
            
            <tag> requests </tag>
            
            <tag> WebScraper </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2020 全国大学生数学建模竞赛 C 题思路</title>
      <link href="/posts/4afbb50d/"/>
      <url>/posts/4afbb50d/</url>
      
        <content type="html"><![CDATA[<p>mark</p>]]></content>
      
      
      <categories>
          
          <category> MathematicalModeling </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MathematicalModeling </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用 Scrapy 爬虫框架爬取 books.toscrape.com 上书籍的相关信息</title>
      <link href="/posts/b425ae87/"/>
      <url>/posts/b425ae87/</url>
      
        <content type="html"><![CDATA[<p>此处准备使用 Scrapy 爬虫框架对 <a href="http://books.toscrape.com/">http://books.toscrape.com/</a>（一个专门用来被爬取的网站）上书籍的相关信息进行爬取。</p><p><code>相关信息包括：书名、价格、评价等级、库存量、产品编码、评价数量。</code></p><hr><h3 id="首先进行页面分析："><a href="#首先进行页面分析：" class="headerlink" title="首先进行页面分析："></a>首先进行页面分析：</h3><blockquote><p>这里补充一下，通常现在的浏览器都会对 HTML 文本进行一定的规范化, 所以在使用 Chrome 等浏览器自带的 XPath 路径的时候, 有可能会导致读取失败。<br>虽然很多时候用 view 命令加载出的页面和浏览器打开的是一样的，但是前者是 Scrapy 爬虫下载的页面，后者是由浏览器下载的页面，有时它们是不同的。</p></blockquote><p>在进行页面分析时，使用 view 命令更加可靠：</p><pre><code>在命令提示符窗口输入scrapy shell urlview(response)然后就打开了 Scrapy 爬虫下载的页面，此时在 F12 开发者工具中看的路径就是原始路径。</code></pre><h3 id="以第一本书为例进行分析："><a href="#以第一本书为例进行分析：" class="headerlink" title="以第一本书为例进行分析："></a>以第一本书为例进行分析：</h3><p>首先输入 <code>scrapy shell http://books.toscrape.com/catalogue/a-light-in-the-attic_1000/index.html</code><br><img src="https://img-blog.csdnimg.cn/20200228113739296.png" alt="在这里插入图片描述" loading="lazy"></p><blockquote><p>运行这条命令后，scrapy shell 会使用 URL 参数构造一个 Request 对象，并提交给 Scrapy 引擎，页面下载完成后，程序进入 Scrapy 终端，在此环境中已经创建好了一些变量（对象和函数），我们可以在这里调试爬取代码。</p></blockquote><p>状态码为 200，表示请求成功：</p><img src="https://img-blog.csdnimg.cn/20200228120504292.png" width="60%" loading="lazy"><p>然后输入 <code>view(response)</code>：</p><img src="https://img-blog.csdnimg.cn/2020022811392076.png" width="50%" loading="lazy"><p>然后就自动打开页面了：</p><p><img src="https://img-blog.csdnimg.cn/20200228114106814.png?1x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTk2MTc3NA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" loading="lazy"></p><h3 id="接下来使用-XPath-Helper-和-F12-解析-HTML-页面："><a href="#接下来使用-XPath-Helper-和-F12-解析-HTML-页面：" class="headerlink" title="接下来使用 XPath Helper 和 F12 解析 HTML 页面："></a>接下来使用 XPath Helper 和 F12 解析 HTML 页面：</h3><p>首先是书名：</p><p><img src="https://img-blog.csdnimg.cn/20200228114839884.png?1x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTk2MTc3NA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" loading="lazy"></p><p>在 Scrapy 终端里测试一下：</p><p><img src="https://img-blog.csdnimg.cn/20200228115211302.png" alt="在这里插入图片描述" loading="lazy"></p><blockquote><p><strong>extract() 与 extract_first() 区别：</strong><br>extract() 返回的所有数据，存在一个 list 里。<br>extract_first() 返回的是一个 string，是 extract() 结果中第一个值。</p></blockquote><hr><p>接下来是价格：</p><p><img src="https://img-blog.csdnimg.cn/20200228121904511.png?1x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTk2MTc3NA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" loading="lazy"></p><hr><p>然后是评价等级：</p><p><img src="https://img-blog.csdnimg.cn/20200228122502887.png?1x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTk2MTc3NA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" loading="lazy"></p><p>我们用正则表达式去除字符串中的 <code>star-rating</code>：</p><p><img src="https://img-blog.csdnimg.cn/20200228123132343.png" alt="在这里插入图片描述" loading="lazy"></p><hr><p>接下来是库存量：</p><p><img src="https://img-blog.csdnimg.cn/20200228124658391.png?1x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTk2MTc3NA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" loading="lazy"></p><p>我们依然使用正则表达式对库存量进行提取：</p><p><img src="https://img-blog.csdnimg.cn/20200228130935435.png" alt="在这里插入图片描述" loading="lazy"></p><p><strong>这里我们会发现，按照我们直接分析的 XPath 是提取不到内容的，我们得删去 tbody 标签，为什么呢？</strong></p><p>因为浏览器本身自动为 table 新增了 tbody 标签内容，但是在 xpath 中是不需要的（试试看把 tbody 标签去掉，依然表示对应的信息），需要在进行 xpath 查询之时移除掉。</p><hr><p>然后是产品编码：</p><p><img src="https://img-blog.csdnimg.cn/20200228131515231.png?1x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTk2MTc3NA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" loading="lazy"></p><p>同理，我们可以这样提取：</p><p><img src="https://img-blog.csdnimg.cn/20200228131721329.png" alt="在这里插入图片描述" loading="lazy"></p><hr><p>最后是评价数量：</p><p><img src="https://img-blog.csdnimg.cn/20200228132038589.png?1x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTk2MTc3NA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" loading="lazy"></p><p>同理，我们可以这样提取：</p><p><img src="https://img-blog.csdnimg.cn/20200228132329216.png" alt="在这里插入图片描述" loading="lazy"></p><hr><p>至此，我们已经分析完了一本书的页面，接下来我们考虑一下如何<strong>获取一个页面所有书籍的链接以及获取下一页的链接</strong>。</p><hr><p>首先我们<strong>使用 fetch 命令下载书籍列表页面</strong>，然后<strong>用 view 命令打开页面进行分析</strong>：</p><p><img src="https://img-blog.csdnimg.cn/20200228133429522.png" alt="在这里插入图片描述" loading="lazy"></p><p>经过分析，一个页面所有书籍的链接如下：</p><p><img src="https://img-blog.csdnimg.cn/2020022813404364.png?1x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTk2MTc3NA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" loading="lazy"></p><p>接下来分析下一页的链接：</p><p><img src="https://img-blog.csdnimg.cn/20200228134510487.png?1x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTk2MTc3NA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" loading="lazy"></p><hr><p>然后我们使用 LinkExtractor 提取这些链接：</p><blockquote><p>因为 href 中的链接跟该站点有联系，直接获取出来的不是绝对 URL，需要拼接计算。<br>如 catalogue/page-2.html 是标签中的内容，而正确地址为 <a href="http://books.toscrape.com/catalogue/page-2.html">http://books.toscrape.com/catalogue/page-2.html</a></p></blockquote><p>我们分析一下如何提取一个页面中所有书的绝对链接：</p><p><img src="https://img-blog.csdnimg.cn/20200228140305883.png?1x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTk2MTc3NA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" loading="lazy"></p><p>接下来用 Scrapy 终端测试一下：</p><blockquote><p>这里有个细节要注意，在使用双重引号的时候，要么外面是双引号，里面是单引号；要么反过来。否则就会报错：SyntaxError: invalid syntax</p><p><img src="https://img-blog.csdnimg.cn/2020022814372646.png?1x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTk2MTc3NA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" loading="lazy"></p></blockquote><p>然后用 Scrapy 终端测试下一页的链接：</p><p><img src="https://img-blog.csdnimg.cn/20200228144256189.png?1x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTk2MTc3NA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" loading="lazy"></p><p><strong>这里详细分析一下这些对象：</strong></p><ul><li><p>le 是 LinkExtractor 对象，起到选择器作用，定义选取规则。</p></li><li><p>links 是 le 调用 extract_links 方法，传入当前页面 response，在当前页面中根据 le 规则寻找 links，返回 Link 对象组成的列表。</p></li><li><p>links[0] 是一个 Link 对象。</p></li><li><p>links[0].url 是对象的一个属性，即我们要的绝对 URL 地址（无需再拼接计算）。</p></li></ul><hr><h3 id="接着开始创建-Scrapy-爬虫工程："><a href="#接着开始创建-Scrapy-爬虫工程：" class="headerlink" title="接着开始创建 Scrapy 爬虫工程："></a>接着开始创建 Scrapy 爬虫工程：</h3><p>此处使用 Pycharm 实现，首先在 Pycharm 创建一个新的项目 MyScrapy：</p><img src="https://img-blog.csdnimg.cn/20200228145258978.png" width="60%" loading="lazy"><p>接下来打开 Pycharm 的终端 Terminal，输入 <code>scrapy startproject books</code> 创建一个 Scrapy 爬虫项目：</p><img src="https://img-blog.csdnimg.cn/20200228145735435.png" width="60%" loading="lazy"><p>然后进入 books 目录，输入 <code>scrapy genspider books_spider books.toscrape.com </code>创建 Spider 文件以及 Spider 类：</p><img src="https://img-blog.csdnimg.cn/2020022815025368.png" width="60%" loading="lazy"><p>在实现 Spider 之前，先定义封装书籍信息的 Item 类，在 items.py 中添加如下代码：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># 书籍项目</span><span class="token keyword">class</span> <span class="token class-name">BooksItem</span><span class="token punctuation">(</span>scrapy<span class="token punctuation">.</span>Item<span class="token punctuation">)</span><span class="token punctuation">:</span>    name <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 书名</span>    price <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 价格</span>    review_rating <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 评价等级</span>    review_num <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 评价数量</span>    upc <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 产品编码</span>    stock <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 库存量</span></code></pre><p>接下来我们在爬虫类中要实现两个页面解析函数，一个是每一页的页面解析函数，一个是每本书的页面解析函数，打开 books.py，根据我们前面的分析，编辑代码如下：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token keyword">import</span> scrapy<span class="token keyword">from</span> scrapy<span class="token punctuation">.</span>linkextractors <span class="token keyword">import</span> LinkExtractor<span class="token keyword">from</span> <span class="token punctuation">.</span><span class="token punctuation">.</span>items <span class="token keyword">import</span> BooksItem  <span class="token comment"># ..表示上级目录</span><span class="token keyword">class</span> <span class="token class-name">BooksSpider</span><span class="token punctuation">(</span>scrapy<span class="token punctuation">.</span>Spider<span class="token punctuation">)</span><span class="token punctuation">:</span>    name <span class="token operator">=</span> <span class="token string">'books'</span>    allowed_domains <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'books.toscrape.com'</span><span class="token punctuation">]</span>    start_urls <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'http://books.toscrape.com/'</span><span class="token punctuation">]</span>    <span class="token comment"># 每一页的页面解析函数</span>    <span class="token keyword">def</span> <span class="token function">parse</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token comment"># 提取当前页面所有书的url</span>        le <span class="token operator">=</span> LinkExtractor<span class="token punctuation">(</span>restrict_xpaths<span class="token operator">=</span><span class="token string">'//article[@class="product_pod"]'</span><span class="token punctuation">)</span>        <span class="token keyword">for</span> link <span class="token keyword">in</span> le<span class="token punctuation">.</span>extract_links<span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">yield</span> scrapy<span class="token punctuation">.</span>Request<span class="token punctuation">(</span>url<span class="token operator">=</span>link<span class="token punctuation">.</span>url<span class="token punctuation">,</span> callback<span class="token operator">=</span>self<span class="token punctuation">.</span>parse_book<span class="token punctuation">)</span>        <span class="token comment"># 提取下一页的url</span>        le <span class="token operator">=</span> LinkExtractor<span class="token punctuation">(</span>restrict_xpaths<span class="token operator">=</span><span class="token string">'//ul[@class="pager"]/li[@class="next"]/a'</span><span class="token punctuation">)</span>        links <span class="token operator">=</span> le<span class="token punctuation">.</span>extract_links<span class="token punctuation">(</span>response<span class="token punctuation">)</span>        <span class="token keyword">if</span> links<span class="token punctuation">:</span>            next_url <span class="token operator">=</span> links<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>url            <span class="token keyword">yield</span> scrapy<span class="token punctuation">.</span>Request<span class="token punctuation">(</span>url<span class="token operator">=</span>next_url<span class="token punctuation">,</span> callback<span class="token operator">=</span>self<span class="token punctuation">.</span>parse<span class="token punctuation">)</span>    <span class="token comment"># 每一本书的页面解析函数</span>    <span class="token keyword">def</span> <span class="token function">parse_book</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>        book <span class="token operator">=</span> BooksItem<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 将信息存入BooksItem对象</span>        book<span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span> <span class="token operator">=</span> response<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'//div[@class="col-sm-6 product_main"]/h1/text()'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract_first<span class="token punctuation">(</span><span class="token punctuation">)</span>        book<span class="token punctuation">[</span><span class="token string">'price'</span><span class="token punctuation">]</span> <span class="token operator">=</span> response<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'//p[@class="price_color"]/text()'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract_first<span class="token punctuation">(</span><span class="token punctuation">)</span>        book<span class="token punctuation">[</span><span class="token string">'review_rating'</span><span class="token punctuation">]</span> <span class="token operator">=</span> response<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'//div[@class="col-sm-6 product_main"]/p[3]/@class'</span><span class="token punctuation">)</span> \            <span class="token punctuation">.</span>re_first<span class="token punctuation">(</span><span class="token string">'star-rating ([A-Za-z]+)'</span><span class="token punctuation">)</span>  <span class="token comment"># \是续行符</span>        book<span class="token punctuation">[</span><span class="token string">'stock'</span><span class="token punctuation">]</span> <span class="token operator">=</span> response<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'//table[@class="table table-striped"]//tr[6]/td/text()'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>re_first<span class="token punctuation">(</span><span class="token string">'\((\d+) available\)'</span><span class="token punctuation">)</span>        book<span class="token punctuation">[</span><span class="token string">'upc'</span><span class="token punctuation">]</span> <span class="token operator">=</span> response<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'//table[@class="table table-striped"]//tr[1]/td/text()'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract_first<span class="token punctuation">(</span><span class="token punctuation">)</span>        book<span class="token punctuation">[</span><span class="token string">'review_num'</span><span class="token punctuation">]</span> <span class="token operator">=</span> response<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'//table[@class="table table-striped"]//tr[7]/td/text()'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract_first<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">yield</span> book</code></pre><hr><h3 id="优化步骤："><a href="#优化步骤：" class="headerlink" title="优化步骤："></a>优化步骤：</h3><p>接下来配置文件 settings.py，使用 FEED_EXPORT_FIELDS 指定各列的次序：</p><pre class="language-python" data-language="python"><code class="language-python">FEED_EXPORT_FIELDS<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'upc'</span><span class="token punctuation">,</span><span class="token string">'name'</span><span class="token punctuation">,</span><span class="token string">'price'</span><span class="token punctuation">,</span><span class="token string">'stock'</span><span class="token punctuation">,</span><span class="token string">'review_rating'</span><span class="token punctuation">,</span><span class="token string">'review_num'</span><span class="token punctuation">]</span></code></pre><p>另外，评价等级字段的值是 One、Two、Three…… 这样的英语单词，我们可以将它们改为阿拉伯数字，下面实现一个 Item Pipeline，将单词映射到数字。在 pipelines.py 中实现 BookPipeline，代码如下：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">BooksPipeline</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    review_rating_map <span class="token operator">=</span> <span class="token punctuation">&#123;</span>        <span class="token string">'One'</span><span class="token punctuation">:</span>  <span class="token number">1</span><span class="token punctuation">,</span>        <span class="token string">'Two'</span><span class="token punctuation">:</span>  <span class="token number">2</span><span class="token punctuation">,</span>        <span class="token string">'Three'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span>        <span class="token string">'Four'</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span>        <span class="token string">'Five'</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>        <span class="token punctuation">&#125;</span>    <span class="token keyword">def</span> <span class="token function">process_item</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>item<span class="token punctuation">,</span>spider<span class="token punctuation">)</span><span class="token punctuation">:</span>        rating <span class="token operator">=</span> item<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'review_rating'</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> rating<span class="token punctuation">:</span>            item<span class="token punctuation">[</span><span class="token string">'review_rating'</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>review_rating_map<span class="token punctuation">[</span>rating<span class="token punctuation">]</span>        <span class="token keyword">return</span> item</code></pre><p>然后在配置文件 settings.py 中启用 BooksPipeline：</p><pre class="language-python" data-language="python"><code class="language-python">ITEM_PIPELINES <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token string">'books.pipelines.BooksPipeline'</span><span class="token punctuation">:</span> <span class="token number">300</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span> <span class="token comment"># books是 Scrapy爬虫项目的名字</span></code></pre><hr><h3 id="最后运行整个爬虫项目："><a href="#最后运行整个爬虫项目：" class="headerlink" title="最后运行整个爬虫项目："></a>最后运行整个爬虫项目：</h3><p>在 Pycharm 终端输入 <code>scrapy crawl books_spider -o books.csv --nolog</code>：</p><blockquote><p>这里加上 - -nolog 就可以不显示运行日志</p></blockquote><img src="https://img-blog.csdnimg.cn/20200228172613457.png" width="60%" loading="lazy"><img src="https://img-blog.csdnimg.cn/20200228162331690.png" width="60%" loading="lazy"><img src="https://img-blog.csdnimg.cn/20200228172845805.png" width="60%" loading="lazy"><p>至此，整个爬虫项目就完成了。</p><hr><h4 id="完整源代码"><a href="#完整源代码" class="headerlink" title="完整源代码"></a><a href="https://github.com/Giyn/PythonSpider/tree/master/MyScrapyBooks/books">完整源代码</a></h4>]]></content>
      
      
      <categories>
          
          <category> WebScraper </category>
          
      </categories>
      
      
        <tags>
            
            <tag> WebScraper </tag>
            
            <tag> Scrapy </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>爬取 b 站视频的名称、地址、简介、观看次数、弹幕数量及发布时间</title>
      <link href="/posts/534e73ee/"/>
      <url>/posts/534e73ee/</url>
      
        <content type="html"><![CDATA[<h2 id="该爬虫大致分为以下步骤："><a href="#该爬虫大致分为以下步骤：" class="headerlink" title="该爬虫大致分为以下步骤："></a>该爬虫大致分为以下步骤：</h2><p><strong>0. 搜索关键词、点击搜索、进入新页面</strong>。<br><strong>1. 获取每个页面的 HTML</strong>。<br><strong>2. 解析每个页面的 HTML</strong>。<br><strong>3. 将爬取到的数据写入 csv 文件</strong>。</p><p>（这里搜索的例子是华晨宇，爬取前 5 页）</p><p>文章末尾有完整源代码，分析过程的代码比较杂。</p><hr><p><strong>先引入相关模块、做好准备工作：</strong></p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requests<span class="token keyword">from</span> bs4 <span class="token keyword">import</span> BeautifulSoup<span class="token keyword">from</span> selenium <span class="token keyword">import</span> webdriver  <span class="token comment"># 引入浏览器驱动</span><span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver<span class="token punctuation">.</span>common<span class="token punctuation">.</span>by <span class="token keyword">import</span> By  <span class="token comment"># 借助By模块进行操作</span><span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver<span class="token punctuation">.</span>support<span class="token punctuation">.</span>ui <span class="token keyword">import</span> WebDriverWait  <span class="token comment"># 显式等待</span><span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver<span class="token punctuation">.</span>support <span class="token keyword">import</span> expected_conditions <span class="token keyword">as</span> Ec  <span class="token comment"># 显式等待的条件</span><span class="token keyword">from</span> selenium<span class="token punctuation">.</span>common<span class="token punctuation">.</span>exceptions <span class="token keyword">import</span> TimeoutException  <span class="token comment"># 捕获超时异常</span><span class="token keyword">import</span> pandas <span class="token keyword">as</span> pdbrowser <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Chrome<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 获取浏览器对象</span>WAIT <span class="token operator">=</span> WebDriverWait<span class="token punctuation">(</span>browser<span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span>  <span class="token comment"># 指定最长等待时间</span>url <span class="token operator">=</span> <span class="token string">'https://www.bilibili.com'</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'开始访问b站……'</span><span class="token punctuation">)</span>browser<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span></code></pre><hr><h2 id="0-搜索关键词、点击搜索、进入新页面："><a href="#0-搜索关键词、点击搜索、进入新页面：" class="headerlink" title="0.搜索关键词、点击搜索、进入新页面："></a>0.搜索关键词、点击搜索、进入新页面：</h2><p><strong>首先我们按 F12 观察一下 b 站页面的搜索框和搜索按键：</strong></p><img src="https://img-blog.csdnimg.cn/20200215133511238.png" width="70%" loading="lazy"><img src="https://img-blog.csdnimg.cn/20200215133530631.png" width="70%" loading="lazy"><p><strong>这里我们使用 XPath 选取节点，右键点击框起来的标签选择 Copy XPath。</strong></p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">search</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'正在进行搜索……'</span><span class="token punctuation">)</span>    <span class="token comment"># 用XPath选取节点</span>    <span class="token builtin">input</span> <span class="token operator">=</span> WAIT<span class="token punctuation">.</span>until<span class="token punctuation">(</span>Ec<span class="token punctuation">.</span>presence_of_element_located<span class="token punctuation">(</span><span class="token punctuation">(</span>By<span class="token punctuation">.</span>XPATH<span class="token punctuation">,</span><span class="token string">'//*[@id="nav_searchform"]/input'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    submit <span class="token operator">=</span> WAIT<span class="token punctuation">.</span>until<span class="token punctuation">(</span>Ec<span class="token punctuation">.</span>element_to_be_clickable<span class="token punctuation">(</span><span class="token punctuation">(</span>By<span class="token punctuation">.</span>XPATH<span class="token punctuation">,</span><span class="token string">'//*[@id="nav_searchform"]/div/button'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment"># 从搜索框输入并点击搜索</span>    <span class="token builtin">input</span><span class="token punctuation">.</span>send_keys<span class="token punctuation">(</span>content<span class="token punctuation">)</span>    submit<span class="token punctuation">.</span>click<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><hr><h2 id="1-获取每个页面的-HTML："><a href="#1-获取每个页面的-HTML：" class="headerlink" title="1. 获取每个页面的 HTML："></a>1. 获取每个页面的 HTML：</h2><p><strong>首先我们搜索华晨宇，打开第二页：</strong></p><img src="https://img-blog.csdnimg.cn/20200215135909178.png" width="60%" loading="lazy"><p><strong>我们看到在 URL 的末尾有一个关于页数的标记，所以我们使用 for 循环配合 f+ 字符串的语句来格式化：</strong></p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token comment"># 用f+字符串来表示每一个页面的网址</span>        url <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"https://search.bilibili.com/all?keyword=%E5%8D%8E%E6%99%A8%E5%AE%87&amp;from_source=nav_search_new&amp;page=</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span></code></pre><p><strong>这个步骤的代码为：</strong></p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">crawl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    htmls <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># 存放每个页面的HTML</span>    <span class="token comment"># 用for循环爬取每一个页面并获得其HTML</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token comment"># 用f+字符串来表示每一个页面的网址</span>        url <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"https://search.bilibili.com/all?keyword=%E5%8D%8E%E6%99%A8%E5%AE%87&amp;from_source=nav_search_new&amp;page=</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span>        r <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span>  <span class="token comment"># 返回Response对象</span>        <span class="token keyword">if</span> r<span class="token punctuation">.</span>status_code <span class="token operator">!=</span> <span class="token number">200</span><span class="token punctuation">:</span>  <span class="token comment"># 状态码检测</span>            <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">)</span>        htmls<span class="token punctuation">.</span>append<span class="token punctuation">(</span>r<span class="token punctuation">.</span>text<span class="token punctuation">)</span>  <span class="token comment"># r.text是字符串类型</span>    <span class="token keyword">return</span> htmls</code></pre><hr><h2 id="2-解析每个页面的-HTML："><a href="#2-解析每个页面的-HTML：" class="headerlink" title="2. 解析每个页面的 HTML："></a>2. 解析每个页面的 HTML：</h2><p><strong>这时我们已经完成了搜索的操作，接下来按 F12：</strong></p><img src="https://img-blog.csdnimg.cn/2020021716052667.png" width="60%" loading="lazy"><hr><p><strong>然后找到每个视频的 HTML 内容，我们使用 find 和 find_all 函数进行提取（返回的是列表）：</strong></p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">parse</span><span class="token punctuation">(</span>htmls<span class="token punctuation">)</span><span class="token punctuation">:</span>    videos <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># 存放每个视频解析出来的HTML</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'解析页面中……'</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> html <span class="token keyword">in</span> htmls<span class="token punctuation">:</span>        soup <span class="token operator">=</span> BeautifulSoup<span class="token punctuation">(</span>html<span class="token punctuation">,</span> <span class="token string">'html.parser'</span><span class="token punctuation">)</span>  <span class="token comment"># 解析每个页面</span>        <span class="token comment"># 获取每个视频的标签树</span>        video <span class="token operator">=</span> soup<span class="token punctuation">.</span>find<span class="token punctuation">(</span>class_ <span class="token operator">=</span> <span class="token string">"video-list clearfix"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>find_all<span class="token punctuation">(</span>class_<span class="token operator">=</span><span class="token string">"video-item matrix"</span><span class="token punctuation">)</span>        videos<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>video<span class="token punctuation">)</span>  <span class="token comment"># 列表存入列表，所以用extend()函数</span></code></pre><hr><p><strong>接下来查找每个视频的名称、地址、简介、观看次数、弹幕数量及发布时间的 HTML 内容：</strong></p><img src="https://img-blog.csdnimg.cn/20200217163420738.png" width="70%" loading="lazy"><p>我们以第一个视频为例，可以看出视频的名称是 a 标签的 title 属性，地址是 href 属性，简介在有属性 class=”des hide” 的标签的 NavigableString（非属性字符串）元素中，而观看次数、弹幕数量及发布时间也类似，这里我找到 class=”so-icon watch-num”、class=”so-icon time”、class=”so-icon hide” 对应的标签并用 <code>get_text()</code> 的方法获取目标路径下的子孙字符串（或者你找到 i 标签，用 <code>.string</code> 方法获取也可以，这里尝试多一种方法）。</p><hr><p><strong>完整的 parse 函数代码：</strong></p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">parse</span><span class="token punctuation">(</span>htmls<span class="token punctuation">)</span><span class="token punctuation">:</span>    videos <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># 存放每个视频解析出来的HTML</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'解析页面中……'</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> html <span class="token keyword">in</span> htmls<span class="token punctuation">:</span>        soup <span class="token operator">=</span> BeautifulSoup<span class="token punctuation">(</span>html<span class="token punctuation">,</span> <span class="token string">'html.parser'</span><span class="token punctuation">)</span>  <span class="token comment"># 解析每个页面</span>        <span class="token comment"># 获取每个视频的标签树</span>        video <span class="token operator">=</span> soup<span class="token punctuation">.</span>find<span class="token punctuation">(</span>class_ <span class="token operator">=</span> <span class="token string">"video-list clearfix"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>find_all<span class="token punctuation">(</span>class_<span class="token operator">=</span><span class="token string">"video-item matrix"</span><span class="token punctuation">)</span>        videos<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>video<span class="token punctuation">)</span>  <span class="token comment"># 列表存入列表，所以用extend()函数</span>    items <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># 存放每个视频的各个项目</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'正在爬取相关信息……'</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> video <span class="token keyword">in</span> videos<span class="token punctuation">:</span>        item <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>  <span class="token comment"># 每个字典存放每个视频的相关信息</span>        item<span class="token punctuation">[</span><span class="token string">'视频标题'</span><span class="token punctuation">]</span> <span class="token operator">=</span> video<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'title'</span><span class="token punctuation">]</span>  <span class="token comment"># 获取标签属性</span>        item<span class="token punctuation">[</span><span class="token string">'视频地址'</span><span class="token punctuation">]</span> <span class="token operator">=</span> video<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'href'</span><span class="token punctuation">]</span>        item<span class="token punctuation">[</span><span class="token string">'简介'</span><span class="token punctuation">]</span> <span class="token operator">=</span> video<span class="token punctuation">.</span>find<span class="token punctuation">(</span>class_ <span class="token operator">=</span> <span class="token string">'des hide'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>string  <span class="token comment"># 获取NavigableString</span>        item<span class="token punctuation">[</span><span class="token string">'观看次数'</span><span class="token punctuation">]</span> <span class="token operator">=</span> video<span class="token punctuation">.</span>find<span class="token punctuation">(</span>class_ <span class="token operator">=</span> <span class="token string">'so-icon watch-num'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get_text<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 获取目标路径下的子孙字符串</span>        item<span class="token punctuation">[</span><span class="token string">'发布时间'</span><span class="token punctuation">]</span> <span class="token operator">=</span> video<span class="token punctuation">.</span>find<span class="token punctuation">(</span>class_ <span class="token operator">=</span> <span class="token string">'so-icon time'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get_text<span class="token punctuation">(</span><span class="token punctuation">)</span>        item<span class="token punctuation">[</span><span class="token string">'弹幕数量'</span><span class="token punctuation">]</span> <span class="token operator">=</span> video<span class="token punctuation">.</span>find<span class="token punctuation">(</span>class_ <span class="token operator">=</span> <span class="token string">'so-icon hide'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get_text<span class="token punctuation">(</span><span class="token punctuation">)</span>        items<span class="token punctuation">.</span>append<span class="token punctuation">(</span>item<span class="token punctuation">)</span>  <span class="token comment"># 字典存入列表，所以用append()函数</span>            <span class="token keyword">return</span> items</code></pre><hr><h2 id="3-将爬取到的数据写入-csv-文件："><a href="#3-将爬取到的数据写入-csv-文件：" class="headerlink" title="3.将爬取到的数据写入 csv 文件："></a>3.将爬取到的数据写入 csv 文件：</h2><p><strong>这里用 pandas 库的 DataFrame 方法构造一个数据框，然后写入 csv 文件：</strong></p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">save_to_csv</span><span class="token punctuation">(</span>items<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'成功将数据写入文件！'</span><span class="token punctuation">)</span>    <span class="token comment"># 将爬取的数据写入csv文件</span>    df <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>items<span class="token punctuation">)</span> <span class="token comment"># 用DataFrame构造数据框</span>    df<span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span><span class="token string">"华晨宇.csv"</span><span class="token punctuation">)</span></code></pre><h2 id="主函数："><a href="#主函数：" class="headerlink" title="主函数："></a>主函数：</h2><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        search<span class="token punctuation">(</span><span class="token string">'华晨宇'</span><span class="token punctuation">)</span>        htmls <span class="token operator">=</span> crawl<span class="token punctuation">(</span><span class="token punctuation">)</span>        items <span class="token operator">=</span> parse<span class="token punctuation">(</span>htmls<span class="token punctuation">)</span>        save_to_csv<span class="token punctuation">(</span>items<span class="token punctuation">)</span>    <span class="token keyword">finally</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'爬取信息成功！'</span><span class="token punctuation">)</span>        browser<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    main<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><h2 id="运行代码："><a href="#运行代码：" class="headerlink" title="运行代码："></a>运行代码：</h2><img src="https://img-blog.csdnimg.cn/2020021716543886.png" width="15%" loading="lazy"><p><strong>爬取成功！接下来我们看一下我们的 csv 文件：</strong></p><img src="https://img-blog.csdnimg.cn/20200217165543170.png" width="15%" loading="lazy"><p><strong>打开它：</strong></p><img src="https://img-blog.csdnimg.cn/20200217165716768.png" width="70%" loading="lazy"><p><strong>发现显示乱码……</strong></p><hr><h2 id="解决方法："><a href="#解决方法：" class="headerlink" title="解决方法："></a>解决方法：</h2><p><strong>我们用记事本打开该 csv 文件：</strong></p><img src="https://img-blog.csdnimg.cn/20200217170048939.png" width="50%" loading="lazy"><p><strong>然后另存为，同时编码方式选择带有 BOM 的 UTF-8：</strong></p><img src="https://img-blog.csdnimg.cn/20200217170448267.png" width="60%" loading="lazy"><p><strong>再次打开该 csv 文件，乱码问题就解决了：</strong></p><img src="https://img-blog.csdnimg.cn/2020021717095261.png" width="100%" loading="lazy"><hr><h4 id="完整源代码"><a href="#完整源代码" class="headerlink" title="完整源代码"></a><a href="https://github.com/Giyn/PythonSpider/blob/master/crawl%20bilibili/crawl%20bilibili.py">完整源代码</a></h4>]]></content>
      
      
      <categories>
          
          <category> WebScraper </category>
          
      </categories>
      
      
        <tags>
            
            <tag> requests </tag>
            
            <tag> WebScraper </tag>
            
            <tag> Selenium </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>爬取豆瓣电影 Top250 的海报图片以及相关信息</title>
      <link href="/posts/e3c1aa14/"/>
      <url>/posts/e3c1aa14/</url>
      
        <content type="html"><![CDATA[<h3 id="该项目大致分为以下步骤："><a href="#该项目大致分为以下步骤：" class="headerlink" title="该项目大致分为以下步骤："></a>该项目大致分为以下步骤：</h3><ul><li>使用 requests 库 获取页面</li><li>使用 lxml 库 和 XPath 解析页面</li><li>爬取电影海报图片</li><li>使用 pandas 库 将电影的相关信息存储为 csv 文件</li><li>添加循环，保存所有图片以及相关信息</li></ul><hr><h4 id="首先构建一个框架来获取豆瓣电影的-HTML-页面："><a href="#首先构建一个框架来获取豆瓣电影的-HTML-页面：" class="headerlink" title="首先构建一个框架来获取豆瓣电影的 HTML 页面："></a>首先构建一个框架来获取豆瓣电影的 HTML 页面：</h4><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requests<span class="token keyword">def</span> <span class="token function">get_html</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""        获取HTML页面    Parameters    ----------    url : string        URL链接    Returns    -------    HTML        HTML页面    """</span>    headers <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">'User-Agent'</span><span class="token punctuation">:</span><span class="token string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.132 Safari/537.36"</span><span class="token punctuation">&#125;</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        html <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">)</span>        html<span class="token punctuation">.</span>encoding <span class="token operator">=</span> html<span class="token punctuation">.</span>apparent_encoding        <span class="token keyword">if</span> html<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">:</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"获取HTML页面成功！"</span><span class="token punctuation">)</span>    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"获取HTML页面失败，原因是：%s"</span> <span class="token operator">%</span> e<span class="token punctuation">)</span>                <span class="token keyword">return</span> html<span class="token punctuation">.</span>text<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>url <span class="token operator">=</span> <span class="token string">"https://movie.douban.com/top250"</span>html <span class="token operator">=</span> get_html<span class="token punctuation">(</span>url<span class="token punctuation">)</span></code></pre><hr><h4 id="接下来分析一下豆瓣电影的网页："><a href="#接下来分析一下豆瓣电影的网页：" class="headerlink" title="接下来分析一下豆瓣电影的网页："></a>接下来分析一下豆瓣电影的网页：</h4><p>使用开发者工具 (F12)，经过分析，可以发现每一页的电影信息都是这些li标签：</p><img src="https://img-blog.csdnimg.cn/2020030707424829.png" width="70%" loading="lazy"><p>我们用 XPath Helper 获取这些li标签：</p><img src="https://img-blog.csdnimg.cn/20200307074723316.png" width="70%" loading="lazy"><p><strong>在刚才获取的 li 标签下继续分析电影相关信息：</strong></p><p>首先是电影名字：</p><img src="https://img-blog.csdnimg.cn/20200307075235608.png" width="50%" loading="lazy"><p>接下来是导演主演信息：</p><img src="https://img-blog.csdnimg.cn/2020030707544363.png" width="60%" loading="lazy"><p>然后是年份、国家和电影类型：</p><img src="https://img-blog.csdnimg.cn/20200307075741458.png" width="60%" loading="lazy"><p>接下来是电影评分：</p><img src="https://img-blog.csdnimg.cn/20200307080040827.png" width="50%" loading="lazy"><p>然后是评价人数：</p><img src="https://img-blog.csdnimg.cn/20200307080141408.png" width="50%" loading="lazy"><p>接下来是简介：</p><img src="https://img-blog.csdnimg.cn/20200307080249731.png" width="50%" loading="lazy"><p>（这里发现 Top 247 的那部电影没有简介，所以后面需要处理一下）</p><p>最后是电影海报图片：</p><img src="https://img-blog.csdnimg.cn/20200307092332145.png" width="50%" loading="lazy"><hr><h4 id="编写解析页面的函数："><a href="#编写解析页面的函数：" class="headerlink" title="编写解析页面的函数："></a>编写解析页面的函数：</h4><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> lxml <span class="token keyword">import</span> etree  <span class="token comment"># 解析HTML页面</span><span class="token keyword">def</span> <span class="token function">parse_html</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""        解析HTML页面    Parameters    ----------    html : HTML        爬取的HTML页面            Returns    -------    movies : list        电影信息    imgurls : list        电影海报图片    """</span>    movies <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># 存储电影的相关信息</span>    imgurls <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># 存储电影海报图片</span>        html <span class="token operator">=</span> etree<span class="token punctuation">.</span>HTML<span class="token punctuation">(</span>html<span class="token punctuation">)</span>    lis <span class="token operator">=</span> html<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">"//ol[@class='grid_view']/li"</span><span class="token punctuation">)</span>  <span class="token comment"># XPath返回列表对象</span>    <span class="token comment"># 提取每一部电影的相关信息</span>    <span class="token keyword">for</span> li <span class="token keyword">in</span> lis<span class="token punctuation">:</span>        <span class="token comment"># 下面的XPath路径前面都要加上. 表示从li这个节点开始</span>        name <span class="token operator">=</span> li<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">".//a/span[@class='title'][1]/text()"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># 获取到的列表第0个元素才是电影名字</span>        director_actor <span class="token operator">=</span> li<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">".//div[@class='bd']/p/text()[1]"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'\xa0'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>  <span class="token comment"># 去除字符串中的多余字符</span>        info <span class="token operator">=</span> li<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">".//div[@class='bd']/p/text()[2]"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'\xa0'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>  <span class="token comment"># 去除字符串中的多余字符</span>        rating_score <span class="token operator">=</span> li<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">".//span[@class='rating_num']/text()"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>        rating_num <span class="token operator">=</span> li<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">".//div[@class='star']/span[4]/text()"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>        introduce <span class="token operator">=</span> li<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">".//p[@class='quote']/span/text()"</span><span class="token punctuation">)</span>                    <span class="token comment"># 把提取的相关信息存入movie字典，顺便处理Top 247那部电影没有introduce的情况</span>        <span class="token keyword">if</span> introduce<span class="token punctuation">:</span>            movie <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">'name'</span><span class="token punctuation">:</span> name<span class="token punctuation">,</span> <span class="token string">'director_actor'</span><span class="token punctuation">:</span> director_actor<span class="token punctuation">,</span> <span class="token string">'info'</span><span class="token punctuation">:</span> info<span class="token punctuation">,</span> <span class="token string">'rating_score'</span><span class="token punctuation">:</span> rating_score<span class="token punctuation">,</span>                     <span class="token string">'rating_num'</span><span class="token punctuation">:</span> rating_num<span class="token punctuation">,</span> <span class="token string">'introduce'</span><span class="token punctuation">:</span> introduce<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            movie <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">'name'</span><span class="token punctuation">:</span> name<span class="token punctuation">,</span> <span class="token string">'director_actor'</span><span class="token punctuation">:</span> director_actor<span class="token punctuation">,</span> <span class="token string">'info'</span><span class="token punctuation">:</span> info<span class="token punctuation">,</span> <span class="token string">'rating_score'</span><span class="token punctuation">:</span> rating_score<span class="token punctuation">,</span>                     <span class="token string">'rating_num'</span><span class="token punctuation">:</span> rating_num<span class="token punctuation">,</span> <span class="token string">'introduce'</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">&#125;</span>                        movies<span class="token punctuation">.</span>append<span class="token punctuation">(</span>movie<span class="token punctuation">)</span>                imgurl <span class="token operator">=</span> li<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">".//img/@src"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># 提取图片URL</span>        imgurls<span class="token punctuation">.</span>append<span class="token punctuation">(</span>imgurl<span class="token punctuation">)</span>                <span class="token keyword">return</span> movies<span class="token punctuation">,</span> imgurls<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    url <span class="token operator">=</span> <span class="token string">'https://movie.douban.com/top250'</span>    html <span class="token operator">=</span> get_html<span class="token punctuation">(</span>url<span class="token punctuation">)</span>    movies <span class="token operator">=</span> parse_html<span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    imgurls <span class="token operator">=</span> parse_html<span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span></code></pre><blockquote><p>测试时发现 director_actor 和 info 有 \xa0不间断空白符：<br><img src="https://img-blog.csdnimg.cn/20200307084623522.png" alt="在这里插入图片描述" loading="lazy"><br>用.replace(‘\xa0’, ‘’)语句去除。</p></blockquote><hr><h4 id="编写保存电影海报图片的函数："><a href="#编写保存电影海报图片的函数：" class="headerlink" title="编写保存电影海报图片的函数："></a>编写保存电影海报图片的函数：</h4><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> os<span class="token keyword">def</span> <span class="token function">download_img</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> movie<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""        保存海报图片    Parameters    ----------    url : string        图片文件链接    movie : dict        电影信息    Returns    -------    None.    """</span>    <span class="token keyword">if</span> <span class="token string">'movieposter'</span> <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span><span class="token string">r'S:\DouBan'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">pass</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        os<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span><span class="token string">'movieposter'</span><span class="token punctuation">)</span>                os<span class="token punctuation">.</span>chdir<span class="token punctuation">(</span><span class="token string">r'S:\DouBan\movieposter'</span><span class="token punctuation">)</span>    img <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span>content  <span class="token comment"># 返回的是bytes型也就是二进制的数据</span>        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>movie<span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">'.jpg'</span><span class="token punctuation">,</span> <span class="token string">'wb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>img<span class="token punctuation">)</span></code></pre><h4 id="最后添加循环，爬取所有电影的海报图片以及相关信息："><a href="#最后添加循环，爬取所有电影的海报图片以及相关信息：" class="headerlink" title="最后添加循环，爬取所有电影的海报图片以及相关信息："></a>最后添加循环，爬取所有电影的海报图片以及相关信息：</h4><blockquote><p>每一页有 25 部电影，一共十页：<br><img src="https://img-blog.csdnimg.cn/20200307074442891.png" width="50%" loading="lazy"><br>每一页的 URL 通过以下方式决定：<br><img src="https://img-blog.csdnimg.cn/20200307100727648.png" alt="在这里插入图片描述" loading="lazy"><br><img src="https://img-blog.csdnimg.cn/20200307100733449.png" alt="在这里插入图片描述" loading="lazy"></p></blockquote><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>        MOVIES <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    IMGURLS <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>                <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        url <span class="token operator">=</span> <span class="token string">"https://movie.douban.com/top250?start="</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token operator">*</span><span class="token number">25</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"&amp;filter="</span>        html <span class="token operator">=</span> get_html<span class="token punctuation">(</span>url<span class="token punctuation">)</span>        movies <span class="token operator">=</span> parse_html<span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>        imgurls <span class="token operator">=</span> parse_html<span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>        MOVIES<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>movies<span class="token punctuation">)</span>        IMGURLS<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>imgurls<span class="token punctuation">)</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">250</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        download_img<span class="token punctuation">(</span>IMGURLS<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> MOVIES<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"正在下载第"</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"张图片……"</span><span class="token punctuation">)</span>    os<span class="token punctuation">.</span>chdir<span class="token punctuation">(</span><span class="token string">r'S:\DouBan'</span><span class="token punctuation">)</span>  <span class="token comment"># 记得把路径换回来</span>    moviedata <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>MOVIES<span class="token punctuation">)</span>  <span class="token comment"># 把电影相关信息转换为DataFrame数据格式</span>    moviedata<span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span><span class="token string">'movie.csv'</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"电影相关信息存储成功！"</span><span class="token punctuation">)</span></code></pre><hr><h3 id="运行代码："><a href="#运行代码：" class="headerlink" title="运行代码："></a>运行代码：</h3><img src="https://img-blog.csdnimg.cn/2020030711210317.png" width="20%" loading="lazy"><img src="https://img-blog.csdnimg.cn/20200307112153636.png" width="20%" loading="lazy"><img src="https://img-blog.csdnimg.cn/20200307112353151.png" width="50%" loading="lazy"><img src="https://img-blog.csdnimg.cn/20200307112734493.png" width="80%" loading="lazy"><img src="https://img-blog.csdnimg.cn/20200307112801360.png" width="80%" loading="lazy"><p><strong>至此，该项目就完成了。</strong></p><hr><h4 id="完整源代码"><a href="#完整源代码" class="headerlink" title="完整源代码"></a><a href="https://github.com/Giyn/PythonSpider/blob/master/DouBanMoviesSpiders/crawl%20dbmovie%20posters%20&%20INFO/crawl%20dbmovie%20posters%20&%20INFO.py">完整源代码</a></h4>]]></content>
      
      
      <categories>
          
          <category> WebScraper </category>
          
      </categories>
      
      
        <tags>
            
            <tag> requests </tag>
            
            <tag> WebScraper </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>爬取豆瓣 Top100 电影并存储为 csv 文件（附 csv 文件乱码解决方法）</title>
      <link href="/posts/1cdfbc28/"/>
      <url>/posts/1cdfbc28/</url>
      
        <content type="html"><![CDATA[<h2 id="大致分为以下步骤："><a href="#大致分为以下步骤：" class="headerlink" title="大致分为以下步骤："></a>大致分为以下步骤：</h2><ul><li>使用 requests 库爬取网页。</li><li>使用 BeautifulSoup 库解析网页。</li><li>使用 pandas 库将数据存储为 csv 文件。</li></ul><h2 id="1-首先引入第三方库："><a href="#1-首先引入第三方库：" class="headerlink" title="1. 首先引入第三方库："></a>1. 首先引入第三方库：</h2><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requests<span class="token keyword">from</span> bs4 <span class="token keyword">import</span> BeautifulSoup<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd</code></pre><p><strong>我们去豆瓣电影 Top250 会发现每个页面有 25 个电影：</strong></p><img src="https://img-blog.csdnimg.cn/20200207122859829.png" width="50%" loading="lazy"><p><strong>查看 URL 发现每个 URL 都有标志：</strong><br><img src="https://img-blog.csdnimg.cn/20200207123247164.png" alt="在这里插入图片描述" loading="lazy"><img src="https://img-blog.csdnimg.cn/20200207123322188.png" alt="在这里插入图片描述" loading="lazy"></p><h2 id="2-下载-4-个页面的-HTML："><a href="#2-下载-4-个页面的-HTML：" class="headerlink" title="2. 下载 4 个页面的 HTML："></a>2. 下载 4 个页面的 HTML：</h2><pre class="language-python" data-language="python"><code class="language-python">page_indexs <span class="token operator">=</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">)</span>  <span class="token comment"># 构造分页列表</span><span class="token builtin">list</span><span class="token punctuation">(</span>page_indexs<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">download_all_htmls</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 爬取4个页面的HTML，用于后续的分析</span>    htmls <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token keyword">for</span> idx <span class="token keyword">in</span> page_indexs<span class="token punctuation">:</span>        url <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"https://movie.douban.com/top250?start=</span><span class="token interpolation"><span class="token punctuation">&#123;</span>idx<span class="token punctuation">&#125;</span></span><span class="token string">&amp;filter="</span></span>  <span class="token comment"># 替换分页参数</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"craw html:"</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span>        r <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">,</span>                         headers<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"User-Agent"</span><span class="token punctuation">:</span><span class="token string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko)"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>         <span class="token comment"># r返回一个包含服务器资源的Response对象</span>        <span class="token keyword">if</span> r<span class="token punctuation">.</span>status_code <span class="token operator">!=</span> <span class="token number">200</span><span class="token punctuation">:</span>            <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">)</span>  <span class="token comment"># 当程序出错时通过raise语句显示引发异常</span>        htmls<span class="token punctuation">.</span>append<span class="token punctuation">(</span>r<span class="token punctuation">.</span>text<span class="token punctuation">)</span>    <span class="token keyword">return</span> htmls <span class="token comment"># 执行爬取</span>htmls <span class="token operator">=</span> download_all_htmls<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 爬取4个页面的HTML</span></code></pre><h2 id="3-解析-HTML-得到数据："><a href="#3-解析-HTML-得到数据：" class="headerlink" title="3. 解析 HTML 得到数据："></a>3. 解析 HTML 得到数据：</h2><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">parse_single_html</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 解析单个HTML，得到数据</span>    soup <span class="token operator">=</span> BeautifulSoup<span class="token punctuation">(</span>html<span class="token punctuation">,</span> <span class="token string">'html.parser'</span><span class="token punctuation">)</span>  <span class="token comment"># 解析HTML数据</span>    <span class="token comment"># 对照HTML结构写</span>    article_items <span class="token operator">=</span> <span class="token punctuation">(</span>                                 soup<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">"div"</span><span class="token punctuation">,</span> class_<span class="token operator">=</span><span class="token string">"article"</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">"ol"</span><span class="token punctuation">,</span> class_<span class="token operator">=</span><span class="token string">"grid_view"</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span>find_all<span class="token punctuation">(</span><span class="token string">"div"</span><span class="token punctuation">,</span> class_<span class="token operator">=</span><span class="token string">"item"</span><span class="token punctuation">)</span>    <span class="token punctuation">)</span>    datas <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># 将数据存入列表</span>    <span class="token keyword">for</span> article_item <span class="token keyword">in</span> article_items<span class="token punctuation">:</span>        rank <span class="token operator">=</span> article_item<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">"div"</span><span class="token punctuation">,</span> class_<span class="token operator">=</span><span class="token string">"pic"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">"em"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get_text<span class="token punctuation">(</span><span class="token punctuation">)</span>        info <span class="token operator">=</span> article_item<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">"div"</span><span class="token punctuation">,</span> class_<span class="token operator">=</span><span class="token string">"info"</span><span class="token punctuation">)</span>        title <span class="token operator">=</span> info<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">"div"</span><span class="token punctuation">,</span> class_<span class="token operator">=</span><span class="token string">"hd"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">"span"</span><span class="token punctuation">,</span> class_<span class="token operator">=</span><span class="token string">"title"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get_text<span class="token punctuation">(</span><span class="token punctuation">)</span>        stars <span class="token operator">=</span> <span class="token punctuation">(</span>            info<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">"div"</span><span class="token punctuation">,</span> class_<span class="token operator">=</span><span class="token string">"bd"</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">"div"</span><span class="token punctuation">,</span> class_<span class="token operator">=</span><span class="token string">"star"</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span>find_all<span class="token punctuation">(</span><span class="token string">"span"</span><span class="token punctuation">)</span>  <span class="token comment"># 有4个span，所以用find_all</span>        <span class="token punctuation">)</span>        rating_star <span class="token operator">=</span> stars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"class"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># 由于class属性有多个，所以取第0个</span>        rating_num <span class="token operator">=</span> stars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>get_text<span class="token punctuation">(</span><span class="token punctuation">)</span>        comments <span class="token operator">=</span> stars<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>get_text<span class="token punctuation">(</span><span class="token punctuation">)</span>                datas<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>            <span class="token string">"排名"</span><span class="token punctuation">:</span>rank<span class="token punctuation">,</span>            <span class="token string">"电影名称"</span><span class="token punctuation">:</span>title<span class="token punctuation">,</span>            <span class="token string">"评星"</span><span class="token punctuation">:</span>rating_star<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"rating"</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"-t"</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token string">"评分"</span><span class="token punctuation">:</span>rating_num<span class="token punctuation">,</span>            <span class="token string">"评价人数"</span><span class="token punctuation">:</span>comments<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"人评价"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> datas<span class="token comment"># 执行所有的HTML页面的解析</span>all_datas <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">for</span> html <span class="token keyword">in</span> htmls<span class="token punctuation">:</span>    all_datas<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>parse_single_html<span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><h2 id="4-将数据存储为-csv-文件"><a href="#4-将数据存储为-csv-文件" class="headerlink" title="4. 将数据存储为 csv 文件"></a>4. 将数据存储为 csv 文件</h2><pre class="language-python" data-language="python"><code class="language-python">df <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>all_datas<span class="token punctuation">)</span>df<span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span><span class="token string">"豆瓣电影Top100.csv"</span><span class="token punctuation">)</span></code></pre><p><strong>然后就生成了 csv 文件：</strong></p><p><img src="https://img-blog.csdnimg.cn/2020020713452035.png" alt="在这里插入图片描述" loading="lazy"></p><p><strong>打开它，发现出现乱码：</strong></p><img src="https://img-blog.csdnimg.cn/20200207134816609.png" width="40%" loading="lazy"><h2 id="解决方法："><a href="#解决方法：" class="headerlink" title="解决方法："></a>解决方法：</h2><p> <strong>1. 用记事本打开该文件：</strong></p><img src="https://img-blog.csdnimg.cn/20200207135427878.png" width="50%" loading="lazy"><p> <strong>2. 另存为 csv 文件（在文件名后面加 .csv 后缀），并把编码改为带有 BOM 的 UTF-8：</strong></p><img src="https://img-blog.csdnimg.cn/20200207135908514.png" width="50%" loading="lazy"><p> <strong>3. 再次打开该 csv 文件，就不会出现乱码了：</strong></p><img src="https://img-blog.csdnimg.cn/20200207140150502.png" width="40%" loading="lazy"><h2 id="完整源代码："><a href="#完整源代码：" class="headerlink" title="完整源代码："></a>完整源代码：</h2><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requests<span class="token keyword">from</span> bs4 <span class="token keyword">import</span> BeautifulSoup<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pdpage_indexs <span class="token operator">=</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">)</span>  <span class="token comment"># 构造分页列表</span><span class="token builtin">list</span><span class="token punctuation">(</span>page_indexs<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">download_all_htmls</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 爬取4个页面的HTML，用于后续的分析</span>    htmls <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token keyword">for</span> idx <span class="token keyword">in</span> page_indexs<span class="token punctuation">:</span>        url <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"https://movie.douban.com/top250?start=</span><span class="token interpolation"><span class="token punctuation">&#123;</span>idx<span class="token punctuation">&#125;</span></span><span class="token string">&amp;filter="</span></span>  <span class="token comment"># 替换分页参数</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"craw html:"</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span>        r <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">,</span>                         headers<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"User-Agent"</span><span class="token punctuation">:</span><span class="token string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko)"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>         <span class="token comment"># r返回一个包含服务器资源的Response对象</span>        <span class="token keyword">if</span> r<span class="token punctuation">.</span>status_code <span class="token operator">!=</span> <span class="token number">200</span><span class="token punctuation">:</span>            <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">)</span>  <span class="token comment"># 当程序出错时通过raise语句显示引发异常</span>        htmls<span class="token punctuation">.</span>append<span class="token punctuation">(</span>r<span class="token punctuation">.</span>text<span class="token punctuation">)</span>    <span class="token keyword">return</span> htmls  <span class="token comment"># 执行爬取</span>htmls <span class="token operator">=</span> download_all_htmls<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 爬取4个页面的HTML</span><span class="token keyword">def</span> <span class="token function">parse_single_html</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 解析单个HTML，得到数据</span>    soup <span class="token operator">=</span> BeautifulSoup<span class="token punctuation">(</span>html<span class="token punctuation">,</span> <span class="token string">'html.parser'</span><span class="token punctuation">)</span>  <span class="token comment"># 解析HTML数据</span>    <span class="token comment"># 对照HTML结构写</span>    article_items <span class="token operator">=</span> <span class="token punctuation">(</span>                                  soup<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">"div"</span><span class="token punctuation">,</span> class_<span class="token operator">=</span><span class="token string">"article"</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">"ol"</span><span class="token punctuation">,</span> class_<span class="token operator">=</span><span class="token string">"grid_view"</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span>find_all<span class="token punctuation">(</span><span class="token string">"div"</span><span class="token punctuation">,</span> class_<span class="token operator">=</span><span class="token string">"item"</span><span class="token punctuation">)</span>    <span class="token punctuation">)</span>    datas <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># 将数据存入列表</span>    <span class="token keyword">for</span> article_item <span class="token keyword">in</span> article_items<span class="token punctuation">:</span>        rank <span class="token operator">=</span> article_item<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">"div"</span><span class="token punctuation">,</span> class_<span class="token operator">=</span><span class="token string">"pic"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">"em"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get_text<span class="token punctuation">(</span><span class="token punctuation">)</span>        info <span class="token operator">=</span> article_item<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">"div"</span><span class="token punctuation">,</span> class_<span class="token operator">=</span><span class="token string">"info"</span><span class="token punctuation">)</span>        title <span class="token operator">=</span> info<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">"div"</span><span class="token punctuation">,</span> class_<span class="token operator">=</span><span class="token string">"hd"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">"span"</span><span class="token punctuation">,</span> class_<span class="token operator">=</span><span class="token string">"title"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get_text<span class="token punctuation">(</span><span class="token punctuation">)</span>        stars <span class="token operator">=</span> <span class="token punctuation">(</span>            info<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">"div"</span><span class="token punctuation">,</span> class_<span class="token operator">=</span><span class="token string">"bd"</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">"div"</span><span class="token punctuation">,</span> class_<span class="token operator">=</span><span class="token string">"star"</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span>find_all<span class="token punctuation">(</span><span class="token string">"span"</span><span class="token punctuation">)</span>  <span class="token comment"># 有4个span，所以用find_all</span>        <span class="token punctuation">)</span>        rating_star <span class="token operator">=</span> stars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"class"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># 由于class属性有多个，所以取第0个</span>        rating_num <span class="token operator">=</span> stars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>get_text<span class="token punctuation">(</span><span class="token punctuation">)</span>        comments <span class="token operator">=</span> stars<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>get_text<span class="token punctuation">(</span><span class="token punctuation">)</span>                datas<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>            <span class="token string">"rank"</span><span class="token punctuation">:</span>rank<span class="token punctuation">,</span>            <span class="token string">"title"</span><span class="token punctuation">:</span>title<span class="token punctuation">,</span>            <span class="token string">"rating_star"</span><span class="token punctuation">:</span>rating_star<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"rating"</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"-t"</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token string">"rating_num"</span><span class="token punctuation">:</span>rating_num<span class="token punctuation">,</span>            <span class="token string">"comments"</span><span class="token punctuation">:</span>comments<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"人评价"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> datas<span class="token comment"># 执行所有的HTML页面的解析</span>all_datas <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">for</span> html <span class="token keyword">in</span> htmls<span class="token punctuation">:</span>    all_datas<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>parse_single_html<span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">)</span>df <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>all_datas<span class="token punctuation">)</span>df<span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span><span class="token string">"豆瓣电影Top100.csv"</span><span class="token punctuation">)</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> WebScraper </category>
          
      </categories>
      
      
        <tags>
            
            <tag> requests </tag>
            
            <tag> WebScraper </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Python 中 requests 库的使用和 Response 对象</title>
      <link href="/posts/f39d0b99/"/>
      <url>/posts/f39d0b99/</url>
      
        <content type="html"><![CDATA[<h3 id="HTTP-协议："><a href="#HTTP-协议：" class="headerlink" title="HTTP 协议："></a>HTTP 协议：</h3><p>HTTP，Hypertext Transfer Protocol，超文本传输协议。</p><p>HTTP 是一个基于“请求与响应”模式的、无状态的应用层协议。</p><blockquote><p>简单说，用户发起请求，服务器做相关响应，这就是请求与响应的模式。</p><p>无状态指的是第一次请求跟第二次请求之间并没有相关的关联。</p><p>应用层协议指的是该协议工作在 TCP 协议之上。</p></blockquote><p>HTTP 协议采用 URL 作为定位网络资源的标识。</p><blockquote><p>URL 格式 http: //host [:port] [path]<br>host：合法的 Internet 主机域名或 IP 地址<br>port：端口号，缺省端口为 80（可以省略，默认为 80）<br>path：请求资源的路径</p></blockquote><p><strong>HTTP URL 的理解:</strong></p><p>URL 是通过 HTTP 协议存取资源的 Internet 路径， 一个 URL 对应一个数据资源。</p><h4 id="HTTP-协议对资源的操作："><a href="#HTTP-协议对资源的操作：" class="headerlink" title="HTTP 协议对资源的操作："></a>HTTP 协议对资源的操作：</h4><table><thead><tr><th>方法</th><th>说明</th></tr></thead><tbody><tr><td>GET</td><td>请求获取 URL 位置的资源</td></tr><tr><td>HEAD</td><td>请求获取 URL 位置资源的响应消息报告，即获得该资源的头部信息</td></tr><tr><td>POST</td><td>请求向 URL 位置的资源后附加新的数据</td></tr><tr><td>PUT</td><td>请求向 URL 位置存储一个资源，覆盖原 URL 位置的资源</td></tr><tr><td>PATCH</td><td>请求局部更新 URL 位置的资源，即改变该处资源的部分内容</td></tr><tr><td>DELETE</td><td>请求删除 URL 位置存储的资源</td></tr></tbody></table><p>事实上，HTTP 协议通过 URL 对资源做定位，通过上面六个常用方法对资源进行管理，每一次操作都是独立无状态的，在 HTTP 协议的世界里网络通道跟服务器都是黑箱，它能看到的就是 URL 链接以及对 URL 链接的相关操作。</p><h4 id="理解-PUT-和-PATCH-的区别："><a href="#理解-PUT-和-PATCH-的区别：" class="headerlink" title="理解 PUT 和 PATCH 的区别："></a>理解 PUT 和 PATCH 的区别：</h4><p>假设 URL 位置有一组数据 UserInfo，包括 UserID、 UserName 等 20 个字段。</p><p>需求：用户修改了 UserName，其他不变。</p><ul><li>采用 PATCH，仅向 URL 提交 UserName 的局部更新请求。</li><li>采用 PUT，必须将所有 20 个字段一并提交到 URL，未提交字段被删除。</li></ul><p><strong>PATCH 的最主要好处：节省网络带宽</strong></p><blockquote><p>PUT 是修改了整条记录，不变的字段也重写一遍，不过重写的值与原来相同而已；而 PATCH 只是单独修改一个字段 。<br>PATCH 相比于 PUT 方法更加节省计算机与网络资源，但其实不必刻意区分，使用 PUT 即可完成所有需求。</p></blockquote><blockquote><p>PATCH 与 PUT 属性上的一个重要区别还在于：PUT 是幂等的，而 PATCH 不是幂等的。</p></blockquote><blockquote><p>幂等是一个数学和计算机学概念，在计算机范畴内表示一个操作执行任意次对系统的影响跟一次是相同。</p></blockquote><hr><h3 id="requests-库"><a href="#requests-库" class="headerlink" title="requests 库"></a>requests 库</h3><p>requests 是用 Python 语言编写的常用 HTTP 请求库，其可以方便地发送 HTTP 请求及处理响应结果。</p><h4 id="requests-库的-7-个主要方法："><a href="#requests-库的-7-个主要方法：" class="headerlink" title="requests 库的 7 个主要方法："></a>requests 库的 7 个主要方法：</h4><table><thead><tr><th>方法</th><th>说明</th></tr></thead><tbody><tr><td>requests.request()</td><td>构造一个请求，支撑以下各方法的基础方法</td></tr><tr><td>requests.get()</td><td>获取 HTML 网页的主要方法，对应于 HTTP 的 GET</td></tr><tr><td>requests.head()</td><td>获取 HTML 网页头信息的方法，对应于 HTTP 的 HEAD</td></tr><tr><td>requests.post()</td><td>向 HTML 网页提交POST请求的方法，对应于 HTTP 的 POST</td></tr><tr><td>requests.put()</td><td>向 HTML 网页提交PUT请求的方法，对应于 HTTP 的 PUT</td></tr><tr><td>requests.patch()</td><td>向 HTML 网页提交局部修改请求，对应于 HTTP 的 PATCH</td></tr><tr><td>requests.delete()</td><td>向 HTML 页面提交删除请求，对应于 HTTP 的 DELETE</td></tr></tbody></table><blockquote><p>7 个方法，request 是基础，其他 6 个是通过调用 request 来实现的。</p></blockquote><p>requests 库的常用方法为 get 方法，其构造一个向服务器请求资源的 Request 对象（内部生成的），并返回一个包含服务器资源的 Response 对象。</p><pre class="language-python" data-language="python"><code class="language-python">requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">,</span> params<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span></code></pre><ul><li>url：拟获取页面的 url 链接</li><li>params：url 中的额外参数，字典或字节流格式，可选</li><li>**kwargs：12 个控制访问的参数</li></ul><blockquote><p><strong>get 方法使用了 request 方法来封装：</strong></p><img src="https://img-blog.csdnimg.cn/20200302151942387.png" width="60%" loading="lazy"></blockquote><p>在 HTTP 协议中，向某一个 URL 提交资源的功能，在服务器上是严格受控的，其有很大的安全问题。如果某个 URL 允许任何用户无限制地向上传输相关资源，则会出现很多问题。<br>例如用大量的垃圾信息，使得服务器的资源消耗完，甚至传输一些不可控的、恶意的内容到某一个 URL 上，这都是对网络空间不负责任的表现。因此，在使用 requests 库时最常用 get 方法，即<strong>通过 get 方法来爬取一些内容，并且部分地向服务器提交一些内容</strong>，而对于某些特别大的 URL 链接，则用 head 获取资源概要。</p><blockquote><p>服务器是计算机的一种，它比普通计算机运行更快、负载更高、价格更贵。<br>服务器在网络中为其它客户机（如 PC 机、智能手机、ATM 等终端甚至是火车系统等大型设备）提供计算或者应用服务。<br>服务器具有高速的 CPU 运算能力、长时间的可靠运行、强大的 I/O 外部数据吞吐能力以及更好的扩展性。<br>根据服务器所提供的服务，一般来说服务器都具备承担响应服务请求、承担服务、保障服务的能力。<br>服务器作为电子设备，其内部的结构十分复杂，但与普通的计算机内部结构相差不大，如：cpu、硬盘、内存，系统、系统总线等。</p></blockquote><h4 id="HTTP-协议与-requests-库的对应关系："><a href="#HTTP-协议与-requests-库的对应关系：" class="headerlink" title="HTTP 协议与 requests 库的对应关系："></a>HTTP 协议与 requests 库的对应关系：</h4><table><thead><tr><th>HTTP 协议方法</th><th>requests 库方法</th></tr></thead><tbody><tr><td>GET</td><td>requests.get()</td></tr><tr><td>HEAD</td><td>requests.head()</td></tr><tr><td>POST</td><td>requests.post()</td></tr><tr><td>PUT</td><td>requests.put()</td></tr><tr><td>PATCH</td><td>requests.patch()</td></tr><tr><td>DELETE</td><td>requests.delete()</td></tr></tbody></table><h4 id="requests-库的异常："><a href="#requests-库的异常：" class="headerlink" title="requests 库的异常："></a>requests 库的异常：</h4><table><thead><tr><th>异常</th><th>说明</th></tr></thead><tbody><tr><td>requests.ConnectionError</td><td>网络连接错误异常，如 DNS 查询失败、拒绝连接等</td></tr><tr><td>requests.HTTPError</td><td>HTTP 错误异常</td></tr><tr><td>requests.URLRequired</td><td>URL 缺失异常</td></tr><tr><td>requests.TooManyRedirects</td><td>超过最大重定向次数，产生重定向异常</td></tr><tr><td>Response.raise_for_status()</td><td>如果不是 200，产生异常 requests.HTTPError</td></tr><tr><td>requests.ConnectTimeout</td><td>连接远程服务器超时异常</td></tr><tr><td>requests.Timeout</td><td>请求 URL 超时，产生超时异常</td></tr></tbody></table><pre class="language-python" data-language="python"><code class="language-python">Response<span class="token punctuation">.</span>raise_for_status<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 如果返回对象的状态码不是200，它将产生异常requests.HTTPError</span></code></pre><hr><h3 id="Response-对象"><a href="#Response-对象" class="headerlink" title="Response 对象"></a>Response 对象</h3><h4 id="Response-对象的属性："><a href="#Response-对象的属性：" class="headerlink" title="Response 对象的属性："></a>Response 对象的属性：</h4><table><thead><tr><th>属性</th><th>说明</th></tr></thead><tbody><tr><td>Response.status_code</td><td>HTTP 请求的返回状态，200 表示连接成功，404 表示失败</td></tr><tr><td>Response.text</td><td>HTTP 响应内容的字符串形式，即，url 对应的页面内容</td></tr><tr><td>Response.encoding</td><td>从 HTTP header 中猜测的响应内容编码方式</td></tr><tr><td>Response.apparent_encoding</td><td>从内容中分析出的响应内容编码方式（备选编码方式）</td></tr><tr><td>Response.content</td><td>HTTP 响应内容的二进制形式</td></tr></tbody></table><h4 id="Response-对象的编码："><a href="#Response-对象的编码：" class="headerlink" title="Response 对象的编码："></a>Response 对象的编码：</h4><table><thead><tr><th>属性</th><th>说明</th></tr></thead><tbody><tr><td>Response.encoding</td><td>从 HTTP header 中猜测的响应内容编码方式</td></tr><tr><td>Response.apparent_encoding</td><td>从内容中分析出的响应内容编码方式（备选编码方式）</td></tr></tbody></table><ul><li>Response.encoding：如果 header 中不存在 charset，则认为编码为 ISO-8859-1</li><li>Response.apparent_encoding：根据网页内容分析出的编码方式</li></ul>]]></content>
      
      
      <categories>
          
          <category> requests </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> requests </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【PyQt5】—— QTextBrowser</title>
      <link href="/posts/524051ce/"/>
      <url>/posts/524051ce/</url>
      
        <content type="html"><![CDATA[<h2 id="QTextBrowser"><a href="#QTextBrowser" class="headerlink" title="QTextBrowser"></a>QTextBrowser</h2><p>QTextBrowser 类为富文本浏览器提供了超文本导航，通常用作程序日志的输出窗口，默认只读。</p><blockquote><p>但只是默认，后期可以自行修改</p></blockquote><hr><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token triple-quoted-string string">"""Created on Sat May  9 17:14:37 2020@author: Giyn"""</span><span class="token keyword">import</span> sys<span class="token keyword">from</span> PyQt5<span class="token punctuation">.</span>QtWidgets <span class="token keyword">import</span> QApplication<span class="token punctuation">,</span> QWidget<span class="token punctuation">,</span> QPushButton<span class="token punctuation">,</span> QTextBrowser<span class="token punctuation">,</span> QVBoxLayout<span class="token punctuation">,</span> QHBoxLayout<span class="token punctuation">,</span> QMessageBox<span class="token keyword">from</span> PyQt5<span class="token punctuation">.</span>QtGui <span class="token keyword">import</span> QIcon<span class="token keyword">class</span> <span class="token class-name">Simple_Window</span><span class="token punctuation">(</span>QWidget<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token builtin">super</span><span class="token punctuation">(</span>Simple_Window<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 使用super函数可以实现子类使用父类的方法</span>        self<span class="token punctuation">.</span>setWindowTitle<span class="token punctuation">(</span><span class="token string">"记事本"</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>setWindowIcon<span class="token punctuation">(</span>QIcon<span class="token punctuation">(</span><span class="token string">'NoteBook.png'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 设置窗口图标</span>        self<span class="token punctuation">.</span>resize<span class="token punctuation">(</span><span class="token number">412</span><span class="token punctuation">,</span> <span class="token number">412</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>text_browser <span class="token operator">=</span> QTextBrowser<span class="token punctuation">(</span>self<span class="token punctuation">)</span>  <span class="token comment"># 实例化一个QTextBrowser对象</span>        self<span class="token punctuation">.</span>text_browser<span class="token punctuation">.</span>setText<span class="token punctuation">(</span><span class="token string">"&lt;h1>Hello World!&lt;/h1>"</span><span class="token punctuation">)</span>  <span class="token comment"># 设置编辑框初始化时显示的文本</span>        <span class="token comment"># self.text_browser.setReadOnly(False)  # 调用setReadOnly方法并传入False参数即可编辑文本浏览框（编辑框也可以变成只读）</span>                self<span class="token punctuation">.</span>save_button <span class="token operator">=</span> QPushButton<span class="token punctuation">(</span><span class="token string">"Save"</span><span class="token punctuation">,</span> self<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>clear_button <span class="token operator">=</span> QPushButton<span class="token punctuation">(</span><span class="token string">"Clear"</span><span class="token punctuation">,</span> self<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>add_button <span class="token operator">=</span> QPushButton<span class="token punctuation">(</span><span class="token string">"Add"</span><span class="token punctuation">,</span> self<span class="token punctuation">)</span>                self<span class="token punctuation">.</span>save_button<span class="token punctuation">.</span>clicked<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token keyword">lambda</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>button_slot<span class="token punctuation">(</span>self<span class="token punctuation">.</span>save_button<span class="token punctuation">)</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>clear_button<span class="token punctuation">.</span>clicked<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token keyword">lambda</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>button_slot<span class="token punctuation">(</span>self<span class="token punctuation">.</span>clear_button<span class="token punctuation">)</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>add_button<span class="token punctuation">.</span>clicked<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>self<span class="token punctuation">.</span>add_text<span class="token punctuation">)</span>                self<span class="token punctuation">.</span>h_layout <span class="token operator">=</span> QHBoxLayout<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>v_layout <span class="token operator">=</span> QVBoxLayout<span class="token punctuation">(</span><span class="token punctuation">)</span>                self<span class="token punctuation">.</span>h_layout<span class="token punctuation">.</span>addWidget<span class="token punctuation">(</span>self<span class="token punctuation">.</span>save_button<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>h_layout<span class="token punctuation">.</span>addWidget<span class="token punctuation">(</span>self<span class="token punctuation">.</span>clear_button<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>h_layout<span class="token punctuation">.</span>addWidget<span class="token punctuation">(</span>self<span class="token punctuation">.</span>add_button<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>v_layout<span class="token punctuation">.</span>addWidget<span class="token punctuation">(</span>self<span class="token punctuation">.</span>text_browser<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>v_layout<span class="token punctuation">.</span>addLayout<span class="token punctuation">(</span>self<span class="token punctuation">.</span>h_layout<span class="token punctuation">)</span>                self<span class="token punctuation">.</span>setLayout<span class="token punctuation">(</span>self<span class="token punctuation">.</span>v_layout<span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">button_slot</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> button<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> button <span class="token operator">==</span> self<span class="token punctuation">.</span>save_button<span class="token punctuation">:</span>            choice <span class="token operator">=</span> QMessageBox<span class="token punctuation">.</span>question<span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">"Question"</span><span class="token punctuation">,</span> <span class="token string">"Do you want to save it?"</span><span class="token punctuation">,</span> QMessageBox<span class="token punctuation">.</span>Yes <span class="token operator">|</span> QMessageBox<span class="token punctuation">.</span>No<span class="token punctuation">)</span>            <span class="token keyword">if</span> choice <span class="token operator">==</span> QMessageBox<span class="token punctuation">.</span>Yes<span class="token punctuation">:</span>                <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'Second text.txt'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>                    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>self<span class="token punctuation">.</span>text_browser<span class="token punctuation">.</span>toPlainText<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                self<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token keyword">elif</span> choice <span class="token operator">==</span> QMessageBox<span class="token punctuation">.</span>No<span class="token punctuation">:</span>                self<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">elif</span> button <span class="token operator">==</span> self<span class="token punctuation">.</span>clear_button<span class="token punctuation">:</span>            self<span class="token punctuation">.</span>text_browser<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token keyword">def</span> <span class="token function">add_text</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>text_browser<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">"&lt;h1>Hello World!&lt;/h1>"</span><span class="token punctuation">)</span>  <span class="token comment"># 调用append方法可以向文本浏览框中添加文本</span>                <span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>    app <span class="token operator">=</span> QApplication<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span>    window <span class="token operator">=</span> Simple_Window<span class="token punctuation">(</span><span class="token punctuation">)</span>    window<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>    sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token keyword">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><h3 id="Output："><a href="#Output：" class="headerlink" title="Output："></a>Output：</h3><img src="https://img-blog.csdnimg.cn/20200509173136559.png" width="30%" loading="lazy"><hr><h4 id="After-clicking-“Add”："><a href="#After-clicking-“Add”：" class="headerlink" title="After clicking “Add”："></a>After clicking “Add”：</h4><img src="https://img-blog.csdnimg.cn/202005091732248.png" width="30%" loading="lazy"><blockquote><p>调用 setReadOnly 方法并传入 False 参数即可编辑文本浏览框（编辑框也可以变成只读）<br>调用 append 方法可以向文本浏览框中添加文本</p></blockquote><p>Reference：<a href="https://study.163.com/course/courseLearn.htm?courseId=1208995818">https://study.163.com/course/courseLearn.htm?courseId=1208995818</a></p>]]></content>
      
      
      <categories>
          
          <category> PyQt5 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> PyQt5 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【PyQt5】—— QTextEdit（制作一个简易的记事本）</title>
      <link href="/posts/2a261d0d/"/>
      <url>/posts/2a261d0d/</url>
      
        <content type="html"><![CDATA[<h2 id="QTextEdit"><a href="#QTextEdit" class="headerlink" title="QTextEdit"></a>QTextEdit</h2><p>QTextEdit 类提供了一个部件，用于编辑和显示纯文本和富文本。</p><hr><h3 id="QTextEdit-的一些方法和属性："><a href="#QTextEdit-的一些方法和属性：" class="headerlink" title="QTextEdit 的一些方法和属性："></a>QTextEdit 的一些方法和属性：</h3><ul><li>**toPlainText()**：获取文本</li><li>**setText()**：设置文本</li><li><strong>textChanged</strong>：文本改变信号（在文本每次发生改变时发射）</li><li>**clear()**：清空文本</li><li>**setPlaceholderText()**：设置占位字符串（只有在文本编辑框中没有任何文本时才会显示）</li></ul><hr><h4 id="一个简易的记事本："><a href="#一个简易的记事本：" class="headerlink" title="一个简易的记事本："></a>一个简易的记事本：</h4><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token triple-quoted-string string">"""Created on Sat May  9 16:17:57 2020@author: Giyn"""</span><span class="token keyword">import</span> sys<span class="token keyword">from</span> PyQt5<span class="token punctuation">.</span>QtWidgets <span class="token keyword">import</span> QApplication<span class="token punctuation">,</span> QWidget<span class="token punctuation">,</span> QPushButton<span class="token punctuation">,</span> QTextEdit<span class="token punctuation">,</span> QVBoxLayout<span class="token punctuation">,</span> QHBoxLayout<span class="token punctuation">,</span> QMessageBox<span class="token keyword">from</span> PyQt5<span class="token punctuation">.</span>QtGui <span class="token keyword">import</span> QIcon<span class="token keyword">class</span> <span class="token class-name">Simple_Window</span><span class="token punctuation">(</span>QWidget<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token builtin">super</span><span class="token punctuation">(</span>Simple_Window<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 使用super函数可以实现子类使用父类的方法</span>        self<span class="token punctuation">.</span>setWindowTitle<span class="token punctuation">(</span><span class="token string">"记事本"</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>setWindowIcon<span class="token punctuation">(</span>QIcon<span class="token punctuation">(</span><span class="token string">'NoteBook.png'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 设置窗口图标</span>        self<span class="token punctuation">.</span>resize<span class="token punctuation">(</span><span class="token number">412</span><span class="token punctuation">,</span> <span class="token number">412</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>text_edit <span class="token operator">=</span> QTextEdit<span class="token punctuation">(</span>self<span class="token punctuation">)</span>  <span class="token comment"># 实例化一个QTextEdit对象</span>        self<span class="token punctuation">.</span>text_edit<span class="token punctuation">.</span>setText<span class="token punctuation">(</span><span class="token string">"Hello World"</span><span class="token punctuation">)</span>  <span class="token comment"># 设置编辑框初始化时显示的文本</span>        self<span class="token punctuation">.</span>text_edit<span class="token punctuation">.</span>setPlaceholderText<span class="token punctuation">(</span><span class="token string">"Please edit text here"</span><span class="token punctuation">)</span>  <span class="token comment"># 设置占位字符串</span>        self<span class="token punctuation">.</span>text_edit<span class="token punctuation">.</span>textChanged<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token keyword">lambda</span><span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"text is changed!"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 判断文本是否发生改变</span>                self<span class="token punctuation">.</span>save_button <span class="token operator">=</span> QPushButton<span class="token punctuation">(</span><span class="token string">"Save"</span><span class="token punctuation">,</span> self<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>clear_button <span class="token operator">=</span> QPushButton<span class="token punctuation">(</span><span class="token string">"Clear"</span><span class="token punctuation">,</span> self<span class="token punctuation">)</span>                self<span class="token punctuation">.</span>save_button<span class="token punctuation">.</span>clicked<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token keyword">lambda</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>button_slot<span class="token punctuation">(</span>self<span class="token punctuation">.</span>save_button<span class="token punctuation">)</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>clear_button<span class="token punctuation">.</span>clicked<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token keyword">lambda</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>button_slot<span class="token punctuation">(</span>self<span class="token punctuation">.</span>clear_button<span class="token punctuation">)</span><span class="token punctuation">)</span>                self<span class="token punctuation">.</span>h_layout <span class="token operator">=</span> QHBoxLayout<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>v_layout <span class="token operator">=</span> QVBoxLayout<span class="token punctuation">(</span><span class="token punctuation">)</span>                self<span class="token punctuation">.</span>h_layout<span class="token punctuation">.</span>addWidget<span class="token punctuation">(</span>self<span class="token punctuation">.</span>save_button<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>h_layout<span class="token punctuation">.</span>addWidget<span class="token punctuation">(</span>self<span class="token punctuation">.</span>clear_button<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>v_layout<span class="token punctuation">.</span>addWidget<span class="token punctuation">(</span>self<span class="token punctuation">.</span>text_edit<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>v_layout<span class="token punctuation">.</span>addLayout<span class="token punctuation">(</span>self<span class="token punctuation">.</span>h_layout<span class="token punctuation">)</span>                self<span class="token punctuation">.</span>setLayout<span class="token punctuation">(</span>self<span class="token punctuation">.</span>v_layout<span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">button_slot</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> button<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> button <span class="token operator">==</span> self<span class="token punctuation">.</span>save_button<span class="token punctuation">:</span>            choice <span class="token operator">=</span> QMessageBox<span class="token punctuation">.</span>question<span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">"Question"</span><span class="token punctuation">,</span> <span class="token string">"Do you want to save it?"</span><span class="token punctuation">,</span> QMessageBox<span class="token punctuation">.</span>Yes <span class="token operator">|</span> QMessageBox<span class="token punctuation">.</span>No<span class="token punctuation">)</span>            <span class="token keyword">if</span> choice <span class="token operator">==</span> QMessageBox<span class="token punctuation">.</span>Yes<span class="token punctuation">:</span>                <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'First text.txt'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>                    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>self<span class="token punctuation">.</span>text_edit<span class="token punctuation">.</span>toPlainText<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                self<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token keyword">elif</span> choice <span class="token operator">==</span> QMessageBox<span class="token punctuation">.</span>No<span class="token punctuation">:</span>                self<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">elif</span> button <span class="token operator">==</span> self<span class="token punctuation">.</span>clear_button<span class="token punctuation">:</span>            self<span class="token punctuation">.</span>text_edit<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>    app <span class="token operator">=</span> QApplication<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span>    window <span class="token operator">=</span> Simple_Window<span class="token punctuation">(</span><span class="token punctuation">)</span>    window<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>    sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token keyword">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><h4 id="Output："><a href="#Output：" class="headerlink" title="Output："></a>Output：</h4><img src="https://img-blog.csdnimg.cn/20200509165805658.png" width="30%" loading="lazy"><hr><h4 id="When-clicking-the-“Clear”："><a href="#When-clicking-the-“Clear”：" class="headerlink" title="When clicking the “Clear”："></a>When clicking the “Clear”：</h4><img src="https://img-blog.csdnimg.cn/20200509165953943.png" width="30%" loading="lazy"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> text <span class="token keyword">is</span> changed!</code></pre><hr><h4 id="When-changing-the-text："><a href="#When-changing-the-text：" class="headerlink" title="When changing the text："></a>When changing the text：</h4><img src="https://img-blog.csdnimg.cn/20200509170136123.png" width="30%" loading="lazy"><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> text <span class="token keyword">is</span> changed!<span class="token operator">>></span><span class="token operator">></span> text <span class="token keyword">is</span> changed!<span class="token operator">>></span><span class="token operator">></span> text <span class="token keyword">is</span> changed!<span class="token operator">>></span><span class="token operator">></span> text <span class="token keyword">is</span> changed!<span class="token operator">>></span><span class="token operator">></span> text <span class="token keyword">is</span> changed!<span class="token operator">>></span><span class="token operator">></span> text <span class="token keyword">is</span> changed!<span class="token operator">>></span><span class="token operator">></span> text <span class="token keyword">is</span> changed!<span class="token operator">>></span><span class="token operator">></span> text <span class="token keyword">is</span> changed!<span class="token operator">>></span><span class="token operator">></span> text <span class="token keyword">is</span> changed!<span class="token operator">>></span><span class="token operator">></span> text <span class="token keyword">is</span> changed!<span class="token operator">>></span><span class="token operator">></span> text <span class="token keyword">is</span> changed!<span class="token operator">>></span><span class="token operator">></span> text <span class="token keyword">is</span> changed!</code></pre><hr><h4 id="When-clicking-the-“Save”："><a href="#When-clicking-the-“Save”：" class="headerlink" title="When clicking the “Save”："></a>When clicking the “Save”：</h4><img src="https://img-blog.csdnimg.cn/20200509170338149.png" width="30%" loading="lazy"><h4 id="After-clicking-“Yes”："><a href="#After-clicking-“Yes”：" class="headerlink" title="After clicking “Yes”："></a>After clicking “Yes”：</h4><p><img src="https://img-blog.csdnimg.cn/20200509170423639.png" alt="在这里插入图片描述" loading="lazy"><br>Then the program close.</p><h4 id="If-clicking-“No”-the-program-will-close-directly"><a href="#If-clicking-“No”-the-program-will-close-directly" class="headerlink" title="If clicking “No”, the program will close directly."></a>If clicking “No”, the program will close directly.</h4><p>Reference：<a href="https://study.163.com/course/courseLearn.htm?courseId=1208995818">https://study.163.com/course/courseLearn.htm?courseId=1208995818</a></p>]]></content>
      
      
      <categories>
          
          <category> PyQt5 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> PyQt5 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【PyQt5】—— QMessageBox</title>
      <link href="/posts/85fb99ec/"/>
      <url>/posts/85fb99ec/</url>
      
        <content type="html"><![CDATA[<h2 id="QMessageBox"><a href="#QMessageBox" class="headerlink" title="QMessageBox"></a>QMessageBox</h2><p>QMessageBox 类提供了一个模式对话框，用于通知用户或询问用户问题并接收答案。</p><blockquote><p>在图形用户界面中，对话框（又称对话方块）是一种特殊的视窗，用来在用户界面中向用户显示信息，或者在需要的时候获得用户的输入响应。之所以称之为“对话框”是因为它们使计算机和用户之间构成了一个对话——或者是通知用户一些信息，或者是请求用户的输入，或者两者皆有。—— 维基百科</p></blockquote><p>对话框可以<strong>增加程序与用户的交互能力</strong>，有时可以<strong>避免一些失误</strong>，如文件忘记保存：</p><img src="https://img-blog.csdnimg.cn/20200509132325139.png" width="40%" loading="lazy"><hr><h4 id="QMessageBox-提供了多种对话框："><a href="#QMessageBox-提供了多种对话框：" class="headerlink" title="QMessageBox 提供了多种对话框："></a><strong>QMessageBox 提供了多种对话框：</strong></h4><img src="https://img-blog.csdnimg.cn/20200509132424841.png" width="40%" loading="lazy"><hr><h5 id="以询问框为例："><a href="#以询问框为例：" class="headerlink" title="以询问框为例："></a>以询问框为例：</h5><h3 id="QMessage-question-parent-title-content-button"><a href="#QMessage-question-parent-title-content-button" class="headerlink" title="QMessage.question(parent, title, content, button)"></a>QMessage.question(parent, title, content, button)</h3><ul><li><strong>parent</strong>：表示对话框所归属的程序窗口。填写父类（通常为 self）；若不属于任何程序窗口，为 None。</li><li><strong>title</strong>：标题。</li><li><strong>content</strong>：内容。</li><li><strong>button</strong>：对话框按钮。</li></ul><hr><p><strong>QMessage.question(None, ‘Question’, ‘Do you want to save it?’, QMessageBox.Yes | QMessageBox.No)</strong></p><p><img src="https://img-blog.csdnimg.cn/20200509133700489.png" alt="在这里插入图片描述" loading="lazy"></p><h4 id="QMessage-question-的返回值是-QMessageBox-Yes-或-QMessageBox-No。"><a href="#QMessage-question-的返回值是-QMessageBox-Yes-或-QMessageBox-No。" class="headerlink" title="QMessage.question 的返回值是 QMessageBox.Yes 或 QMessageBox.No。"></a>QMessage.question 的返回值是 <code>QMessageBox.Yes</code> 或 <code>QMessageBox.No</code>。</h4><blockquote><p>多个对话框按钮用 $|$ 连接</p></blockquote><hr><h4 id="除此以外，QMessageBox-还提供了以下按钮："><a href="#除此以外，QMessageBox-还提供了以下按钮：" class="headerlink" title="除此以外，QMessageBox 还提供了以下按钮："></a>除此以外，QMessageBox 还提供了以下按钮：</h4><p><code>QMessageBox.Ok</code></p><p><code>QMessageBox.Close</code></p><p><code>QMessageBox.Cancel</code></p><p><code>QMessage.Open</code></p><p><code>QMessage.Save</code></p><hr><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token triple-quoted-string string">"""Created on Sat May  9 14:05:57 2020@author: Giyn"""</span><span class="token keyword">import</span> sys<span class="token keyword">from</span> PyQt5<span class="token punctuation">.</span>QtWidgets <span class="token keyword">import</span> QApplication<span class="token punctuation">,</span> QWidget<span class="token punctuation">,</span> QPushButton<span class="token punctuation">,</span> QVBoxLayout<span class="token punctuation">,</span> QMessageBox<span class="token keyword">class</span> <span class="token class-name">Simple_Window</span><span class="token punctuation">(</span>QWidget<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token builtin">super</span><span class="token punctuation">(</span>Simple_Window<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 使用super函数可以实现子类使用父类的方法</span>        self<span class="token punctuation">.</span>setWindowTitle<span class="token punctuation">(</span><span class="token string">"QMessageBox"</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>resize<span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>button1 <span class="token operator">=</span> QPushButton<span class="token punctuation">(</span><span class="token string">"Question"</span><span class="token punctuation">,</span> self<span class="token punctuation">)</span>  <span class="token comment"># self是指定的父类Simple_Window，表示QLabel属于Simple_Window窗口</span>        self<span class="token punctuation">.</span>button2 <span class="token operator">=</span> QPushButton<span class="token punctuation">(</span><span class="token string">"Information"</span><span class="token punctuation">,</span> self<span class="token punctuation">)</span>                <span class="token comment"># 连接信号和槽</span>        self<span class="token punctuation">.</span>button1<span class="token punctuation">.</span>clicked<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token keyword">lambda</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>show_msg_box<span class="token punctuation">(</span>self<span class="token punctuation">.</span>button1<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 槽函数带有参数，使用lambda表达式封装函数</span>        self<span class="token punctuation">.</span>button2<span class="token punctuation">.</span>clicked<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token keyword">lambda</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>show_msg_box<span class="token punctuation">(</span>self<span class="token punctuation">.</span>button2<span class="token punctuation">)</span><span class="token punctuation">)</span>                self<span class="token punctuation">.</span>v_layout <span class="token operator">=</span> QVBoxLayout<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 实例化一个QVBoxLayout对象</span>        self<span class="token punctuation">.</span>v_layout<span class="token punctuation">.</span>addWidget<span class="token punctuation">(</span>self<span class="token punctuation">.</span>button1<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>v_layout<span class="token punctuation">.</span>addWidget<span class="token punctuation">(</span>self<span class="token punctuation">.</span>button2<span class="token punctuation">)</span>                self<span class="token punctuation">.</span>setLayout<span class="token punctuation">(</span>self<span class="token punctuation">.</span>v_layout<span class="token punctuation">)</span>  <span class="token comment"># 调用窗口的setLayout方法将总布局设置为窗口的整体布局</span>            <span class="token keyword">def</span> <span class="token function">show_msg_box</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> button<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> button <span class="token operator">==</span> self<span class="token punctuation">.</span>button1<span class="token punctuation">:</span>            QMessageBox<span class="token punctuation">.</span>question<span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">"Question"</span><span class="token punctuation">,</span> <span class="token string">"Do you want to save it?"</span><span class="token punctuation">,</span> QMessageBox<span class="token punctuation">.</span>Yes <span class="token operator">|</span> QMessageBox<span class="token punctuation">.</span>No<span class="token punctuation">)</span>        <span class="token keyword">elif</span> button <span class="token operator">==</span> self<span class="token punctuation">.</span>button2<span class="token punctuation">:</span>            QMessageBox<span class="token punctuation">.</span>information<span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">"Information"</span><span class="token punctuation">,</span> <span class="token string">"I am an information."</span><span class="token punctuation">,</span> QMessageBox<span class="token punctuation">.</span>Ok<span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>    app <span class="token operator">=</span> QApplication<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span>    window <span class="token operator">=</span> Simple_Window<span class="token punctuation">(</span><span class="token punctuation">)</span>    window<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>    sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token keyword">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><h3 id="Output："><a href="#Output：" class="headerlink" title="Output："></a>Output：</h3><img src="https://img-blog.csdnimg.cn/20200509142556241.png" width="40%" loading="lazy"><h4 id="After-clicking-“Question”："><a href="#After-clicking-“Question”：" class="headerlink" title="After clicking “Question”："></a>After clicking “Question”：</h4><img src="https://img-blog.csdnimg.cn/20200509142658137.png" width="40%" loading="lazy"><h4 id="After-clicking-“Information”："><a href="#After-clicking-“Information”：" class="headerlink" title="After clicking “Information”："></a>After clicking “Information”：</h4><img src="https://img-blog.csdnimg.cn/20200509142745653.png" width="40%" loading="lazy"><p>Reference：<a href="https://study.163.com/course/courseLearn.htm?courseId=1208995818">https://study.163.com/course/courseLearn.htm?courseId=1208995818</a></p>]]></content>
      
      
      <categories>
          
          <category> PyQt5 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> PyQt5 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【PyQt5】—— QGridLayout</title>
      <link href="/posts/b2c9c112/"/>
      <url>/posts/b2c9c112/</url>
      
        <content type="html"><![CDATA[<h2 id="QGridLayout"><a href="#QGridLayout" class="headerlink" title="QGridLayout"></a>QGridLayout</h2><p>QGridLayout 类将部件布置在<strong>网格</strong>中。</p><img src="https://img-blog.csdnimg.cn/20200509091912194.png" width="30%" loading="lazy"><p><strong>user_label: (0, 0)，第1行第1列<br>user_line: (0, 1)，第1行第2列<br>pwd_label: (1, 0)，第2行第1列<br>pwd_line: (1, 1)，第2行第2列</strong></p><hr><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token triple-quoted-string string">"""Created on Sat May  9 09:08:54 2020@author: Giyn"""</span><span class="token keyword">import</span> sys<span class="token keyword">from</span> PyQt5<span class="token punctuation">.</span>QtWidgets <span class="token keyword">import</span> QApplication<span class="token punctuation">,</span> QWidget<span class="token punctuation">,</span> QLabel<span class="token punctuation">,</span> QLineEdit<span class="token punctuation">,</span> QPushButton<span class="token punctuation">,</span> QGridLayout<span class="token keyword">class</span> <span class="token class-name">Simple_Window</span><span class="token punctuation">(</span>QWidget<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token builtin">super</span><span class="token punctuation">(</span>Simple_Window<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 使用super函数可以实现子类使用父类的方法</span>        self<span class="token punctuation">.</span>setWindowTitle<span class="token punctuation">(</span><span class="token string">'登录系统'</span><span class="token punctuation">)</span>  <span class="token comment"># 设置窗口标题</span>        self<span class="token punctuation">.</span>user_label <span class="token operator">=</span> QLabel<span class="token punctuation">(</span><span class="token string">"用户名:"</span><span class="token punctuation">,</span> self<span class="token punctuation">)</span>  <span class="token comment"># self是指定的父类Simple_Window，表示QLabel属于Simple_Window窗口</span>        self<span class="token punctuation">.</span>pwd_label <span class="token operator">=</span> QLabel<span class="token punctuation">(</span><span class="token string">"密码:"</span><span class="token punctuation">,</span> self<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>user_line <span class="token operator">=</span> QLineEdit<span class="token punctuation">(</span>self<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>pwd_line <span class="token operator">=</span> QLineEdit<span class="token punctuation">(</span>self<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>login_button <span class="token operator">=</span> QPushButton<span class="token punctuation">(</span><span class="token string">"登录"</span><span class="token punctuation">,</span> self<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>sign_button <span class="token operator">=</span> QPushButton<span class="token punctuation">(</span><span class="token string">"注册"</span><span class="token punctuation">,</span> self<span class="token punctuation">)</span>                self<span class="token punctuation">.</span>g_layout <span class="token operator">=</span> QGridLayout<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 实例化一个QGridLayout对象</span>        self<span class="token punctuation">.</span>g_layout<span class="token punctuation">.</span>addWidget<span class="token punctuation">(</span>self<span class="token punctuation">.</span>user_label<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>g_layout<span class="token punctuation">.</span>addWidget<span class="token punctuation">(</span>self<span class="token punctuation">.</span>user_line<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>g_layout<span class="token punctuation">.</span>addWidget<span class="token punctuation">(</span>self<span class="token punctuation">.</span>pwd_label<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>g_layout<span class="token punctuation">.</span>addWidget<span class="token punctuation">(</span>self<span class="token punctuation">.</span>pwd_line<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>g_layout<span class="token punctuation">.</span>addWidget<span class="token punctuation">(</span>self<span class="token punctuation">.</span>login_button<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>g_layout<span class="token punctuation">.</span>addWidget<span class="token punctuation">(</span>self<span class="token punctuation">.</span>sign_button<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>setLayout<span class="token punctuation">(</span>self<span class="token punctuation">.</span>g_layout<span class="token punctuation">)</span>  <span class="token comment"># 调用窗口的setLayout方法将总布局设置为窗口的整体布局</span>        <span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>    app <span class="token operator">=</span> QApplication<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span>    window <span class="token operator">=</span> Simple_Window<span class="token punctuation">(</span><span class="token punctuation">)</span>    window<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>    sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token keyword">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><h3 id="Output："><a href="#Output：" class="headerlink" title="Output："></a>Output：</h3><p><img src="https://img-blog.csdnimg.cn/20200509093119809.png" alt="在这里插入图片描述" loading="lazy"></p>]]></content>
      
      
      <categories>
          
          <category> PyQt5 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> PyQt5 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【PyQt5】—— QFormLayout</title>
      <link href="/posts/b4cd67a4/"/>
      <url>/posts/b4cd67a4/</url>
      
        <content type="html"><![CDATA[<h2 id="QFormLayout-类"><a href="#QFormLayout-类" class="headerlink" title="QFormLayout 类"></a>QFormLayout 类</h2><p>QFormLayout 类以<strong>表单布局</strong>的形式，通常用于布局输入窗口部件及其相关文本标签。</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token triple-quoted-string string">"""Created on Sat May  9 08:47:57 2020@author: Giyn"""</span><span class="token keyword">import</span> sys<span class="token keyword">from</span> PyQt5<span class="token punctuation">.</span>QtWidgets <span class="token keyword">import</span> QApplication<span class="token punctuation">,</span> QWidget<span class="token punctuation">,</span> QLabel<span class="token punctuation">,</span> QLineEdit<span class="token punctuation">,</span> QFormLayout<span class="token keyword">class</span> <span class="token class-name">Simple_Window</span><span class="token punctuation">(</span>QWidget<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token builtin">super</span><span class="token punctuation">(</span>Simple_Window<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 使用super函数可以实现子类使用父类的方法</span>        self<span class="token punctuation">.</span>setWindowTitle<span class="token punctuation">(</span><span class="token string">'登录系统'</span><span class="token punctuation">)</span>  <span class="token comment"># 设置窗口标题</span>        self<span class="token punctuation">.</span>user_label <span class="token operator">=</span> QLabel<span class="token punctuation">(</span><span class="token string">"用户名:"</span><span class="token punctuation">,</span> self<span class="token punctuation">)</span>  <span class="token comment"># self是指定的父类Simple_Window，表示QLabel属于Simple_Window窗口</span>        self<span class="token punctuation">.</span>pwd_label <span class="token operator">=</span> QLabel<span class="token punctuation">(</span><span class="token string">"密码:"</span><span class="token punctuation">,</span> self<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>user_line <span class="token operator">=</span> QLineEdit<span class="token punctuation">(</span>self<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>pwd_line <span class="token operator">=</span> QLineEdit<span class="token punctuation">(</span>self<span class="token punctuation">)</span>                self<span class="token punctuation">.</span>f_layout <span class="token operator">=</span> QFormLayout<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 实例化一个QFormLayout对象</span>        self<span class="token punctuation">.</span>f_layout<span class="token punctuation">.</span>addRow<span class="token punctuation">(</span>self<span class="token punctuation">.</span>user_label<span class="token punctuation">,</span> self<span class="token punctuation">.</span>user_line<span class="token punctuation">)</span>  <span class="token comment"># 左边放文本控件，右边放输入型控件</span>        self<span class="token punctuation">.</span>f_layout<span class="token punctuation">.</span>addRow<span class="token punctuation">(</span>self<span class="token punctuation">.</span>pwd_label<span class="token punctuation">,</span> self<span class="token punctuation">.</span>pwd_line<span class="token punctuation">)</span>                <span class="token comment"># self.f_layout.addRow("用户名:", self.user_line)</span>        <span class="token comment"># self.f_layout.addRow("密码:", self.pwd_line)</span>                self<span class="token punctuation">.</span>setLayout<span class="token punctuation">(</span>self<span class="token punctuation">.</span>f_layout<span class="token punctuation">)</span>  <span class="token comment"># 调用窗口的setLayout方法将总布局设置为窗口的整体布局</span>        <span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>    app <span class="token operator">=</span> QApplication<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span>    window <span class="token operator">=</span> Simple_Window<span class="token punctuation">(</span><span class="token punctuation">)</span>    window<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>    sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token keyword">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><h3 id="Output："><a href="#Output：" class="headerlink" title="Output："></a>Output：</h3><p><img src="https://img-blog.csdnimg.cn/20200509090427390.png" alt="在这里插入图片描述" loading="lazy"></p>]]></content>
      
      
      <categories>
          
          <category> PyQt5 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> PyQt5 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【PyQt5】—— QVBoxLayout 和 QHBoxLayout</title>
      <link href="/posts/9fda95d6/"/>
      <url>/posts/9fda95d6/</url>
      
        <content type="html"><![CDATA[<h1 id="QVBoxLayout-和-QHBoxLayout"><a href="#QVBoxLayout-和-QHBoxLayout" class="headerlink" title="QVBoxLayout 和 QHBoxLayout"></a>QVBoxLayout 和 QHBoxLayout</h1><p><strong>$QVBoxLayout$ 和 $QHBoxLayout$ 分别是垂直和水平布局管理器</strong></p><h2 id="QVBoxLayout"><a href="#QVBoxLayout" class="headerlink" title="QVBoxLayout"></a>QVBoxLayout</h2><p>QVBoxLayout 类垂直排列部件。</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token triple-quoted-string string">"""Created on Fri May  8 23:20:44 2020@author: Giyn"""</span><span class="token keyword">import</span> sys<span class="token keyword">from</span> PyQt5<span class="token punctuation">.</span>QtWidgets <span class="token keyword">import</span> QApplication<span class="token punctuation">,</span> QWidget<span class="token punctuation">,</span> QLabel<span class="token punctuation">,</span> QVBoxLayout<span class="token keyword">class</span> <span class="token class-name">Simple_Window</span><span class="token punctuation">(</span>QWidget<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token builtin">super</span><span class="token punctuation">(</span>Simple_Window<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 使用super函数可以实现子类使用父类的方法</span>        self<span class="token punctuation">.</span>user <span class="token operator">=</span> QLabel<span class="token punctuation">(</span><span class="token string">"用户名:"</span><span class="token punctuation">,</span> self<span class="token punctuation">)</span>  <span class="token comment"># self是指定的父类Simple_Window，表示QLabel属于Simple_Window窗口</span>        self<span class="token punctuation">.</span>pwd <span class="token operator">=</span> QLabel<span class="token punctuation">(</span><span class="token string">"密码"</span><span class="token punctuation">,</span> self<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>v_layout <span class="token operator">=</span> QVBoxLayout<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 实例化一个垂直布局管理器</span>        self<span class="token punctuation">.</span>v_layout<span class="token punctuation">.</span>addWidget<span class="token punctuation">(</span>self<span class="token punctuation">.</span>user<span class="token punctuation">)</span>  <span class="token comment"># 调用垂直布局管理器的addWidget方法来添加空间(注意顺序)</span>        self<span class="token punctuation">.</span>v_layout<span class="token punctuation">.</span>addWidget<span class="token punctuation">(</span>self<span class="token punctuation">.</span>pwd<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>setLayout<span class="token punctuation">(</span>self<span class="token punctuation">.</span>v_layout<span class="token punctuation">)</span>  <span class="token comment"># 调用窗口的setLayout方法将垂直布局设置为窗口的整体布局</span>                <span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>    app <span class="token operator">=</span> QApplication<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span>    window <span class="token operator">=</span> Simple_Window<span class="token punctuation">(</span><span class="token punctuation">)</span>    window<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>    sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token keyword">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><h3 id="Output："><a href="#Output：" class="headerlink" title="Output："></a>Output：</h3><p><img src="https://img-blog.csdnimg.cn/20200508232731160.png" alt="在这里插入图片描述" loading="lazy"></p><h2 id="QHBoxLayout"><a href="#QHBoxLayout" class="headerlink" title="QHBoxLayout"></a>QHBoxLayout</h2><p>QHBoxLayout 类水平排列部件。</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token triple-quoted-string string">"""Created on Fri May  8 23:31:56 2020@author: Giyn"""</span><span class="token keyword">import</span> sys<span class="token keyword">from</span> PyQt5<span class="token punctuation">.</span>QtWidgets <span class="token keyword">import</span> QApplication<span class="token punctuation">,</span> QWidget<span class="token punctuation">,</span> QLabel<span class="token punctuation">,</span> QHBoxLayout<span class="token punctuation">,</span> QLineEdit<span class="token keyword">class</span> <span class="token class-name">Simple_Window</span><span class="token punctuation">(</span>QWidget<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token builtin">super</span><span class="token punctuation">(</span>Simple_Window<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 使用super函数可以实现子类使用父类的方法</span>        self<span class="token punctuation">.</span>input_label <span class="token operator">=</span> QLabel<span class="token punctuation">(</span><span class="token string">"请输入:"</span><span class="token punctuation">,</span> self<span class="token punctuation">)</span>  <span class="token comment"># self是指定的父类Simple_Window，表示QLabel属于Simple_Window窗口</span>        self<span class="token punctuation">.</span>input_line <span class="token operator">=</span> QLineEdit<span class="token punctuation">(</span>self<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>h_layout <span class="token operator">=</span> QHBoxLayout<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 实例化一个水平布局管理器</span>        self<span class="token punctuation">.</span>h_layout<span class="token punctuation">.</span>addWidget<span class="token punctuation">(</span>self<span class="token punctuation">.</span>input_label<span class="token punctuation">)</span>  <span class="token comment"># 调用水平布局管理器的addWidget方法来添加空间(注意顺序)</span>        self<span class="token punctuation">.</span>h_layout<span class="token punctuation">.</span>addWidget<span class="token punctuation">(</span>self<span class="token punctuation">.</span>input_line<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>setLayout<span class="token punctuation">(</span>self<span class="token punctuation">.</span>h_layout<span class="token punctuation">)</span>  <span class="token comment"># 调用窗口的setLayout方法将水平布局设置为窗口的整体布局</span>                <span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>    app <span class="token operator">=</span> QApplication<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span>    window <span class="token operator">=</span> Simple_Window<span class="token punctuation">(</span><span class="token punctuation">)</span>    window<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>    sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token keyword">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><h3 id="Output：-1"><a href="#Output：-1" class="headerlink" title="Output："></a>Output：</h3><p><img src="https://img-blog.csdnimg.cn/20200508233619259.png" alt="在这里插入图片描述" loading="lazy"></p>]]></content>
      
      
      <categories>
          
          <category> PyQt5 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> PyQt5 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【PyQt5】—— QLabel 和 QPushButton</title>
      <link href="/posts/ef3a9e1d/"/>
      <url>/posts/ef3a9e1d/</url>
      
        <content type="html"><![CDATA[<h2 id="QLabel"><a href="#QLabel" class="headerlink" title="QLabel"></a>QLabel</h2><p>在 PyQt5 中，QLabel 部件提供<strong>文本或图像显示</strong>：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token triple-quoted-string string">"""Created on Fri May  8 21:52:56 2020@author: Giyn"""</span><span class="token keyword">import</span> sys<span class="token keyword">from</span> PyQt5<span class="token punctuation">.</span>QtWidgets <span class="token keyword">import</span> QApplication<span class="token punctuation">,</span> QLabel<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>    app <span class="token operator">=</span> QApplication<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span>  <span class="token comment"># 实例化一个QApplication对象</span>    label <span class="token operator">=</span> QLabel<span class="token punctuation">(</span><span class="token string">"This is a Label"</span><span class="token punctuation">)</span>  <span class="token comment"># 实例化一个QLabel文本控件</span>    <span class="token comment"># label.setText("This is a Label")  # 参数可以是HTML代码</span>    label<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 窗口和空间默认都是隐藏的，所以需要show方法进行显示</span>    sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token keyword">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># app.exec方法返回0</span></code></pre><h3 id="Output："><a href="#Output：" class="headerlink" title="Output："></a>Output：</h3><p><img src="https://img-blog.csdnimg.cn/20200508222428863.png" alt="在这里插入图片描述" loading="lazy"></p><h2 id="QPushButton"><a href="#QPushButton" class="headerlink" title="QPushButton"></a>QPushButton</h2><p>在 PyQt 中，QPushButton 部件提供了一个命令按钮：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token triple-quoted-string string">"""Created on Fri May  8 21:52:56 2020@author: Giyn"""</span><span class="token keyword">import</span> sys<span class="token keyword">from</span> PyQt5<span class="token punctuation">.</span>QtWidgets <span class="token keyword">import</span> QApplication<span class="token punctuation">,</span> QPushButton<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>    app <span class="token operator">=</span> QApplication<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span>  <span class="token comment"># 实例化一个QApplication对象</span>    button <span class="token operator">=</span> QPushButton<span class="token punctuation">(</span><span class="token string">"I am a Button"</span><span class="token punctuation">)</span>  <span class="token comment"># 实例化一个QPushButton对象</span>    <span class="token comment"># button.setText("I am a Button")</span>    button<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 窗口和空间默认都是隐藏的，所以需要show方法进行显示</span>    sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token keyword">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># app.exec方法返回0</span></code></pre><h3 id="Output：-1"><a href="#Output：-1" class="headerlink" title="Output："></a>Output：</h3><p><img src="https://img-blog.csdnimg.cn/20200508222719319.png" alt="在这里插入图片描述" loading="lazy"></p>]]></content>
      
      
      <categories>
          
          <category> PyQt5 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> PyQt5 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【PyQt5】—— 汉化对话框的按钮</title>
      <link href="/posts/77333682/"/>
      <url>/posts/77333682/</url>
      
        <content type="html"><![CDATA[<h2 id="汉化对话框的按钮"><a href="#汉化对话框的按钮" class="headerlink" title="汉化对话框的按钮"></a>汉化对话框的按钮</h2><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token triple-quoted-string string">"""Created on Sat May  9 14:46:56 2020@author: Giyn"""</span><span class="token keyword">import</span> sys<span class="token keyword">from</span> PyQt5<span class="token punctuation">.</span>QtWidgets <span class="token keyword">import</span> QApplication<span class="token punctuation">,</span> QWidget<span class="token punctuation">,</span> QPushButton<span class="token punctuation">,</span> QMessageBox<span class="token keyword">class</span> <span class="token class-name">Simple_Window</span><span class="token punctuation">(</span>QWidget<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token builtin">super</span><span class="token punctuation">(</span>Simple_Window<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 使用super函数可以实现子类使用父类的方法</span>                self<span class="token punctuation">.</span>button <span class="token operator">=</span> QPushButton<span class="token punctuation">(</span><span class="token string">"Question"</span><span class="token punctuation">,</span> self<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>button<span class="token punctuation">.</span>clicked<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>self<span class="token punctuation">.</span>show_msg_box<span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">show_msg_box</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> button<span class="token punctuation">)</span><span class="token punctuation">:</span>        msg_box <span class="token operator">=</span> QMessageBox<span class="token punctuation">(</span>self<span class="token punctuation">)</span>  <span class="token comment"># 实例化一个QMessageBox对象</span>        msg_box<span class="token punctuation">.</span>setWindowTitle<span class="token punctuation">(</span><span class="token string">"Question"</span><span class="token punctuation">)</span>  <span class="token comment"># 设置对话框的标题</span>        msg_box<span class="token punctuation">.</span>setText<span class="token punctuation">(</span><span class="token string">"Do you want to save it?"</span><span class="token punctuation">)</span>  <span class="token comment"># 设置对话框的内容</span>        msg_box<span class="token punctuation">.</span>setIcon<span class="token punctuation">(</span>QMessageBox<span class="token punctuation">.</span>Question<span class="token punctuation">)</span>                <span class="token comment"># 调用addButton方法传入字符串，确定按钮扮演的角色</span>        msg_box<span class="token punctuation">.</span>addButton<span class="token punctuation">(</span><span class="token string">"是"</span><span class="token punctuation">,</span> QMessageBox<span class="token punctuation">.</span>YesRole<span class="token punctuation">)</span>        msg_box<span class="token punctuation">.</span>addButton<span class="token punctuation">(</span><span class="token string">"否"</span><span class="token punctuation">,</span> QMessageBox<span class="token punctuation">.</span>NoRole<span class="token punctuation">)</span>        msg_box<span class="token punctuation">.</span><span class="token keyword">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token keyword">if</span> msg_box<span class="token punctuation">.</span>clickedButton<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"是"</span><span class="token punctuation">:</span>  <span class="token comment"># clickedButton方法返回用户按下的按钮</span>            self<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"保存成功!"</span><span class="token punctuation">)</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            self<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"退出程序!"</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>    app <span class="token operator">=</span> QApplication<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span>    window <span class="token operator">=</span> Simple_Window<span class="token punctuation">(</span><span class="token punctuation">)</span>    window<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>    sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token keyword">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><h3 id="Output："><a href="#Output：" class="headerlink" title="Output："></a>Output：</h3><img src="https://img-blog.csdnimg.cn/20200509150947473.png" width="20%" loading="lazy"><h4 id="After-clicking-“是”："><a href="#After-clicking-“是”：" class="headerlink" title="After clicking “是”："></a>After clicking “是”：</h4><img src="https://img-blog.csdnimg.cn/20200509151043964.png" width="40%" loading="lazy"><h4 id="After-clicking-“否”："><a href="#After-clicking-“否”：" class="headerlink" title="After clicking “否”："></a>After clicking “否”：</h4><img src="https://img-blog.csdnimg.cn/20200509151133317.png" width="40%" loading="lazy"><hr><blockquote><h6 id="QMessageBox对话框的图标参数："><a href="#QMessageBox对话框的图标参数：" class="headerlink" title="QMessageBox对话框的图标参数："></a>QMessageBox对话框的图标参数：</h6><p><code>QMessageBox.NoIcon</code><br><code>QMessageBox.Question</code><br><code>QMessageBox.Information</code><br><code>QMessageBox.Warning</code><br><code>QMessageBox.Critical</code></p></blockquote><hr><blockquote><h6 id="QMessageBox中常见的按钮角色："><a href="#QMessageBox中常见的按钮角色：" class="headerlink" title="QMessageBox中常见的按钮角色："></a>QMessageBox中常见的按钮角色：</h6><p><code>QMessageBox::AcceptRole</code>  $-&gt;$  $OK$<br><code>QMessageBox::RejectRole</code> $-&gt;$  $Cancel$<br><code>QMessageBox::YesRole</code> $-&gt;$ $Yes$<br><code>QMessageBox::NoRole</code> $-&gt;$ $No$</p></blockquote><hr><blockquote><p><code>clickedButton</code> 方法返回用户按下的按钮</p></blockquote><p>Reference：<a href="https://study.163.com/course/courseLearn.htm?courseId=1208995818">https://study.163.com/course/courseLearn.htm?courseId=1208995818</a></p>]]></content>
      
      
      <categories>
          
          <category> PyQt5 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> PyQt5 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【PyQt5】—— 与对话框进行交互</title>
      <link href="/posts/7ddd1e1f/"/>
      <url>/posts/7ddd1e1f/</url>
      
        <content type="html"><![CDATA[<h2 id="与对话框进行交互"><a href="#与对话框进行交互" class="headerlink" title="与对话框进行交互"></a>与对话框进行交互</h2><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token triple-quoted-string string">"""Created on Sat May  9 14:33:28 2020@author: Giyn"""</span><span class="token keyword">import</span> sys<span class="token keyword">from</span> PyQt5<span class="token punctuation">.</span>QtWidgets <span class="token keyword">import</span> QApplication<span class="token punctuation">,</span> QWidget<span class="token punctuation">,</span> QPushButton<span class="token punctuation">,</span> QVBoxLayout<span class="token punctuation">,</span> QMessageBox<span class="token keyword">class</span> <span class="token class-name">Simple_Window</span><span class="token punctuation">(</span>QWidget<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token builtin">super</span><span class="token punctuation">(</span>Simple_Window<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 使用super函数可以实现子类使用父类的方法</span>        self<span class="token punctuation">.</span>setWindowTitle<span class="token punctuation">(</span><span class="token string">"QMessageBox"</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>resize<span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>button1 <span class="token operator">=</span> QPushButton<span class="token punctuation">(</span><span class="token string">"Question"</span><span class="token punctuation">,</span> self<span class="token punctuation">)</span>  <span class="token comment"># self是指定的父类Simple_Window，表示QLabel属于Simple_Window窗口</span>        self<span class="token punctuation">.</span>button2 <span class="token operator">=</span> QPushButton<span class="token punctuation">(</span><span class="token string">"Information"</span><span class="token punctuation">,</span> self<span class="token punctuation">)</span>                <span class="token comment"># 连接信号和槽</span>        self<span class="token punctuation">.</span>button1<span class="token punctuation">.</span>clicked<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token keyword">lambda</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>show_msg_box<span class="token punctuation">(</span>self<span class="token punctuation">.</span>button1<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 槽函数带有参数，使用lambda表达式封装函数</span>        self<span class="token punctuation">.</span>button2<span class="token punctuation">.</span>clicked<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token keyword">lambda</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>show_msg_box<span class="token punctuation">(</span>self<span class="token punctuation">.</span>button2<span class="token punctuation">)</span><span class="token punctuation">)</span>                self<span class="token punctuation">.</span>v_layout <span class="token operator">=</span> QVBoxLayout<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 实例化一个QVBoxLayout对象</span>        self<span class="token punctuation">.</span>v_layout<span class="token punctuation">.</span>addWidget<span class="token punctuation">(</span>self<span class="token punctuation">.</span>button1<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>v_layout<span class="token punctuation">.</span>addWidget<span class="token punctuation">(</span>self<span class="token punctuation">.</span>button2<span class="token punctuation">)</span>                self<span class="token punctuation">.</span>setLayout<span class="token punctuation">(</span>self<span class="token punctuation">.</span>v_layout<span class="token punctuation">)</span>  <span class="token comment"># 调用窗口的setLayout方法将总布局设置为窗口的整体布局</span>            <span class="token keyword">def</span> <span class="token function">show_msg_box</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> button<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> button <span class="token operator">==</span> self<span class="token punctuation">.</span>button1<span class="token punctuation">:</span>            choice <span class="token operator">=</span> QMessageBox<span class="token punctuation">.</span>question<span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">"Question"</span><span class="token punctuation">,</span> <span class="token string">"Do you want to save it?"</span><span class="token punctuation">,</span> QMessageBox<span class="token punctuation">.</span>Yes <span class="token operator">|</span> QMessageBox<span class="token punctuation">.</span>No<span class="token punctuation">)</span>            <span class="token keyword">if</span> choice <span class="token operator">==</span> QMessageBox<span class="token punctuation">.</span>Yes<span class="token punctuation">:</span>                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Saved!"</span><span class="token punctuation">)</span>                self<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token keyword">elif</span> choice <span class="token operator">==</span> QMessageBox<span class="token punctuation">.</span>No<span class="token punctuation">:</span>                self<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token keyword">elif</span> button <span class="token operator">==</span> self<span class="token punctuation">.</span>button2<span class="token punctuation">:</span>            QMessageBox<span class="token punctuation">.</span>information<span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">"Information"</span><span class="token punctuation">,</span> <span class="token string">"I am an information."</span><span class="token punctuation">,</span> QMessageBox<span class="token punctuation">.</span>Ok<span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>    app <span class="token operator">=</span> QApplication<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span>    window <span class="token operator">=</span> Simple_Window<span class="token punctuation">(</span><span class="token punctuation">)</span>    window<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>    sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token keyword">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><h3 id="Output："><a href="#Output：" class="headerlink" title="Output："></a>Output：</h3><img src="https://img-blog.csdnimg.cn/20200509143929366.png" width="40%" loading="lazy"><h4 id="After-clicking-“Yes”："><a href="#After-clicking-“Yes”：" class="headerlink" title="After clicking “Yes”："></a>After clicking “Yes”：</h4><img src="https://img-blog.csdnimg.cn/20200509144328217.png" width="40%" loading="lazy"><h4 id="After-clicking-“No”："><a href="#After-clicking-“No”：" class="headerlink" title="After clicking “No”："></a>After clicking “No”：</h4><img src="https://img-blog.csdnimg.cn/2020050914414088.png" width="40%" loading="lazy"><p>The window close and output nothing.</p>]]></content>
      
      
      <categories>
          
          <category> PyQt5 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> PyQt5 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【PyQt5】—— 连接带参数的槽函数</title>
      <link href="/posts/fad50a8f/"/>
      <url>/posts/fad50a8f/</url>
      
        <content type="html"><![CDATA[<h2 id="连接带参数的槽函数"><a href="#连接带参数的槽函数" class="headerlink" title="连接带参数的槽函数"></a>连接带参数的槽函数</h2><h5 id="连接带参数的槽函数，必须传入一个函数对象，而不是函数的调用结果，因此使用-lambda-把函数封装成函数对象。"><a href="#连接带参数的槽函数，必须传入一个函数对象，而不是函数的调用结果，因此使用-lambda-把函数封装成函数对象。" class="headerlink" title="连接带参数的槽函数，必须传入一个函数对象，而不是函数的调用结果，因此使用 lambda 把函数封装成函数对象。"></a>连接带参数的槽函数，必须传入一个函数对象，而不是函数的调用结果，因此使用 lambda 把函数封装成函数对象。</h5><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token triple-quoted-string string">"""Created on Sat May  9 12:16:58 2020@author: Giyn"""</span><span class="token keyword">import</span> sys<span class="token keyword">from</span> PyQt5<span class="token punctuation">.</span>QtWidgets <span class="token keyword">import</span> QApplication<span class="token punctuation">,</span> QWidget<span class="token punctuation">,</span> QLabel<span class="token punctuation">,</span> QPushButton<span class="token punctuation">,</span> QVBoxLayout<span class="token keyword">class</span> <span class="token class-name">Simple_Window</span><span class="token punctuation">(</span>QWidget<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token builtin">super</span><span class="token punctuation">(</span>Simple_Window<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 使用super函数可以实现子类使用父类的方法</span>        self<span class="token punctuation">.</span>label <span class="token operator">=</span> QLabel<span class="token punctuation">(</span><span class="token string">"I am the original Label"</span><span class="token punctuation">,</span> self<span class="token punctuation">)</span>  <span class="token comment"># self是指定的父类Simple_Window，表示QLabel属于Simple_Window窗口</span>        self<span class="token punctuation">.</span>button <span class="token operator">=</span> QPushButton<span class="token punctuation">(</span><span class="token string">"Button"</span><span class="token punctuation">,</span> self<span class="token punctuation">)</span>                self<span class="token punctuation">.</span>button<span class="token punctuation">.</span>clicked<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token keyword">lambda</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>change_label<span class="token punctuation">(</span><span class="token string">"I am the changed Label"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 此处要使用匿名函数把函数封装成函数对象</span>                self<span class="token punctuation">.</span>v_layout <span class="token operator">=</span> QVBoxLayout<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 实例化一个QVBoxLayout对象</span>        self<span class="token punctuation">.</span>v_layout<span class="token punctuation">.</span>addWidget<span class="token punctuation">(</span>self<span class="token punctuation">.</span>label<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>v_layout<span class="token punctuation">.</span>addWidget<span class="token punctuation">(</span>self<span class="token punctuation">.</span>button<span class="token punctuation">)</span>                self<span class="token punctuation">.</span>setLayout<span class="token punctuation">(</span>self<span class="token punctuation">.</span>v_layout<span class="token punctuation">)</span>  <span class="token comment"># 调用窗口的setLayout方法将总布局设置为窗口的整体布局</span>            <span class="token keyword">def</span> <span class="token function">change_label</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> text<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>label<span class="token punctuation">.</span>setText<span class="token punctuation">(</span>text<span class="token punctuation">)</span>                <span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>    app <span class="token operator">=</span> QApplication<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span>    window <span class="token operator">=</span> Simple_Window<span class="token punctuation">(</span><span class="token punctuation">)</span>    window<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>    sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token keyword">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><h3 id="Output："><a href="#Output：" class="headerlink" title="Output："></a>Output：</h3><h5 id="When-not-clicked："><a href="#When-not-clicked：" class="headerlink" title="When not clicked："></a>When not clicked：</h5><p><img src="https://img-blog.csdnimg.cn/2020050912253875.png" alt="在这里插入图片描述" loading="lazy"></p><h5 id="When-clicked："><a href="#When-clicked：" class="headerlink" title="When clicked："></a>When clicked：</h5><p><img src="https://img-blog.csdnimg.cn/20200509122608607.png" alt="在这里插入图片描述" loading="lazy"></p><p>Reference：<a href="https://study.163.com/course/courseLearn.htm?courseId=1208995818">https://study.163.com/course/courseLearn.htm?courseId=1208995818</a></p>]]></content>
      
      
      <categories>
          
          <category> PyQt5 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> PyQt5 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【PyQt5】—— 一个信号与多个槽函数连接</title>
      <link href="/posts/311bc453/"/>
      <url>/posts/311bc453/</url>
      
        <content type="html"><![CDATA[<h2 id="一个信号与多个槽函数连接"><a href="#一个信号与多个槽函数连接" class="headerlink" title="一个信号与多个槽函数连接"></a>一个信号与多个槽函数连接</h2><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token triple-quoted-string string">"""Created on Sat May  9 11:50:03 2020@author: Giyn"""</span><span class="token keyword">import</span> sys<span class="token keyword">from</span> PyQt5<span class="token punctuation">.</span>QtWidgets <span class="token keyword">import</span> QApplication<span class="token punctuation">,</span> QWidget<span class="token punctuation">,</span> QLabel<span class="token punctuation">,</span> QPushButton<span class="token punctuation">,</span> QVBoxLayout<span class="token keyword">class</span> <span class="token class-name">Simple_Window</span><span class="token punctuation">(</span>QWidget<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token builtin">super</span><span class="token punctuation">(</span>Simple_Window<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 使用super函数可以实现子类使用父类的方法</span>        self<span class="token punctuation">.</span>label <span class="token operator">=</span> QLabel<span class="token punctuation">(</span><span class="token string">"I am the original Label"</span><span class="token punctuation">,</span> self<span class="token punctuation">)</span>  <span class="token comment"># self是指定的父类Simple_Window，表示QLabel属于Simple_Window窗口</span>        self<span class="token punctuation">.</span>button <span class="token operator">=</span> QPushButton<span class="token punctuation">(</span><span class="token string">"Button"</span><span class="token punctuation">,</span> self<span class="token punctuation">)</span>                <span class="token comment"># 一个信号连接多个槽函数</span>        self<span class="token punctuation">.</span>button<span class="token punctuation">.</span>clicked<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>self<span class="token punctuation">.</span>change_label<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>button<span class="token punctuation">.</span>clicked<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>self<span class="token punctuation">.</span>change_size<span class="token punctuation">)</span>                self<span class="token punctuation">.</span>v_layout <span class="token operator">=</span> QVBoxLayout<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 实例化一个QVBoxLayout对象</span>        self<span class="token punctuation">.</span>v_layout<span class="token punctuation">.</span>addWidget<span class="token punctuation">(</span>self<span class="token punctuation">.</span>label<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>v_layout<span class="token punctuation">.</span>addWidget<span class="token punctuation">(</span>self<span class="token punctuation">.</span>button<span class="token punctuation">)</span>                self<span class="token punctuation">.</span>setLayout<span class="token punctuation">(</span>self<span class="token punctuation">.</span>v_layout<span class="token punctuation">)</span>  <span class="token comment"># 调用窗口的setLayout方法将总布局设置为窗口的整体布局</span>            <span class="token keyword">def</span> <span class="token function">change_label</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>label<span class="token punctuation">.</span>setText<span class="token punctuation">(</span><span class="token string">"I am the changed Label"</span><span class="token punctuation">)</span>            <span class="token keyword">def</span> <span class="token function">change_size</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>resize<span class="token punctuation">(</span><span class="token number">412</span><span class="token punctuation">,</span> <span class="token number">412</span><span class="token punctuation">)</span>                <span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>    app <span class="token operator">=</span> QApplication<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span>    window <span class="token operator">=</span> Simple_Window<span class="token punctuation">(</span><span class="token punctuation">)</span>    window<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>    sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token keyword">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><h3 id="Output："><a href="#Output：" class="headerlink" title="Output："></a>Output：</h3><h5 id="When-not-clicked："><a href="#When-not-clicked：" class="headerlink" title="When not clicked："></a>When not clicked：</h5><p><img src="https://img-blog.csdnimg.cn/20200509115844126.png" alt="在这里插入图片描述" loading="lazy"></p><h5 id="When-clicked："><a href="#When-clicked：" class="headerlink" title="When clicked："></a>When clicked：</h5><img src="https://img-blog.csdnimg.cn/20200509120042209.png" width="40%" loading="lazy"><p>Reference：<a href="https://study.163.com/course/courseLearn.htm?courseId=1208995818">https://study.163.com/course/courseLearn.htm?courseId=1208995818</a></p>]]></content>
      
      
      <categories>
          
          <category> PyQt5 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> PyQt5 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【PyQt5】—— 信号与信号连接</title>
      <link href="/posts/71004e15/"/>
      <url>/posts/71004e15/</url>
      
        <content type="html"><![CDATA[<h2 id="信号与信号连接"><a href="#信号与信号连接" class="headerlink" title="信号与信号连接"></a>信号与信号连接</h2><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token triple-quoted-string string">"""Created on Sat May  9 11:39:49 2020@author: Giyn"""</span><span class="token keyword">import</span> sys<span class="token keyword">from</span> PyQt5<span class="token punctuation">.</span>QtWidgets <span class="token keyword">import</span> QApplication<span class="token punctuation">,</span> QWidget<span class="token punctuation">,</span> QLabel<span class="token punctuation">,</span> QPushButton<span class="token punctuation">,</span> QVBoxLayout<span class="token keyword">class</span> <span class="token class-name">Simple_Window</span><span class="token punctuation">(</span>QWidget<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token builtin">super</span><span class="token punctuation">(</span>Simple_Window<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 使用super函数可以实现子类使用父类的方法</span>        self<span class="token punctuation">.</span>label <span class="token operator">=</span> QLabel<span class="token punctuation">(</span><span class="token string">"I am a Label"</span><span class="token punctuation">,</span> self<span class="token punctuation">)</span>  <span class="token comment"># self是指定的父类Simple_Window，表示QLabel属于Simple_Window窗口</span>        self<span class="token punctuation">.</span>button <span class="token operator">=</span> QPushButton<span class="token punctuation">(</span><span class="token string">"Button"</span><span class="token punctuation">,</span> self<span class="token punctuation">)</span>                self<span class="token punctuation">.</span>button<span class="token punctuation">.</span>pressed<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>self<span class="token punctuation">.</span>button<span class="token punctuation">.</span>released<span class="token punctuation">)</span>  <span class="token comment"># 连接信号与信号</span>        self<span class="token punctuation">.</span>button<span class="token punctuation">.</span>released<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>self<span class="token punctuation">.</span>change_label<span class="token punctuation">)</span>                self<span class="token punctuation">.</span>v_layout <span class="token operator">=</span> QVBoxLayout<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 实例化一个QVBoxLayout对象</span>        self<span class="token punctuation">.</span>v_layout<span class="token punctuation">.</span>addWidget<span class="token punctuation">(</span>self<span class="token punctuation">.</span>label<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>v_layout<span class="token punctuation">.</span>addWidget<span class="token punctuation">(</span>self<span class="token punctuation">.</span>button<span class="token punctuation">)</span>                self<span class="token punctuation">.</span>setLayout<span class="token punctuation">(</span>self<span class="token punctuation">.</span>v_layout<span class="token punctuation">)</span>  <span class="token comment"># 调用窗口的setLayout方法将总布局设置为窗口的整体布局</span>            <span class="token keyword">def</span> <span class="token function">change_label</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>label<span class="token punctuation">.</span>setText<span class="token punctuation">(</span><span class="token string">"I am changed"</span><span class="token punctuation">)</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"flag"</span><span class="token punctuation">)</span>                <span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>    app <span class="token operator">=</span> QApplication<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span>    window <span class="token operator">=</span> Simple_Window<span class="token punctuation">(</span><span class="token punctuation">)</span>    window<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>    sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token keyword">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><h3 id="Output："><a href="#Output：" class="headerlink" title="Output："></a>Output：</h3><h5 id="When-push-not-released-："><a href="#When-push-not-released-：" class="headerlink" title="When push (not released)："></a>When push (not released)：</h5><p><img src="https://img-blog.csdnimg.cn/20200509114511330.png" alt="在这里插入图片描述" loading="lazy"></p><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> flag</code></pre><h5 id="When-released："><a href="#When-released：" class="headerlink" title="When released："></a>When released：</h5><p><img src="https://img-blog.csdnimg.cn/20200509114513937.png" alt="在这里插入图片描述" loading="lazy"></p><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> flag<span class="token operator">>></span><span class="token operator">></span> flag</code></pre><p><strong>当按下按钮且未释放的时候，发射了 <code>pressed</code> 信号，同时发射了 <code>released</code> 信号，然后调用槽函数；释放按钮， <code>released</code> 信号再次发射，再次调用槽函数。</strong></p><blockquote><p>第一次调用槽函数是间接调用；第二次调用槽函数是直接调用。</p></blockquote><p>Reference：<a href="https://study.163.com/course/courseLearn.htm?courseId=1208995818">https://study.163.com/course/courseLearn.htm?courseId=1208995818</a></p>]]></content>
      
      
      <categories>
          
          <category> PyQt5 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> PyQt5 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【PyQt5】—— 多个信号连接同一个槽函数</title>
      <link href="/posts/bd17b586/"/>
      <url>/posts/bd17b586/</url>
      
        <content type="html"><![CDATA[<h2 id="多个信号连接同一个槽函数"><a href="#多个信号连接同一个槽函数" class="headerlink" title="多个信号连接同一个槽函数"></a>多个信号连接同一个槽函数</h2><h5 id="QPushButton-控件的-pressed-信号和-released-信号分别是在按钮被-点击-和-释放-的瞬间发出，以此来实现多个信号连接同一个槽函数："><a href="#QPushButton-控件的-pressed-信号和-released-信号分别是在按钮被-点击-和-释放-的瞬间发出，以此来实现多个信号连接同一个槽函数：" class="headerlink" title="QPushButton 控件的 pressed 信号和 released 信号分别是在按钮被 点击 和 释放 的瞬间发出，以此来实现多个信号连接同一个槽函数："></a>QPushButton 控件的 <code>pressed</code> 信号和 <code>released</code> 信号分别是在按钮被 <code>点击</code> 和 <code>释放</code> 的瞬间发出，以此来实现多个信号连接同一个槽函数：</h5><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token triple-quoted-string string">"""Created on Sat May  9 11:11:21 2020@author: Giyn"""</span><span class="token keyword">import</span> sys<span class="token keyword">from</span> PyQt5<span class="token punctuation">.</span>QtWidgets <span class="token keyword">import</span> QApplication<span class="token punctuation">,</span> QWidget<span class="token punctuation">,</span> QLabel<span class="token punctuation">,</span> QPushButton<span class="token punctuation">,</span> QVBoxLayout<span class="token keyword">class</span> <span class="token class-name">Simple_Window</span><span class="token punctuation">(</span>QWidget<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token builtin">super</span><span class="token punctuation">(</span>Simple_Window<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 使用super函数可以实现子类使用父类的方法</span>        self<span class="token punctuation">.</span>label <span class="token operator">=</span> QLabel<span class="token punctuation">(</span><span class="token string">"I am a Label"</span><span class="token punctuation">,</span> self<span class="token punctuation">)</span>  <span class="token comment"># self是指定的父类Simple_Window，表示QLabel属于Simple_Window窗口</span>        self<span class="token punctuation">.</span>button <span class="token operator">=</span> QPushButton<span class="token punctuation">(</span><span class="token string">"Button"</span><span class="token punctuation">,</span> self<span class="token punctuation">)</span>                <span class="token comment"># 连接信号和槽</span>        self<span class="token punctuation">.</span>button<span class="token punctuation">.</span>pressed<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>self<span class="token punctuation">.</span>change_label<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>button<span class="token punctuation">.</span>released<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>self<span class="token punctuation">.</span>change_label<span class="token punctuation">)</span>                self<span class="token punctuation">.</span>v_layout <span class="token operator">=</span> QVBoxLayout<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 实例化一个QVBoxLayout对象</span>        self<span class="token punctuation">.</span>v_layout<span class="token punctuation">.</span>addWidget<span class="token punctuation">(</span>self<span class="token punctuation">.</span>label<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>v_layout<span class="token punctuation">.</span>addWidget<span class="token punctuation">(</span>self<span class="token punctuation">.</span>button<span class="token punctuation">)</span>                self<span class="token punctuation">.</span>setLayout<span class="token punctuation">(</span>self<span class="token punctuation">.</span>v_layout<span class="token punctuation">)</span>  <span class="token comment"># 调用窗口的setLayout方法将总布局设置为窗口的整体布局</span>            <span class="token keyword">def</span> <span class="token function">change_label</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>label<span class="token punctuation">.</span>setText<span class="token punctuation">(</span><span class="token string">"I am changed"</span><span class="token punctuation">)</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"flag"</span><span class="token punctuation">)</span>                <span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>    app <span class="token operator">=</span> QApplication<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span>    window <span class="token operator">=</span> Simple_Window<span class="token punctuation">(</span><span class="token punctuation">)</span>    window<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>    sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token keyword">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><h3 id="Output："><a href="#Output：" class="headerlink" title="Output："></a>Output：</h3><h5 id="When-push-not-released-："><a href="#When-push-not-released-：" class="headerlink" title="When push (not released)："></a>When push (not released)：</h5><p><img src="https://img-blog.csdnimg.cn/20200509113649560.png" alt="在这里插入图片描述" loading="lazy"></p><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> flag</code></pre><h5 id="When-released："><a href="#When-released：" class="headerlink" title="When released："></a>When released：</h5><p><img src="https://img-blog.csdnimg.cn/20200509113729665.png" alt="在这里插入图片描述" loading="lazy"></p><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> flag<span class="token operator">>></span><span class="token operator">></span> flag</code></pre>]]></content>
      
      
      <categories>
          
          <category> PyQt5 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> PyQt5 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【PyQt5】—— 一个信号连接一个槽函数</title>
      <link href="/posts/ea55619e/"/>
      <url>/posts/ea55619e/</url>
      
        <content type="html"><![CDATA[<h2 id="一个信号连接一个槽函数"><a href="#一个信号连接一个槽函数" class="headerlink" title="一个信号连接一个槽函数"></a>一个信号连接一个槽函数</h2><h5 id="PyQt5-的按钮控件-QPushButton-被点击之后会发射一个-clicked-信号，然后再通过-QLabel-的-setText-方法改变文本控件的内容，以此来实现一个信号连接一个槽函数："><a href="#PyQt5-的按钮控件-QPushButton-被点击之后会发射一个-clicked-信号，然后再通过-QLabel-的-setText-方法改变文本控件的内容，以此来实现一个信号连接一个槽函数：" class="headerlink" title="PyQt5 的按钮控件 QPushButton 被点击之后会发射一个 clicked 信号，然后再通过 QLabel 的 setText 方法改变文本控件的内容，以此来实现一个信号连接一个槽函数："></a>PyQt5 的按钮控件 <code>QPushButton</code> 被点击之后会发射一个 <code>clicked</code> 信号，然后再通过 <code>QLabel</code> 的 <code>setText</code> 方法改变文本控件的内容，以此来实现一个信号连接一个槽函数：</h5><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token triple-quoted-string string">"""Created on Sat May  9 11:11:21 2020@author: Giyn"""</span><span class="token keyword">import</span> sys<span class="token keyword">from</span> PyQt5<span class="token punctuation">.</span>QtWidgets <span class="token keyword">import</span> QApplication<span class="token punctuation">,</span> QWidget<span class="token punctuation">,</span> QLabel<span class="token punctuation">,</span> QPushButton<span class="token punctuation">,</span> QVBoxLayout<span class="token keyword">class</span> <span class="token class-name">Simple_Window</span><span class="token punctuation">(</span>QWidget<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token builtin">super</span><span class="token punctuation">(</span>Simple_Window<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 使用super函数可以实现子类使用父类的方法</span>        self<span class="token punctuation">.</span>label <span class="token operator">=</span> QLabel<span class="token punctuation">(</span><span class="token string">"I am a Label"</span><span class="token punctuation">,</span> self<span class="token punctuation">)</span>  <span class="token comment"># self是指定的父类Simple_Window，表示QLabel属于Simple_Window窗口</span>        self<span class="token punctuation">.</span>button <span class="token operator">=</span> QPushButton<span class="token punctuation">(</span><span class="token string">"Button"</span><span class="token punctuation">,</span> self<span class="token punctuation">)</span>                self<span class="token punctuation">.</span>button<span class="token punctuation">.</span>clicked<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>self<span class="token punctuation">.</span>change_label<span class="token punctuation">)</span>  <span class="token comment"># 连接信号和槽</span>                self<span class="token punctuation">.</span>v_layout <span class="token operator">=</span> QVBoxLayout<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 实例化一个QVBoxLayout对象</span>        self<span class="token punctuation">.</span>v_layout<span class="token punctuation">.</span>addWidget<span class="token punctuation">(</span>self<span class="token punctuation">.</span>label<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>v_layout<span class="token punctuation">.</span>addWidget<span class="token punctuation">(</span>self<span class="token punctuation">.</span>button<span class="token punctuation">)</span>                self<span class="token punctuation">.</span>setLayout<span class="token punctuation">(</span>self<span class="token punctuation">.</span>v_layout<span class="token punctuation">)</span>  <span class="token comment"># 调用窗口的setLayout方法将总布局设置为窗口的整体布局</span>            <span class="token keyword">def</span> <span class="token function">change_label</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>label<span class="token punctuation">.</span>setText<span class="token punctuation">(</span><span class="token string">"I am changed"</span><span class="token punctuation">)</span>  <span class="token comment"># 改变文本控件的内容</span>                <span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>    app <span class="token operator">=</span> QApplication<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span>    window <span class="token operator">=</span> Simple_Window<span class="token punctuation">(</span><span class="token punctuation">)</span>    window<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>    sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token keyword">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><h3 id="Output："><a href="#Output：" class="headerlink" title="Output："></a>Output：</h3><p><img src="https://img-blog.csdnimg.cn/20200509112222167.png" alt="在这里插入图片描述" loading="lazy"></p><h3 id="After-pushing-the-button："><a href="#After-pushing-the-button：" class="headerlink" title="After pushing the button："></a>After pushing the button：</h3><p><img src="https://img-blog.csdnimg.cn/2020050911231710.png" alt="在这里插入图片描述" loading="lazy"></p><p>Reference：<a href="https://study.163.com/course/courseLearn.htm?courseId=1208995818">https://study.163.com/course/courseLearn.htm?courseId=1208995818</a></p>]]></content>
      
      
      <categories>
          
          <category> PyQt5 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> PyQt5 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【PyQt5】—— 信号和槽</title>
      <link href="/posts/8cbf7e4e/"/>
      <url>/posts/8cbf7e4e/</url>
      
        <content type="html"><![CDATA[<h3 id="信号和槽"><a href="#信号和槽" class="headerlink" title="信号和槽"></a>信号和槽</h3><p>信号和槽用于两个对象之间的通信，是 Qt 的代表性特征。</p><p>简单地，可以理解为信号就是一个事件的发生，例如鼠标点击，键盘输入等；而槽就是一个函数，用于执行接收信号后的操作。通过信号可以决定调用哪个槽函数。</p><h4 id="我们可以拿生活中的红绿灯来类比信号和槽机制："><a href="#我们可以拿生活中的红绿灯来类比信号和槽机制：" class="headerlink" title="我们可以拿生活中的红绿灯来类比信号和槽机制："></a>我们可以拿生活中的红绿灯来类比信号和槽机制：</h4><img src="https://img-blog.csdnimg.cn/20200509105316324.png" width="10%" loading="lazy"><p>$red-&gt;stop()$<br>$green-&gt;go()$</p><p><a href="https://www.banbaowang.com/jianbihuajiaocheng/148788/">图片来源</a></p><h3 id="信号和槽只有在连接后才可以起作用："><a href="#信号和槽只有在连接后才可以起作用：" class="headerlink" title="信号和槽只有在连接后才可以起作用："></a>信号和槽只有在连接后才可以起作用：</h3><img src="https://img-blog.csdnimg.cn/20200509104353832.png" width="30%" loading="lazy"><h4 id="红绿灯的例子："><a href="#红绿灯的例子：" class="headerlink" title="红绿灯的例子："></a>红绿灯的例子：</h4><p><code>traffic_light.red.connect(stop)</code><br><code>traffic_light.green.connect(go)</code></p><p>连接后，信号发射，调用槽函数。</p><p>Reference：<a href="https://study.163.com/course/courseLearn.htm?courseId=1208995818&share=1&shareId=1396892512#/learn/video?lessonId=1278866429&courseId=1208995818">https://study.163.com/course/courseMain.htm?courseId=1208995818</a></p>]]></content>
      
      
      <categories>
          
          <category> PyQt5 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> PyQt5 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【PyQt5】—— 嵌套布局</title>
      <link href="/posts/7db9c5ab/"/>
      <url>/posts/7db9c5ab/</url>
      
        <content type="html"><![CDATA[<h2 id="嵌套布局"><a href="#嵌套布局" class="headerlink" title="嵌套布局"></a>嵌套布局</h2><p>布局管理器除了可以添加控件，还可以添加子布局。</p><h4 id="通常嵌套布局有以下两种方式："><a href="#通常嵌套布局有以下两种方式：" class="headerlink" title="通常嵌套布局有以下两种方式："></a>通常嵌套布局有以下两种方式：</h4><img src="https://img-blog.csdnimg.cn/2020050900561586.png" width="30%" loading="lazy"><img src="https://img-blog.csdnimg.cn/20200509005624391.png" width="30%" loading="lazy"><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token triple-quoted-string string">"""Created on Fri May  8 23:56:28 2020@author: Giyn"""</span><span class="token keyword">import</span> sys<span class="token keyword">from</span> PyQt5<span class="token punctuation">.</span>QtWidgets <span class="token keyword">import</span> QApplication<span class="token punctuation">,</span> QWidget<span class="token punctuation">,</span> QLabel<span class="token punctuation">,</span> QVBoxLayout<span class="token punctuation">,</span> QHBoxLayout<span class="token punctuation">,</span> QLineEdit<span class="token keyword">class</span> <span class="token class-name">Simple_Window</span><span class="token punctuation">(</span>QWidget<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token builtin">super</span><span class="token punctuation">(</span>Simple_Window<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 使用super函数可以实现子类使用父类的方法</span>        self<span class="token punctuation">.</span>setWindowTitle<span class="token punctuation">(</span><span class="token string">'登录系统'</span><span class="token punctuation">)</span>  <span class="token comment"># 设置窗口标题</span>        self<span class="token punctuation">.</span>user_label <span class="token operator">=</span> QLabel<span class="token punctuation">(</span><span class="token string">"用户名:"</span><span class="token punctuation">,</span> self<span class="token punctuation">)</span>  <span class="token comment"># self是指定的父类Simple_Window，表示QLabel属于Simple_Window窗口</span>        self<span class="token punctuation">.</span>pwd_label <span class="token operator">=</span> QLabel<span class="token punctuation">(</span><span class="token string">"密码:"</span><span class="token punctuation">,</span> self<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>user_line <span class="token operator">=</span> QLineEdit<span class="token punctuation">(</span>self<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>pwd_line <span class="token operator">=</span> QLineEdit<span class="token punctuation">(</span>self<span class="token punctuation">)</span>                <span class="token comment"># 子布局</span>        self<span class="token punctuation">.</span>h1_layout <span class="token operator">=</span> QHBoxLayout<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>h2_layout <span class="token operator">=</span> QHBoxLayout<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>v_layout <span class="token operator">=</span> QVBoxLayout<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 总布局</span>                <span class="token comment"># 添加部件</span>        self<span class="token punctuation">.</span>h1_layout<span class="token punctuation">.</span>addWidget<span class="token punctuation">(</span>self<span class="token punctuation">.</span>user_label<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>h1_layout<span class="token punctuation">.</span>addWidget<span class="token punctuation">(</span>self<span class="token punctuation">.</span>user_line<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>h2_layout<span class="token punctuation">.</span>addWidget<span class="token punctuation">(</span>self<span class="token punctuation">.</span>pwd_label<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>h2_layout<span class="token punctuation">.</span>addWidget<span class="token punctuation">(</span>self<span class="token punctuation">.</span>pwd_line<span class="token punctuation">)</span>                <span class="token comment"># 调用addLayout方法将两个水平布局添加到总的垂直布局中</span>        self<span class="token punctuation">.</span>v_layout<span class="token punctuation">.</span>addLayout<span class="token punctuation">(</span>self<span class="token punctuation">.</span>h1_layout<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>v_layout<span class="token punctuation">.</span>addLayout<span class="token punctuation">(</span>self<span class="token punctuation">.</span>h2_layout<span class="token punctuation">)</span>                self<span class="token punctuation">.</span>setLayout<span class="token punctuation">(</span>self<span class="token punctuation">.</span>v_layout<span class="token punctuation">)</span>  <span class="token comment"># 调用窗口的setLayout方法将总布局设置为窗口的整体布局</span>        <span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>    app <span class="token operator">=</span> QApplication<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span>    window <span class="token operator">=</span> Simple_Window<span class="token punctuation">(</span><span class="token punctuation">)</span>    window<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>    sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token keyword">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><h3 id="Output："><a href="#Output：" class="headerlink" title="Output："></a>Output：</h3><img src="https://img-blog.csdnimg.cn/2020050900580419.png" width="30%" loading="lazy">]]></content>
      
      
      <categories>
          
          <category> PyQt5 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> PyQt5 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【PyQt5】—— 使用 move 方法进行布局管理</title>
      <link href="/posts/eed201fb/"/>
      <url>/posts/eed201fb/</url>
      
        <content type="html"><![CDATA[<h3 id="PyQt5-中的坐标体系："><a href="#PyQt5-中的坐标体系：" class="headerlink" title="PyQt5 中的坐标体系："></a>PyQt5 中的坐标体系：</h3><img src="https://img-blog.csdnimg.cn/20200509090156886.png" width="40%" loading="lazy"><p><strong>向右为 $x$ 轴正方向，向下为 $y$ 轴正方向。</strong></p><p>使用 $move(x, y)$ 可以对窗口进行布局。</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token triple-quoted-string string">"""Created on Fri May  8 23:03:21 2020@author: Giyn"""</span><span class="token keyword">import</span> sys<span class="token keyword">from</span> PyQt5<span class="token punctuation">.</span>QtWidgets <span class="token keyword">import</span> QApplication<span class="token punctuation">,</span> QWidget<span class="token punctuation">,</span> QLabel<span class="token punctuation">,</span> QPushButton<span class="token keyword">class</span> <span class="token class-name">Simple_Window</span><span class="token punctuation">(</span>QWidget<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token builtin">super</span><span class="token punctuation">(</span>Simple_Window<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 使用super函数可以实现子类使用父类的方法</span>        self<span class="token punctuation">.</span>resize<span class="token punctuation">(</span><span class="token number">412</span><span class="token punctuation">,</span> <span class="token number">412</span><span class="token punctuation">)</span>                self<span class="token punctuation">.</span>label <span class="token operator">=</span> QLabel<span class="token punctuation">(</span><span class="token string">"This is a Label"</span><span class="token punctuation">,</span> self<span class="token punctuation">)</span> <span class="token comment"># self是指定的父类Simple_Window，表示QLabel属于Simple_Window窗口</span>        self<span class="token punctuation">.</span>button <span class="token operator">=</span> QPushButton<span class="token punctuation">(</span><span class="token string">"I am a Button"</span><span class="token punctuation">,</span> self<span class="token punctuation">)</span>                 self<span class="token punctuation">.</span>label<span class="token punctuation">.</span>move<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span> <span class="token comment"># 使用move方法对窗口进行布局</span>        self<span class="token punctuation">.</span>button<span class="token punctuation">.</span>move<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>                <span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>    app <span class="token operator">=</span> QApplication<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span>    window <span class="token operator">=</span> Simple_Window<span class="token punctuation">(</span><span class="token punctuation">)</span>    window<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>    sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token keyword">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><h3 id="Output："><a href="#Output：" class="headerlink" title="Output："></a>Output：</h3><img src="https://img-blog.csdnimg.cn/2020050823113596.png" width="40%" loading="lazy">]]></content>
      
      
      <categories>
          
          <category> PyQt5 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> PyQt5 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【PyQt5】—— 代码封装成类</title>
      <link href="/posts/20f3793/"/>
      <url>/posts/20f3793/</url>
      
        <content type="html"><![CDATA[<h2 id="代码封装"><a href="#代码封装" class="headerlink" title="代码封装"></a>代码封装</h2><p>考虑到代码的扩展性和可维护性，我们需要封装一下代码：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token triple-quoted-string string">"""Created on Fri May  8 22:30:19 2020@author: Giyn"""</span><span class="token keyword">import</span> sys<span class="token keyword">from</span> PyQt5<span class="token punctuation">.</span>QtWidgets <span class="token keyword">import</span> QApplication<span class="token punctuation">,</span> QWidget<span class="token punctuation">,</span> QLabel<span class="token punctuation">,</span> QPushButton<span class="token keyword">class</span> <span class="token class-name">Simple_Window</span><span class="token punctuation">(</span>QWidget<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token builtin">super</span><span class="token punctuation">(</span>Simple_Window<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 使用super函数可以实现子类使用父类的方法</span>        self<span class="token punctuation">.</span>label <span class="token operator">=</span> QLabel<span class="token punctuation">(</span><span class="token string">"This is a Label"</span><span class="token punctuation">,</span> self<span class="token punctuation">)</span>  <span class="token comment"># self是指定的父类Simple_Window，表示QLabel属于Simple_Window窗口</span>                <span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>    app <span class="token operator">=</span> QApplication<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span>    window <span class="token operator">=</span> Simple_Window<span class="token punctuation">(</span><span class="token punctuation">)</span>    window<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>    sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token keyword">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><h3 id="Output："><a href="#Output：" class="headerlink" title="Output："></a>Output：</h3><p><img src="https://img-blog.csdnimg.cn/20200508222428863.png" alt="在这里插入图片描述" loading="lazy"></p>]]></content>
      
      
      <categories>
          
          <category> PyQt5 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> PyQt5 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Python 中 re 库的 match 对象和最小匹配操作符</title>
      <link href="/posts/3d3451e4/"/>
      <url>/posts/3d3451e4/</url>
      
        <content type="html"><![CDATA[<h5 id="Match-对象的属性："><a href="#Match-对象的属性：" class="headerlink" title="Match 对象的属性："></a>Match 对象的属性：</h5><table><thead><tr><th>属性</th><th>说明</th></tr></thead><tbody><tr><td>.string</td><td>待匹配的文本</td></tr><tr><td>.re</td><td>匹配时使用的 pattern 对象（正则表达式）</td></tr><tr><td>.pos</td><td>正则表达式搜索文本的开始位置</td></tr><tr><td>.endpos</td><td>正则表达式搜索文本的结束位置</td></tr></tbody></table><h5 id="Match-对象的方法："><a href="#Match-对象的方法：" class="headerlink" title="Match 对象的方法："></a>Match 对象的方法：</h5><table><thead><tr><th>方法</th><th>说明</th></tr></thead><tbody><tr><td>.group(0)</td><td>获得匹配后的字符串</td></tr><tr><td>.start()</td><td>匹配字符串在原始字符串的开始位置</td></tr><tr><td>.end()</td><td>匹配字符串在原始字符串的结束位置</td></tr><tr><td>.span()</td><td>返回 (.start(), .end())</td></tr></tbody></table><blockquote><p>group 和 groups 是两个不同的函数。</p></blockquote><blockquote><p>一般，m.group(N) 返回第 N 组括号匹配的字符。<br>而 m.group() == m.group(0) == 所有匹配的字符，与括号无关，这个是 API 规定的。</p></blockquote><blockquote><p>m.groups() 以 tuple 格式返回所有括号匹配的字符。</p></blockquote><p>在程序内部认为，只有经过 compile 之后的正则表达式才是一个正则表达式，没有经过 compile 的正则表达式仅仅只是正则表达式的一种表示。</p><p>Match 对象只包含一次匹配的结果，事实上它可能存在两次匹配，Match 对象返回的是第一次匹配的结果，如果希望得到每一次返回的 Match 对象，要用 finditer 函数实现。</p><hr><h5 id="最小匹配操作符："><a href="#最小匹配操作符：" class="headerlink" title="最小匹配操作符："></a>最小匹配操作符：</h5><table><thead><tr><th>操作符</th><th>说明</th></tr></thead><tbody><tr><td>*?</td><td>前一个字符 0 次或无限次扩展，最小匹配</td></tr><tr><td>+?</td><td>前一个字符 1 次或无限次扩展，最小匹配</td></tr><tr><td>??</td><td>前一个字符 0 次或 1 次扩展，最小匹配</td></tr><tr><td>{m, n}?</td><td>扩展前一个字符 m 至 n 次（含 n），最小匹配</td></tr></tbody></table><blockquote><p>Re 库默认采用贪婪匹配，即输出匹配最长的字符串。</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> regex </category>
          
      </categories>
      
      
        <tags>
            
            <tag> regex </tag>
            
            <tag> Python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MongoDB 数据库的使用</title>
      <link href="/posts/aa2f4391/"/>
      <url>/posts/aa2f4391/</url>
      
        <content type="html"><![CDATA[<h3 id="MongoDB-数据库介绍"><a href="#MongoDB-数据库介绍" class="headerlink" title="MongoDB 数据库介绍"></a>MongoDB 数据库介绍</h3><p>MongoDB 是由 C++ 编写的非关系型数据库，是一个基于分布式文件存储的开源数据库系统，其内容存储形式类似 JSON 对象，它的字段值可以包含其他文档、数组及文档数组，非常灵活。</p><hr><h3 id="连接-MongoDB"><a href="#连接-MongoDB" class="headerlink" title="连接 MongoDB"></a>连接 MongoDB</h3><blockquote><p>PyMongo 库安装：在命令提示符中输入 <code>pip install pymongo</code></p></blockquote><p>连接 MongoDB 时，可以使用 PyMongo 库里面的 MongoClient。一般来说，我们只需要向其传入 MongoDB 的 IP 及端口即可，其中第一个参数为地址 host，第二个参数为端口 port（默认 27017）：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> pymongoclient <span class="token operator">=</span> pymongo<span class="token punctuation">.</span>MongoClient<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'localhost'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">27017</span><span class="token punctuation">)</span></code></pre><p>这样就创建了 MongoDB 的连接对象。</p><p>另外，MongoClient 的第一个参数 host 还可以直接传入 MongoDB 的连接字符串：</p><pre class="language-python" data-language="python"><code class="language-python">client <span class="token operator">=</span> pymongo<span class="token punctuation">.</span>MongoClient<span class="token punctuation">(</span><span class="token string">'mongodb://localhost:27017/'</span><span class="token punctuation">)</span></code></pre><p>这可以达到同样的连接效果。</p><hr><h3 id="指定数据库"><a href="#指定数据库" class="headerlink" title="指定数据库"></a>指定数据库</h3><p>MongoDB 中可以建立多个数据库，下面指定操作其中一个数据库。这里以 test 数据库为例：</p><pre class="language-python" data-language="python"><code class="language-python">db <span class="token operator">=</span> client<span class="token punctuation">.</span>test</code></pre><p>这里调用 client 的 test 属性即可返回 test 数据库。当然，我们也可以这样指定：</p><pre class="language-python" data-language="python"><code class="language-python">db <span class="token operator">=</span> client<span class="token punctuation">[</span><span class="token string">'test'</span><span class="token punctuation">]</span></code></pre><p>这两种方式是等价的。</p><hr><h3 id="指定集合"><a href="#指定集合" class="headerlink" title="指定集合"></a>指定集合</h3><blockquote><p>MongoDB 的每个数据库又包含许多集合（collection），它们类似于关系型数据库中的表。</p></blockquote><p>指定待操作的集合 students。与指定数据库类似，指定集合也有两种方式：</p><pre class="language-python" data-language="python"><code class="language-python">collection <span class="token operator">=</span> db<span class="token punctuation">.</span>students</code></pre><p>或是</p><pre class="language-python" data-language="python"><code class="language-python">collection <span class="token operator">=</span> db<span class="token punctuation">[</span><span class="token string">'students'</span><span class="token punctuation">]</span></code></pre><p>这样便声明了一个 Collection 对象。</p><hr><h3 id="插入数据"><a href="#插入数据" class="headerlink" title="插入数据"></a>插入数据</h3><blockquote><p>在 MongoDB 中，每条数据都有一个 _id 属性来唯一标识。</p></blockquote><p><strong>下面使用 insert_one 方法来插入单条记录：</strong></p><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># 此处对 students 集合新建一条数据，该数据以字典形式表示。</span>student <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token string">'id'</span><span class="token punctuation">:</span> <span class="token string">'20170101'</span><span class="token punctuation">,</span>    <span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token string">'Jordan'</span><span class="token punctuation">,</span>    <span class="token string">'age'</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span>    <span class="token string">'gender'</span><span class="token punctuation">:</span> <span class="token string">'male'</span><span class="token punctuation">&#125;</span>result <span class="token operator">=</span> collection<span class="token punctuation">.</span>insert_one<span class="token punctuation">(</span>student<span class="token punctuation">)</span> <span class="token comment"># insert_one 方法返回 InsertOneResult 对象</span><span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>inserted_id<span class="token punctuation">)</span> <span class="token comment"># 调用 inserted_id 属性获取_id</span></code></pre><p>运行结果如下：</p><pre class="language-none"><code class="language-none">&lt;pymongo.results.InsertOneResult object at 0x10d68b558&gt;5932ab0f15c2606f0c1cf6c5</code></pre><img src="https://img-blog.csdnimg.cn/20200607103956957.png" width="50%" loading="lazy"><p><strong>下面使用 insert_many 方法来插入多条记录，此处可以将数据以列表形式传递：</strong></p><pre class="language-python" data-language="python"><code class="language-python">student1 <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token string">'id'</span><span class="token punctuation">:</span> <span class="token string">'20170101'</span><span class="token punctuation">,</span>    <span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token string">'Jordan'</span><span class="token punctuation">,</span>    <span class="token string">'age'</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span>    <span class="token string">'gender'</span><span class="token punctuation">:</span> <span class="token string">'male'</span><span class="token punctuation">&#125;</span>student2 <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token string">'id'</span><span class="token punctuation">:</span> <span class="token string">'20170202'</span><span class="token punctuation">,</span>    <span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token string">'Mike'</span><span class="token punctuation">,</span>    <span class="token string">'age'</span><span class="token punctuation">:</span> <span class="token number">21</span><span class="token punctuation">,</span>    <span class="token string">'gender'</span><span class="token punctuation">:</span> <span class="token string">'male'</span><span class="token punctuation">&#125;</span>result <span class="token operator">=</span> collection<span class="token punctuation">.</span>insert_many<span class="token punctuation">(</span><span class="token punctuation">[</span>student1<span class="token punctuation">,</span> student2<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># insert_many 方法返回的类型是 InsertManyResult</span><span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>inserted_ids<span class="token punctuation">)</span> <span class="token comment"># 调用 inserted_ids 属性获取插入数据的 _id 列表</span></code></pre><p>运行结果如下：</p><pre class="language-none"><code class="language-none">&lt;pymongo.results.InsertManyResult object at 0x101dea558&gt;[ObjectId(&#39;5932abf415c2607083d3b2ac&#39;), ObjectId(&#39;5932abf415c2607083d3b2ad&#39;)]</code></pre><img src="https://img-blog.csdnimg.cn/20200607104258154.png" width="50%" loading="lazy"><hr><h3 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h3><p>插入数据后，可以利用 find_one 或 find 方法进行查询，其中 find_one 查询得到的是单个结果，find 则返回一个生成器对象。</p><p><strong>使用 find_one 方法查询：</strong></p><pre class="language-python" data-language="python"><code class="language-python">result <span class="token operator">=</span> collection<span class="token punctuation">.</span>find_one<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token string">'Mike'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span></code></pre><p>此处查询 name 为 Mike 的数据，它的返回结果是字典类型，运行结果如下：</p><pre class="language-none"><code class="language-none">&lt;class &#39;dict&#39;&gt;&#123;&#39;_id&#39;: ObjectId(&#39;5932a80115c2606a59e8a049&#39;), &#39;id&#39;: &#39;20170202&#39;, &#39;name&#39;: &#39;Mike&#39;, &#39;age&#39;: 21, &#39;gender&#39;: &#39;male&#39;&#125;</code></pre><p>可以发现，它多了 _id 属性，这是 MongoDB 在插入过程中自动添加的。</p><p><strong>此外，我们也可以根据 ObjectId 来查询，此时需要调用 bson 库里面的 objectid：</strong></p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> bson<span class="token punctuation">.</span>objectid <span class="token keyword">import</span> ObjectIdresult <span class="token operator">=</span> collection<span class="token punctuation">.</span>find_one<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">'_id'</span><span class="token punctuation">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">'593278c115c2602667ec6bae'</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span></code></pre><p>其查询结果依然是字典类型，具体如下：</p><pre class="language-none"><code class="language-none">&#123;&#39;_id&#39;: ObjectId(&#39;593278c115c2602667ec6bae&#39;), &#39;id&#39;: &#39;20170101&#39;, &#39;name&#39;: &#39;Jordan&#39;, &#39;age&#39;: 20, &#39;gender&#39;: &#39;male&#39;&#125;</code></pre><p>如果查询结果不存在，则会返回 None。</p><p><strong>对于多条数据的查询，我们可以使用 find 方法：</strong></p><pre class="language-python" data-language="python"><code class="language-python">results <span class="token operator">=</span> collection<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">'age'</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token keyword">for</span> result <span class="token keyword">in</span> results<span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span></code></pre><p>运行结果如下：</p><pre class="language-none"><code class="language-none">&lt;pymongo.cursor.Cursor object at 0x1032d5128&gt;&#123;&#39;_id&#39;: ObjectId(&#39;593278c115c2602667ec6bae&#39;), &#39;id&#39;: &#39;20170101&#39;, &#39;name&#39;: &#39;Jordan&#39;, &#39;age&#39;: 20, &#39;gender&#39;: &#39;male&#39;&#125;&#123;&#39;_id&#39;: ObjectId(&#39;593278c815c2602678bb2b8d&#39;), &#39;id&#39;: &#39;20170102&#39;, &#39;name&#39;: &#39;Kevin&#39;, &#39;age&#39;: 20, &#39;gender&#39;: &#39;male&#39;&#125;&#123;&#39;_id&#39;: ObjectId(&#39;593278d815c260269d7645a8&#39;), &#39;id&#39;: &#39;20170103&#39;, &#39;name&#39;: &#39;Harden&#39;, &#39;age&#39;: 20, &#39;gender&#39;: &#39;male&#39;&#125;</code></pre><p>返回结果是 Cursor 类型，它相当于一个<strong>生成器</strong>，遍历获取的所有结果，其中每个结果都是字典类型。</p><p><strong>如果要查询年龄大于 20 的数据，则写法如下：</strong></p><pre class="language-python" data-language="python"><code class="language-python">results <span class="token operator">=</span> collection<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">'age'</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token string">'$gt'</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></code></pre><p>此处查询的条件键值不是单纯的数字，而是一个字典，其键名为比较符号 $gt，意思是大于，键值为 20。</p><p><strong>比较符号：</strong></p><table><thead><tr><th>符号</th><th>含义</th><th>示例</th></tr></thead><tbody><tr><td>$lt</td><td>小于</td><td>{‘age’: {‘$lt’: 20}}</td></tr><tr><td>$gt</td><td>大于</td><td>{‘age’: {‘$gt’: 20}}</td></tr><tr><td>$lte</td><td>小于或等于</td><td>{‘age’: {‘$lte’: 20}}</td></tr><tr><td>$gte</td><td>大于或等于</td><td>{‘age’: {‘$gte’: 20}}</td></tr><tr><td>$ne</td><td>不等于</td><td>{‘age’: {‘$ne’: 20}}</td></tr><tr><td>$in</td><td>在范围内</td><td>{‘age’: {‘$in’: [20, 23]}}</td></tr><tr><td>$nin</td><td>不在范围内</td><td>{‘age’: {‘$nin’: [20, 23]}}</td></tr></tbody></table><p><strong>另外，还可以进行正则匹配查询：</strong></p><p>此处查询名字以 M 开头的学生数据。</p><pre class="language-python" data-language="python"><code class="language-python">results <span class="token operator">=</span> collection<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token string">'$regex'</span><span class="token punctuation">:</span> <span class="token string">'^M.*'</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></code></pre><p>此处使用 $regex 来指定正则匹配，^M.* 代表以 M 开头的正则表达式。</p><p><strong>功能符号：</strong><br>| 符号    | 含义           | 示例                                               | 示例含义                          |<br>| ——- | ————– | ————————————————– | ——————————— |<br>| $regex  | 匹配正则表达式 | {‘name’: {‘$regex’: ‘^M.*}}                        | name 以 M 开头                    |<br>| $exists | 属性是否存在   | {‘name’: {‘$exists’: True}}                        | name 属性存在                     |<br>| $type   | 类型判断       | {‘age’: {‘$type’: ‘int’}                           | age 的类型为 int                  |<br>| $mod    | 数字模操作     | {‘age’: {‘$mod’: [5, 0]}}                          | 年龄模 5 余 0                     |<br>| $text   | 文本查询       | {‘$text’: {‘search’: ‘Mike’}}                      | text 类型的属性中包含 Mike 字符串 |<br>| $where  | 高级条件查询   | {‘$where’: ‘obj.fans_ count== obj.follows_ count’} | 自身粉丝数等于关注数              |</p><hr><h3 id="计数"><a href="#计数" class="headerlink" title="计数"></a>计数</h3><p>要统计查询结果有多少条数据，可以调用 count 方法。</p><p><strong>此处统计所有数据条数：</strong></p><pre class="language-python" data-language="python"><code class="language-python">count <span class="token operator">=</span> collection<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span></code></pre><p><strong>此外还可以统计符合某个条件的数据：</strong></p><pre class="language-python" data-language="python"><code class="language-python">count <span class="token operator">=</span> collection<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">'age'</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span></code></pre><p>运行结果是一个数值，即符合条件的数据条数。</p><hr><h3 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h3><p>排序时可以直接调用 sort 方法，并在其中传入排序的字段及升降序标志。</p><p><strong>示例：</strong></p><pre class="language-python" data-language="python"><code class="language-python">results <span class="token operator">=</span> collection<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>sort<span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">,</span> pymongo<span class="token punctuation">.</span>ASCENDING<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">[</span>result<span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span> <span class="token keyword">for</span> result <span class="token keyword">in</span> results<span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre><p>运行结果如下：</p><pre class="language-none"><code class="language-none">[&#39;Harden&#39;, &#39;Jordan&#39;, &#39;Kevin&#39;, &#39;Mark&#39;, &#39;Mike&#39;]</code></pre><p>此处调用 pymongo.ASCENDING 指定升序。</p><blockquote><p>如果要降序排列，可以传入 pymongo.DESCENDING。</p></blockquote><hr><h3 id="偏移"><a href="#偏移" class="headerlink" title="偏移"></a>偏移</h3><p>在某些情况下，可能只需要取某几个元素，这时可以利用 skip 方法偏移几个位置，比如偏移 2，就代表忽略前两个元素，得到第 3 个及以后的元素：</p><pre class="language-python" data-language="python"><code class="language-python">results <span class="token operator">=</span> collection<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>sort<span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">,</span> pymongo<span class="token punctuation">.</span>ASCENDING<span class="token punctuation">)</span><span class="token punctuation">.</span>skip<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">[</span>result<span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span> <span class="token keyword">for</span> result <span class="token keyword">in</span> results<span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre><p>运行结果如下：</p><pre class="language-none"><code class="language-none">[&#39;Kevin&#39;, &#39;Mark&#39;, &#39;Mike&#39;]</code></pre><p><strong>另外还可以用 limit 方法指定要取的结果个数：</strong></p><pre class="language-python" data-language="python"><code class="language-python">results <span class="token operator">=</span> collection<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>sort<span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">,</span> pymongo<span class="token punctuation">.</span>ASCENDING<span class="token punctuation">)</span><span class="token punctuation">.</span>skip<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>limit<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">[</span>result<span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span> <span class="token keyword">for</span> result <span class="token keyword">in</span> results<span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre><p>运行结果如下：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token punctuation">[</span><span class="token string">'Kevin'</span><span class="token punctuation">,</span> <span class="token string">'Mark'</span><span class="token punctuation">]</span></code></pre><blockquote><p>如果不使用 limit 方法，原本会返回 3 个结果，加了限制后，就会截取两个结果返回。</p></blockquote><p>值得注意的是，在数据量非常庞大的时候，比如在查询千万、亿级别的数据库时，最好不要使用大的偏移量，因为这样很可能导致内存溢出。此时可以使用类似如下操作来查询：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> bson<span class="token punctuation">.</span>objectid <span class="token keyword">import</span> ObjectIdcollection<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">'_id'</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token string">'$gt'</span><span class="token punctuation">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">'593278c815c2602678bb2b8d'</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></code></pre><p>这就需要记录好上次查询的 _id。</p><hr><h3 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h3><p>对于数据更新，可以使用 update_one 方法和 update_many 方法，它们的第 2 个参数需要使用 $ 类型操作符作为字典的键名。</p><p><strong>首先指定查询条件，然后将数据查询出来，修改对应数据后调用 update 方法将原条件和修改后的数据传入：</strong></p><pre class="language-python" data-language="python"><code class="language-python">condition <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token string">'Kevin'</span><span class="token punctuation">&#125;</span>student <span class="token operator">=</span> collection<span class="token punctuation">.</span>find_one<span class="token punctuation">(</span>condition<span class="token punctuation">)</span>student<span class="token punctuation">[</span><span class="token string">'age'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">26</span>result <span class="token operator">=</span> collection<span class="token punctuation">.</span>update_one<span class="token punctuation">(</span>condition<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token string">'$set'</span><span class="token punctuation">:</span> student<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>matched_count<span class="token punctuation">,</span> result<span class="token punctuation">.</span>modified_count<span class="token punctuation">)</span></code></pre><p>上面调用了 update_one 方法，第 2 个参数不能直接传入修改后的字典，而是需要使用 {‘$set’: student} 这样的形式，其返回结果是 UpdateResult 类型。然后分别调用 matched_count 和 modified_count 属性，可以获得匹配的数据条数和影响的数据条数。</p><blockquote><p>使用 $set 操作符对数据进行更新可以只更新 student 字典内存在的字段。如果原先还有其他字段，则不会更新，也不会删除。</p></blockquote><p>运行结果如下：</p><pre class="language-none"><code class="language-none">&lt;pymongo.results.UpdateResult object at 0x10d17b678&gt;1 0</code></pre><p><strong>再看一个例子：</strong></p><pre class="language-python" data-language="python"><code class="language-python">condition <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">'age'</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token string">'$gt'</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>result <span class="token operator">=</span> collection<span class="token punctuation">.</span>update_one<span class="token punctuation">(</span>condition<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token string">'$inc'</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token string">'age'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>matched_count<span class="token punctuation">,</span> result<span class="token punctuation">.</span>modified_count<span class="token punctuation">)</span></code></pre><p>这里指定查询条件为年龄大于 20，然后更新条件为 {‘$inc’: {‘age’: 1}}，表示年龄加 1，执行之后会将第一条符合条件的数据年龄加 1。</p><p>运行结果如下：</p><pre class="language-none"><code class="language-none">&lt;pymongo.results.UpdateResult object at 0x10b8874c8&gt;1 1</code></pre><p>可以看到匹配条数为 1 条，影响条数也为 1 条。</p><p><strong>如果调用 update_many 方法，则会将所有符合条件的数据都更新：</strong></p><pre class="language-python" data-language="python"><code class="language-python">condition <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">'age'</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token string">'$gt'</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>result <span class="token operator">=</span> collection<span class="token punctuation">.</span>update_many<span class="token punctuation">(</span>condition<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token string">'$inc'</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token string">'age'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>matched_count<span class="token punctuation">,</span> result<span class="token punctuation">.</span>modified_count<span class="token punctuation">)</span></code></pre><p>这时匹配条数就不再为 1 条了，运行结果如下：</p><pre class="language-none"><code class="language-none">&lt;pymongo.results.UpdateResult object at 0x10c6384c8&gt;3 3</code></pre><p>此时所有匹配到的数据都会被更新。</p><hr><h3 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h3><p>删除操作可以调用  delete_one 和 delete_many 方法，并指定删除的条件，符合条件的所有数据均会被删除。</p><p><strong>示例：</strong></p><pre class="language-python" data-language="python"><code class="language-python">result <span class="token operator">=</span> collection<span class="token punctuation">.</span>delete_one<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token string">'Kevin'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>deleted_count<span class="token punctuation">)</span>result <span class="token operator">=</span> collection<span class="token punctuation">.</span>delete_many<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">'age'</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token string">'$lt'</span><span class="token punctuation">:</span> <span class="token number">25</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>deleted_count<span class="token punctuation">)</span></code></pre><p>运行结果如下：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">&lt;</span>pymongo<span class="token punctuation">.</span>results<span class="token punctuation">.</span>DeleteResult <span class="token builtin">object</span> at <span class="token number">0x10e6ba4c8</span><span class="token operator">></span><span class="token number">1</span><span class="token number">4</span></code></pre><p>delete_one 即删除第一条符合条件的数据，delete_many 即删除所有符合条件的数据。它们的返回结果都是 DeleteResult 类型，可以调用 deleted_count 属性获取删除的数据条数。</p><hr><h3 id="其他操作"><a href="#其他操作" class="headerlink" title="其他操作"></a>其他操作</h3><p>PyMongo 还提供了一些组合方法，如 find_one_and_delete、find_one_and_replace 和 find_one_and_update，它们分别用于查找后删除、替换和更新操作，其使用方法与上述方法基本一致。</p><p>另外还可以对索引进行操作，相关方法有 create_index、create_indexes 和 drop_index 等。</p><p><a href="https://api.mongodb.com/python/current/api/pymongo/">PyMongo 官方文档</a></p><hr><p>Reference：<a href="https://kaiwu.lagou.com/course/courseInfo.htm?courseId=46#/detail/pc?id=1671">https://kaiwu.lagou.com/course/courseInfo.htm?courseId=46#/detail/pc?id=1671</a></p>]]></content>
      
      
      <categories>
          
          <category> MongoDB </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MongoDB </tag>
            
            <tag> Database </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【Probability Theory】—— 熵、条件熵、信息增益</title>
      <link href="/posts/c1af7711/"/>
      <url>/posts/c1af7711/</url>
      
        <content type="html"><![CDATA[<h4 id="熵的含义："><a href="#熵的含义：" class="headerlink" title="熵的含义："></a>熵的含义：</h4><p>在信息论中，熵（英语：entropy）是接收的每条消息中包含的信息的平均量，又被称为信息熵、信源熵、平均自信息量。这里，“消息”代表来自分布或数据流中的事件、样本或特征。（熵最好理解为不确定性的量度而不是确定性的量度，因为越随机的信源的熵越大。）——维基百科。</p><p><code>我们可以直观地把熵理解为一个事件的结果的不确定性，或者信息量，其单位为 bit。</code></p><h4 id="熵的计算："><a href="#熵的计算：" class="headerlink" title="熵的计算："></a>熵的计算：</h4><p>熵描述的是个事件的不确定性，如果某个事件有 $n$ 个结果，每个结果的概率为 $p_n$。那么这个事件的熵 $H(p)$ 的定义式为</p><div>    $$ H(p)=-\sum_{i=1}^{n} p_{i} \log _{2} p_{i} $$</div><p>例子：</p><p>假设有一场足球赛，巴西队对战中国队。假设巴西队获胜的概率为 $0.9$，不胜的概率为 $0.1$。那么这场比赛结果的熵就是：</p><div>    $$ H(p)=-\sum_{i=1}^{n} p_{i} \log _{2} p_{i}=-0.9 * \log _{2} 0.9-0.1 * \log _{2} 0.1=0.4690 $$</div><p>假设有另一场足球赛，英国队对战法国队。假设英国队获胜或不胜的概率都是 $0.5$。那么这场比赛结果的熵就是：</p><div>    $$ H(p)=-\sum_{i=1}^{n} p_{i} \log _{2} p_{i}=-0.5 * \log _{2} 0.5-0.5 * \log _{2} 0.5=1 $$</div><pre><code>后者的熵比前者大，可见结果的不确定更大，比赛结果的信息量就更大。</code></pre><h4 id="条件熵："><a href="#条件熵：" class="headerlink" title="条件熵："></a>条件熵：</h4><p>熵是对事件结果不确定性的度量，但在某些条件下，这个不确定性会变小。</p><p>条件熵衡量的就是在某个条件 $X$ 下，事件 $Y$ 的不确定性，记作 $H(Y|X)$ 。其定义式为：</p><div>    $$ H(Y \mid X)=\sum_{i=1}^{n} p_{i} H\left(Y \mid X=x_{i}\right) $$</div><p><code>条件熵可以理解为，$X$ 事件每个可能性的结果的熵乘以发生概率的求和。</code></p><h4 id="信息增益："><a href="#信息增益：" class="headerlink" title="信息增益："></a>信息增益：</h4><img src="https://img-blog.csdnimg.cn/20200424124040426.png" width="30%" loading="lazy"><p>熵衡量的是事件的不确定性；条件熵衡量的是知道了某个条件后，事件的不确定性。</p><p>对于同一个事件，熵的值肯定是大于或等于条件熵的。</p><p>因此引入信息增益的概念，写作 $g(X,Y)$。它的计算方式为熵减去条件熵：</p><div>    $$ g(X, Y)=H(Y)-H(Y \mid X) $$</div><p><code>信息增益表示的是，知道了某个条件后，原来事件不确定性降低的幅度。</code></p><p>Reference：<a href="https://kaiwu.lagou.com/course/courseInfo.htm?courseId=15#/detail/pc?id=219">https://kaiwu.lagou.com/course/courseInfo.htm?courseId=15#/detail/pc?id=219</a></p>]]></content>
      
      
      <categories>
          
          <category> Probability Theory </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Probability Theory </tag>
            
            <tag> entropy </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【Calculus】—— chang the order of integration in double integrals</title>
      <link href="/posts/da903b34/"/>
      <url>/posts/da903b34/</url>
      
        <content type="html"><![CDATA[<h3 id="An-intuitive-example："><a href="#An-intuitive-example：" class="headerlink" title="An intuitive example："></a>An intuitive example：</h3><h4 id="To-be-integrated："><a href="#To-be-integrated：" class="headerlink" title="To be integrated："></a>To be integrated：</h4><div>    $$ \int_{0}^{1} \int_{1}^{e^{y}} f(x, y) dxdy $$</div><h4 id="Draw-figure："><a href="#Draw-figure：" class="headerlink" title="Draw figure："></a>Draw figure：</h4><img src="https://img-blog.csdnimg.cn/20200420092507484.png" width="30%" loading="lazy"><p>At this step, you need to use your spatial thinking in order to better understand.</p><h4 id="Result："><a href="#Result：" class="headerlink" title="Result："></a>Result：</h4><div>    $$ \int_{1}^{e}\left\{\int_{\ln x}^{1} f(x, y)dy \right\}dx $$</div><p>References：<a href="https://mathinsight.org/double_integral_change_order_integration_examples">https://mathinsight.org/double_integral_change_order_integration_examples</a></p>]]></content>
      
      
      <categories>
          
          <category> Math </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Math </tag>
            
            <tag> Calculus </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Python 连接 MySQL 并将 csv 文件存入数据库</title>
      <link href="/posts/1312e100/"/>
      <url>/posts/1312e100/</url>
      
        <content type="html"><![CDATA[<p>此处使用 Python3 和 MySQL 数据库连接，并读取 csv 文件，写入数据库。</p><p>这里我们将使用 PyMySQL 库实现 Python 和 MySQL 数据库交互。</p><p>PyMySQL 库安装方法：在命令提示符中输入 <code>pip3 install PyMySQL</code>。</p><hr><p>此处我准备将之前爬取的 <code>豆瓣电影Top100.csv</code> 文件存入数据库，打开文件预览：</p><img src="https://img-blog.csdnimg.cn/20200325172736587.png" width="40%" loading="lazy"><pre><code>第一列是自动生成的序号，不需要将它入库；第一行我们可以使用 SQLyog 设置，因此也不需要入库。</code></pre><hr><p>这里我们事先使用 MySQL 可视化工具 SQLyog 创建 DataBase：dbmovie_top100 和 Table：db_top100：</p><p><img src="https://img-blog.csdnimg.cn/20200325173819131.png" alt="在这里插入图片描述" loading="lazy"><br>并把 Table 各列的参数配置好。（例如说我们需要的第一列是排名，设置数据类型为int）</p><hr><p>接下来使用代码实现入库：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> csv<span class="token keyword">import</span> pymysql<span class="token comment"># 连接MySQL数据库（注意：charset参数是utf8而不是utf-8）</span>conn <span class="token operator">=</span> pymysql<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'localhost'</span><span class="token punctuation">,</span> user<span class="token operator">=</span><span class="token string">'root'</span><span class="token punctuation">,</span> password<span class="token operator">=</span><span class="token string">'MySQL密码'</span><span class="token punctuation">,</span> db<span class="token operator">=</span><span class="token string">'dbmovie_top100'</span><span class="token punctuation">,</span> charset<span class="token operator">=</span><span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token comment"># 创建游标对象</span>cursor <span class="token operator">=</span> conn<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># 读取csv文件</span><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'豆瓣电影Top100.csv'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>    read <span class="token operator">=</span> csv<span class="token punctuation">.</span>reader<span class="token punctuation">(</span>f<span class="token punctuation">)</span>        <span class="token comment"># 一行一行地存，除去第一行和第一列</span>    <span class="token keyword">for</span> each <span class="token keyword">in</span> <span class="token builtin">list</span><span class="token punctuation">(</span>read<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">:</span>        i <span class="token operator">=</span> <span class="token builtin">tuple</span><span class="token punctuation">(</span>each<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>                <span class="token comment"># 使用SQL语句添加数据</span>        sql <span class="token operator">=</span> <span class="token string">"INSERT INTO db_top100 VALUES"</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>  <span class="token comment"># db_top100是表的名称</span>        cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>sql<span class="token punctuation">)</span>  <span class="token comment">#执行SQL语句</span>        conn<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 提交数据</span>    cursor<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 关闭游标</span>    conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 关闭数据库</span></code></pre><p>运行程序：</p><img src="https://img-blog.csdnimg.cn/20200325174642807.png" width="40%" loading="lazy"><p>即成功将 csv 文件存入 MySQL 数据库。</p>]]></content>
      
      
      <categories>
          
          <category> MySQL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Database </tag>
            
            <tag> Python </tag>
            
            <tag> MySQL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用梯度下降算法解决一元和多元数学最值问题</title>
      <link href="/posts/d2bca9b2/"/>
      <url>/posts/d2bca9b2/</url>
      
        <content type="html"><![CDATA[<h3 id="一元最值问题"><a href="#一元最值问题" class="headerlink" title="一元最值问题"></a>一元最值问题</h3><p><strong>[例]</strong> 求解 x 为多少时，目标函数 <code>y = sinx + 5x² + 2</code> 可取得最小值？</p><p>接下来分析一下这道题，它是求最值问题，我们按照高中的思路，容易想到求导，然后让导数值为 0，求得的 x 即为极值点，接着通过相关计算求出答案。</p><p>那我们就来试试看，首先求导得<code>y&#39; = cosx +10x</code>，然而我们不知道如何求得 x 使得导数值为 0……</p><p>这时我们就需要使用到梯度下降算法，因为我们求的是最小值，所以设置学习率为 -0.1。</p><p><strong>[解]</strong> 首先随机初始化 x，假设 x = 0。梯度为 <code>▽y= cosx + 10x</code></p><table><thead><tr><th>循环</th><th>x</th><th>梯度</th><th>更新x</th></tr></thead><tbody><tr><td>1</td><td>0</td><td>cos0 + 10 * 0 = 1</td><td>0 - 0.1 * 1 = -0.1</td></tr><tr><td>2</td><td>-0.1</td><td>cos0.1 + 10 * 0.1 = -0.0050</td><td>-0.1 + 0.1 * 0.0050 = -0.0995</td></tr><tr><td>3</td><td>-0.0995</td><td>cos(-0.0995) - 10 * 0.0995 = -0.00005 ≈ 0</td><td>无更新</td></tr></tbody></table><p>梯度为 -0.00005 时，已经接近为 0 了，也就意味着偏导数为 0，意味着此时已经到达极小值了。</p><pre><code>当 x = -0.0995 时，ymin = 1.95，问题得解！</code></pre><hr><h3 id="多元最值问题"><a href="#多元最值问题" class="headerlink" title="多元最值问题"></a>多元最值问题</h3><p><strong>[例]</strong> 利用梯度下降法，计算<code>y = (x1 - 1)² + (x2 - 3)²</code>的极小值</p><p><strong>[解]</strong> 先计算梯度</p><div>    \nabla y=\left[\frac{\partial y}{\partial x_{1}} \frac{\partial y}{\partial x_{2}}\right]=\left[2 x_{1}-2 \quad 2 x_{2}-6\right]</div><p>因为求解最小值，所以设置学习率为 -0.4。</p><table><thead><tr><th>循环</th><th>[x1 x2]</th><th>梯度</th><th>更新 [x1 x2]</th></tr></thead><tbody><tr><td>1</td><td>[0 0]</td><td>[2 * 0 - 2  2 * 0 - 6] = [-2 -6]</td><td>[0 0] - 0.4 * [-2 -6] = [0.8 2.4]</td></tr><tr><td>2</td><td>[0.8 2.4]</td><td>[-0.4 -1.2]</td><td>[0.96 2.88]</td></tr><tr><td>3</td><td>[0.96 2.88]</td><td>[-0.08 -0.24]</td><td>[0.99 2.98]</td></tr><tr><td>4</td><td>[0.99 2.98]</td><td>[-0.02 -0.05]</td><td>≈ [1.00 3.00]，不再更新</td></tr></tbody></table><pre><code>当 [x1 x2] = [1.00 3.00] 时，ymin = 0，问题得解！</code></pre>]]></content>
      
      
      <categories>
          
          <category> Math </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Math </tag>
            
            <tag> Gradient Descent </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>如何获取 QQ 邮箱授权码?</title>
      <link href="/posts/3278ba5d/"/>
      <url>/posts/3278ba5d/</url>
      
        <content type="html"><![CDATA[<h4 id="什么是-QQ-邮箱授权码？"><a href="#什么是-QQ-邮箱授权码？" class="headerlink" title="什么是 QQ 邮箱授权码？"></a>什么是 QQ 邮箱授权码？</h4><p>授权码是 QQ 邮箱推出的，用于登录第三方客户端的专用密码</p><p>如果你想用 Python 发送 QQ 邮箱，你就需要用到 QQ 邮箱授权码！</p><p>它适用于登录以下服务：POP3/IMAP/SMTP/Exchange/CardDAV/CalDAV服务</p><blockquote><p>温馨提醒：为了您的帐户安全，更改QQ密码以及独立密码会触发授权码过期，需要重新获取新的授权码登录。</p></blockquote><hr><h4 id="如何获取-QQ-邮箱授权码？"><a href="#如何获取-QQ-邮箱授权码？" class="headerlink" title="如何获取 QQ 邮箱授权码？"></a>如何获取 QQ 邮箱授权码？</h4><p>首先，打开 QQ 邮箱，点击 <code>设置</code>：</p><img src="https://img-blog.csdnimg.cn/20200323075832233.png" width="30%" loading="lazy"><p>然后点击 <code>账户</code>：</p><img src="https://img-blog.csdnimg.cn/20200323080008340.png" width="30%" loading="lazy"><p>下拉到这里，并点击 <code>开启</code>：</p><img src="https://img-blog.csdnimg.cn/20200323080250335.png" width="60%" loading="lazy"><blockquote><p>因为我已经开启了，所以显示的是关闭选项。</p></blockquote><p>操作完毕之后，成功获得 QQ 邮箱授权码：</p><img src="https://img-blog.csdnimg.cn/20200323080559229.png" width="30%" loading="lazy">]]></content>
      
      
      <categories>
          
          <category> Tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> QQ mail box </tag>
            
            <tag> Tools </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Python 中 re 库的使用</title>
      <link href="/posts/7cf75891/"/>
      <url>/posts/7cf75891/</url>
      
        <content type="html"><![CDATA[<p>Re 库是 Python 的第三方库，用于对文字进行模糊匹配。</p><h4 id="Re-库主要功能函数："><a href="#Re-库主要功能函数：" class="headerlink" title="Re 库主要功能函数："></a>Re 库主要功能函数：</h4><table><thead><tr><th align="left">函数</th><th>说明</th></tr></thead><tbody><tr><td align="left">re.search()</td><td>在一个字符串中搜索匹配正则表达式的第一个位置，返回 match 对象</td></tr><tr><td align="left">re.match()</td><td>从一个字符串的开始位置起匹配正则表达式，返回 match 对象</td></tr><tr><td align="left">re.findall()</td><td>搜索字符串，以列表类型返回全部能匹配的子串</td></tr><tr><td align="left">re.split()</td><td>将一个字符串按照正则表达式匹配结果进行分割，返回列表类型</td></tr><tr><td align="left">re.finditer</td><td>搜索字符串，返回一个匹配结果的迭代类型，每个迭代元素是 match 对象</td></tr><tr><td align="left">re.sub()</td><td>在一个字符串中替换所有匹配正则表达式的子串，返回替换后的字符串</td></tr></tbody></table><h5 id="re-search-函数："><a href="#re-search-函数：" class="headerlink" title="re.search 函数："></a>re.search 函数：</h5><p><code>re.search(pattern, string, flags=0)</code></p><p><strong>✧ 在一个字符串中搜索匹配正则表达式的第一个位置，返回 match 对象。</strong></p><ul><li>pattern：正则表达式的字符串或原生字符串表示</li><li>string：待匹配字符串</li><li>flags：正则表达式使用时的控制标记</li></ul><p><strong>flags: 正则表达式使用时的控制标记</strong></p><table><thead><tr><th>常用标记</th><th>说明</th></tr></thead><tbody><tr><td>re.I re.IGNORECASE</td><td>忽略正则表达式的大小写，[A-Z]</td></tr><tr><td>re.M re.MULTILINE</td><td>正则表达式中的^操作符能够将给定字符串的每行当作匹配开始</td></tr><tr><td>re.S re.DOTALL</td><td>正则表达式中的.操作符能够匹配所有字符，默认匹配除换行外的所有字符</td></tr></tbody></table><p>例：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> re<span class="token operator">>></span><span class="token operator">></span> match <span class="token operator">=</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">r'[1-9]\d&#123;5&#125;'</span><span class="token punctuation">,</span> <span class="token string">'516600'</span><span class="token punctuation">)</span><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>match<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token number">516600</span></code></pre><blockquote><p>group(N) 是 match 对象的方法，返回第 N 组括号匹配的字符。</p></blockquote><h5 id="re-match-函数"><a href="#re-match-函数" class="headerlink" title="re.match 函数"></a>re.match 函数</h5><p><code>re.match(pattern, string, flags=0)</code></p><p><strong>✧ 从一个字符串的开始位置起匹配正则表达式，返回 match 对象。</strong></p><ul><li>pattern：正则表达式的字符串或原生字符串表示</li><li>string：待匹配字符串</li><li>flags：正则表达式使用时的控制标记</li></ul><h5 id="re-findall-函数"><a href="#re-findall-函数" class="headerlink" title="re.findall 函数"></a>re.findall 函数</h5><p><code>re.findall(pattern, string, flags=0)</code></p><p><strong>✧ 搜索字符串，以列表类型返回全部能匹配的子串。</strong></p><ul><li>pattern：正则表达式的字符串或原生字符串表示</li><li>string：待匹配字符串</li><li>flags：正则表达式使用时的控制标记</li></ul><p>例：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> re<span class="token operator">>></span><span class="token operator">></span> zip_codes <span class="token operator">=</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">r'[1-9]\d&#123;5&#125;'</span><span class="token punctuation">,</span> <span class="token string">'516600 516601'</span><span class="token punctuation">)</span><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>zip_codes<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'516600'</span><span class="token punctuation">,</span> <span class="token string">'516601'</span><span class="token punctuation">]</span></code></pre><h5 id="re-split-函数"><a href="#re-split-函数" class="headerlink" title="re.split 函数"></a>re.split 函数</h5><p><strong>✧ 将一个字符串按照正则表达式匹配结果进行分割，返回列表类型。</strong></p><ul><li>pattern：正则表达式的字符串或原生字符串表示</li><li>string：待匹配字符串</li><li>maxsplit：最大分割数，剩余部分作为最后一个元素输出，不指定将全部分割</li><li>flags：正则表达式使用时的控制标记</li></ul><p>例：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> re<span class="token operator">>></span><span class="token operator">></span> re<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">r'[1-9]\d&#123;5&#125;'</span><span class="token punctuation">,</span> <span class="token string">'A516600 B516601'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'A'</span><span class="token punctuation">,</span> <span class="token string">'B'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">]</span><span class="token operator">>></span><span class="token operator">></span> re<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">r'[1-9]\d&#123;5&#125;'</span><span class="token punctuation">,</span> <span class="token string">'A516600 B516601'</span><span class="token punctuation">,</span> maxsplit<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'A'</span><span class="token punctuation">,</span> <span class="token string">'B516601'</span><span class="token punctuation">]</span></code></pre><blockquote><p>第一种情况输出’ ‘是因为没有对象可以分割了。</p></blockquote><h5 id="re-finditer-函数"><a href="#re-finditer-函数" class="headerlink" title="re.finditer 函数"></a>re.finditer 函数</h5><p><code>re.finditer(pattern, string, flags=0)</code></p><p><strong>✧ 搜索字符串，返回一个匹配结果的迭代类型，每个迭代元素是 match 对象。</strong></p><ul><li>pattern：正则表达式的字符串或原生字符串表示</li><li>string：待匹配字符串</li><li>flags：正则表达式使用时的控制标记</li></ul><p>例：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> re<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">for</span> i <span class="token keyword">in</span> re<span class="token punctuation">.</span>finditer<span class="token punctuation">(</span><span class="token string">r'[1-9]\d&#123;5&#125;'</span><span class="token punctuation">,</span> <span class="token string">'A516600 B516601'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token number">516601</span><span class="token number">516600</span></code></pre><h5 id="re-sub-函数"><a href="#re-sub-函数" class="headerlink" title="re.sub 函数"></a>re.sub 函数</h5><p><code>re.sub(pattern, repl, string, count=0, flags=0)</code></p><p><strong>✧ 在一个字符串中替换所有匹配正则表达式的子串，返回替换后的字符串。</strong></p><ul><li>pattern：正则表达式的字符串或原生字符串表示</li><li>repl：替换匹配字符串的字符串</li><li>string：待匹配字符串</li><li>count：匹配的最大替换次数</li><li>flags：正则表达式使用时的控制标记</li></ul><p>例：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> re<span class="token operator">>></span><span class="token operator">></span> re<span class="token punctuation">.</span>sub<span class="token punctuation">(</span><span class="token string">r'[1-9]\d&#123;5&#125;'</span><span class="token punctuation">,</span> <span class="token string">':zipcode'</span><span class="token punctuation">,</span> <span class="token string">'A516600 B516601'</span><span class="token punctuation">)</span><span class="token string">'A:zipcode B:zipcode'</span></code></pre><p><img src="https://img-blog.csdnimg.cn/20200301084232580.png" alt="在这里插入图片描述" loading="lazy"></p><h4 id="Re库的另一种等价用法："><a href="#Re库的另一种等价用法：" class="headerlink" title="Re库的另一种等价用法："></a>Re库的另一种等价用法：</h4><p>函数式用法：一次性操作</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> reresult <span class="token operator">=</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">r'[1-9]\d&#123;5&#125;'</span><span class="token punctuation">,</span> <span class="token string">'A516600'</span><span class="token punctuation">)</span></code></pre><p>面向对象用法：编译后的多次操作</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> repattern <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span><span class="token string">r'[1-9]\d&#123;5&#125;'</span><span class="token punctuation">)</span>result <span class="token operator">=</span> pattern<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">'A516600'</span><span class="token punctuation">)</span></code></pre><h6 id="这种方法的好处是：经过一次编译，当我们需要多次对正则表达式进行使用和匹配时，就可以用这种方式来加快整个程序的运行。"><a href="#这种方法的好处是：经过一次编译，当我们需要多次对正则表达式进行使用和匹配时，就可以用这种方式来加快整个程序的运行。" class="headerlink" title="这种方法的好处是：经过一次编译，当我们需要多次对正则表达式进行使用和匹配时，就可以用这种方式来加快整个程序的运行。"></a>这种方法的好处是：经过一次编译，当我们需要多次对正则表达式进行使用和匹配时，就可以用这种方式来加快整个程序的运行。</h6><p><code>regex = re.compile(pattern, flags=0)</code></p><p><strong>✧ 将正则表达式的字符串形式编译成正则表达式对象。</strong></p><ul><li>pattern：正则表达式的字符串或原生字符串表示</li><li>flags：正则表达式使用时的控制标记</li></ul><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> reregex <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span><span class="token string">r'[1-9]\d&#123;5&#125;'</span><span class="token punctuation">)</span></code></pre><table><thead><tr><th>函数</th><th>说明</th></tr></thead><tbody><tr><td>regex.search()</td><td>在一个字符串中搜索匹配正则表达式的第一个位置，返回 match 对象</td></tr><tr><td>regex.match()</td><td>从一个字符串的开始位置起匹配正则表达式，返回 match 对象</td></tr><tr><td>regex.findall()</td><td>搜索字符串，以列表类型返回全部能匹配的子串</td></tr><tr><td>regex.split()</td><td>将一个字符串按照正则表达式匹配结果进行分割，返回列表类型</td></tr><tr><td>regex.finditer</td><td>搜索字符串，返回一个匹配结果的迭代类型，每个迭代元素是 match 对象</td></tr><tr><td>regex.sub()</td><td>在一个字符串中替换所有匹配正则表达式的子串，返回替换后的字符串</td></tr></tbody></table><p><code>re.compile()</code> 将正则表达式<strong>编译成正则表达式对象</strong>，再用正则表达式对象调用这些函数。</p><p><strong>在编程使用中，文本处理和操作是最常使用的功能，而正则表达式库很好地支撑了文本匹配、文本替换的一些工作，在我们很多的程序中，都有正则表达式库的身影。</strong></p>]]></content>
      
      
      <categories>
          
          <category> regex </category>
          
      </categories>
      
      
        <tags>
            
            <tag> regex </tag>
            
            <tag> Python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>正则表达式语法</title>
      <link href="/posts/f81acfd4/"/>
      <url>/posts/f81acfd4/</url>
      
        <content type="html"><![CDATA[<p>正则表达式语法<strong>由字符和操作符构成</strong>。</p><h4 id="正则表达式的常用操作符："><a href="#正则表达式的常用操作符：" class="headerlink" title="正则表达式的常用操作符："></a>正则表达式的常用操作符：</h4><table><thead><tr><th align="center">操作符</th><th align="center">说明</th><th align="center">实例</th></tr></thead><tbody><tr><td align="center">.</td><td align="center">表示任何单个字符</td><td align="center"></td></tr><tr><td align="center">[ ]</td><td align="center">字符集，对单个字符给出取值范围</td><td align="center">[abc]表示a、b、c，[a-z]表示a到z单个字符</td></tr><tr><td align="center">[^ ]</td><td align="center">非字符集，对单个字符给出排除范围</td><td align="center">[^abc]表示非a或b或c的单个字符</td></tr><tr><td align="center">*</td><td align="center">前一个字符0次或无限次扩展</td><td align="center">abc*表示ab、abc、abcc、abccc等</td></tr><tr><td align="center">+</td><td align="center">前一个字符1次或无限次扩展</td><td align="center">abc+表示abc、abcc、abccc等</td></tr><tr><td align="center">？</td><td align="center">前一个字符0次或1次扩展</td><td align="center">abc？表示ab、abc</td></tr><tr><td align="center">&#124;</td><td align="center">左右表达式任一个</td><td align="center">abc&#124;def表示abc、def</td></tr></tbody></table><p><strong>注意：</strong></p><ul><li>.不能代表换行</li><li>注意使用范围（几个字符）</li></ul><h4 id="正则表达式的常用操作符：-1"><a href="#正则表达式的常用操作符：-1" class="headerlink" title="正则表达式的常用操作符："></a>正则表达式的常用操作符：</h4><table><thead><tr><th align="center">操作符</th><th align="center">说明</th><th align="center">实例</th></tr></thead><tbody><tr><td align="center">{m}</td><td align="center">扩展前一个字符m次</td><td align="center">ab{2}c表示abbc</td></tr><tr><td align="center">{m,n}</td><td align="center">扩展前一个字符m至n次（含n）</td><td align="center">ab{1,2}表示abc、abbc</td></tr><tr><td align="center">^</td><td align="center">匹配字符串开头</td><td align="center">^abc表示abc且在一个字符串的开头</td></tr><tr><td align="center">$</td><td align="center">匹配字符串结尾</td><td align="center">abc$表示abc且在一个字符串的结尾</td></tr><tr><td align="center">()</td><td align="center">分组标记，内部只能使用 &#124; 操作符</td><td align="center">(abc)表示abc，(abc&#124;def)表示abc、def</td></tr><tr><td align="center">\d</td><td align="center">数字，等价于[0-9]</td><td align="center"></td></tr><tr><td align="center">\w</td><td align="center">单词字符，等价于[A-Za-z0-9_]</td><td align="center"></td></tr></tbody></table><h4 id="经典正则表达式实例："><a href="#经典正则表达式实例：" class="headerlink" title="经典正则表达式实例："></a>经典正则表达式实例：</h4><table><thead><tr><th align="center">正则表达式</th><th align="center">含义</th></tr></thead><tbody><tr><td align="center">^[A-Za-z]+$</td><td align="center">由26个字母组成的字符串</td></tr><tr><td align="center">^[A-Za-z0-9]+$</td><td align="center">由26个字母和数字组成的字符串</td></tr><tr><td align="center">^-?\d+$</td><td align="center">整数形式的字符串</td></tr><tr><td align="center">^[0-9] * [1-9] [0-9]*$</td><td align="center">正整数形式的字符串</td></tr><tr><td align="center">[1-9]\d{5}</td><td align="center">中国境内邮政编码 (6位)</td></tr><tr><td align="center">[\u4e00-\u9fa5]</td><td align="center">中文字符</td></tr><tr><td align="center">\d{3}-\d{8}|\d{4}-\d{7}</td><td align="center">国内电话号码</td></tr></tbody></table><h4 id="IP地址匹配："><a href="#IP地址匹配：" class="headerlink" title="IP地址匹配："></a>IP地址匹配：</h4><p><code>(?:(?:[0,1]?\d?\d|2[0-4]\d|25[0-5])\.)&#123;3&#125;(?:[0,1]?\d?\d|2[0-4]\d|25[0-5]):\d&#123;2,6&#125;</code></p><blockquote><p><strong>当正则表达式包含转义符时，使用原生字符串(r’regex’)更方便。</strong></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> regex </category>
          
      </categories>
      
      
        <tags>
            
            <tag> regex </tag>
            
            <tag> Python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用 pymysql 库时出现 AttributeError：NoneType object has no attribute encoding 的解决方法</title>
      <link href="/posts/5fa48c5c/"/>
      <url>/posts/5fa48c5c/</url>
      
        <content type="html"><![CDATA[<p><strong>使用 Python 的 pymysql 库与 MySQL 交互时出现 <code>AttributeError：&#39;NoneType&#39; object has no attribute encoding</code>：</strong></p><img src="https://img-blog.csdnimg.cn/20200325175728252.png" width="70%" loading="lazy"><h5 id="原因："><a href="#原因：" class="headerlink" title="原因："></a>原因：</h5><img src="https://img-blog.csdnimg.cn/20200325180107238.png" width="80%" loading="lazy"><p>这编码格式的问题，惯性思维写成 <code>utf-8</code> 了。</p><h5 id="解决方法："><a href="#解决方法：" class="headerlink" title="解决方法："></a>解决方法：</h5><p>将 connect 中的 charset 参数的值改为 <code>utf8</code>。</p>]]></content>
      
      
      <categories>
          
          <category> Problems </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Problems </tag>
            
            <tag> pymysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>tesserocr 安装过程中的版本问题</title>
      <link href="/posts/d79492c0/"/>
      <url>/posts/d79492c0/</url>
      
        <content type="html"><![CDATA[<p><strong>tesserocr 是 Python 的一个 OCR 识别库，但其实是对 tesseract 做的一层 Python API 封装，所以它的核心是 tesseract。</strong></p><p><strong>因此，在安装 tesserocr 之前，我们需要先安装 tesseract。</strong></p><p>tesseract下载地址：<a href="http://digi.bib.uni-mannheim.de/tesseract">http://digi.bib.uni-mannheim.de/tesseract</a></p><hr><p>在 Windows 操作系统下，如果下载完 tesseract 在命令提示符执行 <code>pip install tesserocr pillow</code> 会报错：<br><img src="https://img-blog.csdnimg.cn/20200321105932512.png?0x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTk2MTc3NA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" loading="lazy"></p><p>而 python3.8.0 没有对应版本的 <code>.whl</code> 文件，因此无法通过下载 <code>.whl</code> 文件安装。</p><p>但可以通过下载 Anaconda，并输入 <code>conda install -c simonflueckiger tesserocr pillow</code> 安装。</p><hr><h4 id="测试："><a href="#测试：" class="headerlink" title="测试："></a>测试：</h4><p>图片地址：<a href="https://raw.githubusercontent.com/Python3WebSpider/TestTess/master/image.png">https://raw.githubusercontent.com/Python3WebSpider/TestTess/master/image.png</a></p><img src="https://img-blog.csdnimg.cn/20200321111243608.png" width="50%" loading="lazy"><p><strong>解决方法：用 Windows 批处理命令 type 代替 cat：</strong></p><img src="https://img-blog.csdnimg.cn/20200321111418550.png" width="50%" loading="lazy"><img src="https://img-blog.csdnimg.cn/20200321111505453.png" width="20%" loading="lazy"><hr><p><strong>最后我选择卸载 Python3.8，安装 Python3.7，这样就有对应版本的 <code>.whl</code> 文件了。</strong></p>]]></content>
      
      
      <categories>
          
          <category> Problems </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Problems </tag>
            
            <tag> tesserocr </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>github.io 绑定域名</title>
      <link href="/posts/ea866bb8/"/>
      <url>/posts/ea866bb8/</url>
      
        <content type="html"><![CDATA[<p>在此之前已在 GitHub Pages 搭建好了博客，且能够通过 github.io 进行访问。</p><hr><h4 id="下面介绍一下如何将-github-io-与域名绑定："><a href="#下面介绍一下如何将-github-io-与域名绑定：" class="headerlink" title="下面介绍一下如何将 github.io 与域名绑定："></a>下面介绍一下如何将 github.io 与域名绑定：</h4><h5 id="购买域名"><a href="#购买域名" class="headerlink" title="购买域名"></a>购买域名</h5><p>可以在阿里云等购买。此处有一个阿里云域名1元购的活动可以<del>白嫖</del>了解一下。</p><p><a href="https://wanwang.aliyun.com/domain/1yuan">https://wanwang.aliyun.com/domain/1yuan</a></p><h5 id="在-GitHub-Pages-仓库添加-CNAME-文件并填入将绑定的域名"><a href="#在-GitHub-Pages-仓库添加-CNAME-文件并填入将绑定的域名" class="headerlink" title="在 GitHub Pages 仓库添加 CNAME 文件并填入将绑定的域名"></a>在 GitHub Pages 仓库添加 CNAME 文件并填入将绑定的域名</h5><p><img src="https://i.loli.net/2020/09/05/merfszk2F91MUgX.png" alt="2020090413304028.png" loading="lazy"><br><img src="https://i.loli.net/2020/09/05/7r6ZVCfFgWsnxXR.png" alt="20200904133102274.png" loading="lazy"></p><p><img src="https://i.loli.net/2020/09/05/zmMW87uyeSVnkxs.png" alt="20200904133147320.png" loading="lazy"></p><blockquote><p>填入的域名不要包含 <code>https://</code> 和 <code>www</code>。</p></blockquote><h5 id="进入-GitHub-Pages-仓库的-Settings-界面"><a href="#进入-GitHub-Pages-仓库的-Settings-界面" class="headerlink" title="进入 GitHub Pages 仓库的 Settings 界面"></a>进入 GitHub Pages 仓库的 Settings 界面</h5><p><img src="https://i.loli.net/2020/09/05/ZHXzc7rp3EGn5q8.png" alt="20200904133402828.png" loading="lazy"></p><h5 id="下拉至-GitHub-Pages-模块并在-Custom-domain-部分填入域名地址并保存"><a href="#下拉至-GitHub-Pages-模块并在-Custom-domain-部分填入域名地址并保存" class="headerlink" title="下拉至 GitHub Pages 模块并在 Custom domain 部分填入域名地址并保存"></a>下拉至 GitHub Pages 模块并在 Custom domain 部分填入域名地址并保存</h5><p><img src="https://i.loli.net/2020/09/05/cbfM8d3IKWLazPY.png" alt="20200904133445487.png" loading="lazy"></p><h5 id="添加域名解析"><a href="#添加域名解析" class="headerlink" title="添加域名解析"></a>添加域名解析</h5><p>在命令行窗口 <code>ping</code> 你的 <code>user.github.io</code> 域名，得到一个IP地址，如图：</p><p><img src="https://i.loli.net/2020/09/05/rmPiLo1WKtDlyFJ.png" alt="20200904133929443.png" loading="lazy"></p><p>添加域名解析记录，此处以阿里云为例，添加两个 A 记录，用 ping 所得 IP，一个主机记录为：“www”，另一个为“@”。</p><p><img src="https://i.loli.net/2020/09/05/cJ8tSoTjxApFPkb.png" alt="20200904134110160.png" loading="lazy"></p><p>稍等几分钟，此后通过 xxx.com 和 <a href="http://www.xxx.com/">www.xxx.com</a> 都能进行访问了。</p>]]></content>
      
      
      <categories>
          
          <category> Blog </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Blog </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【Jupyter Notebook】—— 解决由于 kernel 文件中 Python 解释器路径出错导致的 FileNotFoundError</title>
      <link href="/posts/530299ae/"/>
      <url>/posts/530299ae/</url>
      
        <content type="html"><![CDATA[<p>最近 Jupyter Notebook 突然无法启动，找了很久的解决方法都不凑效，于是重装了一遍，然而出现了以下问题：</p><p><img src="https://img-blog.csdnimg.cn/20200812215039747.png?1x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTk2MTc3NA==,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述" loading="lazy"></p><p><img src="https://img-blog.csdnimg.cn/2020081221504517.png?1x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTk2MTc3NA==,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述" loading="lazy"></p><p>即 Jupyter Notebook 能够正常启动以及打开文件，但是无法运行 ipynb 文件，控制台报错为 <code>FileNotFoundError: [WinError 2] 系统找不到指定的文件。</code>，本以为是重新安装的时候出错了，但再次安装了好几次依旧报错，经过排查，发现原因为 <code>kernel.json</code> 文件的解释器路径错误，因为原本是使用 TensorFlow 环境运行的 Jupyter Notebook，重新安装之后就无 TensorFlow 环境了，但配置文件依旧不变，因此我们找到 <code>C:\User\用户名\AppData\Roaming\jupyter\kernels\python3</code> 里的 <code>kernel.json</code> 文件，将其修改为正确的 Python 解释器路径：</p><p><img src="https://img-blog.csdnimg.cn/20200812215537529.png?1x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTk2MTc3NA==,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述" loading="lazy"></p><p>修改完后即可重新启动 Jupyter Notebook。</p>]]></content>
      
      
      <categories>
          
          <category> Problems </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Problems </tag>
            
            <tag> Jupyter Notebook </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
